---
name: ops-expert
description: 影院商品管理中台运营专家。当用户需要以下操作时使用此skill：(1) 查询场景包、门店、影厅、预约、单位换算等数据；(2) 执行场景包发布/下架、门店设置修改、单位换算配置等操作；(3) 获取系统操作指导和业务规则说明；(4) 单位换算计算和换算规则管理。触发词：查询、查看、显示、统计、发布、下架、修改、设置、如何、怎么、运营、场景包、门店、影厅、预约、换算、转换、等于多少、单位、瓶、ml、升、kg。
version: 0.2.0
---

# 影院商品管理中台 - 运营专家

为运营人员提供通过对话方式查询数据、执行操作、获取指导的能力。

## 核心能力

### 1. 数据查询 (Query)
通过 Supabase MCP 查询系统数据：
- **场景包**: 列表、详情、状态统计
- **门店**: 列表、详情、预约设置
- **影厅**: 列表、详情、关联门店
- **预约订单**: 列表、统计、状态分布

### 2. 操作执行 (Operation)
通过 Python 脚本执行写操作：
- **场景包管理**: 发布、下架、编辑基本信息
- **门店设置**: 修改预约时间、时长单位、押金规则
- **批量操作**: 批量修改设置、批量状态变更

### 3. 操作指导 (Help)
基于业务知识库提供帮助：
- **操作流程**: 如何发布场景包、如何设置预约等
- **业务规则**: 发布条件、状态流转、约束规则
- **常见问题**: FAQ 和故障排查

### 4. 单位换算 (Conversion) - NEW
提供单位换算计算和规则管理：
- **换算计算**: 执行即时单位换算（如 45ml=?瓶）
- **规则查询**: 查看所有换算规则、按类别筛选、搜索单位
- **规则配置**: 添加、修改、删除换算规则
- **路径查找**: 自动查找换算路径（如 瓶→ml→L）
- **循环检测**: 创建规则前检测循环依赖

**脚本位置**: `.claude/skills/ops-expert/scripts/`
- `calculate_conversion.py` - 换算计算
- `query_conversions.py` - 规则查询
- `create_conversion.py` - 创建规则
- `update_conversion.py` - 更新规则
- `delete_conversion.py` - 删除规则
- `validate_cycle.py` - 循环检测

## 工作流程

### 步骤1：意图识别
分析用户输入，识别意图类型：

| 意图类型 | 关键词示例 | 执行路径 |
|---------|-----------|---------|
| 查询 | 查看、显示、列出、统计、有多少 | Supabase MCP 查询 |
| 操作 | 发布、下架、修改、设置、创建、删除 | Python 脚本执行 |
| 帮助 | 如何、怎么、什么是、为什么、规则 | 知识库参考 |
| 换算计算 | 等于多少、换算、转换、可以做多少 | calculate_conversion.py |
| 换算规则 | 查看换算规则、添加换算规则、删除换算 | 换算脚本执行 |

### 步骤2：执行操作
根据意图类型选择执行路径：

**查询流程**:
1. 解析查询目标（场景包/门店/影厅/订单）
2. 构建 SQL 查询（参考 database-schema.md）
3. 使用 Supabase MCP 执行查询
4. 格式化结果返回

**操作流程**:
1. 解析操作目标和参数
2. 调用对应的 Python 脚本
3. 显示影响范围，请求确认
4. 执行操作并返回结果

**帮助流程**:
1. 识别问题领域
2. 查找对应的知识库文档
3. 提取相关内容
4. 组织回答

**单位换算流程**:
1. 识别换算意图（计算/查询/配置）
2. 计算意图：调用 `calculate_conversion.py <数量> <源单位> <目标单位>`
3. 查询意图：调用 `query_conversions.py [--category] [--search]`
4. 配置意图：调用对应脚本（create/update/delete）
5. 显示结果，包含换算路径和舍入说明

### 步骤3：返回结果
格式化输出结果，提供后续操作建议。

## 业务知识参考

### 数据库表结构
- **`references/database-schema.md`** - 核心表结构和字段说明

### 业务领域规则
- **`references/scenario-package.md`** - 场景包管理规则
- **`references/store-management.md`** - 门店管理规则
- **`references/hall-management.md`** - 影厅管理规则
- **`references/reservation.md`** - 预约管理规则
- **`references/unit-conversion.md`** - 单位换算规则和配置指南

### 运营指南
- **`references/ops-guide.md`** - 运营操作指南和 FAQ
- **`references/glossary.md`** - 业务术语表

### 示例
- **`examples/common-queries.md`** - 常见查询和操作示例

## 安全约束

### 必须遵守的安全规则

1. **操作确认**: 所有写操作必须在执行前请求用户确认
2. **破坏性操作警告**: 删除、下架等操作需要明确警告
3. **批量操作二次确认**: 影响超过 10 条数据的操作需要二次确认
4. **敏感信息保护**: 不在输出中显示 API Token 等敏感信息
5. **操作日志**: 所有操作通过脚本执行，便于审计追踪

### 工具限制

本技能只能使用以下工具：
- `Read` - 读取知识库文件
- `Bash(python:*)` - 执行 Python 脚本
- `mcp__supabase__*` - Supabase 数据库查询

## 常见指令示例

### 查询类
- "查看所有已发布的场景包"
- "显示门店列表"
- "本周有多少预约订单"
- "场景包'VIP派对'的详情"

### 操作类
- "将场景包'测试'下架"
- "为门店'旗舰店'设置预约时段 9:00-22:00"
- "创建名为'生日派对'的场景包"

### 帮助类
- "如何发布一个场景包"
- "场景包发布需要什么条件"
- "门店预约提前量是什么意思"

### 单位换算类
- "45ml威士忌等于多少瓶"
- "1瓶威士忌可以做多少杯鸡尾酒"
- "查看所有体积类换算规则"
- "添加换算规则：1箱=12瓶"
- "瓶和升之间能换算吗"
- "删除换算规则：瓶→ml"

## 错误处理模式

### 常见错误场景及处理方式

| 错误场景 | 错误代码 | 处理方式 |
|---------|---------|---------|
| 目标不存在 | `NOT_FOUND` | 提示用户检查名称，建议执行查询确认 |
| 状态不允许操作 | `INVALID_STATUS` | 解释当前状态和允许的操作，提供替代方案 |
| 参数验证失败 | `VALIDATION_ERROR` | 详细说明哪些参数不符合要求及正确格式 |
| 网络/API 错误 | `API_ERROR` | 提示稍后重试，如持续失败请联系管理员 |
| 权限不足 | `PERMISSION_DENIED` | 说明需要的权限，引导用户联系管理员 |
| 换算路径不存在 | `PATH_NOT_FOUND` | 提示先配置相关换算规则 |
| 循环依赖检测 | `CYCLE_DETECTED` | 显示循环路径，阻止规则创建 |
| 规则被 BOM 引用 | `RULE_REFERENCED` | 显示引用的 BOM 列表，阻止删除 |

### 错误响应格式

```json
{
  "success": false,
  "message": "用户友好的错误描述",
  "error": "ERROR_CODE",
  "timestamp": "2025-12-25T10:00:00Z"
}
```

### 错误恢复建议

1. **查询无结果**
   - 检查名称拼写是否正确
   - 尝试使用模糊搜索（"搜索场景包 关键词"）
   - 确认目标是否已被删除或归档

2. **操作被拒绝**
   - 使用查询确认目标当前状态
   - 参考 ops-guide.md 了解操作前置条件
   - 按状态流转图执行必要的前置操作

3. **批量操作部分失败**
   - 查看返回的 success_items 和 fail_items 详情
   - 对失败项逐个排查原因
   - 修复问题后可重新执行失败项

### 用户输入容错

- 支持多种时间格式："8:00"、"08:00"、"8:00:00"
- 支持中英文冒号
- 数字支持带单位："2小时"、"120分钟"、"800元"
- 名称支持带或不带引号
