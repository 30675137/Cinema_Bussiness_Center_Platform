# Java 后端代码检测规则
# Code Health Guardian - Java Rules

version: "1.0.0"

# 文件级规则
file_rules:
  # 文件大小限制
  max_lines:
    warning: 300
    error: 500
    message: "类文件过大，建议拆分职责"

  # 导入数量限制
  max_imports:
    warning: 20
    error: 40
    message: "导入过多，可能职责过重"

# 类规则
class_rules:
  # 类行数
  max_class_lines:
    warning: 250
    error: 500
    message: "类过大，违反单一职责原则"

  # 方法数量
  max_methods:
    warning: 15
    error: 25
    message: "方法过多，考虑拆分类"

  # 字段数量
  max_fields:
    warning: 10
    error: 20
    message: "字段过多，考虑拆分或使用组合"

  # 公共方法数量
  max_public_methods:
    warning: 10
    error: 15
    message: "公共接口过大，考虑接口隔离"

# 方法规则
method_rules:
  # 方法行数
  max_lines:
    warning: 40
    error: 80
    message: "方法过长，建议提取子方法"

  # 参数数量
  max_parameters:
    warning: 4
    error: 7
    message: "参数过多，考虑使用对象封装"

  # 嵌套深度
  max_nesting:
    warning: 3
    error: 5
    message: "嵌套过深，使用早返回或提取方法"

  # 局部变量数量
  max_local_variables:
    warning: 8
    error: 15
    message: "局部变量过多，方法职责可能过重"

# 复杂度规则
complexity_rules:
  cyclomatic:
    warning: 10
    error: 20
    message: "圈复杂度过高，建议拆分"

  cognitive:
    warning: 15
    error: 25
    message: "认知复杂度过高"

# 代码异味检测
code_smells:
  # God Class
  - id: god_class
    name: "上帝类 (God Class)"
    pattern: "类超过 500 行或方法超过 20 个"
    severity: critical
    suggestion: |
      识别类的不同职责，按职责拆分为多个类：
      1. 使用单一职责原则（SRP）分析
      2. 识别可以独立的功能模块
      3. 提取为独立的服务类
      4. 使用组合而非继承

  # 长方法
  - id: long_method
    name: "长方法"
    pattern: "方法超过 50 行"
    severity: high
    suggestion: |
      1. 识别方法中的独立步骤
      2. 为每个步骤提取子方法
      3. 使用有意义的方法名替代注释
      4. 考虑使用模板方法模式

  # 过多参数
  - id: long_parameter_list
    name: "过多参数"
    pattern: "方法参数超过 5 个"
    severity: medium
    suggestion: |
      1. 将相关参数封装为对象（Parameter Object）
      2. 使用 Builder 模式
      3. 考虑是否存在隐含的对象

  # 特性依恋
  - id: feature_envy
    name: "特性依恋 (Feature Envy)"
    pattern: "方法过度使用其他类的数据"
    severity: medium
    suggestion: "将方法移动到它最常访问的类中"

  # 数据泥团
  - id: data_clumps
    name: "数据泥团 (Data Clumps)"
    pattern: "相同的字段组在多处出现"
    severity: medium
    suggestion: "将这组数据提取为独立的类"

  # 过度注释
  - id: excessive_comments
    name: "过度注释"
    pattern: "大量注释解释代码逻辑"
    severity: low
    suggestion: "重构代码使其自解释，用方法名表达意图"

  # 硬编码
  - id: hardcoded_values
    name: "硬编码配置"
    pattern: "配置值写死在代码中"
    severity: medium
    suggestion: "使用配置文件或常量类"

  # Switch 语句过多
  - id: switch_statements
    name: "Switch 语句过多"
    pattern: "复杂的 switch/case 或 if/else 链"
    severity: medium
    suggestion: "使用策略模式、状态模式或多态"

  # 懒类
  - id: lazy_class
    name: "懒类 (Lazy Class)"
    pattern: "类过于简单，几乎没有行为"
    severity: low
    suggestion: "考虑合并到其他类或删除"

  # 重复代码
  - id: duplicate_code
    name: "重复代码"
    pattern: "相似代码块在多处出现"
    severity: high
    suggestion: "提取为公共方法或工具类"

  # 死代码
  - id: dead_code
    name: "死代码"
    pattern: "未使用的方法、变量或导入"
    severity: low
    suggestion: "删除未使用的代码"

  # 过深继承
  - id: deep_inheritance
    name: "过深继承层次"
    pattern: "继承层次超过 3 层"
    severity: medium
    suggestion: "优先使用组合而非继承"

# 分层架构规则 (针对 Spring Boot)
layer_rules:
  layers:
    - name: controller
      patterns: ["*Controller.java", "*Resource.java"]
      allowed_dependencies: [service, dto, vo]
      forbidden_dependencies: [repository, entity, mapper]

    - name: service
      patterns: ["*Service.java", "*ServiceImpl.java"]
      allowed_dependencies: [repository, entity, dto, mapper, other_service]
      forbidden_dependencies: [controller]

    - name: repository
      patterns: ["*Repository.java", "*Dao.java", "*Mapper.java"]
      allowed_dependencies: [entity]
      forbidden_dependencies: [controller, service, dto]

    - name: entity
      patterns: ["*Entity.java", "*DO.java"]
      allowed_dependencies: []
      forbidden_dependencies: [controller, service, repository, dto]

    - name: dto
      patterns: ["*DTO.java", "*Request.java", "*Response.java"]
      allowed_dependencies: []
      forbidden_dependencies: [controller, service, repository, entity]

# 重构模式建议
refactor_patterns:
  # 提取方法
  - id: extract_method
    name: "提取方法"
    trigger:
      - "长方法"
      - "重复代码块"
      - "注释分隔的代码段"
    template: |
      // 提取前
      public void processOrder(Order order) {
          // 验证订单
          if (order.getItems().isEmpty()) {
              throw new ValidationException("订单为空");
          }
          if (order.getAmount() <= 0) {
              throw new ValidationException("金额无效");
          }

          // 计算价格
          BigDecimal total = BigDecimal.ZERO;
          for (OrderItem item : order.getItems()) {
              total = total.add(item.getPrice().multiply(item.getQuantity()));
          }
          // ... more logic
      }

      // 提取后
      public void processOrder(Order order) {
          validateOrder(order);
          BigDecimal total = calculateTotal(order);
          // ... more logic
      }

      private void validateOrder(Order order) {
          if (order.getItems().isEmpty()) {
              throw new ValidationException("订单为空");
          }
          if (order.getAmount() <= 0) {
              throw new ValidationException("金额无效");
          }
      }

      private BigDecimal calculateTotal(Order order) {
          return order.getItems().stream()
              .map(item -> item.getPrice().multiply(item.getQuantity()))
              .reduce(BigDecimal.ZERO, BigDecimal::add);
      }

  # 提取类
  - id: extract_class
    name: "提取类"
    trigger:
      - "God Class"
      - "类职责过多"
    template: |
      // 提取前：OrderService 负责订单处理 + 价格计算 + 库存检查

      // 提取后
      @Service
      public class OrderService {
          private final PriceCalculator priceCalculator;
          private final StockValidator stockValidator;
          private final OrderRepository orderRepository;

          public Order createOrder(OrderRequest request) {
              stockValidator.validate(request.getItems());
              BigDecimal total = priceCalculator.calculate(request.getItems());
              return orderRepository.save(Order.from(request, total));
          }
      }

      @Component
      public class PriceCalculator {
          public BigDecimal calculate(List<OrderItem> items) { ... }
          public BigDecimal applyDiscount(BigDecimal price, Discount discount) { ... }
      }

      @Component
      public class StockValidator {
          public void validate(List<OrderItem> items) { ... }
      }

  # 策略模式
  - id: strategy_pattern
    name: "策略模式替换条件分支"
    trigger:
      - "Switch 语句过多"
      - "复杂条件逻辑"
    template: |
      // 提取前
      public BigDecimal calculatePrice(Order order) {
          switch (order.getType()) {
              case NORMAL:
                  return calculateNormalPrice(order);
              case VIP:
                  return calculateVipPrice(order);
              case WHOLESALE:
                  return calculateWholesalePrice(order);
              default:
                  throw new IllegalArgumentException();
          }
      }

      // 提取后
      public interface PricingStrategy {
          BigDecimal calculate(Order order);
      }

      @Component
      public class NormalPricingStrategy implements PricingStrategy { ... }

      @Component
      public class VipPricingStrategy implements PricingStrategy { ... }

      @Service
      public class PricingService {
          private final Map<OrderType, PricingStrategy> strategies;

          public BigDecimal calculatePrice(Order order) {
              return strategies.get(order.getType()).calculate(order);
          }
      }

  # 参数对象
  - id: parameter_object
    name: "参数对象封装"
    trigger:
      - "过多参数"
    template: |
      // 提取前
      public Order createOrder(String customerId, List<Item> items,
                               String shippingAddress, String billingAddress,
                               PaymentMethod paymentMethod, String couponCode) { ... }

      // 提取后
      public Order createOrder(CreateOrderRequest request) { ... }

      @Data
      public class CreateOrderRequest {
          private String customerId;
          private List<Item> items;
          private AddressInfo shippingAddress;
          private AddressInfo billingAddress;
          private PaymentMethod paymentMethod;
          private String couponCode;
      }

# 重复代码检测配置
duplicate_detection:
  min_lines: 6
  min_tokens: 50
  ignore_patterns:
    - "import.*"
    - "package.*"
    - "@.*"  # 注解
    - "logger\\..*"
    - "return.*"

# 依赖分析配置
dependency_analysis:
  # 核心模块（高扇入是正常的）
  core_modules:
    - "common"
    - "util"
    - "config"
    - "exception"

  # 循环依赖检测
  detect_circular: true

  # 模块耦合度阈值
  coupling_threshold:
    warning: 8
    error: 15
