{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://cinema-bussiness-center.com/schemas/e2e-scenario-spec.json",
  "title": "E2EScenarioSpec",
  "description": "Schema for E2E test scenario YAML files",
  "type": "object",
  "required": ["scenario_id", "spec_ref", "title", "tags", "preconditions", "steps", "assertions"],
  "properties": {
    "scenario_id": {
      "type": "string",
      "pattern": "^E2E-[A-Z]+-\\d{3}$",
      "description": "Unique scenario identifier, format: E2E-<MODULE>-<NUMBER>",
      "examples": ["E2E-ORDER-001", "E2E-INVENTORY-001"]
    },
    "spec_ref": {
      "type": "string",
      "pattern": "^[A-Z]\\d{3}$",
      "description": "Reference to project specification ID",
      "examples": ["P005", "O003", "U001"]
    },
    "title": {
      "type": "string",
      "minLength": 1,
      "maxLength": 100,
      "description": "Descriptive title of the scenario"
    },
    "description": {
      "type": "string",
      "maxLength": 500,
      "description": "Optional detailed description of the scenario"
    },
    "tags": {
      "type": "object",
      "required": ["module", "channel", "deploy"],
      "properties": {
        "module": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "enum": ["order", "inventory", "store", "hall", "payment", "user", "category", "brand", "reservation", "activity"]
          },
          "description": "Business module tags"
        },
        "channel": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "enum": ["miniapp", "h5", "web", "app"]
          },
          "description": "Platform channel tags"
        },
        "deploy": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "enum": ["saas", "onprem"]
          },
          "description": "Deployment type tags"
        },
        "priority": {
          "type": "string",
          "enum": ["p1", "p2", "p3"],
          "description": "Priority level (extracted from spec.md)"
        },
        "smoke": {
          "type": "boolean",
          "description": "Whether this is a smoke test"
        }
      },
      "additionalProperties": {
        "type": ["string", "boolean", "array"]
      }
    },
    "preconditions": {
      "type": "object",
      "required": ["role"],
      "properties": {
        "role": {
          "type": "string",
          "enum": ["admin", "normal_user", "guest", "manager", "qa_engineer", "operator"],
          "description": "User role for executing the scenario"
        },
        "testdata_ref": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_]+\\.[a-zA-Z0-9_]+$",
          "description": "Reference to test data, format: <dataset>.<key>",
          "examples": ["userTestData.admin_001", "storeTestData.beijing_store"]
        }
      },
      "additionalProperties": false,
      "not": {
        "anyOf": [
          { "required": ["environment"] },
          { "required": ["baseURL"] },
          { "required": ["tenant"] }
        ]
      }
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["action"],
        "properties": {
          "action": {
            "type": "string",
            "enum": [
              "login", "logout", "navigate", "click", "input", "select", "submit",
              "browse_product", "add_to_cart", "checkout", "pay",
              "create_order", "cancel_order", "update_order",
              "adjust_inventory", "approve_adjustment", "reject_adjustment",
              "create_store", "update_store", "delete_store",
              "create_hall", "update_hall", "associate_store_hall",
              "create_reservation", "cancel_reservation", "update_reservation",
              "wait", "scroll", "hover"
            ],
            "description": "Action to perform"
          },
          "params": {
            "type": "object",
            "properties": {
              "testdata_ref": {
                "type": "string",
                "pattern": "^[a-zA-Z0-9_]+\\.[a-zA-Z0-9_]+$"
              },
              "quantity": { "type": "integer", "minimum": 1 },
              "reason": { "type": "string" },
              "page": { "type": "string" },
              "element": { "type": "string" }
            },
            "additionalProperties": true,
            "not": {
              "anyOf": [
                { "required": ["url"] },
                { "required": ["baseURL"] },
                { "required": ["environment"] }
              ]
            }
          },
          "description": {
            "type": "string",
            "maxLength": 200
          },
          "wait": {
            "type": "integer",
            "minimum": 0,
            "maximum": 30000,
            "description": "Wait time in milliseconds"
          }
        },
        "additionalProperties": false
      }
    },
    "assertions": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["type", "check"],
        "properties": {
          "type": {
            "type": "string",
            "enum": ["ui", "api"],
            "description": "Assertion type"
          },
          "check": {
            "type": "string",
            "enum": [
              "element_visible", "element_contains_text", "page_url_matches",
              "toast_message_shown", "modal_opened", "list_item_count",
              "response_status_is", "response_body_contains",
              "database_record_exists", "database_field_equals",
              "order_status_is_paid", "inventory_updated", "adjustment_approved"
            ],
            "description": "Assertion condition"
          },
          "params": {
            "type": "object",
            "properties": {
              "message": { "type": "string" },
              "expected": { "type": ["string", "number", "boolean"] },
              "table": { "type": "string" },
              "field": { "type": "string" },
              "where": { "type": "object" },
              "testdata_ref": { "type": "string" }
            },
            "additionalProperties": true
          },
          "timeout": {
            "type": "integer",
            "minimum": 0,
            "maximum": 60000,
            "default": 5000,
            "description": "Timeout in milliseconds"
          }
        },
        "additionalProperties": false
      }
    },
    "artifacts": {
      "type": "object",
      "properties": {
        "trace": {
          "type": "string",
          "enum": ["on", "off", "on-failure", "retain-on-failure"],
          "default": "on-failure",
          "description": "Playwright trace capture strategy"
        },
        "video": {
          "type": "string",
          "enum": ["on", "off", "on-failure", "retain-on-failure"],
          "default": "on-failure",
          "description": "Video recording strategy"
        },
        "screenshot": {
          "type": "string",
          "enum": ["on", "off", "only-on-failure"],
          "default": "only-on-failure",
          "description": "Screenshot capture strategy"
        }
      },
      "additionalProperties": false
    },
    "metadata": {
      "type": "object",
      "properties": {
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp"
        },
        "created_by": {
          "type": "string",
          "maxLength": 100
        },
        "updated_at": {
          "type": "string",
          "format": "date-time"
        },
        "updated_by": {
          "type": "string",
          "maxLength": 100
        },
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Semantic version"
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
