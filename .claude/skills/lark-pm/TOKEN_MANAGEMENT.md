# Token ç®¡ç†æœºåˆ¶è¯´æ˜

**@spec T004-lark-project-management**

## æ··åˆæ–¹æ¡ˆï¼šTypeScript + MCP ååŒç®¡ç† Token

### æ¶æ„æ¦‚è¿°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç”¨æˆ·æ“ä½œæµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    /lark-pm auth (OAuth æˆæƒ)
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   TokenManager (TypeScript)                  â”‚
â”‚  â€¢ åŠ è½½ token ä» .env                                         â”‚
â”‚  â€¢ æ£€æµ‹ token è¿‡æœŸï¼ˆæå‰ 5 åˆ†é’Ÿï¼‰                              â”‚
â”‚  â€¢ è‡ªåŠ¨åˆ·æ–° token                                             â”‚
â”‚  â€¢ æä¾› getToken() æ¥å£                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                   /lark-pm get-token (CLI å‘½ä»¤)
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¾“å‡º JSON æ ¼å¼                             â”‚
â”‚  {                                                            â”‚
â”‚    "success": true,                                           â”‚
â”‚    "token": "u-xxxxxx",                                       â”‚
â”‚    "expiresAt": "2026-01-01T04:27:54.863Z"                    â”‚
â”‚  }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                   Claude è¯»å– token
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Claude è°ƒç”¨ MCP å·¥å…·                         â”‚
â”‚  mcp__lark-mcp__bitable_v1_appTableRecord_create({           â”‚
â”‚    path: {...},                                               â”‚
â”‚    data: {...},                                               â”‚
â”‚    // MCP ä»ç¯å¢ƒå˜é‡è¯»å– UAT                                  â”‚
â”‚  })                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. TokenManager (src/utils/token-manager.ts)

**èŒè´£**ï¼š
- ä» `.env` æ–‡ä»¶åŠ è½½ token
- æ£€æµ‹ token æ˜¯å¦è¿‡æœŸï¼ˆæå‰ 5 åˆ†é’Ÿåˆ·æ–°ï¼‰
- è‡ªåŠ¨è°ƒç”¨ LarkOAuthHelper åˆ·æ–° token
- æä¾›å•ä¾‹è®¿é—®æ¥å£

**å…³é”®æ–¹æ³•**ï¼š
```typescript
class TokenManager {
  static getInstance(): TokenManager
  async getToken(): Promise<string>  // è‡ªåŠ¨åˆ·æ–°è¿‡æœŸ token
  async reloadToken(): Promise<void>  // æ‰‹åŠ¨é‡æ–°åŠ è½½
  setToken(accessToken, refreshToken, expiresIn): void
}
```

#### 2. get-token å‘½ä»¤ (src/commands/get-token.ts)

**ç”¨é€”**ï¼š
- ä¾› Claude åœ¨è°ƒç”¨ MCP å·¥å…·å‰è·å–æœ€æ–°çš„ token
- è¾“å‡º JSON æ ¼å¼æ–¹ä¾¿è§£æ
- è‡ªåŠ¨è§¦å‘ token åˆ·æ–°ï¼ˆå¦‚æœéœ€è¦ï¼‰

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```bash
$ node dist/index.js get-token
{
  "success": true,
  "token": "u-7Ax8rY5CxalbGuhgP6CcdEk40Xgkh4Ujjoaaiww02yM0",
  "expiresAt": "2026-01-01T04:27:54.863Z",
  "message": "Token is valid"
}
```

#### 3. æ›´æ–°åçš„ auth å‘½ä»¤

**OAuth å®Œæˆå**ï¼š
```typescript
// é€šçŸ¥ TokenManager è®¾ç½®æ–° token
const tokenManager = TokenManager.getInstance()
tokenManager.setToken(tokens.accessToken, tokens.refreshToken, tokens.expiresIn)

// æ–°æç¤ºï¼šæ— éœ€é‡å¯ï¼
console.log('ğŸ‰ Token å·²è‡ªåŠ¨åŠ è½½ï¼Œæ— éœ€é‡å¯ Claude Codeï¼')
```

**Token åˆ·æ–°å**ï¼š
```typescript
// é€šçŸ¥ TokenManager é‡æ–°åŠ è½½ token
await tokenManager.reloadToken()

console.log('ğŸ‰ Token å·²è‡ªåŠ¨åŠ è½½ï¼Œæ— éœ€é‡å¯ Claude Codeï¼')
```

### ä¼˜åŠ¿

#### âœ… è§£å†³äº† MCP ç¯å¢ƒå˜é‡åˆ·æ–°é—®é¢˜

**ä¹‹å‰çš„é—®é¢˜**ï¼š
1. è¿è¡Œ `/lark-pm auth` æ›´æ–° `.env`
2. MCP æœåŠ¡å™¨ä»ä½¿ç”¨æ—§ tokenï¼ˆå·²è¿‡æœŸï¼‰
3. å¿…é¡»é‡å¯ Claude Code æ‰èƒ½ç”Ÿæ•ˆ âŒ

**ç°åœ¨çš„æ–¹æ¡ˆ**ï¼š
1. è¿è¡Œ `/lark-pm auth` æ›´æ–° `.env`
2. TokenManager ç«‹å³é‡æ–°åŠ è½½ token âœ…
3. æ— éœ€é‡å¯ï¼Œç›´æ¥å¯ç”¨ âœ…

#### âœ… è‡ªåŠ¨ Token åˆ·æ–°

**æ™ºèƒ½åˆ·æ–°ç­–ç•¥**ï¼š
- Token è¿‡æœŸå‰ 5 åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
- ç”¨æˆ·æ— æ„ŸçŸ¥
- é¿å…åœ¨æ“ä½œä¸­é€” token å¤±æ•ˆ

**ç¤ºä¾‹æµç¨‹**ï¼š
```
ç”¨æˆ·: /lark-pm backlog list
  â†“
TokenManager: æ£€æµ‹ token è¿˜æœ‰ 3 åˆ†é’Ÿè¿‡æœŸ
  â†“
TokenManager: è‡ªåŠ¨è°ƒç”¨ refreshToken()
  â†“
TokenManager: è¿”å›æ–° token
  â†“
å‘½ä»¤æ‰§è¡ŒæˆåŠŸ âœ…
```

#### âœ… å‘åå…¼å®¹

- MCP å·¥å…·ä»ä»ç¯å¢ƒå˜é‡è¯»å– tokenï¼ˆæ— éœ€ä¿®æ”¹ MCP æœåŠ¡å™¨ï¼‰
- ç°æœ‰å‘½ä»¤æ— éœ€ä¿®æ”¹
- Claude è°ƒç”¨ MCP å·¥å…·çš„æ–¹å¼ä¸å˜

### ä½¿ç”¨æŒ‡å—

#### é¦–æ¬¡é…ç½®

1. **é…ç½® .env æ–‡ä»¶**ï¼š
   ```bash
   cd .claude/skills/lark-pm
   cp .env.example .env
   # ç¼–è¾‘ .envï¼Œå¡«å…¥ LARK_APP_ID å’Œ LARK_APP_SECRET
   ```

2. **è¿è¡Œ OAuth æˆæƒ**ï¼š
   ```bash
   npm install
   npm run build
   node dist/index.js auth
   ```

3. **éªŒè¯ token**ï¼š
   ```bash
   node dist/index.js get-token
   ```

#### æ—¥å¸¸ä½¿ç”¨

**æ— éœ€ä»»ä½•æ“ä½œï¼**

TokenManager ä¼šè‡ªåŠ¨ï¼š
- åŠ è½½ token
- æ£€æµ‹è¿‡æœŸ
- åˆ·æ–° token

ç”¨æˆ·åªéœ€æ­£å¸¸ä½¿ç”¨å‘½ä»¤ï¼š
```bash
/lark-pm backlog list
/lark-pm task create --title "æ–°ä»»åŠ¡"
```

#### æ‰‹åŠ¨åˆ·æ–° Token

å¦‚æœéœ€è¦ç«‹å³åˆ·æ–° tokenï¼š
```bash
node dist/index.js auth --refresh
```

æç¤ºï¼š
```
ğŸ‰ Token å·²è‡ªåŠ¨åŠ è½½ï¼Œæ— éœ€é‡å¯ Claude Codeï¼
```

### Claude é›†æˆç¤ºä¾‹

å½“ Claude éœ€è¦è°ƒç”¨ MCP å·¥å…·æ—¶ï¼š

```typescript
// 1. è·å–æœ€æ–° tokenï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰
const tokenInfo = await executeCommand('node dist/index.js get-token')
const { token } = JSON.parse(tokenInfo)

// 2. ç›´æ¥è°ƒç”¨ MCPï¼ˆMCP ä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
await mcp__lark-mcp__bitable_v1_appTableRecord_search({
  path: { app_token: "xxx", table_id: "xxx" },
  data: { filter: {...} }
  // useUAT: true  // å¯é€‰ï¼ŒMCP ä¼šä»ç¯å¢ƒå˜é‡è¯»å–
})
```

å®é™…ä¸Šï¼Œç”±äº TokenManager å·²ç»æ›´æ–°äº† `.env`ï¼ŒClaude å¯ä»¥ç›´æ¥è°ƒç”¨ MCP å·¥å…·ï¼Œæ— éœ€å…ˆè°ƒç”¨ `get-token`ã€‚

ä½† `get-token` å‘½ä»¤åœ¨ä»¥ä¸‹åœºæ™¯æœ‰ç”¨ï¼š
- è°ƒè¯• token çŠ¶æ€
- éªŒè¯ token æœ‰æ•ˆæ€§
- æ‰‹åŠ¨è§¦å‘ token åˆ·æ–°

### Token ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Token ç”Ÿå‘½å‘¨æœŸ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OAuth æˆæƒ
  â”œâ”€ è·å– access_token (æœ‰æ•ˆæœŸ 2 å°æ—¶)
  â”œâ”€ è·å– refresh_token (æœ‰æ•ˆæœŸ 30 å¤©)
  â””â”€ ä¿å­˜åˆ° .env + TokenManager

TokenManager åŠ è½½
  â”œâ”€ è¯»å– .env ä¸­çš„ token
  â”œâ”€ è®¡ç®—è¿‡æœŸæ—¶é—´: now + 2 hours
  â””â”€ å­˜å‚¨åœ¨å†…å­˜ä¸­

Token ä½¿ç”¨
  â”œâ”€ getToken() è¢«è°ƒç”¨
  â”œâ”€ æ£€æŸ¥: expiresAt - now < 5 minutes?
  â”‚   â”œâ”€ æ˜¯ â†’ è‡ªåŠ¨åˆ·æ–° token
  â”‚   â””â”€ å¦ â†’ ç›´æ¥è¿”å›å½“å‰ token
  â””â”€ è¿”å›æœ‰æ•ˆ token

Token åˆ·æ–°
  â”œâ”€ ä½¿ç”¨ refresh_token æ¢å–æ–°çš„ access_token
  â”œâ”€ æ›´æ–° .env æ–‡ä»¶
  â”œâ”€ æ›´æ–° TokenManager å†…å­˜
  â””â”€ æ–° token ç«‹å³å¯ç”¨ï¼ˆæ— éœ€é‡å¯ï¼‰
```

### é”™è¯¯å¤„ç†

#### Token ä¸å­˜åœ¨

```bash
$ node dist/index.js get-token
{
  "success": false,
  "error": "No user access token found. Please run \"/lark-pm auth\" to obtain token.",
  "message": "Failed to get token. Please run \"/lark-pm auth\" to authenticate."
}
```

**è§£å†³**ï¼šè¿è¡Œ `/lark-pm auth`

#### Refresh Token è¿‡æœŸ

**åœºæ™¯**ï¼š30 å¤©æœªä½¿ç”¨ï¼Œrefresh_token è¿‡æœŸ

**æç¤º**ï¼š
```
Token refresh failed. Please run "/lark-pm auth" to re-authenticate.
```

**è§£å†³**ï¼šé‡æ–°è¿è¡Œ OAuth æˆæƒ

### æ€§èƒ½è€ƒè™‘

#### å†…å­˜å ç”¨

- TokenManager å•ä¾‹ï¼š~1KB
- Token å­—ç¬¦ä¸²ï¼š~50 bytes
- æ€»è®¡ï¼šå¯å¿½ç•¥ä¸è®¡

#### æ–‡ä»¶ I/O

- åˆå§‹åŒ–æ—¶è¯»å– `.env`ï¼š1 æ¬¡
- Token åˆ·æ–°æ—¶å†™å…¥ `.env`ï¼šæ¯ 2 å°æ—¶ 1 æ¬¡
- å½±å“ï¼šå¯å¿½ç•¥ä¸è®¡

#### API è°ƒç”¨

- Token åˆ·æ–°ï¼šæ¯ 2 å°æ—¶ 1 æ¬¡
- ä½¿ç”¨ refresh_tokenï¼Œæ— éœ€ç”¨æˆ·äº¤äº’
- å¯¹é£ä¹¦ API å½±å“æå°

### å®‰å…¨è€ƒè™‘

#### Token å­˜å‚¨

- âœ… `.env` æ–‡ä»¶ä¸æäº¤åˆ° Gitï¼ˆåœ¨ `.gitignore` ä¸­ï¼‰
- âœ… Token åªå­˜åœ¨äºæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ
- âœ… TokenManager å†…å­˜ä¸­çš„ token éšè¿›ç¨‹ç»“æŸè€Œæ¸…é™¤

#### Token ä¼ è¾“

- âœ… `get-token` å‘½ä»¤è¾“å‡ºåˆ° stdoutï¼ˆä»…æœ¬åœ°ï¼‰
- âœ… MCP å·¥å…·é€šè¿‡æœ¬åœ° IPC é€šä¿¡
- âœ… é£ä¹¦ API è°ƒç”¨ä½¿ç”¨ HTTPS

#### æƒé™æ§åˆ¶

- âœ… Token åªæœ‰æ–‡ä»¶æ‰€æœ‰è€…å¯è¯»å†™ï¼ˆUnix æƒé™ï¼‰
- âœ… OAuth scope é™åˆ¶ä¸º `bitable:app` å’Œ `drive:drive`
- âœ… éµå¾ªæœ€å°æƒé™åŸåˆ™

### æ•…éšœæ’é™¤

#### é—®é¢˜ï¼šget-token è¿”å›æ—§ token

**å¯èƒ½åŸå› **ï¼šTokenManager æœªé‡æ–°åŠ è½½

**è§£å†³**ï¼š
```bash
# æ‰‹åŠ¨åˆ·æ–°
node dist/index.js auth --refresh
```

#### é—®é¢˜ï¼šMCP è°ƒç”¨æŠ¥é”™ "invalid token"

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥ token æ˜¯å¦æœ‰æ•ˆï¼š
   ```bash
   node dist/index.js get-token
   ```

2. æ£€æŸ¥ `.env` æ–‡ä»¶ï¼š
   ```bash
   cat .env | grep LARK_USER_ACCESS_TOKEN
   ```

3. é‡æ–°æˆæƒï¼š
   ```bash
   node dist/index.js auth
   ```

#### é—®é¢˜ï¼šOAuth å¤±è´¥

**å¸¸è§åŸå› **ï¼š
- APP_ID æˆ– APP_SECRET é…ç½®é”™è¯¯
- é‡å®šå‘ URL æœªåœ¨é£ä¹¦åº”ç”¨ä¸­é…ç½®
- ç½‘ç»œè¿æ¥é—®é¢˜

**è§£å†³**ï¼šå‚è€ƒ README.md çš„é…ç½®æ­¥éª¤

### æœªæ¥ä¼˜åŒ–æ–¹å‘

#### 1. æŒä¹…åŒ–è¿‡æœŸæ—¶é—´

**å½“å‰**ï¼šå‡è®¾ token æœ‰æ•ˆæœŸä¸º 2 å°æ—¶

**ä¼˜åŒ–**ï¼š
- OAuth å“åº”ä¸­ä¿å­˜å®é™… `expires_in`
- å†™å…¥ `.env` æ–‡ä»¶ï¼š`LARK_TOKEN_EXPIRES_AT=1735712874863`
- TokenManager è¯»å–å‡†ç¡®è¿‡æœŸæ—¶é—´

#### 2. Token å¥åº·æ£€æŸ¥

**åŠŸèƒ½**ï¼š
```bash
node dist/index.js token-status
```

**è¾“å‡º**ï¼š
```
Token Status:
  âœ… Valid
  Expires in: 1h 45m
  Last refreshed: 2026-01-01 08:30:00
  Refresh token expires: 2026-01-30
```

#### 3. è‡ªåŠ¨é‡è¯•æœºåˆ¶

**åœºæ™¯**ï¼šToken åˆ·æ–°å¤±è´¥æ—¶

**ä¼˜åŒ–**ï¼š
- é‡è¯• 3 æ¬¡ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
- å¤±è´¥åæç¤ºç”¨æˆ·é‡æ–°æˆæƒ
- è®°å½•é”™è¯¯æ—¥å¿—

---

**æœ€åæ›´æ–°**: 2026-01-01
**çŠ¶æ€**: âœ… å·²å®ç°
**è´Ÿè´£äºº**: @randy
