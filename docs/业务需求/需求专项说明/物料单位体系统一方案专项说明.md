# 物料单位体系统一方案专项说明

> **文档版本**: 1.0  
> **创建日期**: 2025-01-11  
> **关联功能**: P002-unit-conversion, 物料主数据  
> **状态**: 规划中

---

## 1. 问题背景

### 1.1 现状问题

当前系统在物料与单位管理方面存在以下问题：

| 问题 | 描述 | 影响 |
|------|------|------|
| **SKU必须关联SPU** | 所有SKU（包括原料、包材）必须先创建SPU | 原料管理繁琐，数据冗余 |
| **单位数据硬编码** | 单位列表写在前端Mock代码中 | 无法动态管理单位 |
| **缺少计量单位** | 只有包装单位（瓶、听），缺少ml、g | 无法实现精细库存管理 |
| **物料级换算缺失** | 不同规格同类物料无法独立配置换算 | 750ml/瓶和500ml/瓶需要不同换算规则 |

### 1.2 业务场景痛点

```
场景：朗姆酒采购与BOM配方

痛点1 - 采购管理：
┌──────────────────────────────────────────────────────────────┐
│  朗姆酒规格：500ml/瓶                                         │
│  采购需求：按瓶采购                                            │
│  库存管理：按ml管理                                            │
│                                                              │
│  当前问题：                                                    │
│  • 无法配置"1瓶=500ml"的物料级换算                            │
│  • 单位列表缺少ml选项                                          │
│  • 必须创建"朗姆酒SPU"才能创建SKU                              │
└──────────────────────────────────────────────────────────────┘

痛点2 - BOM配方：
┌──────────────────────────────────────────────────────────────┐
│  鸡尾酒配方：每份需要朗姆酒50ml                                 │
│                                                              │
│  期望流程：                                                    │
│  • 配方定义用量50ml                                            │
│  • 系统自动换算：50ml = 0.1瓶                                  │
│  • 库存扣减500ml（售出10份）                                   │
│                                                              │
│  当前问题：                                                    │
│  • 无法按ml录入配方用量                                        │
│  • 缺少物料级换算支持                                          │
└──────────────────────────────────────────────────────────────┘
```

### 1.3 目标愿景

建立统一的物料单位体系，实现：

- **单位主数据化**：单位作为独立主数据，支持增删改查
- **物料与SKU分离**：原料/包材使用独立物料模型，无需SPU
- **换算体系统一**：全局换算 + 物料级覆盖，灵活支持各场景
- **与现有系统兼容**：复用 P002-unit-conversion 的换算能力

---

## 2. 现状分析

### 2.1 现有系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                       当前系统架构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────┐           ┌─────────────────┐            │
│   │   SPU 商品主数据 │◀──────────│   品类/品牌      │            │
│   └────────┬────────┘           └─────────────────┘            │
│            │ 必须关联                                           │
│            ▼                                                    │
│   ┌─────────────────┐           ┌─────────────────┐            │
│   │   SKU 库存单位   │───────────│   硬编码单位列表  │            │
│   │ (所有类型都需要  │           │ (瓶、听、袋...)   │            │
│   │  先创建SPU)     │           │ (缺少ml、g)      │            │
│   └────────┬────────┘           └─────────────────┘            │
│            │                                                    │
│            ▼                                                    │
│   ┌─────────────────┐                                          │
│   │  unit_conversions│  ◀── P002 单位换算（已实现）              │
│   │  全局换算规则    │                                          │
│   └─────────────────┘                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 P002 单位换算功能现状

| 项目 | 状态 | 说明 |
|------|------|------|
| **数据表** | ✅ 已创建 | `unit_conversions` 表 |
| **后端API** | ✅ 已实现 | CRUD + 换算计算接口 |
| **前端界面** | 🔄 开发中 | `/bom/conversion` 页面 |
| **换算链计算** | ✅ 已实现 | 支持 瓶→ml→L 多级换算 |
| **循环检测** | ✅ 已实现 | 防止 A→B→C→A 死循环 |

**P002 数据模型：**

```sql
-- 已存在的换算规则表
CREATE TABLE unit_conversions (
  id UUID PRIMARY KEY,
  from_unit VARCHAR(20) NOT NULL,       -- 源单位代码
  to_unit VARCHAR(20) NOT NULL,         -- 目标单位代码
  conversion_rate DECIMAL(10,6) NOT NULL, -- 换算率
  category VARCHAR(20) NOT NULL,        -- 类别: volume/weight/quantity
  UNIQUE (from_unit, to_unit)
);

-- 已有基础数据
-- ml↔L, g↔kg, 个↔打, 瓶↔箱
```

### 2.3 问题根源分析

```
问题1: 单位数据散落
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  前端硬编码:                    数据库 unit_conversions:
  ┌───────────────────┐         ┌───────────────────┐
  │ UNITS = [         │         │ from_unit: 'ml'   │
  │   {code:'BOTTLE'} │   ≠     │ to_unit: 'l'      │
  │   {code:'CAN'}    │         │ ...               │
  │ ]                 │         │                   │
  └───────────────────┘         └───────────────────┘
  
  问题: 前端单位列表与换算规则的单位代码不一致

问题2: SKU强依赖SPU
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  BasicInfoTab.tsx:
  ┌───────────────────────────────────────┐
  │ <Controller                           │
  │   name="spuId"                        │
  │   rules={{ required: '请选择所属SPU' }} │  ← 强制必填
  │ />                                    │
  └───────────────────────────────────────┘
  
  问题: 原料/包材不应该需要SPU，但代码强制要求

问题3: 缺少物料级换算
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  全局规则: 1瓶 = 750ml
  
  实际情况:
  • 威士忌A: 750ml/瓶
  • 威士忌B: 700ml/瓶  
  • 朗姆酒:  500ml/瓶  ← 无法独立配置
  
  问题: 全局换算无法满足不同规格的物料
```

---

## 3. 统一方案设计

### 3.1 设计原则

| 原则 | 说明 |
|------|------|
| **单位主数据化** | 单位作为独立实体，统一管理 |
| **复用现有能力** | 保留 P002 换算链计算能力 |
| **物料独立管理** | 原料/包材使用独立模型，与SKU/SPU解耦 |
| **层级覆盖** | 全局换算 → 物料级覆盖，灵活配置 |
| **最小改动** | 渐进式改造，兼容现有数据 |

### 3.2 统一架构设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         统一物料单位体系架构                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     单位主数据 (units)                           │   │
│  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐       │   │
│  │  │ ml  │ │  L  │ │  g  │ │ kg  │ │ 瓶  │ │ 个  │ │ 份  │ ...   │   │
│  │  └──┬──┘ └──┬──┘ └──┬──┘ └──┬──┘ └──┬──┘ └──┬──┘ └──┬──┘       │   │
│  └─────┼──────┼──────┼──────┼──────┼──────┼──────┼─────────────────┘   │
│        │      │      │      │      │      │      │                     │
│        └──────┴──────┴──────┴──────┴──────┴──────┘                     │
│                           │                                            │
│          ┌────────────────┴────────────────┐                          │
│          ▼                                  ▼                          │
│  ┌─────────────────────┐         ┌─────────────────────┐              │
│  │  全局换算规则         │         │   物料主数据         │              │
│  │  (unit_conversions) │         │   (materials)       │              │
│  │  ─────────────────  │         │  ─────────────────  │              │
│  │  • ml ↔ L (1000)    │ 提供    │  • 物料名称          │              │
│  │  • g ↔ kg (1000)    │ 默认    │  • 库存单位 → units  │              │
│  │  • 瓶 ↔ ml (默认)    │────────→│  • 采购单位 → units  │              │
│  │  • 个 ↔ 打 (12)     │         │  • 采购换算率(可选)   │              │
│  └─────────────────────┘         │  • 使用全局换算?     │              │
│                                  └──────────┬──────────┘              │
│                                             │                          │
│          ┌──────────────────────────────────┼──────────────────┐       │
│          │                                  │                  │       │
│          ▼                                  ▼                  ▼       │
│  ┌─────────────────┐              ┌─────────────────┐  ┌─────────────┐│
│  │  BOM 配方管理   │              │   采购订单      │  │  库存管理   ││
│  │  (用量自动换算)  │              │  (按采购单位)    │  │ (按库存单位)││
│  └─────────────────┘              └─────────────────┘  └─────────────┘│
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 核心概念定义

| 概念 | 定义 | 示例 |
|------|------|------|
| **单位 (Unit)** | 计量单位主数据 | ml、瓶、个、份 |
| **全局换算** | 系统级通用换算规则 | 1L = 1000ml |
| **物料 (Material)** | 原料/包材的独立实体 | 朗姆酒、威士忌、高脚杯 |
| **库存单位** | 物料的库存计量单位 | ml（液体类）、个（包材类） |
| **采购单位** | 物料的采购计量单位 | 瓶、箱、包 |
| **物料换算率** | 物料级别的采购↔库存换算 | 朗姆酒：1瓶=500ml |

### 3.4 换算优先级机制

```
换算计算优先级：物料级 > 全局级

┌─────────────────────────────────────────────────────────────────┐
│                         换算计算流程                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  输入: 物料=朗姆酒, 数量=2, 源单位=瓶, 目标单位=ml               │
│                                                                 │
│  Step 1: 检查物料是否有自定义换算                                │
│          ┌──────────────────────────────────────┐              │
│          │ IF material.purchase_conversion_rate │              │
│          │    AND material.purchase_unit = 瓶   │              │
│          │    AND material.inventory_unit = ml  │              │
│          │ THEN 使用物料换算率                    │              │
│          └──────────────────┬───────────────────┘              │
│                             │                                   │
│                             ▼                                   │
│          result = 2瓶 × 500ml/瓶 = 1000ml  ✓                    │
│                                                                 │
│  Step 2: 若无自定义，使用全局换算链                               │
│          ┌──────────────────────────────────────┐              │
│          │ ELSE                                  │              │
│          │   查询 unit_conversions 表            │              │
│          │   计算换算链: 瓶 → ml                  │              │
│          └──────────────────┬───────────────────┘              │
│                             │                                   │
│                             ▼                                   │
│          result = 2瓶 × 750ml/瓶 = 1500ml  (默认规格)            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 数据模型设计

### 4.1 新增表结构

#### 4.1.1 单位主数据表 (units)

```sql
-- 单位主数据表
CREATE TABLE units (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(20) NOT NULL UNIQUE,      -- 单位代码: ML, BOTTLE, PIECE
  name VARCHAR(50) NOT NULL,             -- 单位名称: 毫升, 瓶, 个
  category VARCHAR(20) NOT NULL,         -- 类别: VOLUME, WEIGHT, COUNT
  description VARCHAR(200),              -- 描述
  decimal_places INT DEFAULT 2,          -- 默认小数位数
  is_base_unit BOOLEAN DEFAULT FALSE,    -- 是否为基础单位
  is_active BOOLEAN DEFAULT TRUE,        -- 是否启用
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  CONSTRAINT chk_unit_category CHECK (category IN ('VOLUME', 'WEIGHT', 'COUNT'))
);

-- 预置单位数据
INSERT INTO units (code, name, category, decimal_places, is_base_unit) VALUES
  -- 体积类
  ('ML', '毫升', 'VOLUME', 1, TRUE),
  ('L', '升', 'VOLUME', 2, FALSE),
  ('BOTTLE', '瓶', 'VOLUME', 0, FALSE),
  ('CUP', '杯', 'VOLUME', 0, FALSE),
  ('SERVING', '份', 'VOLUME', 0, FALSE),
  -- 重量类
  ('G', '克', 'WEIGHT', 0, TRUE),
  ('KG', '千克', 'WEIGHT', 2, FALSE),
  -- 计数类
  ('PIECE', '个', 'COUNT', 0, TRUE),
  ('PACK', '包', 'COUNT', 0, FALSE),
  ('BOX', '箱', 'COUNT', 0, FALSE),
  ('DOZEN', '打', 'COUNT', 0, FALSE);
```

#### 4.1.2 物料主数据表 (materials)

```sql
-- 物料主数据表
CREATE TABLE materials (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(50) NOT NULL UNIQUE,      -- 物料编码: MAT-RUM-001
  name VARCHAR(100) NOT NULL,            -- 物料名称: 朗姆酒
  category VARCHAR(20) NOT NULL,         -- 物料类别: RAW_MATERIAL, PACKAGING
  
  -- 单位配置
  inventory_unit_id UUID NOT NULL REFERENCES units(id),  -- 库存单位
  purchase_unit_id UUID REFERENCES units(id),            -- 采购单位(可选)
  
  -- 换算配置
  purchase_conversion_rate DECIMAL(10,4), -- 采购换算率: 1采购单位=X库存单位
  use_global_conversion BOOLEAN DEFAULT TRUE, -- 是否使用全局换算
  
  -- 其他属性
  specification VARCHAR(200),            -- 规格描述: 500ml/瓶
  brand VARCHAR(100),                    -- 品牌
  supplier_id UUID,                      -- 默认供应商
  standard_cost DECIMAL(10,4),           -- 标准成本(按库存单位)
  
  -- 状态
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  CONSTRAINT chk_material_category CHECK (category IN ('RAW_MATERIAL', 'PACKAGING'))
);

-- 物料示例数据
INSERT INTO materials (code, name, category, inventory_unit_id, purchase_unit_id, 
                       purchase_conversion_rate, use_global_conversion, specification) VALUES
  ('MAT-RUM-001', '朗姆酒', 'RAW_MATERIAL', 
   (SELECT id FROM units WHERE code='ML'),
   (SELECT id FROM units WHERE code='BOTTLE'),
   500, FALSE, '500ml/瓶'),
   
  ('MAT-WHISKY-001', '威士忌', 'RAW_MATERIAL',
   (SELECT id FROM units WHERE code='ML'),
   (SELECT id FROM units WHERE code='BOTTLE'),
   750, FALSE, '750ml/瓶'),
   
  ('MAT-GLASS-001', '高脚杯', 'PACKAGING',
   (SELECT id FROM units WHERE code='PIECE'),
   (SELECT id FROM units WHERE code='BOX'),
   20, FALSE, '20个/箱');
```

### 4.2 扩展现有表

#### 4.2.1 升级 unit_conversions 表

```sql
-- 扩展换算规则表，关联单位主数据
ALTER TABLE unit_conversions 
  ADD COLUMN from_unit_id UUID REFERENCES units(id),
  ADD COLUMN to_unit_id UUID REFERENCES units(id);

-- 数据迁移：将字符串单位关联到单位主数据
UPDATE unit_conversions uc SET 
  from_unit_id = (SELECT id FROM units WHERE UPPER(code) = UPPER(uc.from_unit)),
  to_unit_id = (SELECT id FROM units WHERE UPPER(code) = UPPER(uc.to_unit));

-- 后续版本可删除字符串字段，但保持向后兼容
```

### 4.3 实体关系图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            数据模型关系图                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│    ┌───────────────┐                    ┌───────────────┐               │
│    │    units      │◀───────────────────│unit_conversions│              │
│    ├───────────────┤   from_unit_id     ├───────────────┤               │
│    │ id (PK)       │   to_unit_id       │ id (PK)       │               │
│    │ code          │                    │ from_unit_id  │               │
│    │ name          │                    │ to_unit_id    │               │
│    │ category      │                    │ conversion_rate│              │
│    │ decimal_places│                    │ category      │               │
│    │ is_base_unit  │                    └───────────────┘               │
│    └───────┬───────┘                                                    │
│            │                                                            │
│            │ inventory_unit_id                                          │
│            │ purchase_unit_id                                           │
│            ▼                                                            │
│    ┌───────────────┐                    ┌───────────────┐               │
│    │  materials    │────────────────────│  bom_items    │               │
│    ├───────────────┤    material_id     ├───────────────┤               │
│    │ id (PK)       │                    │ id (PK)       │               │
│    │ code          │                    │ bom_id        │               │
│    │ name          │                    │ material_id   │               │
│    │ category      │                    │ quantity      │               │
│    │ inventory_unit│                    │ unit_id       │               │
│    │ purchase_unit │                    └───────────────┘               │
│    │ conversion_rate│                                                   │
│    │ use_global    │                                                    │
│    └───────────────┘                                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 业务场景支持

### 5.1 场景一：朗姆酒采购与库存

```
场景描述：采购朗姆酒10瓶，按ml管理库存

Step 1: 创建单位（如已存在则跳过）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  进入: 系统设置 > 单位管理
  确认存在: ML(毫升), BOTTLE(瓶)

Step 2: 创建物料
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  进入: 物料管理 > 新建物料
  
  ┌─────────────────────────────────────────────┐
  │ 物料编码:  MAT-RUM-001                       │
  │ 物料名称:  朗姆酒                             │
  │ 物料类别:  原料 (RAW_MATERIAL)               │
  │ 规格描述:  500ml/瓶                          │
  │ ─────────────────────────────────────────── │
  │ 库存单位:  毫升 (ML)                         │
  │ 采购单位:  瓶 (BOTTLE)                       │
  │ 采购换算率: 500 (1瓶=500ml)                  │
  │ 使用全局换算: 否 (使用自定义换算)              │
  │ ─────────────────────────────────────────── │
  │ 标准成本:  0.30 元/ml                        │
  └─────────────────────────────────────────────┘

Step 3: 创建采购订单
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  进入: 采购管理 > 新建采购单
  
  ┌─────────────────────────────────────────────┐
  │ 物料: 朗姆酒 (MAT-RUM-001)                   │
  │ 采购数量: 10                                 │
  │ 采购单位: 瓶                                 │
  │ ─────────────────────────────────────────── │
  │ 系统自动计算:                                │
  │ 入库数量 = 10瓶 × 500ml/瓶 = 5000ml         │
  └─────────────────────────────────────────────┘

Step 4: 库存入库
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  库存记录:
  ┌─────────────────────────────────────────────┐
  │ 物料: 朗姆酒                                 │
  │ 库存数量: 5000 ml                           │
  │ 显示: 5000ml (约 10瓶)                      │
  └─────────────────────────────────────────────┘
```

### 5.2 场景二：BOM配方与库存扣减

```
场景描述：鸡尾酒配方使用朗姆酒50ml/份，售出20份

Step 1: 配置BOM配方
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  进入: BOM管理 > 配方管理
  
  成品: 朗姆鸡尾酒
  组件清单:
  ┌─────────────────────────────────────────────┐
  │ 物料        │ 用量 │ 单位 │ 换算到库存单位   │
  ├─────────────────────────────────────────────┤
  │ 朗姆酒      │ 50   │ ml   │ 50ml           │
  │ 可乐        │ 100  │ ml   │ 100ml          │
  │ 高脚杯      │ 1    │ 个   │ 1个            │
  └─────────────────────────────────────────────┘

Step 2: 订单处理
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  订单: 朗姆鸡尾酒 × 20份
  
  BOM展开:
  ┌─────────────────────────────────────────────┐
  │ 物料        │ 单份用量 │ 订单数量 │ 扣减量  │
  ├─────────────────────────────────────────────┤
  │ 朗姆酒      │ 50ml    │ × 20   │ 1000ml  │
  │ 可乐        │ 100ml   │ × 20   │ 2000ml  │
  │ 高脚杯      │ 1个     │ × 20   │ 20个    │
  └─────────────────────────────────────────────┘

Step 3: 库存变化
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  朗姆酒库存:
  ┌─────────────────────────────────────────────┐
  │ 初始库存:  5000ml                           │
  │ 扣减数量:  1000ml (20份 × 50ml)             │
  │ 剩余库存:  4000ml                           │
  │ 折算显示:  4000ml (约 8瓶)                  │
  └─────────────────────────────────────────────┘
```

### 5.3 场景三：不同规格同类物料

```
场景描述：威士忌有750ml/瓶和350ml/瓶两种规格

物料配置:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
┌───────────────────────────────────────────────────────────────┐
│  物料A: 威士忌(标准瓶)                                         │
│  编码: MAT-WHISKY-STD                                         │
│  规格: 750ml/瓶                                               │
│  库存单位: ml                                                  │
│  采购单位: 瓶                                                  │
│  采购换算率: 750 ← 独立配置                                    │
├───────────────────────────────────────────────────────────────┤
│  物料B: 威士忌(小瓶)                                           │
│  编码: MAT-WHISKY-MINI                                        │
│  规格: 350ml/瓶                                               │
│  库存单位: ml                                                  │
│  采购单位: 瓶                                                  │
│  采购换算率: 350 ← 独立配置                                    │
└───────────────────────────────────────────────────────────────┘

采购对比:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
┌───────────────────────────────────────────────────────────────┐
│  采购物料A: 10瓶 → 10 × 750 = 7500ml                          │
│  采购物料B: 10瓶 → 10 × 350 = 3500ml                          │
│                                                               │
│  同样采购10瓶，入库数量不同！                                   │
│  ✓ 物料级换算解决了不同规格问题                                 │
└───────────────────────────────────────────────────────────────┘
```

---

## 6. 功能模块设计

### 6.1 前端页面规划

| 模块 | 路由 | 功能 | 状态 |
|------|------|------|------|
| **单位管理** | `/system/units` | 单位增删改查 | 新增 |
| **物料管理** | `/materials` | 物料主数据管理 | 新增 |
| **物料列表** | `/materials/list` | 物料查询列表 | 新增 |
| **物料详情** | `/materials/:id` | 物料详情/编辑 | 新增 |
| **单位换算** | `/bom/conversion` | 全局换算规则 | 已有，需改造 |

### 6.2 API 接口设计

#### 6.2.1 单位管理 API

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/units` | GET | 获取单位列表，支持分类筛选 |
| `/api/units` | POST | 创建单位 |
| `/api/units/{id}` | GET | 获取单位详情 |
| `/api/units/{id}` | PUT | 更新单位 |
| `/api/units/{id}` | DELETE | 删除单位（有引用时禁止） |
| `/api/units/categories` | GET | 获取单位类别枚举 |

#### 6.2.2 物料管理 API

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/materials` | GET | 获取物料列表，支持筛选 |
| `/api/materials` | POST | 创建物料 |
| `/api/materials/{id}` | GET | 获取物料详情 |
| `/api/materials/{id}` | PUT | 更新物料 |
| `/api/materials/{id}` | DELETE | 删除物料（有引用时禁止） |
| `/api/materials/{id}/convert` | POST | 执行物料换算计算 |

#### 6.2.3 换算服务 API

```typescript
// 统一换算服务接口
interface ConversionRequest {
  materialId?: string;      // 物料ID，有则使用物料换算
  fromUnitId: string;       // 源单位ID
  toUnitId: string;         // 目标单位ID
  quantity: number;         // 数量
}

interface ConversionResponse {
  result: number;           // 换算结果
  conversionRate: number;   // 使用的换算率
  source: 'material' | 'global';  // 换算来源
  path?: string[];          // 换算路径（全局换算链）
}

// POST /api/conversions/calculate
```

### 6.3 服务层设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          服务层架构                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                       UnifiedConversionService                    │  │
│  │  ─────────────────────────────────────────────────────────────── │  │
│  │  + convert(request: ConversionRequest): ConversionResponse       │  │
│  │  + getMaterialConversionRate(materialId, fromUnit, toUnit)       │  │
│  │  + getGlobalConversionRate(fromUnit, toUnit)                     │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│               ┌──────────────┴──────────────┐                          │
│               ▼                              ▼                          │
│  ┌───────────────────────┐    ┌───────────────────────┐                │
│  │   MaterialService     │    │ UnitConversionService │ ← 复用P002     │
│  │  ──────────────────── │    │  ──────────────────── │                │
│  │  + getMaterial(id)    │    │  + getConversion()    │                │
│  │  + saveMaterial()     │    │  + calculateChain()   │                │
│  │  + getMaterialRate()  │    │  + detectCycle()      │                │
│  └───────────────────────┘    └───────────────────────┘                │
│               │                              │                          │
│               ▼                              ▼                          │
│  ┌───────────────────────┐    ┌───────────────────────┐                │
│  │   MaterialRepository  │    │UnitConversionRepository│               │
│  └───────────────────────┘    └───────────────────────┘                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.4 换算计算核心逻辑

```java
/**
 * 统一换算服务 - 核心算法
 */
@Service
public class UnifiedConversionService {
    
    @Autowired
    private MaterialRepository materialRepository;
    
    @Autowired
    private UnitConversionService globalConversionService; // 复用P002
    
    /**
     * 执行换算计算
     * 优先级: 物料级换算 > 全局换算链
     */
    public ConversionResponse convert(ConversionRequest request) {
        // 1. 如果指定了物料，尝试物料级换算
        if (request.getMaterialId() != null) {
            Optional<BigDecimal> materialRate = getMaterialConversionRate(
                request.getMaterialId(),
                request.getFromUnitId(),
                request.getToUnitId()
            );
            
            if (materialRate.isPresent()) {
                return ConversionResponse.builder()
                    .result(request.getQuantity().multiply(materialRate.get()))
                    .conversionRate(materialRate.get())
                    .source("material")
                    .build();
            }
        }
        
        // 2. 降级到全局换算
        ConversionResult globalResult = globalConversionService.calculate(
            request.getFromUnitId(),
            request.getToUnitId(),
            request.getQuantity()
        );
        
        return ConversionResponse.builder()
            .result(globalResult.getValue())
            .conversionRate(globalResult.getRate())
            .source("global")
            .path(globalResult.getPath())
            .build();
    }
    
    /**
     * 获取物料级换算率
     */
    private Optional<BigDecimal> getMaterialConversionRate(
            String materialId, String fromUnitId, String toUnitId) {
        
        Material material = materialRepository.findById(materialId)
            .orElseThrow(() -> new NotFoundException("Material not found"));
        
        // 检查是否使用全局换算
        if (material.isUseGlobalConversion()) {
            return Optional.empty();
        }
        
        // 检查是否匹配采购→库存换算
        if (material.getPurchaseUnitId().equals(fromUnitId) 
            && material.getInventoryUnitId().equals(toUnitId)) {
            return Optional.of(material.getPurchaseConversionRate());
        }
        
        // 检查是否匹配库存→采购换算（反向）
        if (material.getInventoryUnitId().equals(fromUnitId) 
            && material.getPurchaseUnitId().equals(toUnitId)) {
            return Optional.of(
                BigDecimal.ONE.divide(material.getPurchaseConversionRate(), 6, RoundingMode.HALF_UP)
            );
        }
        
        return Optional.empty();
    }
}
```

---

## 7. 开发实施计划

### 7.1 阶段划分

```
Phase 1: 基础设施 (1-2周)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ├── T1.1 创建 units 表及迁移脚本
  ├── T1.2 预置基础单位数据
  ├── T1.3 开发 UnitService 和 UnitController
  ├── T1.4 前端单位管理页面 (/system/units)
  └── T1.5 改造现有单位下拉组件，从API获取数据

Phase 2: 物料主数据 (2-3周)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ├── T2.1 创建 materials 表及迁移脚本
  ├── T2.2 开发 MaterialService 和 MaterialController
  ├── T2.3 前端物料管理页面 (/materials)
  ├── T2.4 物料换算配置表单组件
  └── T2.5 物料与单位关联逻辑

Phase 3: 换算整合 (1-2周)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ├── T3.1 开发 UnifiedConversionService
  ├── T3.2 改造现有换算API，支持物料参数
  ├── T3.3 升级 unit_conversions 表关联 units
  └── T3.4 前端换算页面增加物料换算展示

Phase 4: 业务集成 (2-3周)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ├── T4.1 BOM配方管理集成物料选择
  ├── T4.2 采购订单集成物料换算
  ├── T4.3 库存管理支持物料库存
  └── T4.4 报表与统计调整
```

### 7.2 详细任务清单

| 阶段 | 任务 | 优先级 | 工时估算 | 依赖 |
|------|------|--------|----------|------|
| **P1** | T1.1 units 表迁移脚本 | P0 | 2h | - |
| **P1** | T1.2 预置单位数据 | P0 | 1h | T1.1 |
| **P1** | T1.3 UnitService/Controller | P0 | 4h | T1.1 |
| **P1** | T1.4 单位管理前端页面 | P0 | 8h | T1.3 |
| **P1** | T1.5 改造单位下拉组件 | P0 | 4h | T1.3 |
| **P2** | T2.1 materials 表迁移脚本 | P0 | 2h | T1.1 |
| **P2** | T2.2 MaterialService/Controller | P0 | 8h | T2.1 |
| **P2** | T2.3 物料管理前端页面 | P0 | 16h | T2.2 |
| **P2** | T2.4 物料换算配置组件 | P1 | 8h | T2.3, T1.4 |
| **P2** | T2.5 物料单位关联逻辑 | P1 | 4h | T2.2, T1.3 |
| **P3** | T3.1 UnifiedConversionService | P0 | 8h | T2.2, P002 |
| **P3** | T3.2 换算API支持物料参数 | P1 | 4h | T3.1 |
| **P3** | T3.3 unit_conversions 升级 | P1 | 4h | T1.1 |
| **P3** | T3.4 换算页面物料展示 | P2 | 4h | T3.1 |
| **P4** | T4.1 BOM配方集成 | P1 | 16h | T3.1 |
| **P4** | T4.2 采购订单集成 | P1 | 8h | T2.2, T3.1 |
| **P4** | T4.3 库存管理支持 | P1 | 8h | T2.2 |
| **P4** | T4.4 报表统计调整 | P2 | 4h | T4.1-T4.3 |

### 7.3 里程碑

| 里程碑 | 目标日期 | 交付物 | 验收标准 |
|--------|----------|--------|----------|
| **M1** | +2周 | 单位主数据功能上线 | 可通过界面管理单位 |
| **M2** | +5周 | 物料主数据功能上线 | 可创建物料并配置换算 |
| **M3** | +7周 | 统一换算服务上线 | 物料级换算优先生效 |
| **M4** | +10周 | 全功能集成完成 | 采购/BOM/库存全链路打通 |

---

## 8. 兼容性与迁移

### 8.1 向后兼容策略

| 场景 | 兼容策略 |
|------|----------|
| **现有SKU数据** | 保持不变，成品SKU继续使用SPU-SKU模型 |
| **现有换算规则** | 保留 unit_conversions 数据，新增字段关联 |
| **现有BOM配方** | 渐进迁移，支持SKU和物料两种组件 |
| **现有API调用** | 保持原有接口可用，新增物料参数为可选 |

### 8.2 数据迁移方案

```sql
-- 迁移步骤1: 从现有SKU提取原料数据到物料表
INSERT INTO materials (code, name, category, inventory_unit_id, purchase_unit_id)
SELECT 
  sku_code,
  sku_name,
  CASE WHEN type = 'RAW_MATERIAL' THEN 'RAW_MATERIAL'
       WHEN type = 'PACKAGING' THEN 'PACKAGING'
  END,
  (SELECT id FROM units WHERE code = main_unit_code),
  NULL  -- 采购单位后续配置
FROM skus
WHERE type IN ('RAW_MATERIAL', 'PACKAGING');

-- 迁移步骤2: 关联换算规则到单位主数据
UPDATE unit_conversions uc SET
  from_unit_id = (SELECT id FROM units WHERE LOWER(code) = LOWER(uc.from_unit)),
  to_unit_id = (SELECT id FROM units WHERE LOWER(code) = LOWER(uc.to_unit));
```

### 8.3 回滚方案

```
如需回滚，执行以下步骤:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. 前端回滚: 恢复硬编码单位列表
2. API回滚: 移除物料参数，使用纯全局换算
3. 数据回滚: 保留 units/materials 表，但不使用
4. 关联回滚: unit_conversions 继续使用字符串字段

回滚影响:
• 新创建的物料数据将不可用
• 物料级换算配置失效，回退到全局换算
• 前端组件恢复使用硬编码数据
```

---

## 9. 验收标准

### 9.1 功能验收

| 功能 | 验收标准 |
|------|----------|
| **单位管理** | 可增删改查单位，支持分类筛选 |
| **物料管理** | 可创建物料，配置库存/采购单位及换算率 |
| **物料换算** | 物料级换算率优先于全局换算 |
| **全局换算** | 无物料时使用全局换算链 |
| **BOM集成** | BOM组件支持选择物料，自动换算 |
| **采购集成** | 采购订单按采购单位录入，自动换算入库 |

### 9.2 测试场景

```
测试场景1: 朗姆酒采购
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  前置: 创建物料"朗姆酒"，配置1瓶=500ml
  操作: 创建采购订单10瓶
  预期: 入库5000ml
  验证: 库存记录显示5000ml

测试场景2: BOM配方扣减
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  前置: 库存5000ml，配方用量50ml/份
  操作: 下单10份
  预期: 扣减500ml，剩余4500ml
  验证: 库存变为4500ml

测试场景3: 物料级覆盖全局
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  前置: 全局规则1瓶=750ml，物料配置1瓶=500ml
  操作: 换算1瓶朗姆酒
  预期: 结果500ml（使用物料配置）
  验证: 返回source='material'

测试场景4: 降级到全局换算
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  前置: 物料设置use_global_conversion=true
  操作: 换算1瓶
  预期: 使用全局规则750ml
  验证: 返回source='global'
```

---

## 附录

### A. 术语对照表

| 术语 | 英文 | 说明 |
|------|------|------|
| 单位 | Unit | 计量单位，如ml、瓶、个 |
| 物料 | Material | 原料/包材的主数据实体 |
| 全局换算 | Global Conversion | 系统级通用换算规则 |
| 物料换算 | Material Conversion | 物料级别的自定义换算 |
| 库存单位 | Inventory Unit | 物料的库存计量单位 |
| 采购单位 | Purchase Unit | 物料的采购计量单位 |
| 换算率 | Conversion Rate | 单位间的换算比例 |

### B. 相关文档

| 文档 | 路径 | 说明 |
|------|------|------|
| P002 单位换算专项说明 | `/docs/业务需求/需求专项说明/单位换算配置功能专项说明.md` | 现有换算功能 |
| P002 功能规格 | `/specs/P002-unit-conversion/spec.md` | 换算功能规格 |
| BOM MVP需求书 | `/docs/业务需求/BOM_MVP_业务需求书_敏捷故事卡片.md` | 整体业务需求 |
| 酒吧场景验证 | `/docs/业务需求/酒吧现调饮品售卖场景验证分析.md` | 场景验证分析 |

### C. 变更历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2025-01-11 | 初始版本，完整方案设计 | - |
