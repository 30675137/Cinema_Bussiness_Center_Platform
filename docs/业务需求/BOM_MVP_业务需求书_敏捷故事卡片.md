# 影院特色影厅 / 酒吧式售卖 —— BOM（配方）MVP 业务需求书 & 敏捷故事卡片
版本：V1.1  
日期：2025-12-24  
作者：ChatGPT（按你提供的MVP范围整理）  
更新记录：V1.1 增加已有功能状态标记、场景化验证流程

---

## 0. 文档目的
在“特色影厅酒吧式售卖”场景下，落地一套 **BOM（配方/物料清单）** 的最小可用闭环（MVP），覆盖：
- 成品（现调/小吃）按配方扣原料与包材
- 套餐（组合）按规则扣子项
- 吧台库库存可信（领用/盘点/差异/报损赠饮）
- 成品标准成本与毛利可计算

---

## 1. 业务背景与痛点
### 1.1 业务背景
影院特色影厅引入酒吧式经营：现调饮品、酒水按杯售卖、小吃制作、观影套餐/派对套餐等。销售渠道包含：吧台POS、前台POS、可能的小程序下单/到店核销。

### 1.2 当前痛点（要被MVP解决）
- **按杯卖酒**：库存是“瓶/升”，售卖是“杯/份”，没有标准扣减与换算，易超卖/盘亏。
- **现调饮品成本不清**：缺配方与损耗规则，毛利失真。
- **包材消耗不可追踪**：杯子/吸管/餐盒等消耗没有闭环。
- **退单/客诉补偿难治理**：已出品退单的回库与损耗无法一致处理。
- **吧台库存不可信**：领用、盘点、报损、赠饮没有事件化单据。

---

## 2. 目标与成功指标
### 2.1 MVP目标（Outcome）
1) 任何“配方成品”售卖后，原料/包材库存被正确扣减（或按流程预占→出品扣减）。  
2) 任何“组合套餐”售卖后，子项库存被正确扣减。  
3) 退单/已出品退单可以走清晰规则（回滚/报损/赠饮），库存与财务口径一致。  
4) 可计算成品标准成本与毛利，支撑经营决策。  
5) 吧台库存可通过领用与盘点形成闭环治理。

### 2.2 关键指标（建议）
- BOM成品出品扣减成功率 ≥ 99.5%
- “缺料不可售”拦截准确率 ≥ 95%（以盘点/复核为准）
- 盘亏率（重点品：基酒/杯子）逐周下降
- 成品毛利表可用（覆盖≥80%高频SKU）

---

## 3. 范围（MVP）
### 3.1 In Scope（必须交付）
> 对应你之前确认的 MVP 10项闭环

1. 物料/包材/成品主档  
2. 单位换算（瓶↔ml↔杯；g↔份等）  
3. 配方BOM（含包材）  
4. BOM版本 + 门店生效（可按门店/渠道启用）  
5. 扣减策略：**预占 + 出品确认扣减**（POS可自动出品）  
6. 预占：订单创建后占用原料/包材；取消/退单释放  
7. 退单反向冲销：未出品退单=释放占用；已出品退单=按规则生成报损/赠饮  
8. 标准成本计算（用于毛利）  
9. 领用/转仓（主仓→吧台库）  
10. 吧台盘点 + 盘亏差异单（原因字典、可审批）

### 3.2 Out of Scope（MVP不做，但保留扩展位）
- 多配方/个性化加料导致配方动态变化（糖度/冰量/基酒可选）
- 替代料/缺货自动替换
- 复杂生产工单队列与吧台排队系统
- 批次/FIFO等精细成本（MVP只做标准成本）
- 按影厅/活动维度成本归集（团建/派对的项目核算）

---

## 4. 角色与权限（MVP）Out of Scope（MVP不做，但保留扩展位）
| 角色 | 典型岗位 | 核心权限（MVP） |
|---|---|---|
| 吧台员工 | 调制/出品 | 出品确认；盘点录入；报损/赠饮提报（可选） |
| 店长 | 门店管理 | 审批报损/赠饮/盘亏；调整吧台库配置；查看报表 |
| 仓管/采购 | 主仓管理 | 采购入库；调拨/领用出库；盘点主仓 |
| 财务/运营 | 成本与经营 | 成本口径维护；查看毛利报表；字典维护（原因/损耗） |
| 系统管理员 | IT/中台 | 主数据/单位换算/BOM版本维护；权限配置 |

---

## 5. 关键业务概念（Glossary）
- **原料SKU**：用于制作/调制的消耗品（酒液、糖浆、玉米粒等）
- **包材SKU**：杯子、吸管、餐盒、纸袋等
- **成品SKU**：可售卖的饮品/小吃（由BOM定义消耗）
- **组合SKU（套餐）**：由多个可售SKU组合，销售时扣子项
- **BOM（配方）**：父项成品对应子项原料/包材及用量、单位、损耗
- **预占（Reservation）**：订单确认后先锁定库存，避免超卖
- **出品确认（Production Confirm）**：确认已制作/交付，触发实际扣减
- **差异单**：盘点后差异形成的调整单据（带原因与审批）

---

## 6. 关键业务流程（MVP）
### 6.1 采购入库 → 主仓
1) 采购下单（可选）→ 到货验收 → 入库到主仓  
2) 原料/包材形成库存与单价（MVP成本取“标准成本”，不强依赖采购价）

### 6.2 领用/转仓 → 吧台库
1) 主仓发起“领用出库/调拨”到吧台库  
2) 吧台库形成可售原料基数（盘点与差异以吧台库为准）

### 6.3 BOM配置与生效
1) 管理员创建成品SKU与配方BOM（含包材）  
2) 设置BOM版本、生效日期、适用门店/渠道  
3) 系统校验：单位换算存在、子项状态可用

### 6.4 售卖/出品（预占 + 出品扣减）
1) 收银/小程序创建订单 → 订单确认  
2) 系统按BOM计算需用量，进行库存**预占**（吧台库优先）  
3) 出品人员点击“出品确认”，系统将占用转为**实际扣减**  
4) POS快速场景：可配置为“支付即自动出品确认”（减少一步）

### 6.5 退单/取消（反向处理）
- **未出品退单**：释放预占，不做实际扣减回滚  
- **已出品退单**：不直接回库；按规则生成：
  - 客诉补偿：走 **赠饮单**（消耗已发生，归因留痕）
  - 质量问题/过期：走 **报损单**
  - 需要财务确认的退货：可选走审批后处理

### 6.6 盘点 → 差异单
1) 吧台盘点录入（支持液体按ml、瓶按剩余容量折算）  
2) 系统生成差异单（盘盈/盘亏），必须选择原因并可触发审批  
3) 审批通过后，系统调整库存并沉淀治理数据

---

## 7. 功能需求（Functional Requirements）

> **图例说明**：
> - 🟢 已完成：功能已实现并可用
> - 🟡 部分完成：有UI框架或基础功能，核心逻辑待实现
> - 🔴 待开发：功能尚未开始开发

### FR-01 主数据：原料/包材/成品/套餐 🟢 已完成
**描述**：支持维护四类SKU，定义属性与可用范围。  
**关键点**：
- SKU类型：原料、包材、成品、组合（套餐）
- 基本字段：名称、规格、单位、启用状态、门店范围
- 库存属性：是否管理库存、是否允许负库存（MVP默认不允许）
- 成本属性：标准成本（原料/包材维护；成品由BOM反算）

**验收**：
- 可以创建并启用以上四类SKU；可按门店生效。

**现有功能**：
- ✅ SKU管理模块已完成（`/products/sku`），支持CRUD、状态切换、多步骤表单
- ✅ SPU管理模块已完成（`/products/spu`），支持商品主数据维护
- ✅ 类目管理已完成（`/mdm-pim/category`）
- ✅ 品牌管理已完成（`/mdm-pim/brands`）
- ⚠️ SKU类型字段需扩展：增加原料、包材类型选项

---

### FR-02 单位与换算体系 🟡 部分完成
**描述**：支撑“瓶↔ml↔杯”“g↔份”等换算。  
**规则**：
- 支持基础单位与包装单位：瓶、L、ml、g、份、个、杯
- 支持换算链：例如 1瓶=750ml；1杯=150ml（杯是售卖单位，ml是库存计量）
- 舍入规则：扣减保留小数位（建议保留到0.1ml或1ml，按业务配置）

**验收**：
- 配方用量与库存扣减能正确换算，并通过校验。

**现有功能**：
- ✅ 单位基础定义存在（瓶、罐、毫升、克等）
- ❌ 单位换算关系表不存在，需新建
- ❌ 换算链配置界面需开发（`/bom/conversion`菜单已存在）

---

### FR-03 配方BOM（Recipe BOM） 🟡 部分完成
**描述**：成品SKU绑定子项清单：原料+包材+用量+单位+损耗。  
**BOM字段**：
- 父项（成品SKU）
- 子项（原料/包材SKU）
- 标准用量、单位（如威士忌45ml、杯子1个）
- 损耗（百分比或固定量；MVP选“百分比”）
- 产出数量（默认=1份成品）

**校验**：
- 子项必须可用；单位换算存在；用量>0
- BOM循环依赖禁止（MVP不允许子项再次是父项成品）

**验收**：
- 创建/编辑/查看BOM；销售模拟可计算需用量清单。

**现有功能**：
- ✅ BOM配置Tab组件已实现（`BomTab.tsx`），支持物料添加/删除、用量设置、成本计算
- ✅ BOM类型定义已完成（`BOMRecipe`、`BOMComponent`接口）
- ⚠️ 损耗率字段需补充
- ❌ BOM与库存联动的消耗预览功能需开发

---

### FR-04 BOM版本与生效（门店/渠道） 🔴 待开发
**描述**：同一成品可维护多个版本，按日期与范围生效。  
**规则**：
- 版本号、状态（草稿/生效/停用）
- 生效范围：门店、渠道（吧台POS/前台POS/小程序）
- 同一时间同一范围只允许一个生效版本

**验收**：
- 到达生效日期后自动使用生效版本；历史订单保留当时版本快照（MVP可存“用量快照”）。

**现有功能**：
- ✅ BOM版本管理菜单已存在（`/bom/version`）
- ❌ 版本管理核心功能待开发
- ❌ 门店/渠道生效规则待开发

---

### FR-05 扣减策略：预占 + 出品确认扣减 🟡 部分完成
**描述**：订单确认先预占，出品确认后扣减。  
**规则**：
- 预占对象：吧台库（默认）；不足则按策略：禁止售卖/提示调拨（MVP：禁止售卖）
- 出品确认：将预占转为扣减，生成“出品记录”
- POS快速模式：支付成功即自动出品确认（可配置）

**验收**：
- 订单确认后库存可见“可用/已占用/总量”
- 出品确认后实际库存减少，已占用清零。

**现有功能**：
- ✅ 库存预占管理UI框架已实现（`InventoryReservation.tsx`）
- ✅ 库存数据模型支持预占字段（`reservedQuantity`、`availableQuantity`）
- ✅ 预约系统有库存检查逻辑（`ReservationOrderService.checkInventory`）
- ⚠️ 需扩展为按BOM展开的物料级预占
- ❌ 出品确认触发扣减逻辑待开发

---

### FR-06 预占释放（取消/超时） 🟡 部分完成
**描述**：订单取消、支付失败或超时自动释放占用。  
**规则**：
- 订单取消立即释放
- 超时（如15分钟）自动释放（参数化）
- 幂等：重复释放不导致负占用

**验收**：
- 模拟超时与取消后，占用正确释放。

**现有功能**：
- ✅ 预约取消释放逻辑已实现（`ReservationOrderService`）
- ⚠️ 需扩展为通用订单的预占释放
- ❌ 超时自动释放定时任务待开发

---

### FR-07 退单/反向冲销规则 🔴 待开发
**描述**：区分未出品与已出品两类。  
**规则**：
- 未出品退单：释放预占即可
- 已出品退单：必须选择“处理方式”
  - 赠饮（客诉补偿/活动赠送）：生成赠饮单（不回库）
  - 报损（制作失败/过期/溢洒）：生成报损单（不回库）
- 审批：赠饮/报损金额或数量超过阈值需要店长审批（阈值参数化）

**验收**：
- 已出品退单不会直接回滚库存；会产生对应事件单据并可追溯。

**现有功能**：
- ❌ 赠饮单/报损单数据模型待设计
- ❌ 退单处理方式选择界面待开发
- ❌ 审批流程待开发

---

### FR-08 标准成本与毛利（MVP） 🟡 部分完成
**描述**：基于BOM反算成品标准成本，并在订单维度计算毛利。  
**规则**：
- 子项标准成本维护在原料/包材SKU上
- 成品标准成本 = Σ(子项用量×子项标准成本) × (1+损耗率)
- 订单毛利 = 销售额（含折扣后）- 成本（按成品标准成本×数量）

**验收**：
- 能输出“成品标准成本表”“商品毛利汇总（按天/门店/渠道）”。

**现有功能**：
- ✅ BOM Tab 支持成本计算显示（`unitCost`、`totalCost`）
- ✅ 成本/毛利预估菜单已存在（`/bom/cost`）
- ⚠️ 需与BOM联动实现自动反算
- ❌ 毛利报表功能待开发

---

### FR-09 领用/转仓（主仓→吧台库） 🟡 部分完成
**描述**：主仓向吧台库补货/领用，形成可追溯链路。  
**规则**：
- 单据：领用单/调拨单（MVP二选一实现也可）
- 状态：草稿→提交→出库→入库（或一体化完成）
- 权限：仓管创建；吧台/店长确认入库（可选）

**验收**：
- 领用后吧台库库存增加；单据可追溯到SKU与数量。

**现有功能**：
- ✅ 调拨管理菜单已存在（`/procurement/transfer`、`/inventory/transfer`）
- ✅ 调拨单数据模型已定义（`TransferOrder`、`TransferStatus`）
- ✅ 库存服务支持调拨操作（`inventoryService.createInventoryTransfer`）
- ⚠️ 调拨单列表/表单UI待完善

---

### FR-10 吧台盘点 + 差异单（含原因&审批） 🟡 部分完成
**描述**：盘点录入后自动生成差异单，强制原因。  
**规则**：
- 支持按SKU快速录入实盘数量
- 自动计算差异：盘盈/盘亏
- 原因字典：过期、溢洒、操作错误、赠饮未登记、客诉补偿等
- 审批：店长审批后才生效调整

**验收**：
- 盘点后差异单生成；审批前不改库存，审批后库存更新。

**现有功能**：
- ✅ 盘点模块UI框架已实现（`Stocktaking.tsx`），包含概览、计划、执行、审核、报表Tab
- ⚠️ 盘点录入/差异计算核心功能待开发
- ❌ 差异单数据模型待设计
- ❌ 原因字典待配置

---

## 7.1 功能完成度汇总

| 功能需求 | 完成状态 | 现有基础 | 待开发内容 |
|---------|---------|---------|----------|
| FR-01 主数据 | 🟢 已完成 | SKU/SPU/类目/品牌管理 | 扩展SKU类型(原料/包材) |
| FR-02 单位换算 | 🟡 部分完成 | 单位基础定义 | 换算关系表+配置界面 |
| FR-03 配方BOM | 🟡 部分完成 | BomTab组件+类型定义 | 损耗率+消耗预览 |
| FR-04 BOM版本 | 🔴 待开发 | 菜单入口 | 全部核心功能 |
| FR-05 预占+扣减 | 🟡 部分完成 | 预占UI框架+数据模型 | BOM展开+出品扣减 |
| FR-06 预占释放 | 🟡 部分完成 | 预约取消释放逻辑 | 通用化+超时任务 |
| FR-07 退单冲销 | 🔴 待开发 | 无 | 赠饮/报损单+审批 |
| FR-08 成本毛利 | 🟡 部分完成 | BOM成本展示 | 自动反算+报表 |
| FR-09 领用转仓 | 🟡 部分完成 | 调拨数据模型+服务 | UI完善 |
| FR-10 盘点差异 | 🟡 部分完成 | 盘点UI框架 | 核心功能+差异单 |

---

## 8. 关键数据模型（概念级）
> MVP只要求概念级一致性，具体表结构可在技术设计阶段细化

- SKU（商品/物料）  
- Unit（单位） / UnitConversion（换算）  
- BOMHeader（配方头）/ BOMLine（子项明细）/ BOMVersion（版本与范围）  
- Inventory（库存：总量/可用/已占用）  
- Reservation（占用记录：订单行维度）  
- Order / OrderLine（订单与明细）  
- ProductionRecord（出品记录）  
- StockTransfer（调拨/领用单）  
- StockCount（盘点单）/ StockVariance（差异单）  
- WasteOrder（报损单）/ ComplimentaryOrder（赠饮单）  
- Dictionary（原因字典/阈值参数）

---

## 9. 边界条件与假设（MVP）
- 默认不允许负库存；库存不足则禁止确认订单（提示“缺料需补货/调拨”）
- 吧台库为出品扣减主库位；主仓仅用于补货与盘点
- 成本口径先采用标准成本（人工维护），不做采购价联动
- 退单逻辑以“治理优先”：已出品不回库，必须归因（赠饮/报损）

---

## 10. 风险与应对
- **单位换算不一致导致扣减错误** → 上线前做“重点SKU换算对照表 + 自动化校验”
- **出品确认遗漏导致占用长期锁死** → 增加超时提醒/自动释放策略（仅对未支付/未出品订单）
- **员工绕过流程** → 赠饮/报损/盘点强制原因；审批阈值；日报表追踪异常

---

## 11. 验收清单（MVP Gate）
1) 完成1个门店的：主数据、换算、10个配方成品、5个套餐  
2) POS下单→预占→出品→扣减 全链路可跑通  
3) 取消/退单（未出品）能释放占用  
4) 已出品退单能生成赠饮/报损单并可审批  
5) 领用（主仓→吧台库）可追溯  
6) 盘点→差异→审批→库存修正可追溯  
7) 标准成本与毛利报表可出数（按天/门店/商品）

---

# 二、敏捷拆分：Epic & 用户故事卡片（MVP Backlog）

> 说明：优先级 P0=必须，P1=重要可延后；SP为粗略估算（可按你团队习惯调整）

## Epic E1：主数据 & 单位换算
### US-001 创建SKU主档（原料/包材/成品/套餐）
- **作为** 系统管理员  
- **我希望** 创建并维护不同类型SKU及其基础属性  
- **以便** 支撑BOM、库存、售卖与报表  
- **优先级** P0｜**估算** 5 SP  
- **验收标准**
  - Given 我在商品管理中创建SKU  
  - When 选择SKU类型并填写必填字段  
  - Then SKU可保存、可启用/停用、可配置门店范围

### US-002 维护单位与换算关系
- **作为** 系统管理员  
- **我希望** 维护单位与换算（瓶↔ml↔杯、g↔份）  
- **以便** BOM扣减与盘点一致  
- **优先级** P0｜**估算** 5 SP  
- **验收标准**
  - 支持创建单位、创建换算链
  - 缺换算时BOM保存/订单确认会被阻止并提示原因

---

## Epic E2：配方BOM与版本生效
### US-003 创建配方BOM（含包材）
- **作为** 运营/管理员  
- **我希望** 为成品SKU配置子项清单（原料+包材）与用量  
- **以便** 出品时自动计算消耗  
- **优先级** P0｜**估算** 8 SP  
- **依赖** US-001, US-002  
- **验收标准**
  - 支持添加/删除子项、设置用量与单位、设置损耗
  - 系统校验：用量>0、单位换算存在、子项可用
  - 支持“消耗预览”：输入成品数量→输出子项消耗汇总

### US-004 BOM版本与门店/渠道生效
- **作为** 系统管理员  
- **我希望** 同一成品存在多个BOM版本并按范围/日期生效  
- **以便** 不同门店/渠道可使用不同配方  
- **优先级** P0｜**估算** 8 SP  
- **依赖** US-003  
- **验收标准**
  - 同范围同时间只允许一个生效版本
  - 订单生成时固化BOM快照（至少固化子项清单与用量）

---

## Epic E3：售卖预占 & 出品扣减
### US-005 订单确认触发库存预占（按BOM展开）
- **作为** 收银员/小程序系统  
- **我希望** 订单确认后系统按BOM计算并预占吧台库库存  
- **以便** 防止超卖并保障出品  
- **优先级** P0｜**估算** 13 SP  
- **依赖** US-001~US-004  
- **验收标准**
  - Given 订单包含成品/套餐  
  - When 订单确认  
  - Then 系统按BOM/套餐规则展开预占明细（SKU、数量、库位）
  - If 库存不足 Then 阻止确认并提示缺料清单

### US-006 出品确认：占用转扣减并生成出品记录
- **作为** 吧台员工  
- **我希望** 点击“出品确认”后系统将预占转为实际扣减  
- **以便** 库存与出品一致  
- **优先级** P0｜**估算** 8 SP  
- **依赖** US-005  
- **验收标准**
  - 出品确认后：库存总量减少、占用减少、生成出品记录
  - 幂等：重复点击不会重复扣减

### US-007 POS快速模式：支付成功自动出品确认（可配置）
- **作为** 店长/运营  
- **我希望** 针对吧台POS配置“支付即出品”  
- **以便** 高峰期减少操作步骤  
- **优先级** P1｜**估算** 5 SP  
- **依赖** US-006  
- **验收标准**
  - 开关启用时：支付完成自动执行出品确认
  - 关闭时：仍需手动出品确认

---

## Epic E4：取消/退单与赠饮报损闭环
### US-008 订单取消/超时释放预占
- **作为** 系统  
- **我希望** 订单取消或超时后自动释放占用  
- **以便** 库存可用量恢复  
- **优先级** P0｜**估算** 5 SP  
- **依赖** US-005  
- **验收标准**
  - 取消立即释放
  - 超时（可配置）自动释放
  - 幂等释放

### US-009 未出品退单：释放占用并记录原因
- **作为** 收银员  
- **我希望** 未出品退单时系统释放占用并记录退单原因  
- **以便** 库存与业务一致  
- **优先级** P0｜**估算** 5 SP  
- **依赖** US-008  
- **验收标准**
  - 未出品状态退单=释放占用，不产生报损/赠饮

### US-010 已出品退单：必须选择赠饮/报损并生成单据
- **作为** 收银员/店长  
- **我希望** 已出品退单必须走赠饮或报损单  
- **以便** 对客诉补偿与损耗进行治理追踪  
- **优先级** P0｜**估算** 8 SP  
- **依赖** US-006  
- **验收标准**
  - 已出品退单时，系统强制选择处理方式与原因
  - 生成赠饮单/报损单并可追溯到订单行与BOM消耗

### US-011 赠饮/报损审批阈值（参数化）
- **作为** 店长  
- **我希望** 赠饮/报损超过阈值需要审批  
- **以便** 控制风险与责任边界  
- **优先级** P1｜**估算** 5 SP  
- **依赖** US-010  
- **验收标准**
  - 低于阈值：自动生效
  - 高于阈值：进入待审批，审批通过后生效

---

## Epic E5：标准成本与毛利
### US-012 维护原料/包材标准成本
- **作为** 财务/运营  
- **我希望** 维护原料/包材的标准成本  
- **以便** 反算成品成本  
- **优先级** P0｜**估算** 3 SP  
- **依赖** US-001  
- **验收标准**
  - SKU可维护标准成本与生效日期（MVP可不做多版本，至少能更新）

### US-013 反算成品标准成本（BOM成本展开）
- **作为** 财务/运营  
- **我希望** 系统根据BOM与标准成本反算成品标准成本  
- **以便** 查看成本结构与调整售价  
- **优先级** P0｜**估算** 5 SP  
- **依赖** US-003, US-012  
- **验收标准**
  - 展示成品成本=子项成本合计×(1+损耗率)
  - 可导出成本明细（父项→子项）

### US-014 订单毛利计算与日报表
- **作为** 店长/运营  
- **我希望** 查看按天/门店/商品的毛利汇总  
- **以便** 经营分析与SKU治理  
- **优先级** P0｜**估算** 8 SP  
- **依赖** US-013, US-006  
- **验收标准**
  - 报表至少包含：销售额、成本、毛利额、毛利率
  - 支持筛选：门店、渠道、日期

---

## Epic E6：主仓→吧台库领用/转仓
### US-015 创建领用/调拨单并完成入库
- **作为** 仓管/店长  
- **我希望** 将主仓库存领用/调拨到吧台库  
- **以便** 吧台库存可售可盘  
- **优先级** P0｜**估算** 8 SP  
- **依赖** US-001  
- **验收标准**
  - 单据流程完成后：主仓减少、吧台库增加
  - 单据可追溯：创建人、时间、SKU、数量

---

## Epic E7：吧台盘点与差异治理
### US-016 吧台盘点录入（支持液体容量）
- **作为** 吧台员工  
- **我希望** 快速录入吧台实盘数量（含液体按容量）  
- **以便** 发现差异并治理  
- **优先级** P0｜**估算** 8 SP  
- **依赖** US-001, US-002  
- **验收标准**
  - 支持按SKU搜索录入
  - 液体类可录入“剩余ml”或“剩余比例（可选）”并折算

### US-017 自动生成差异单并强制原因
- **作为** 系统/店长  
- **我希望** 盘点后自动生成差异单并强制选择原因  
- **以便** 盘亏盘盈可追溯  
- **优先级** P0｜**估算** 5 SP  
- **依赖** US-016  
- **验收标准**
  - 差异单包含：差异数量、原因、附件（可选）、责任人
  - 审批前不调整库存，审批后才生效

### US-018 差异单审批与库存调整
- **作为** 店长  
- **我希望** 审批差异单后系统调整库存  
- **以便** 保证库存可信  
- **优先级** P0｜**估算** 5 SP  
- **依赖** US-017  
- **验收标准**
  - 审批通过：库存调整并记录审计日志
  - 驳回：库存不变，需重新盘点/补充原因

---

## 建议的交付顺序（P0优先）
1) US-001/002（主数据&换算）  
2) US-003/004（BOM&版本生效）  
3) US-015（吧台补货）  
4) US-005/006（预占&出品扣减）  
5) US-008/009/010（取消退单闭环）  
6) US-012/013/014（成本毛利）  
7) US-016/017/018（盘点差异治理）  
8) US-007/011（可配置增强）

---

## 附：字典建议（MVP）
- 报损原因：过期、溢洒、制作失败、破损、操作错误  
- 赠饮原因：客诉补偿、活动赠送、试饮、会员福利  
- 盘亏原因：未登记赠饮、未登记报损、计量误差、盗损、系统操作错误

---

# 三、场景化验证流程

> 以下场景用于验证 BOM MVP 核心功能的端到端可用性

## 场景1：酒吧现调饮品售卖（核心场景）

**业务场景**：顾客在吧台点一杯"威士忌可乐"，吧台员工制作并交付。

### 前置条件
- 已创建原料SKU：威士忌(库存单位:ml)、可乐(库存单位:ml)
- 已创建包材SKU：高脚杯(库存单位:个)、吸管(库存单位:根)
- 已创建成品SKU：威士忌可乐
- 已配置BOM：威士忌可乐 = 威士忌45ml + 可乐150ml + 高脚杯1个 + 吸管1根
- 已配置单位换算：1瓶威士忌=700ml
- 吧台库有库存：威士忌1400ml(2瓶)、可乐3000ml、高脚杯50个、吸管100根

### 验证步骤

| 步骤 | 操作 | 预期结果 | 验证点 |
|-----|------|---------|-------|
| 1 | POS下单：威士忌可乐 x 1 | 订单创建成功 | 订单号生成 |
| 2 | 订单确认 | 库存预占成功 | 可用库存减少：威士忌-45ml、可乐-150ml、杯-1、管-1 |
| 3 | 查看库存状态 | 显示"总量/可用/已占用" | 威士忌：1400/1355/45 |
| 4 | 吧台出品确认 | 实际扣减完成 | 库存总量减少，占用清零 |
| 5 | 查看出品记录 | 记录完整 | 包含订单号、SKU明细、时间 |

### 异常场景
- **库存不足**：预占时提示"威士忌库存不足，请补货"
- **出品前取消**：释放预占，库存恢复

---

## 场景2：已出品退单 → 赠饮单

**业务场景**：顾客反映饮品口味不对，要求退单，店员已制作完成。

### 验证步骤

| 步骤 | 操作 | 预期结果 | 验证点 |
|-----|------|---------|-------|
| 1 | 选择已出品订单，点击"退单" | 弹出处理方式选择 | 不允许直接取消 |
| 2 | 选择"客诉补偿 - 赠饮" | 选择原因：口味问题 | 原因必选 |
| 3 | 提交退单申请 | 生成赠饮单 | 赠饮单号生成 |
| 4 | 店长审批（如超阈值） | 审批通过 | 记录审批人和时间 |
| 5 | 查看库存 | 库存不变 | 已消耗不回滚 |
| 6 | 查看赠饮报表 | 记录可追溯 | 关联订单号、BOM消耗明细 |

---

## 场景3：主仓领用 → 吧台库

**业务场景**：吧台威士忌库存告警，需从主仓领用补货。

### 验证步骤

| 步骤 | 操作 | 预期结果 | 验证点 |
|-----|------|---------|-------|
| 1 | 仓管创建领用单 | 选择：威士忌 x 3瓶 | 单据状态=草稿 |
| 2 | 提交领用单 | 状态变更为"待出库" | 主仓库存预扣 |
| 3 | 仓管确认出库 | 状态变更为"在途" | 主仓库存实际减少 |
| 4 | 吧台确认入库 | 状态变更为"已完成" | 吧台库存增加2100ml(3×700ml) |
| 5 | 查看单据 | 全流程可追溯 | 包含创建人、出库人、入库人、时间 |

---

## 场景4：吧台盘点 → 差异调整

**业务场景**：月末盘点，发现威士忌实际库存与系统不符。

### 验证步骤

| 步骤 | 操作 | 预期结果 | 验证点 |
|-----|------|---------|-------|
| 1 | 创建盘点单 | 选择盘点范围：吧台库-酒水类 | 生成盘点任务 |
| 2 | 录入实盘数量 | 系统库存1400ml，实盘1200ml | 自动计算差异-200ml |
| 3 | 选择差异原因 | 选择"计量误差+溢洒" | 原因必选 |
| 4 | 提交盘点单 | 生成差异单，待审批 | 库存暂不变动 |
| 5 | 店长审批 | 审批通过 | 记录审批意见 |
| 6 | 系统调整库存 | 库存变为1200ml | 生成库存变动日志 |
| 7 | 查看差异报表 | 本月盘亏汇总 | 按原因/SKU统计 |

---

## 场景5：套餐售卖（组合SKU）

**业务场景**：顾客购买"观影套餐"，包含爆米花+可乐+电影票权益。

### 前置条件
- 已创建成品SKU：中杯可乐、大桶爆米花
- 已创建套餐SKU：观影套餐 = 中杯可乐 x 1 + 大桶爆米花 x 1
- 各成品已配置BOM

### 验证步骤

| 步骤 | 操作 | 预期结果 | 验证点 |
|-----|------|---------|-------|
| 1 | POS下单：观影套餐 x 1 | 订单创建成功 | 包含2个子项 |
| 2 | 订单确认 | 按套餐展开预占 | 同时预占可乐原料+爆米花原料+包材 |
| 3 | 分别出品确认 | 子项分别扣减 | 支持分次出品 |
| 4 | 查看订单成本 | 成本=子项BOM成本之和 | 毛利计算正确 |

---

## 场景6：成本与毛利计算

**业务场景**：财务查看"威士忌可乐"的成本结构和日销毛利。

### 验证步骤

| 步骤 | 操作 | 预期结果 | 验证点 |
|-----|------|---------|-------|
| 1 | 维护原料标准成本 | 威士忌=0.5元/ml，可乐=0.01元/ml | 成本生效日期 |
| 2 | 维护包材标准成本 | 高脚杯=2元/个，吸管=0.1元/根 | 成本可更新 |
| 3 | 查看成品成本明细 | 系统反算总成本 | 45×0.5+150×0.01+2+0.1=26.1元 |
| 4 | 设置成品售价 | 威士忌可乐=48元 | 售价≠成本 |
| 5 | 查看日毛利报表 | 日销10杯=毛利(48-26.1)×10=219元 | 毛利率=45.6% |
| 6 | 按门店筛选 | 不同门店毛利对比 | 支持维度分析 |

