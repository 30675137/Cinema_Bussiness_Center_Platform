# 影院 SaaS 业务中台微服务架构拆分方案

> 文档版本：v1.0  
> 创建日期：2026-01-13  
> 文档状态：草案

---

## 1. 现有系统能力分析

### 1.1 后端模块现状

当前系统采用单体架构，后端包含以下业务模块：

```
backend/src/main/java/com/cinema/
├── auth/                    # 认证（基础）
├── beverage/                # 饮品业务
├── bom/                     # BOM/配方管理
├── category/                # 分类管理
├── channelproduct/          # 渠道商品
├── common/                  # 公共组件
├── config/                  # 配置
├── hallstore/               # 门店/影厅
├── inventory/               # 库存管理
├── material/                # 物料管理
├── order/                   # 订单管理
├── procurement/             # 采购管理
├── product/                 # 商品管理
├── reservation/             # 预约管理
├── scenariopackage/         # 场景包
├── security/                # 安全
├── sku/                     # SKU 管理
├── unit/                    # 计量单位
└── unitconversion/          # 单位换算
```

### 1.2 数据库表分布（共 61 张表）

| 领域 | 核心表 | 数量 |
|------|--------|:----:|
| 基础配置 | stores, suppliers, units, categories, brands | ~10 |
| 商品主数据 | spus, skus, materials, bom_* | ~15 |
| 库存管理 | store_inventory, inventory_adjustments, inventory_movements | ~8 |
| 采购供应链 | purchase_orders, goods_receipts | ~6 |
| 订单履约 | orders, order_items, reservation_orders | ~8 |
| 场景资源 | scenario_packages, halls, hall_reservations | ~8 |
| 渠道商品 | channel_products, menu_categories | ~6 |

### 1.3 功能完成度评估

| 模块 | 完成度 | 备注 |
|------|:------:|------|
| 商品管理 (MDM/PIM) | 77% | SKU 价格体系待完善 |
| BOM/配方管理 | 53% | 版本管理、成本核算待开发 |
| 库存管理 | 21% | ⚠️ 预占、调拨、盘点待开发 |
| 场景包管理 | 84% | 基本完成 |
| 采购供应链 | 31% | 审批、计划待开发 |
| 订单履约 | 31% | ⚠️ 支付、出品待开发 |
| 门店资源管理 | 58% | 基本可用 |
| 运营报表 | 0% | ⚠️ 完全缺失 |

---

## 2. 微服务拆分原则

### 2.1 拆分依据

| 原则 | 说明 |
|------|------|
| **业务边界** | 按 DDD 限界上下文划分 |
| **数据自治** | 每个服务拥有自己的数据库/Schema |
| **团队对齐** | 一个服务对应一个小团队 |
| **独立部署** | 服务可独立发布，互不影响 |
| **故障隔离** | 单个服务故障不影响整体 |
| **技术异构** | 允许不同服务使用最适合的技术栈 |

### 2.2 通信机制

| 场景 | 方式 | 说明 |
|------|------|------|
| 同步查询 | REST / gRPC | 实时数据查询 |
| 异步命令 | 消息队列 (Kafka/RabbitMQ) | 跨服务业务流程 |
| 事件驱动 | 领域事件 | 松耦合业务协作 |
| 数据同步 | CDC / 定时任务 | 数据一致性保障 |

---

## 3. 微服务架构设计

### 3.1 服务全景图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              接入层 (API Gateway)                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  B端 Web    │  │  C端小程序  │  │  开放 API   │  │  第三方集成 │        │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘        │
└─────────┼────────────────┼────────────────┼────────────────┼────────────────┘
          │                │                │                │
          ▼                ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         API Gateway (Kong / APISIX)                          │
│              路由、限流、熔断、认证、日志、监控                              │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              业务服务层                                      │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        核心平台服务                                  │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │   🔐 IAM    │  │  📋 租户   │  │  ⚙️ 配置   │                  │   │
│  │  │  身份认证   │  │  租户管理   │  │  配置中心   │                  │   │
│  │  │  Keycloak  │  │  服务      │  │  服务      │                  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        主数据域服务                                  │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │  📦 商品   │  │  🏭 物料   │  │  🏪 门店   │                  │   │
│  │  │  商品中心   │  │  BOM中心   │  │  资源中心   │                  │   │
│  │  │  (MDM)     │  │  (MOM)     │  │  (Store)   │                  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        交易域服务                                    │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │  📝 订单   │  │  📦 库存   │  │  🛒 采购   │  │ 🎬 预约   │  │   │
│  │  │  订单中心   │  │  库存中心   │  │  供应链    │  │ 预约中心  │  │   │
│  │  │  (OMS)     │  │  (IMS)     │  │  (SCM)     │  │ (RMS)    │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        渠道与营销域服务                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │  📱 渠道   │  │  👤 会员   │  │  🎁 营销   │  │ 💰 结算   │  │   │
│  │  │  渠道商品   │  │  会员中心   │  │  营销中心   │  │ 结算中心  │  │   │
│  │  │  (Channel) │  │  (Member)  │  │  (MKT)     │  │ (Finance) │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        支撑域服务                                    │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │  📊 报表   │  │  📨 消息   │  │  🔍 搜索   │                  │   │
│  │  │  数据分析   │  │  消息通知   │  │  搜索服务   │                  │   │
│  │  │  (BI)      │  │  (MSG)     │  │  (Search)  │                  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据层                                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │
│  │PostgreSQL│  │  Redis   │  │  Kafka   │  │   OSS    │  │   ES     │     │
│  │ Supabase │  │  缓存    │  │  消息队列│  │  文件存储│  │  搜索    │     │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘     │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 微服务详细设计

### 4.1 核心平台服务

#### 4.1.1 🔐 IAM 身份认证服务

| 属性 | 描述 |
|------|------|
| **服务名** | `cinema-iam-service` |
| **职责** | 统一身份认证、授权、SSO |
| **技术选型** | Keycloak + Spring Security |
| **数据** | 用户、角色、权限、会话 |

**核心能力：**
- 多租户身份管理 (Organizations)
- 多 IdP 支持 (飞书/钉钉/企微)
- OAuth 2.0 / OIDC 协议
- RBAC / ABAC 权限模型
- 单点登录 / 单点登出
- Token 管理与刷新

**对外接口：**
```yaml
APIs:
  - POST /auth/login                    # 登录
  - POST /auth/logout                   # 登出
  - GET  /auth/userinfo                 # 当前用户信息
  - POST /auth/token/refresh            # Token 刷新
  - GET  /auth/permissions              # 获取权限列表

Events (发布):
  - UserCreated
  - UserLoggedIn
  - UserLoggedOut
  - RoleAssigned
```

---

#### 4.1.2 📋 租户管理服务

| 属性 | 描述 |
|------|------|
| **服务名** | `cinema-tenant-service` |
| **职责** | 租户生命周期、配置、隔离 |
| **技术选型** | Spring Boot |
| **数据** | tenants, tenant_domains, tenant_configs |

**核心能力：**
- 租户入驻/暂停/终止
- 租户域名管理
- 租户配置管理
- 租户资源配额
- 租户数据隔离策略

**对外接口：**
```yaml
APIs:
  - POST /tenants                       # 创建租户
  - GET  /tenants/{id}                  # 租户详情
  - PUT  /tenants/{id}/config           # 更新配置
  - POST /tenants/{id}/suspend          # 暂停租户
  - GET  /tenants/by-domain/{domain}    # 域名查租户

Events (发布):
  - TenantCreated
  - TenantSuspended
  - TenantConfigUpdated
```

---

### 4.2 主数据域服务

#### 4.2.1 📦 商品中心 (MDM)

| 属性 | 描述 |
|------|------|
| **服务名** | `cinema-product-service` |
| **职责** | SPU/SKU、分类、品牌、属性 |
| **当前模块** | product, sku, category, 部分 channelproduct |
| **数据** | spus, skus, categories, brands, attributes |

**核心能力：**
- SPU/SKU 主数据 CRUD
- 分类树管理（三级）
- 品牌管理
- 属性字典管理
- 商品上下架状态
- 商品内容管理

**领域模型：**
```
商品聚合根
├── SPU (标准产品单元)
│   ├── 基础信息 (名称、描述、图片)
│   ├── 分类归属
│   ├── 品牌归属
│   └── SKU 列表
├── SKU (最小库存单元)
│   ├── 规格属性
│   ├── 价格信息
│   ├── 条码
│   └── 状态
├── Category (分类)
└── Brand (品牌)
```

**对外接口：**
```yaml
APIs:
  - GET  /products/spus                 # SPU 列表
  - POST /products/spus                 # 创建 SPU
  - GET  /products/skus/{id}            # SKU 详情
  - GET  /products/categories/tree      # 分类树
  - GET  /products/brands               # 品牌列表

Events (发布):
  - ProductCreated
  - ProductUpdated
  - ProductStatusChanged
  - SkuPriceChanged
```

---

#### 4.2.2 🏭 BOM/物料中心 (MOM)

| 属性 | 描述 |
|------|------|
| **服务名** | `cinema-bom-service` |
| **职责** | 物料、BOM/配方、成本核算 |
| **当前模块** | material, bom, unitconversion |
| **数据** | materials, bom_headers, bom_items, unit_conversions |

**核心能力：**
- 物料主数据管理
- BOM/配方配置
- 单位换算规则
- 配方版本管理
- 成本预估与核算
- 损耗率配置

**领域模型：**
```
BOM 聚合根
├── Material (物料)
│   ├── 采购单位
│   ├── 库存单位
│   ├── 成本信息
│   └── 供应商关联
├── BOM Header (配方头)
│   ├── 关联 SKU
│   ├── 版本号
│   └── 生效状态
└── BOM Item (配方明细)
    ├── 物料
    ├── 用量
    └── 损耗率
```

---

#### 4.2.3 🏪 门店资源中心 (Store)

| 属性 | 描述 |
|------|------|
| **服务名** | `cinema-store-service` |
| **职责** | 门店、影厅、场景包、排期 |
| **当前模块** | hallstore, scenariopackage, reservation |
| **数据** | stores, halls, scenario_packages, hall_reservations |

**核心能力：**
- 门店 CRUD
- 影厅资源管理
- 场景包/套餐配置
- 排期管理
- 资源冲突校验
- 预约设置

**领域模型：**
```
门店聚合根
├── Store (门店)
│   ├── 基础信息
│   ├── 营业时间
│   ├── 预约配置
│   └── 影厅列表
├── Hall (影厅)
│   ├── 座位数
│   ├── 设备信息
│   └── 可用状态
├── ScenarioPackage (场景包)
│   ├── 内容组合
│   ├── 定价策略
│   └── 适用资源
└── HallReservation (影厅预约)
```

---

### 4.3 交易域服务

#### 4.3.1 📝 订单中心 (OMS)

| 属性 | 描述 |
|------|------|
| **服务名** | `cinema-order-service` |
| **职责** | 订单生命周期、履约、核销 |
| **当前模块** | order, beverage |
| **数据** | orders, order_items, verification_codes |

**核心能力：**
- 订单创建与校验
- 订单状态机管理
- 支付对接
- 履约调度
- 核销码生成与验证
- 退款/改期处理
- 异常订单处理

**领域模型：**
```
订单聚合根
├── Order (订单)
│   ├── 订单号
│   ├── 租户/门店
│   ├── 用户信息
│   ├── 订单状态
│   ├── 支付状态
│   └── 订单明细列表
├── OrderItem (订单明细)
│   ├── SKU/场景包
│   ├── 数量/价格
│   └── 状态
├── Payment (支付记录)
└── Fulfillment (履约记录)
```

**对外接口：**
```yaml
APIs:
  - POST /orders                        # 创建订单
  - GET  /orders/{id}                   # 订单详情
  - POST /orders/{id}/pay               # 发起支付
  - POST /orders/{id}/verify            # 核销
  - POST /orders/{id}/cancel            # 取消
  - POST /orders/{id}/refund            # 退款

Events (发布):
  - OrderCreated
  - OrderPaid
  - OrderVerified
  - OrderCancelled
  - OrderRefunded

Events (消费):
  - InventoryReserved (库存服务)
  - PaymentCompleted (支付服务)
```

---

#### 4.3.2 📦 库存中心 (IMS)

| 属性 | 描述 |
|------|------|
| **服务名** | `cinema-inventory-service` |
| **职责** | 库存台账、预占/释放、调拨、盘点 |
| **当前模块** | inventory |
| **数据** | store_inventory, inventory_movements, inventory_adjustments |

**核心能力：**
- 库存台账查询
- 库存预占与释放
- 入库/出库操作
- 调拨管理
- 盘点管理
- 安全库存预警
- 库存变动审计

**领域模型：**
```
库存聚合根
├── Inventory (库存台账)
│   ├── 现存数量 (on_hand_qty)
│   ├── 可用数量 (available_qty)
│   ├── 预占数量 (reserved_qty)
│   └── 安全库存 (safety_stock)
├── InventoryMovement (库存变动)
│   ├── 变动类型
│   ├── 变动数量
│   └── 关联单据
├── InventoryReservation (库存预占)
└── StockTransfer (调拨单)
```

**对外接口：**
```yaml
APIs:
  - GET  /inventory                     # 库存台账
  - POST /inventory/reserve             # 预占库存
  - POST /inventory/release             # 释放库存
  - POST /inventory/adjust              # 库存调整
  - GET  /inventory/movements           # 变动流水

Events (发布):
  - InventoryReserved
  - InventoryReleased
  - InventoryAdjusted
  - LowStockAlert

Events (消费):
  - OrderCreated → 预占库存
  - OrderCancelled → 释放库存
  - GoodsReceived → 入库
```

---

#### 4.3.3 🛒 供应链服务 (SCM)

| 属性 | 描述 |
|------|------|
| **服务名** | `cinema-scm-service` |
| **职责** | 供应商、采购、收货入库 |
| **当前模块** | procurement |
| **数据** | suppliers, purchase_orders, goods_receipts |

**核心能力：**
- 供应商管理
- 采购订单管理
- 采购审批流
- 收货验收
- 入库确认
- 采购计划（待开发）

---

#### 4.3.4 🎬 预约中心 (RMS)

| 属性 | 描述 |
|------|------|
| **服务名** | `cinema-reservation-service` |
| **职责** | 预约单管理、档期管理 |
| **当前模块** | reservation |
| **数据** | reservation_orders, hall_reservations |

**核心能力：**
- 预约单创建
- 预约单审核
- 预约单确认/取消
- 档期查询与占用
- 冲突校验

---

### 4.4 渠道与营销域服务

#### 4.4.1 📱 渠道商品服务 (Channel)

| 属性 | 描述 |
|------|------|
| **服务名** | `cinema-channel-service` |
| **职责** | 渠道商品配置、菜单管理 |
| **当前模块** | channelproduct |
| **数据** | channel_products, menu_categories |

**核心能力：**
- 小程序商品配置
- 菜单分类管理
- 商品上下架
- 渠道价格配置
- 商品展示排序

---

#### 4.4.2 👤 会员中心 (Member) - 待建设

| 属性 | 描述 |
|------|------|
| **服务名** | `cinema-member-service` |
| **职责** | 会员体系、积分、等级 |
| **状态** | 🔮 **规划中** |

**规划能力：**
- 会员注册/登录
- 会员等级体系
- 积分账户管理
- 积分规则配置
- 会员标签/画像
- 会员权益配置

**领域模型：**
```
会员聚合根
├── Member (会员)
│   ├── 基础信息
│   ├── 等级信息
│   ├── 积分账户
│   └── 标签列表
├── MemberLevel (等级)
│   ├── 等级规则
│   └── 权益配置
├── PointAccount (积分账户)
│   ├── 可用积分
│   ├── 冻结积分
│   └── 过期积分
└── PointTransaction (积分流水)
```

---

#### 4.4.3 🎁 营销中心 (Marketing) - 待建设

| 属性 | 描述 |
|------|------|
| **服务名** | `cinema-marketing-service` |
| **职责** | 优惠券、促销、活动 |
| **状态** | 🔮 **规划中** |

**规划能力：**
- 优惠券管理
  - 满减券、折扣券、代金券
  - 发放规则、核销规则
- 促销活动
  - 限时折扣
  - 满减活动
  - 组合优惠
- 营销工具
  - 秒杀
  - 拼团
  - 分销

**领域模型：**
```
营销聚合根
├── Coupon (优惠券)
│   ├── 券模板
│   ├── 券批次
│   ├── 用户券实例
│   └── 核销规则
├── Promotion (促销活动)
│   ├── 活动规则
│   ├── 适用范围
│   └── 活动时间
└── Campaign (营销活动)
    ├── 秒杀活动
    ├── 拼团活动
    └── 分销活动
```

---

#### 4.4.4 💰 结算中心 (Finance) - 待建设

| 属性 | 描述 |
|------|------|
| **服务名** | `cinema-finance-service` |
| **职责** | 支付、结算、对账 |
| **状态** | 🔮 **规划中** |

**规划能力：**
- 支付渠道对接（微信/支付宝）
- 支付单管理
- 退款管理
- 租户结算
- 财务对账

---

### 4.5 支撑域服务

#### 4.5.1 📊 数据分析服务 (BI)

| 属性 | 描述 |
|------|------|
| **服务名** | `cinema-bi-service` |
| **职责** | 报表、看板、数据分析 |
| **状态** | 🔮 **规划中** |

**规划能力：**
- 销售报表
- 库存报表
- 运营看板
- 数据导出

---

#### 4.5.2 📨 消息通知服务 (Message)

| 属性 | 描述 |
|------|------|
| **服务名** | `cinema-message-service` |
| **职责** | 消息推送、通知、告警 |

**核心能力：**
- 短信通知
- 微信模板消息
- 邮件通知
- 站内消息
- 告警通知

---

## 5. 服务拆分优先级

### 5.1 拆分阶段规划

```
Phase 1: 平台基础 (8周)
├── 🔐 IAM 身份认证服务 (Keycloak)
├── 📋 租户管理服务
└── ⚙️ 配置中心服务

Phase 2: 核心交易 (10周)
├── 📦 商品中心服务
├── 📦 库存中心服务
└── 📝 订单中心服务

Phase 3: 主数据完善 (6周)
├── 🏭 BOM/物料中心
├── 🏪 门店资源中心
└── 🛒 供应链服务

Phase 4: 营销会员 (8周)
├── 👤 会员中心
├── 🎁 营销中心
└── 💰 结算中心

Phase 5: 支撑服务 (4周)
├── 📊 数据分析服务
├── 📨 消息通知服务
└── 🔍 搜索服务
```

### 5.2 服务优先级矩阵

| 服务 | 业务价值 | 技术复杂度 | 依赖程度 | 优先级 |
|------|:--------:|:----------:|:--------:|:------:|
| IAM 身份认证 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | 🔼 被依赖 | P0 |
| 租户管理 | ⭐⭐⭐⭐⭐ | ⭐⭐ | 🔼 被依赖 | P0 |
| 商品中心 | ⭐⭐⭐⭐ | ⭐⭐⭐ | 🔽 依赖少 | P1 |
| 库存中心 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ➡️ 中等 | P1 |
| 订单中心 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ➡️ 中等 | P1 |
| 门店资源 | ⭐⭐⭐⭐ | ⭐⭐⭐ | 🔽 依赖少 | P2 |
| 供应链 | ⭐⭐⭐ | ⭐⭐⭐ | 🔽 依赖少 | P2 |
| 会员中心 | ⭐⭐⭐⭐ | ⭐⭐⭐ | ➡️ 中等 | P3 |
| 营销中心 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ➡️ 中等 | P3 |
| 结算中心 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ➡️ 中等 | P3 |

---

## 6. 服务依赖关系

### 6.1 服务依赖拓扑

```
                    ┌─────────────┐
                    │   IAM       │
                    │ (身份认证)  │
                    └──────┬──────┘
                           │ 被所有服务依赖
           ┌───────────────┼───────────────┐
           ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │   租户      │ │   配置中心  │ │   消息      │
    │   管理      │ │             │ │   服务      │
    └──────┬──────┘ └─────────────┘ └─────────────┘
           │
     ┌─────┴─────┐
     ▼           ▼
┌─────────┐ ┌─────────┐
│  商品   │ │  门店   │
│  中心   │ │  资源   │
└────┬────┘ └────┬────┘
     │           │
     │     ┌─────┴─────┐
     │     ▼           ▼
     │ ┌─────────┐ ┌─────────┐
     │ │  BOM    │ │  预约   │
     │ │  中心   │ │  中心   │
     │ └────┬────┘ └─────────┘
     │      │
     ▼      ▼
┌─────────────────┐
│   库存中心      │
│                 │
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌─────────┐ ┌─────────┐
│  供应链 │ │  订单   │◀─────┐
│  服务   │ │  中心   │      │
└─────────┘ └────┬────┘      │
                 │           │
           ┌─────┴─────┐     │
           ▼           ▼     │
      ┌─────────┐ ┌─────────┐│
      │  会员   │ │  结算   ││
      │  中心   │ │  中心   │┘
      └────┬────┘ └─────────┘
           │
           ▼
      ┌─────────┐
      │  营销   │
      │  中心   │
      └─────────┘
```

### 6.2 核心事件流

```yaml
# 订单创建流程
1. OrderCreated (订单中心)
   ├── → 库存中心: 预占库存
   ├── → 会员中心: 查询会员权益
   └── → 营销中心: 计算优惠

2. PaymentCompleted (结算中心)
   └── → 订单中心: 更新订单支付状态

3. OrderPaid (订单中心)
   ├── → 库存中心: 确认扣减
   ├── → 会员中心: 累加积分
   └── → 消息服务: 发送通知

4. OrderCancelled (订单中心)
   ├── → 库存中心: 释放库存
   ├── → 结算中心: 触发退款
   └── → 营销中心: 回退优惠券
```

---

## 7. 技术架构建议

### 7.1 技术选型建议

| 组件 | 推荐选型 | 备选方案 |
|------|----------|----------|
| 注册中心 | Nacos | Consul, Eureka |
| 配置中心 | Nacos | Spring Cloud Config |
| API 网关 | APISIX | Kong, Spring Cloud Gateway |
| 服务通信 | Feign + gRPC | Dubbo |
| 消息队列 | RabbitMQ | Kafka, RocketMQ |
| 分布式缓存 | Redis Cluster | - |
| 分布式事务 | Seata | 本地消息表 |
| 链路追踪 | SkyWalking | Zipkin, Jaeger |
| 日志聚合 | ELK | Loki + Grafana |
| 监控告警 | Prometheus + Grafana | - |

### 7.2 部署架构

```yaml
Kubernetes 集群:
  Namespace:
    - cinema-platform       # 平台服务
    - cinema-business       # 业务服务
    - cinema-support        # 支撑服务
    - cinema-middleware     # 中间件
    - cinema-monitoring     # 监控

  每个服务:
    - Deployment (至少 2 副本)
    - Service (ClusterIP)
    - HPA (自动扩缩容)
    - ConfigMap / Secret
    - Ingress (对外服务)
```

---

## 8. 数据隔离方案

### 8.1 多租户数据隔离

| 方案 | 说明 | 适用场景 |
|------|------|----------|
| **Schema 隔离** | 每租户独立 Schema | 数据量大，隔离要求高 |
| **表字段隔离** | tenant_id 字段 + RLS | 租户数量多，管理简单 |
| **独立数据库** | 每租户独立 DB | 超大型租户 |

**推荐方案**：表字段隔离 + RLS（现有 Supabase 方案延续）

```sql
-- 所有业务表添加 tenant_id
ALTER TABLE orders ADD COLUMN tenant_id UUID NOT NULL;
ALTER TABLE products ADD COLUMN tenant_id UUID NOT NULL;
-- ...

-- RLS 策略
CREATE POLICY tenant_isolation ON orders
    FOR ALL
    USING (tenant_id = auth.tenant_id());
```

### 8.2 跨服务数据一致性

| 场景 | 方案 |
|------|------|
| 强一致性 | 分布式事务 (Seata TCC) |
| 最终一致性 | 事件驱动 + 补偿机制 |
| 幂等处理 | 业务唯一键 + 状态机 |

---

## 9. 迁移路径

### 9.1 渐进式拆分策略

```
Step 1: 单体内模块化
  └── 在现有单体中按 DDD 重构代码边界

Step 2: 数据库拆分
  └── 按服务边界拆分表，建立数据同步

Step 3: API 拆分
  └── 引入 API 网关，逐步迁移端点

Step 4: 服务独立部署
  └── 一个一个服务独立出来

Step 5: 完全微服务化
  └── 移除单体，完成迁移
```

### 9.2 风险控制

| 风险 | 缓解措施 |
|------|----------|
| 数据不一致 | 双写 + 数据校验 + 回滚方案 |
| 性能下降 | 压测 + 熔断 + 降级 |
| 服务雪崩 | 限流 + 熔断 + 隔离 |
| 部署复杂 | CI/CD 流水线 + 灰度发布 |

---

## 10. 工作量估算

### 10.1 各阶段工作量

| 阶段 | 工作内容 | 预估人天 | 团队配置 |
|------|----------|:--------:|----------|
| Phase 1 | IAM + 租户 + 配置 | 40 | 后端 2 人 |
| Phase 2 | 商品 + 库存 + 订单 | 60 | 后端 3 人 |
| Phase 3 | BOM + 门店 + 供应链 | 36 | 后端 2 人 |
| Phase 4 | 会员 + 营销 + 结算 | 50 | 后端 2 人 |
| Phase 5 | BI + 消息 + 搜索 | 24 | 后端 2 人 |
| **总计** | - | **210** | - |

### 10.2 预计时间线

| 里程碑 | 时间点 | 交付物 |
|--------|--------|--------|
| M1 | +8 周 | IAM 上线，多租户 SSO 可用 |
| M2 | +18 周 | 核心交易服务独立，订单流程打通 |
| M3 | +24 周 | 主数据服务完善 |
| M4 | +32 周 | 营销会员体系上线 |
| M5 | +36 周 | 全部微服务化完成 |

---

## 变更记录

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| v1.0 | 2026-01-13 | - | 初始版本 |
