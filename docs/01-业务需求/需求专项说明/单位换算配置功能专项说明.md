# 单位换算配置功能专项说明

> **文档版本**: 1.0  
> **创建日期**: 2025-12-25  
> **功能分支**: P002-unit-conversion  
> **状态**: 已实现后端API，前端界面开发中

---

## 1. 功能定义

### 1.1 核心功能

单位换算配置功能是 BOM（物料清单/配方）系统的基础支撑模块，提供标准化的单位转换能力，支持以下核心能力：

| 功能 | 描述 | 示例 |
|------|------|------|
| **基础换算关系配置** | 定义两个单位之间的换算比例 | 1瓶 = 750ml |
| **换算链支持** | 通过多个换算规则实现间接换算 | 瓶→ml→L（通过 1瓶=750ml, 1L=1000ml 推导） |
| **双向自动换算** | 定义正向换算后，系统自动支持反向计算 | 定义 1瓶=750ml，自动支持 1ml=1/750瓶 |
| **分类管理** | 按体积(VOLUME)、重量(WEIGHT)、计数(COUNT)分类 | 体积类：ml↔L、重量类：g↔kg |
| **舍入精度控制** | 按单位类型配置默认舍入规则 | 体积类保留1位小数，重量类保留0位小数 |

### 1.2 业务价值

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          单位换算的业务价值                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ✓ 解决库存扣减痛点：库存以"瓶/升"管理，售卖以"杯/份"计量               │
│                                                                         │
│  ✓ 确保成本计算准确：原料成本统一换算到基础单位进行汇总                  │
│                                                                         │
│  ✓ 支撑BOM配方管理：不同单位的组件可以正确参与配方计算                   │
│                                                                         │
│  ✓ 提升盘点效率：液体类可按"剩余容量"折算，避免估算误差                  │
│                                                                         │
│  ✓ 保障经营决策：毛利计算、成本分析的数据准确性                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.3 典型应用场景

#### 场景一：酒吧按杯售酒

| 角色 | 操作 | 系统依赖 |
|------|------|----------|
| 采购 | 入库威士忌2瓶 | 库存记录：2瓶 或 1400ml |
| 收银 | 销售威士忌1杯 | BOM定义：1杯=45ml |
| 系统 | 自动扣减库存 | 单位换算：45ml = 0.0643瓶 |
| 财务 | 计算成本毛利 | 成本换算：45ml × 0.5元/ml = 22.5元 |

#### 场景二：现调饮品配方

| 配方组件 | 配方用量 | 库存单位 | 换算过程 |
|----------|----------|----------|----------|
| 威士忌 | 45ml | 瓶(750ml/瓶) | 45ml ÷ 750 = 0.06瓶 |
| 可乐 | 150ml | ml | 直接扣减150ml |
| 高脚杯 | 1个 | 个 | 直接扣减1个 |
| 吸管 | 1根 | 根 | 直接扣减1根 |

#### 场景三：原料称重领用

| 原料 | 库存单位 | 领用单位 | 换算规则 |
|------|----------|----------|----------|
| 玉米粒 | kg | g | 1kg = 1000g |
| 糖浆 | L | ml | 1L = 1000ml |
| 奶油 | 桶(5L) | ml | 1桶 = 5000ml |

---

## 2. 前置功能依赖

单位换算配置功能需要以下前置条件就绪：

### 2.1 数据库层

| 依赖项 | 说明 | 状态 |
|--------|------|------|
| **V028 迁移脚本** | 创建 `unit_conversions` 表 | ✅ 已完成 |
| **基础换算数据** | 预置 ml↔L, g↔kg 等基础换算 | ✅ 已完成 |
| **唯一约束** | (from_unit, to_unit) 保证规则唯一 | ✅ 已完成 |

### 2.2 主数据准备

| 依赖项 | 说明 | 关联功能 |
|--------|------|----------|
| **基础单位定义** | ml、L、g、kg、个、瓶、杯、份等 | SKU主数据 FR-01 |
| **SKU类型配置** | 原料、包材、成品、套餐四种类型 | SKU管理模块 |
| **SKU库存单位** | 每个SKU需指定库存计量单位 | SKU创建流程 |

### 2.3 依赖关系图

```
                    ┌──────────────────────┐
                    │   基础单位字典        │
                    │ (ml/L/g/kg/个/瓶/杯)  │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │   单位换算配置        │◀─── 当前功能
                    │ (换算规则CRUD管理)    │
                    └──────────┬───────────┘
                               │
            ┌──────────────────┼──────────────────┐
            ▼                  ▼                  ▼
    ┌───────────────┐  ┌───────────────┐  ┌───────────────┐
    │  SKU 主数据   │  │  BOM 配方管理 │  │  库存管理     │
    │ (指定库存单位)│  │ (组件用量换算)│  │ (扣减/盘点)   │
    └───────────────┘  └───────────────┘  └───────────────┘
```

### 2.4 配置前检查清单

在配置单位换算前，请确认以下项目：

- [ ] 确定业务所需的所有单位（售卖单位、库存单位、采购单位）
- [ ] 明确每种原料/包材的基础计量单位（如：威士忌用ml，玉米粒用g）
- [ ] 收集各单位间的标准换算比例（如：1瓶威士忌=700ml 或 750ml）
- [ ] 确定舍入规则要求（如：扣减保留到0.1ml还是1ml）

---

## 3. 后置功能关联

单位换算配置完成后，将支撑以下核心业务流程：

### 3.1 直接支撑的功能

| 功能模块 | 依赖方式 | 应用场景 |
|----------|----------|----------|
| **BOM 配方计算** | 调用换算API计算组件消耗 | 成品BOM定义威士忌45ml，计算扣减0.06瓶 |
| **库存预占扣减** | 按换算后数量锁定库存 | 订单确认时预占原料库存 |
| **成本计算** | 统一换算到基础单位计算成本 | 成品标准成本 = Σ(组件数量×单位成本) |
| **盘点折算** | 液体类按容量折算库存 | 半瓶威士忌=375ml |

### 3.2 成本计算公式

```
成品标准成本 = Σ(组件数量 × 组件单位成本) × (1 + 损耗率%)

其中：
- 组件数量：通过单位换算转换到组件的库存单位
- 组件单位成本：来自组件SKU的 standard_cost 字段
- 损耗率：成品SKU的 waste_rate 字段（默认0%）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

示例 - 威士忌可乐成本计算：
┌─────────────────────────────────────────────────────┐
│ 组件        │ 用量    │ 单位成本    │ 小计      │
├─────────────────────────────────────────────────────┤
│ 威士忌      │ 45ml    │ 0.50元/ml   │ 22.50元   │
│ 可乐        │ 150ml   │ 0.02元/ml   │ 3.00元    │
│ 高脚杯      │ 1个     │ 2.00元/个   │ 2.00元    │
│ 吸管        │ 1根     │ 0.10元/根   │ 0.10元    │
├─────────────────────────────────────────────────────┤
│ 组件成本合计                         │ 27.60元   │
│ 损耗率 5%                            │ × 1.05    │
│ 标准成本                             │ 28.98元   │
└─────────────────────────────────────────────────────┘
```

### 3.3 库存扣减流程

```
┌──────────────────────────────────────────────────────────────────┐
│                        库存扣减流程                               │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. 订单确认                                                     │
│     └─→ 获取成品BOM组件清单                                      │
│                                                                  │
│  2. BOM展开                                                      │
│     └─→ 遍历每个组件，获取用量和单位                             │
│                                                                  │
│  3. 单位换算  ◀─────────────────────────────── 当前功能          │
│     └─→ 将BOM用量换算到库存单位                                  │
│     └─→ 例：BOM定义1杯(150ml) → 库存单位ml → 扣减150ml          │
│                                                                  │
│  4. 库存预占                                                     │
│     └─→ 锁定换算后的库存数量                                     │
│     └─→ 可用库存 = 现存 - 预占                                   │
│                                                                  │
│  5. 出品确认                                                     │
│     └─→ 预占转实际扣减，库存总量减少                             │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 4. 相关功能模块

### 4.1 功能模块交互图

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│                        ┌─────────────────┐                          │
│                        │   单位换算配置   │                          │
│                        │ /bom/conversion │                          │
│                        └────────┬────────┘                          │
│                                 │                                   │
│         ┌───────────────────────┼───────────────────────┐           │
│         │                       │                       │           │
│         ▼                       ▼                       ▼           │
│  ┌─────────────┐        ┌─────────────┐        ┌─────────────┐      │
│  │ SKU管理     │        │ BOM配方管理 │        │ 库存管理    │      │
│  │/products/sku│        │ /bom/recipe │        │ /inventory  │      │
│  └─────────────┘        └─────────────┘        └─────────────┘      │
│         │                       │                       │           │
│         │                       ▼                       │           │
│         │               ┌─────────────┐                 │           │
│         │               │ 成本/毛利    │                 │           │
│         │               │ /bom/cost   │                 │           │
│         │               └─────────────┘                 │           │
│         │                       │                       │           │
│         └───────────────────────┼───────────────────────┘           │
│                                 ▼                                   │
│                        ┌─────────────────┐                          │
│                        │   订单/出品系统  │                          │
│                        │ (POS/小程序)    │                          │
│                        └─────────────────┘                          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 模块详细说明

| 模块 | 路径 | 交互方式 | 说明 |
|------|------|----------|------|
| **SKU主数据管理** | `/products/sku` | 读取 | SKU定义库存单位，换算时作为目标单位 |
| **SPU商品管理** | `/products/spu` | 读取 | SPU定义产品类型，影响SKU的换算需求 |
| **BOM配方管理** | `/bom/recipe` | 调用 | 配方组件用量换算到库存单位 |
| **BOM版本管理** | `/bom/version` | 关联 | 版本生效时校验换算规则完整性 |
| **成本毛利预估** | `/bom/cost` | 调用 | 成本计算时统一换算到基础单位 |
| **库存台账** | `/inventory/ledger` | 调用 | 显示换算后的可用库存 |
| **库存预占管理** | `/inventory/reservation` | 调用 | 预占时按换算后数量锁定 |
| **盘点管理** | `/inventory/stocktaking` | 调用 | 液体类按容量折算录入 |
| **调拨管理** | `/inventory/transfer` | 调用 | 跨库位调拨时的单位换算 |

### 4.3 API 接口

| 端点 | 方法 | 说明 | 使用方 |
|------|------|------|--------|
| `/api/unit-conversions` | GET | 获取所有换算规则 | 前端列表页、BOM服务 |
| `/api/unit-conversions` | POST | 创建换算规则 | 前端配置页 |
| `/api/unit-conversions/{id}` | GET | 获取单条规则 | 前端编辑页 |
| `/api/unit-conversions/{id}` | PUT | 更新换算规则 | 前端编辑页 |
| `/api/unit-conversions/{id}` | DELETE | 删除换算规则 | 前端配置页 |
| `/api/unit-conversions/stats` | GET | 获取统计信息 | 前端概览卡片 |
| `/api/unit-conversions/calculate` | POST | 执行单位换算计算 | BOM服务、库存服务 |

---

## 5. 最佳实践方法

### 5.1 换算规则配置原则

#### 原则一：以基础计量单位为核心

```
推荐做法：
  瓶 ─→ ml ←─ 杯
  瓶 ─→ ml ←─ L
  kg ─→ g  ←─ 份

不推荐做法：
  瓶 ─→ 杯 ─→ L ─→ ml  （路径过长，精度损失）
```

#### 原则二：保持换算链简洁

| 推荐 | 不推荐 | 原因 |
|------|--------|------|
| 1瓶=750ml | 1瓶=5杯, 1杯=150ml | 间接换算增加计算误差 |
| 1L=1000ml | 1L=6.67杯 | 避免非整数换算率 |
| 1kg=1000g | 1kg=100份, 1份=10g | 减少中间步骤 |

#### 原则三：按单位类型分类管理

| 类型 | 标识 | 常用单位 | 默认精度 |
|------|------|----------|----------|
| **体积类** | VOLUME | ml, L, 升, 杯, 瓶 | 1位小数 |
| **重量类** | WEIGHT | g, kg, 克, 千克, 份 | 0位小数 |
| **计数类** | COUNT | 个, 根, 片, 包, 打, 箱 | 0位小数 |

### 5.2 配置操作流程

```
步骤1: 梳理单位体系
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ├── 列出所有业务涉及的单位（售卖、库存、采购）
    ├── 确定每种单位的类型（体积/重量/计数）
    └── 识别基础计量单位（ml、g、个）

步骤2: 收集换算比例
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ├── 收集供应商提供的规格信息（1瓶=750ml）
    ├── 确认门店实际使用的换算标准
    └── 记录特殊产品的换算差异（不同品牌酒容量不同）

步骤3: 配置换算规则
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ├── 进入"BOM管理 > 单位换算配置"菜单
    ├── 优先配置基础换算（ml↔L, g↔kg）
    ├── 再配置业务换算（瓶↔ml, 杯↔ml）
    └── 保存后验证换算计算结果

步骤4: 验证与测试
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ├── 使用换算计算功能测试典型场景
    ├── 检查BOM成本计算是否正确
    └── 模拟订单扣减验证库存变化
```

### 5.3 注意事项

| 注意项 | 说明 | 应对措施 |
|--------|------|----------|
| **避免循环依赖** | A→B→C→A 会导致计算错误 | 系统自动检测并阻止保存 |
| **防止重复规则** | 同一对单位只能有一条规则 | 唯一约束自动校验 |
| **精度控制** | 多级换算可能导致精度损失 | 配置合理的舍入规则 |
| **删除保护** | 被BOM引用的规则不可删除 | 先解除BOM引用再删除 |
| **换算率验证** | 必须为正数 | 前后端双重校验 |

### 5.4 常见问题处理

**Q1: 不同品牌的同类产品换算比例不同怎么办？**

```
A: 建议在SKU层面区分，例如：
   - "威士忌-标准瓶" (750ml/瓶)
   - "威士忌-小瓶" (350ml/瓶)
   各自配置对应的换算规则
```

**Q2: 换算计算结果小数位过多怎么办？**

```
A: 系统按单位类型应用默认舍入规则：
   - 体积类：保留1位小数 (45.67ml → 45.7ml)
   - 重量类：保留0位小数 (12.8g → 13g)
   - 计数类：保留0位小数 (2.5个 → 3个)
```

**Q3: 需要删除一条被BOM引用的换算规则怎么办？**

```
A: 按以下步骤操作：
   1. 查询使用该规则的所有BOM
   2. 修改BOM组件，使用其他单位或删除组件
   3. 确认无引用后删除换算规则
```

---

## 6. 实际应用案例

### 6.1 案例：酒吧威士忌可乐售卖全流程

#### 第一步：基础数据准备

**1. 创建原料SKU**

| SKU名称 | SKU类型 | 库存单位 | 标准成本 |
|---------|---------|----------|----------|
| 杰克丹尼威士忌 | 原料 | ml | 0.50元/ml |
| 可口可乐（糖浆） | 原料 | ml | 0.02元/ml |

**2. 创建包材SKU**

| SKU名称 | SKU类型 | 库存单位 | 标准成本 |
|---------|---------|----------|----------|
| 高脚杯 | 包材 | 个 | 2.00元/个 |
| 吸管 | 包材 | 根 | 0.10元/根 |

**3. 创建成品SKU**

| SKU名称 | SKU类型 | 售卖单位 | 零售价 |
|---------|---------|----------|--------|
| 威士忌可乐 | 成品 | 杯 | 48.00元/杯 |

#### 第二步：配置单位换算

进入菜单：**BOM管理 > 单位换算配置**

| 源单位 | 目标单位 | 换算率 | 类别 | 说明 |
|--------|----------|--------|------|------|
| 瓶 | ml | 700 | 体积 | 1瓶威士忌=700ml |
| 杯 | ml | 150 | 体积 | 1杯=150ml（标准杯容量） |
| L | ml | 1000 | 体积 | 升与毫升换算 |

配置完成后，系统自动支持：
- 1ml = 1/700 瓶 = 0.001429 瓶
- 1ml = 1/150 杯 = 0.006667 杯
- 1ml = 0.001 L

#### 第三步：配置BOM配方

进入菜单：**BOM管理 > 配方管理**

选择成品SKU"威士忌可乐"，配置组件清单：

| 组件SKU | 用量 | 单位 | 换算到库存单位 | 组件成本 |
|---------|------|------|----------------|----------|
| 杰克丹尼威士忌 | 45 | ml | 45ml | 22.50元 |
| 可口可乐 | 150 | ml | 150ml | 3.00元 |
| 高脚杯 | 1 | 个 | 1个 | 2.00元 |
| 吸管 | 1 | 根 | 1根 | 0.10元 |

**系统自动计算标准成本**: 22.50 + 3.00 + 2.00 + 0.10 = **27.60元**

#### 第四步：模拟订单验证

**初始库存状态**

| SKU | 总量 | 可用 | 已占用 |
|-----|------|------|--------|
| 杰克丹尼威士忌 | 1400ml (2瓶) | 1400ml | 0 |
| 可口可乐 | 3000ml | 3000ml | 0 |
| 高脚杯 | 50个 | 50个 | 0 |
| 吸管 | 100根 | 100根 | 0 |

**订单确认后（预占）**

下单：威士忌可乐 × 1

| SKU | 总量 | 可用 | 已占用 | 变化 |
|-----|------|------|--------|------|
| 杰克丹尼威士忌 | 1400ml | 1355ml | 45ml | -45ml可用 |
| 可口可乐 | 3000ml | 2850ml | 150ml | -150ml可用 |
| 高脚杯 | 50个 | 49个 | 1个 | -1个可用 |
| 吸管 | 100根 | 99根 | 1根 | -1根可用 |

**出品确认后（扣减）**

| SKU | 总量 | 可用 | 已占用 | 变化 |
|-----|------|------|--------|------|
| 杰克丹尼威士忌 | 1355ml | 1355ml | 0 | 总量-45ml |
| 可口可乐 | 2850ml | 2850ml | 0 | 总量-150ml |
| 高脚杯 | 49个 | 49个 | 0 | 总量-1个 |
| 吸管 | 99根 | 99根 | 0 | 总量-1根 |

#### 第五步：毛利计算

| 指标 | 值 | 说明 |
|------|-----|------|
| 销售价 | 48.00元 | 威士忌可乐零售价 |
| 标准成本 | 27.60元 | BOM计算成本 |
| 毛利额 | 20.40元 | 销售价 - 成本 |
| 毛利率 | 42.5% | 毛利额 ÷ 销售价 |

### 6.2 换算链应用示例

#### 场景：威士忌按瓶入库，按ml售卖

```
入库记录：威士忌 2瓶

单位换算：
  2瓶 × 700ml/瓶 = 1400ml

库存显示：
  总量: 1400ml（或 2瓶）
  可用: 1400ml

售卖记录：威士忌可乐 10杯

BOM展开：
  10杯 × 45ml/杯 = 450ml

库存扣减后：
  总量: 950ml（或 1.36瓶）
  可用: 950ml
```

#### 场景：多级换算链

```
换算规则：
  1箱 = 12瓶
  1瓶 = 750ml

换算链：箱 → 瓶 → ml

计算示例：
  入库 2箱
  = 2 × 12瓶 = 24瓶
  = 24 × 750ml = 18000ml

  售卖 100杯（45ml/杯）
  = 100 × 45ml = 4500ml
  
  剩余库存
  = 18000 - 4500 = 13500ml
  = 13500 ÷ 750 = 18瓶
  = 18 ÷ 12 = 1.5箱
```

---

## 附录

### A. 数据库表结构

```sql
-- unit_conversions 表（V028 迁移脚本创建）
CREATE TABLE unit_conversions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  from_unit VARCHAR(20) NOT NULL,           -- 源单位
  to_unit VARCHAR(20) NOT NULL,             -- 目标单位
  conversion_rate DECIMAL(10,6) NOT NULL,   -- 换算率
  category VARCHAR(20) NOT NULL             -- 类别: volume/weight/quantity
    CHECK (category IN ('volume', 'weight', 'quantity')),
  CONSTRAINT uk_conversion_from_to UNIQUE (from_unit, to_unit)
);

-- 现有基础换算数据
INSERT INTO unit_conversions (from_unit, to_unit, conversion_rate, category) VALUES
  ('ml', 'l', 0.001, 'volume'),
  ('l', 'ml', 1000, 'volume'),
  ('g', 'kg', 0.001, 'weight'),
  ('kg', 'g', 1000, 'weight'),
  ('个', '打', 0.083333, 'quantity'),
  ('打', '个', 12, 'quantity'),
  ('瓶', '箱', 0.083333, 'quantity'),
  ('箱', '瓶', 12, 'quantity');
```

### B. 相关文档

| 文档 | 路径 | 说明 |
|------|------|------|
| P002 功能规格 | `/specs/P002-unit-conversion/spec.md` | 详细功能需求 |
| P002 数据模型 | `/specs/P002-unit-conversion/data-model.md` | 数据结构定义 |
| P002 实施计划 | `/specs/P002-unit-conversion/plan.md` | 开发计划 |
| BOM MVP需求书 | `/docs/业务需求/BOM_MVP_业务需求书_敏捷故事卡片.md` | 整体业务需求 |
| 酒吧场景验证 | `/docs/业务需求/酒吧现调饮品售卖场景验证分析.md` | 场景验证分析 |
| SKU API规格 | `/specs/P001-sku-master-data/api-spec.md` | SKU接口定义 |

### C. 系统菜单路径

| 菜单 | 路径 | 说明 |
|------|------|------|
| 单位换算配置 | BOM管理 > 单位换算配置 | `/bom/conversion` |
| 配方管理 | BOM管理 > 配方管理 | `/bom/recipe` |
| 成本/毛利预估 | BOM管理 > 成本/毛利预估 | `/bom/cost` |
| BOM版本管理 | BOM管理 > BOM版本管理 | `/bom/version` |
