# 订单管理与履约模块开发现状分析

> **文档版本**: 1.0  
> **创建日期**: 2025-12-27  
> **分析范围**: 预约订单管理、支付处理、履约管理  
> **功能分支**: P004-inventory-adjustment

---

## 1. 功能完成度分析

### 1.1 整体完成度概览

| 模块 | 完成度 | 说明 |
|------|:------:|------|
| 订单创建 | ✅ 100% | C端小程序下单流程完整 |
| 订单查询 | ✅ 100% | B端/C端列表和详情均已实现 |
| 状态流转 | ✅ 80% | 核心流程完整，缺少部分边界状态 |
| 支付处理 | 🟡 30% | 仅有回调骨架，未对接微信支付API |
| 履约管理 | 🔴 0% | 吧台出品、核销功能待开发 |
| 售后处理 | 🔴 0% | 退款、改期功能待开发 |

### 1.2 各环节实现详情

#### 订单创建（已完成 ✅）

| 功能点 | 后端 | 前端(B端) | 前端(C端) | 说明 |
|--------|:----:|:---------:|:---------:|------|
| 创建预约单 | ✅ | - | ✅ | `POST /api/reservations` |
| 场景包选择 | ✅ | - | ✅ | 支持多档位套餐 |
| 时段选择 | ✅ | - | ✅ | 日期+时段组合 |
| 加购项选择 | ✅ | - | ✅ | 支持多个加购 |
| 联系人信息 | ✅ | - | ✅ | 手机号验证 |
| 订单金额计算 | ✅ | - | ✅ | 套餐+加购项总价 |

#### 订单查询（已完成 ✅）

| 功能点 | 后端 | 前端(B端) | 前端(C端) | 说明 |
|--------|:----:|:---------:|:---------:|------|
| 订单列表 | ✅ | ✅ | ✅ | 分页+筛选 |
| 订单详情 | ✅ | ✅ | ✅ | 含加购项、操作日志 |
| 多条件筛选 | ✅ | ✅ | - | 订单号/手机号/状态/日期 |
| 待处理数量 | ✅ | - | ✅ | 角标显示 |

#### 状态流转（大部分完成 🟡）

| 功能点 | 后端 | 前端(B端) | 前端(C端) | 说明 |
|--------|:----:|:---------:|:---------:|------|
| 确认预约 | ✅ | ✅ | - | 支持"需支付/直接完成"两种模式 |
| 取消预约 | ✅ | ✅ | ✅ | 支持取消原因记录 |
| 修改预约 | ✅ | ✅ | - | 更新联系人、备注等 |
| 支付完成 | ✅ | - | 🔴 | 仅有回调接口骨架 |
| 操作日志 | ✅ | ✅ | ✅ | 完整的操作追踪 |

#### 支付处理（待开发 🔴）

| 功能点 | 后端 | 前端(B端) | 前端(C端) | 说明 |
|--------|:----:|:---------:|:---------:|------|
| 微信支付发起 | 🔴 | - | 🔴 | 未对接微信支付API |
| 支付状态查询 | 🔴 | - | 🔴 | 无主动查询能力 |
| 支付回调 | ✅ | - | - | 仅骨架，接收paymentId |
| 支付超时取消 | 🔴 | - | - | 无定时任务 |
| 退款处理 | 🔴 | 🔴 | 🔴 | 完全缺失 |

#### 履约管理（待开发 🔴）

| 功能点 | 后端 | 前端(B端) | 前端(C端) | 说明 |
|--------|:----:|:---------:|:---------:|------|
| 吧台工作台 | 🔴 | 🔴 | - | 出品订单看板 |
| 出品确认 | 🔴 | 🔴 | - | 确认出品完成 |
| 库存扣减 | 🔴 | - | - | BOM联动扣料 |
| 到店核销 | 🔴 | 🔴 | 🔴 | 扫码核销 |
| 核销码生成 | 🔴 | - | 🔴 | 订单核销二维码 |

---

## 2. 技术实现现状

### 2.1 后端服务架构

```
backend/src/main/java/com/cinema/reservation/
├── controller/
│   ├── ReservationController.java        # C端API (171行)
│   └── ReservationAdminController.java   # B端API (164行)
├── service/
│   ├── ReservationOrderService.java      # 核心业务逻辑
│   └── ReservationNumberGenerator.java   # 订单号生成
├── repository/
│   ├── ReservationOrderRepository.java   # 订单数据访问
│   ├── ReservationItemRepository.java    # 加购项数据访问
│   ├── ReservationOperationLogRepository.java  # 日志
│   └── SlotInventorySnapshotRepository.java    # 时段库存
├── domain/
│   ├── ReservationOrder.java             # 订单实体
│   ├── ReservationAddonItem.java         # 加购项实体
│   ├── ReservationOperationLog.java      # 操作日志实体
│   └── enums/
│       ├── ReservationStatus.java        # 状态枚举
│       └── OperationType.java            # 操作类型枚举
├── dto/                                  # 9个DTO
└── exception/                            # 3个自定义异常
```

### 2.2 API接口清单

#### C端API (`/api/reservations`)

| Method | Path | 功能 | 状态 |
|--------|------|------|:----:|
| POST | `/` | 创建预约单 | ✅ |
| GET | `/my` | 我的预约列表 | ✅ |
| GET | `/{orderNumber}` | 预约详情 | ✅ |
| POST | `/{orderNumber}/payment-callback` | 支付回调 | 🟡 |
| GET | `/pending-count` | 待处理数量 | ✅ |

#### B端API (`/api/admin/reservations`)

| Method | Path | 功能 | 状态 |
|--------|------|------|:----:|
| GET | `/` | 预约列表查询 | ✅ |
| GET | `/{id}` | 预约详情 | ✅ |
| POST | `/{id}/confirm` | 确认预约 | ✅ |
| POST | `/{id}/cancel` | 取消预约 | ✅ |
| PUT | `/{id}` | 修改预约 | ✅ |

### 2.3 数据库表结构

| 表名 | 说明 | 状态 |
|------|------|:----:|
| `reservation_orders` | 预约单主表 | ✅ 已创建 |
| `reservation_addon_items` | 加购项明细表 | ✅ 已创建 |
| `reservation_operation_logs` | 操作日志表 | ✅ 已创建 |
| `slot_inventory_snapshots` | 时段库存快照 | ✅ 已创建 |

**核心字段**（reservation_orders）：
- `id`, `order_number`, `user_id`
- `scenario_package_id`, `tier_id`, `time_slot_id`
- `reservation_date`, `contact_name`, `contact_phone`
- `total_amount`, `status`, `requires_payment`
- `payment_id`, `payment_time`
- `cancel_reason`, `cancelled_at`
- `version` (乐观锁)

### 2.4 前端实现

#### B端管理后台

```
frontend/src/pages/reservation-orders/
├── ReservationOrderList.tsx              # 列表页 (6.7KB)
├── ReservationOrderDetail.tsx            # 详情页 (10.2KB)
├── components/
│   ├── ConfirmOrderModal.tsx             # 确认弹窗
│   ├── CancelOrderModal.tsx              # 取消弹窗
│   ├── OrderStatusTag.tsx                # 状态标签
│   └── OperationLogTimeline.tsx          # 操作日志时间线
├── hooks/
│   ├── useReservationOrders.ts           # 数据获取
│   ├── useReservationMutations.ts        # 状态变更
│   └── useReservationDetail.ts           # 详情查询
├── services/
│   └── reservationOrderService.ts        # API封装
└── types/
    ├── reservationOrder.ts               # 类型定义
    └── index.ts
```

#### C端小程序

```
hall-reserve-taro/src/pages/
├── home/                                 # 场景包列表
├── detail/                               # 场景包详情
├── reservation-form/                     # 下单表单
├── success/                              # 下单成功
├── my-reservations/                      # 我的预约
├── profile/                              # 个人中心
└── ...
```

---

## 3. 业务流程梳理

### 3.1 完整业务流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         预约订单完整业务流程                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  用户端(C端)                    运营端(B端)                 吧台端           │
│  ┌─────────┐                   ┌─────────┐               ┌─────────┐       │
│  │ 浏览场景 │                   │         │               │         │       │
│  │ 包列表  │                   │         │               │         │       │
│  └────┬────┘                   │         │               │         │       │
│       │ ✅                      │         │               │         │       │
│       ▼                        │         │               │         │       │
│  ┌─────────┐                   │         │               │         │       │
│  │ 选择套餐 │                   │         │               │         │       │
│  │ +时段   │                   │         │               │         │       │
│  └────┬────┘                   │         │               │         │       │
│       │ ✅                      │         │               │         │       │
│       ▼                        │         │               │         │       │
│  ┌─────────┐                   │         │               │         │       │
│  │ 提交预约 │───────────────────▶│ 接收订单 │               │         │       │
│  │ [PENDING]│                  │ 待确认  │               │         │       │
│  └────┬────┘                   └────┬────┘               │         │       │
│       │ ✅                          │ ✅                  │         │       │
│       ▼                             ▼                    │         │       │
│  ┌─────────┐                   ┌─────────┐               │         │       │
│  │ 等待确认 │◀──────────────────│ 确认预约 │               │         │       │
│  │         │                   │ 需支付? │               │         │       │
│  └────┬────┘                   └────┬────┘               │         │       │
│       │ ✅                          │ ✅                  │         │       │
│       ▼                             │                    │         │       │
│  ┌─────────┐                        │                    │         │       │
│  │ 发起支付 │────── 🔴 待对接 ───────│                    │         │       │
│  │ [微信]  │                        │                    │         │       │
│  └────┬────┘                        │                    │         │       │
│       │ 🔴                          │                    │         │       │
│       ▼                             │                    │         │       │
│  ┌─────────┐                   ┌─────────┐               ┌─────────┐       │
│  │ 支付完成 │───────────────────▶│ 订单完成 │──────────────▶│ 出品订单 │       │
│  │[COMPLETED]                  │ 等待出品 │               │ 🔴待开发│       │
│  └────┬────┘                   └─────────┘               └────┬────┘       │
│       │ 🔴                                                    │ 🔴         │
│       ▼                                                       ▼            │
│  ┌─────────┐                                             ┌─────────┐       │
│  │ 到店核销 │────────────── 🔴 待开发 ──────────────────────│ 出品确认 │       │
│  │         │                                             │ 库存扣减 │       │
│  └─────────┘                                             └─────────┘       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

图例：✅ 已实现  🔴 待开发
```

### 3.2 已实现环节

1. **场景包浏览** → 用户查看场景包列表和详情
2. **套餐选择** → 选择档位、时段、加购项
3. **提交预约** → 创建订单，状态为PENDING
4. **商家确认** → B端确认预约，设置是否需支付
5. **状态查询** → B端/C端查看订单列表和详情
6. **订单取消** → 双端均可取消订单

### 3.3 缺失环节

1. **支付环节** → 微信支付发起、支付状态同步
2. **履约环节** → 吧台出品、库存扣减
3. **核销环节** → 到店验证、核销码
4. **售后环节** → 退款、改期处理

---

## 4. 依赖关系说明

### 4.1 模块依赖图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            订单模块依赖关系                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  上游依赖（订单创建需要）                                                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 场景包管理  │  │ 时段模板    │  │ 门店管理    │  │ 用户/会员   │        │
│  │    ✅       │  │    ✅       │  │    ✅       │  │    ✅       │        │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘        │
│         │                │                │                │               │
│         └────────────────┼────────────────┼────────────────┘               │
│                          ▼                ▼                                │
│                   ┌──────────────────────────────┐                         │
│                   │        订单管理模块           │                         │
│                   │     (ReservationOrder)       │                         │
│                   └──────────────┬───────────────┘                         │
│                                  │                                          │
│         ┌────────────────────────┼────────────────────────┐                │
│         ▼                        ▼                        ▼                │
│  ┌─────────────┐          ┌─────────────┐          ┌─────────────┐        │
│  │ 支付系统    │          │ 库存系统    │          │ BOM/配方    │        │
│  │ 🔴 待对接   │          │ 🔴 待集成   │          │ 🔴 待集成   │        │
│  └─────────────┘          └─────────────┘          └─────────────┘        │
│  下游依赖（订单完成需要）                                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 具体依赖说明

| 依赖模块 | 关系类型 | 当前状态 | 说明 |
|---------|---------|:--------:|------|
| **场景包管理** | 上游 | ✅ 已集成 | 订单引用场景包和套餐档位 |
| **时段模板** | 上游 | ✅ 已集成 | 订单引用预约时段 |
| **门店管理** | 上游 | ✅ 已集成 | 订单关联门店 |
| **用户/会员** | 上游 | ✅ 已集成 | 订单关联用户ID |
| **微信支付** | 下游 | 🔴 待对接 | 订单支付依赖微信支付 |
| **库存预占** | 下游 | 🔴 待集成 | 下单时需锁定库存 |
| **库存扣减** | 下游 | 🔴 待集成 | 出品时需扣减库存 |
| **BOM配方** | 下游 | 🔴 待集成 | 出品时按BOM扣料 |

---

## 5. 问题与风险

### 5.1 技术债务

| 问题 | 严重程度 | 影响范围 | 说明 |
|------|:--------:|---------|------|
| 无库存预占 | ⚠️ 高 | 订单创建 | 可能超卖，多人同时下单可能库存不足 |
| 支付未对接 | ⚠️ 高 | 交易闭环 | 无法完成线上收款 |
| 无支付超时 | ⚠️ 中 | 订单管理 | 已确认待支付订单可能长期占用 |
| 临时用户ID | ⚠️ 低 | 认证 | 未对接真实认证体系 |

### 5.2 业务逻辑缺陷

| 问题 | 影响 | 建议 |
|------|------|------|
| 无防超卖机制 | 多人下单可能超过时段库存 | 增加库存预占逻辑 |
| 无支付超时自动取消 | 订单长期停留在待支付状态 | 增加定时任务 |
| 无库存联动 | 出品后库存不变 | 集成库存扣减 |
| 无核销机制 | 到店无法验证 | 增加核销码生成和校验 |

### 5.3 潜在风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|:----:|:----:|---------|
| 超卖风险 | 高 | 高 | 优先实现库存预占 |
| 资金对账困难 | 中 | 高 | 完善支付状态记录 |
| 履约混乱 | 中 | 中 | 开发吧台工作台 |
| 售后纠纷 | 中 | 中 | 开发退款流程 |

---

## 6. 开发建议与实施路径

### 6.1 优先级排序

| 优先级 | 功能 | 工作量 | 依赖 | 说明 |
|:------:|------|:------:|------|------|
| **P0** | 微信支付对接 | 5人天 | 无 | 阻塞交易闭环 |
| **P0** | 库存预占机制 | 4人天 | 库存模块 | 防止超卖 |
| **P0** | 订单状态完善 | 3人天 | 支付 | 完整状态机 |
| **P1** | 吧台出品工作台 | 7人天 | 订单 | 履约系统化 |
| **P1** | BOM自动扣料 | 4人天 | BOM+库存 | 原料联动 |
| **P1** | 退款处理 | 4人天 | 支付 | 售后闭环 |
| **P2** | 核销管理 | 3人天 | 订单 | 到店体验 |
| **P2** | 支付超时取消 | 2人天 | 订单 | 运营优化 |

### 6.2 实施路径

```
Phase 1: 交易闭环 (12人天)
├── Week 1
│   ├── [Day 1-3] 微信支付对接
│   │   ├── 支付下单接口
│   │   ├── 支付回调处理
│   │   └── 支付状态查询
│   └── [Day 4-5] 订单状态完善
│       ├── PAYMENT_PENDING状态
│       └── 超时取消逻辑
└── Week 2
    ├── [Day 1-4] 库存预占机制
    │   ├── 预占接口开发
    │   ├── 订单创建集成
    │   └── 取消释放逻辑
    └── [Day 5] 集成测试

Phase 2: 履约能力 (15人天)
├── Week 3
│   ├── [Day 1-5] 吧台出品工作台
│   │   ├── 待出品订单列表
│   │   ├── 出品确认操作
│   │   └── 出品完成状态
└── Week 4
    ├── [Day 1-4] BOM自动扣料
    │   ├── 出品触发扣料
    │   ├── 原料库存联动
    │   └── 流水记录生成
    └── [Day 5] 退款处理
        ├── 退款申请
        └── 微信退款调用

Phase 3: 运营增强 (5人天)
├── [Day 1-3] 核销管理
│   ├── 核销码生成
│   ├── 扫码核销
│   └── 核销记录
└── [Day 4-5] 支付超时取消
    ├── 定时任务
    └── 自动释放预占
```

### 6.3 下一步行动

**立即行动（本周）**：
1. 创建微信支付对接的spec文档
2. 设计库存预占接口规格
3. 确定微信商户号配置

**短期计划（2周内）**：
1. 完成支付闭环开发
2. 实现库存预占机制
3. 完善订单状态流转

**中期计划（1个月内）**：
1. 开发吧台出品工作台
2. 实现BOM自动扣料
3. 完成退款处理流程

---

## 附录：相关文档

| 文档 | 路径 |
|------|------|
| 预约订单管理功能需求规约 | `docs/业务需求/预约订单管理功能需求规约.md` |
| 订单管理spec | `specs/U001-reservation-order-management/spec.md` |
| 业务闭环缺口分析 | `specs/P004-inventory-adjustment/business-gap-analysis.md` |
| 库存台账功能专项说明 | `docs/业务需求/需求专项说明/库存台账功能专项说明.md` |
| 零售行业解决方案白皮书 | `docs/业务需求/零售行业解决方案白皮书.md` |
