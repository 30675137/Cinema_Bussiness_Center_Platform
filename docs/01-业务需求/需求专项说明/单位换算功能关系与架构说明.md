# 单位换算功能关系与架构说明

> **文档版本**: 1.0
> **创建日期**: 2026-01-11
> **相关功能**: C002-unit-master-data, P002-unit-conversion, M001-material-unit-system
> **状态**: 架构设计说明

---

## 1. 功能概述

### 1.1 问题背景

系统中存在两处单位换算相关的菜单入口，容易引起混淆：

| 菜单位置 | 功能名称 | 路由 | Spec ID | 实现状态 |
|---------|---------|------|---------|----------|
| **基础设置与主数据** | 单位 & 换算规则管理 | `/basic-settings/units` | 建议 **C002** | ⚠️ 待实现 |
| **BOM/配方 & 成本管理** | 单位换算/损耗率配置 | `/bom/conversion` | **P002** | ✅ 已实现 |

用户常见疑问：
- 这两个功能是重复的吗？
- 我应该在哪里配置换算规则？
- 单位数据从哪里来？

本文档旨在澄清两个功能的**定位差异**、**职责边界**和**协作关系**。

---

## 2. 功能定位对比

### 2.1 核心定位

```
┌─────────────────────────────────────────────────────────────────┐
│  功能 1: 基础设置 → 单位 & 换算规则管理 (C002)                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  定位: 基础设施层 (Infrastructure Layer)                  │  │
│  │  角色: 数据源 (Master Data Provider)                      │  │
│  │  职责: 提供单位主数据和全局换算规则                        │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────┬───────────────────────────────────────┘
                          │ 提供基础数据
                          ↓
┌─────────────────────────────────────────────────────────────────┐
│  功能 2: BOM/配方 → 单位换算/损耗率配置 (P002)                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  定位: 应用层 (Application Layer)                         │  │
│  │  角色: 数据消费者 (Data Consumer)                         │  │
│  │  职责: 提供 BOM 场景的换算配置和可视化工具                 │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 详细对比表

| 维度 | 基础设置 → 单位 & 换算规则管理 | BOM/配方 → 单位换算/损耗率配置 |
|------|--------------------------------|------------------------------|
| **功能层级** | 基础设施层 (Infrastructure) | 应用层 (Application) |
| **Spec ID** | 建议 **C002-unit-master-data** | **P002-unit-conversion** |
| **实现状态** | ⚠️ 待实现 (菜单已存在) | ✅ 已实现 (后端API完成) |
| **主要用户** | 系统管理员 | 配方管理员、吧台经理 |
| **使用频率** | 一次性配置 (Setup Phase) | 日常使用 (Daily Operations) |
| **核心数据表** | `units`, `unit_conversions` | 复用 `unit_conversions` + `bom_components` |
| **主要功能** | • 单位主数据 CRUD<br>• 全局换算规则配置<br>• 单位分类管理 | • BOM 换算配置界面<br>• 损耗率配置<br>• 换算链可视化<br>• 换算计算测试 |
| **业务价值** | 提供标准化的单位和换算基础数据 | 支撑 BOM 配方计算和库存扣减 |
| **依赖关系** | 无依赖 (最底层) | 依赖 C002 提供的基础数据 |
| **权限要求** | 高 (系统管理员) | 中 (业务操作员) |
| **数据修改影响** | 全局影响 (所有模块) | 局部影响 (BOM 模块) |

---

## 3. 功能职责详解

### 3.1 功能 1: 基础设置 → 单位 & 换算规则管理 (C002)

#### 3.1.1 核心职责

```
┌─────────────────────────────────────────────────────────────┐
│  单位主数据管理 (units 表)                                   │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  • 创建/编辑/删除单位 (如 "瓶", "L", "ml", "g")        ││
│  │  • 单位代码管理 (code: 全局唯一标识)                   ││
│  │  • 单位分类 (category: VOLUME/WEIGHT/COUNT)            ││
│  │  • 引用检查 (防止删除已被使用的单位)                   ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  全局换算规则配置 (unit_conversions 表)                      │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  • 配置通用换算关系 (如 1L = 1000ml)                   ││
│  │  • 换算率维护 (conversion_rate)                        ││
│  │  • 双向换算支持 (自动生成反向规则)                     ││
│  │  • 换算链路径计算 (如 瓶 → L → ml)                     ││
│  │  • 循环依赖检测 (防止 A→B→C→A)                         ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

#### 3.1.2 数据模型

**单位主数据表 (units)**

```sql
CREATE TABLE units (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code VARCHAR(20) UNIQUE NOT NULL,        -- 单位代码 (如 "ml", "L", "瓶")
    name VARCHAR(100) NOT NULL,              -- 单位名称 (如 "毫升", "升", "瓶")
    category VARCHAR(20) NOT NULL,           -- 分类: VOLUME, WEIGHT, COUNT
    description TEXT,                        -- 说明
    is_active BOOLEAN DEFAULT true,          -- 是否启用
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_units_category ON units(category);
CREATE INDEX idx_units_active ON units(is_active);
```

**全局换算规则表 (unit_conversions)**

```sql
CREATE TABLE unit_conversions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    from_unit VARCHAR(20) NOT NULL,          -- 源单位代码
    to_unit VARCHAR(20) NOT NULL,            -- 目标单位代码
    conversion_rate DECIMAL(10, 6) NOT NULL, -- 换算率 (1 源单位 = ? 目标单位)
    category VARCHAR(20) NOT NULL,           -- 类别: volume, weight, quantity
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- 唯一约束: 同一对单位只能有一条换算规则
    CONSTRAINT uq_unit_conversion UNIQUE (from_unit, to_unit),

    -- 外键约束
    CONSTRAINT fk_from_unit FOREIGN KEY (from_unit) REFERENCES units(code),
    CONSTRAINT fk_to_unit FOREIGN KEY (to_unit) REFERENCES units(code)
);

-- 索引
CREATE INDEX idx_unit_conversions_from ON unit_conversions(from_unit);
CREATE INDEX idx_unit_conversions_to ON unit_conversions(to_unit);
CREATE INDEX idx_unit_conversions_category ON unit_conversions(category);
```

#### 3.1.3 典型使用场景

**场景 1: 系统初始化 - 配置基础单位**

```
步骤 1: 创建单位主数据
  ├─ 体积类: ml(毫升), L(升), 瓶
  ├─ 重量类: g(克), kg(千克), 份
  └─ 计数类: 个, 杯, 打

步骤 2: 配置全局换算规则
  ├─ 1L = 1000ml      (体积换算)
  ├─ 1kg = 1000g      (重量换算)
  └─ 1打 = 12个       (计数换算)

步骤 3: 验证换算链
  └─ 测试 1L → ml → 瓶 (假设 1瓶=750ml)
     结果: 1L = 1000ml ≈ 1.33瓶
```

**场景 2: 添加新单位**

```
需求: 新增 "盒" 作为包装单位

操作流程:
  1. 在 "基础设置 → 单位管理" 创建单位
     ├─ 代码: 盒
     ├─ 名称: 盒
     ├─ 分类: COUNT (计数类)

  2. 配置换算规则
     └─ 1盒 = 12个 (在 "基础设置 → 换算规则管理")

  3. 系统自动生效
     └─ 所有模块 (BOM/采购/库存) 立即可用
```

#### 3.1.4 界面设计建议

**单位管理界面**

```
┌────────────────────────────────────────────────────────────┐
│  单位管理                                      [+ 新增单位] │
├────────────────────────────────────────────────────────────┤
│  筛选: [全部分类 ▼] [仅显示启用 ☑]            🔍 [搜索...] │
├──────┬──────┬────────┬────────┬────────┬────────┬─────────┤
│ 代码 │ 名称 │ 分类   │ 引用次数│ 状态   │ 创建时间│ 操作   │
├──────┼──────┼────────┼────────┼────────┼────────┼─────────┤
│ ml   │ 毫升 │ 体积   │ 125    │ 启用   │ 2025-12│ [编辑] │
│ L    │ 升   │ 体积   │ 89     │ 启用   │ 2025-12│ [编辑] │
│ 瓶   │ 瓶   │ 计数   │ 203    │ 启用   │ 2025-12│ [编辑] │
│ g    │ 克   │ 重量   │ 67     │ 启用   │ 2025-12│ [编辑] │
│ 盒   │ 盒   │ 计数   │ 0      │ 启用   │ 2026-01│ [编辑]│
└──────┴──────┴────────┴────────┴────────┴────────┴─────────┘
```

**换算规则管理界面**

```
┌────────────────────────────────────────────────────────────┐
│  换算规则管理                                  [+ 新增规则] │
├────────────────────────────────────────────────────────────┤
│  分类: [全部 ▼]  换算链测试: [瓶] → [ml] = [750.00]       │
├──────────┬──────────┬──────────┬──────────┬────────┬───────┤
│ 源单位   │ 目标单位 │ 换算率   │ 分类     │ 状态   │ 操作  │
├──────────┼──────────┼──────────┼──────────┼────────┼───────┤
│ L        │ ml       │ 1000.00  │ 体积     │ 有效   │ [编辑]│
│ kg       │ g        │ 1000.00  │ 重量     │ 有效   │ [编辑]│
│ 打       │ 个       │ 12.00    │ 计数     │ 有效   │ [编辑]│
│ 盒       │ 个       │ 12.00    │ 计数     │ 有效   │ [删除]│
└──────────┴──────────┴──────────┴──────────┴────────┴───────┘

说明:
  • 双向换算: 定义 L→ml 后，系统自动支持 ml→L
  • 引用检查: 被 BOM/物料使用的规则无法删除
  • 循环检测: 创建前检测是否形成循环 (如 A→B→C→A)
```

#### 3.1.5 业务规则

**删除保护规则**

```
单位删除检查:
  ├─ 检查 unit_conversions 表引用
  │   └─ SELECT COUNT(*) FROM unit_conversions
  │       WHERE from_unit = ? OR to_unit = ?
  │
  ├─ 检查物料表引用 (M001)
  │   └─ SELECT COUNT(*) FROM material
  │       WHERE inventory_unit_id = ? OR purchase_unit_id = ?
  │
  ├─ 检查 BOM 组件引用
  │   └─ SELECT COUNT(*) FROM bom_components
  │       WHERE unit_code = ?
  │
  └─ 有任何引用 → 阻止删除 + 显示引用详情

换算规则删除检查:
  ├─ 检查物料是否使用 (间接引用)
  │   └─ 如果物料配置 use_global_conversion=true
  │       且物料的库存单位/采购单位涉及此规则
  │
  └─ 检查 BOM 组件是否依赖
      └─ BOM 中使用的单位换算路径是否经过此规则
```

**换算规则验证**

```
创建/编辑换算规则时:
  ├─ 检查 1: 换算率必须为正数
  │   └─ conversion_rate > 0
  │
  ├─ 检查 2: 源单位和目标单位不能相同
  │   └─ from_unit ≠ to_unit
  │
  ├─ 检查 3: 检测循环依赖
  │   └─ 使用图算法检测是否形成环路
  │       例如: A→B, B→C, 尝试创建 C→A 时报错
  │
  └─ 检查 4: 唯一性约束
      └─ (from_unit, to_unit) 组合必须唯一
```

---

### 3.2 功能 2: BOM/配方 → 单位换算/损耗率配置 (P002)

#### 3.2.1 核心职责

```
┌─────────────────────────────────────────────────────────────┐
│  BOM 换算配置界面                                            │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  • 展示和测试换算链 (如 瓶 → L → ml)                   ││
│  │  • 可视化换算路径 (流程图/关系图)                      ││
│  │  • 实时换算计算验证                                     ││
│  │  • 换算规则快速查询和筛选                               ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  损耗率配置 (Loss Rate)                                      │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  • 配置物料在 BOM 使用中的损耗率                        ││
│  │  • 影响实际扣减量计算                                   ││
│  │  • 例如: 配方需要 100ml, 损耗率 5%                      ││
│  │         实际扣减 = 100ml × (1 + 5%) = 105ml             ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  换算规则管理界面 (复用 unit_conversions 表)                 │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  • 提供 BOM 场景的换算规则 CRUD 界面                    ││
│  │  • 循环依赖检测和提示                                   ││
│  │  • 舍入规则配置 (按单位类型)                            ││
│  │  • 快速测试和验证                                       ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

#### 3.2.2 数据模型 (扩展)

**BOM 组件表 (bom_components) - 关联字段**

```sql
-- P002 相关字段
ALTER TABLE bom_components
ADD COLUMN unit_code VARCHAR(20),           -- 组件单位
ADD COLUMN loss_rate DECIMAL(5, 2) DEFAULT 0.00,  -- 损耗率 (%)
ADD COLUMN conversion_note TEXT;            -- 换算说明

-- 外键约束
ALTER TABLE bom_components
ADD CONSTRAINT fk_bom_unit
FOREIGN KEY (unit_code) REFERENCES units(code);
```

**舍入规则配置表 (unit_rounding_rules) - 可选**

```sql
CREATE TABLE unit_rounding_rules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    category VARCHAR(20) NOT NULL,      -- volume, weight, quantity
    decimal_places INT DEFAULT 2,       -- 小数位数
    rounding_mode VARCHAR(20) DEFAULT 'HALF_UP',  -- HALF_UP, DOWN, UP
    created_at TIMESTAMP DEFAULT NOW(),

    CONSTRAINT uq_category UNIQUE (category)
);

-- 默认数据
INSERT INTO unit_rounding_rules (category, decimal_places) VALUES
('volume', 1),   -- 体积类保留 1 位小数
('weight', 0),   -- 重量类保留 0 位小数 (整数)
('quantity', 0); -- 计数类保留 0 位小数
```

#### 3.2.3 典型使用场景

**场景 1: BOM 配方创建 - 使用换算**

```
需求: 创建 "朗姆可乐" 配方

步骤 1: 定义 BOM 组件
  ├─ 组件 1: 朗姆酒 - 45ml (配方单位)
  │   └─ 损耗率: 5% (考虑倾倒损耗)
  │
  └─ 组件 2: 可乐 - 150ml
      └─ 损耗率: 3%

步骤 2: 系统自动换算 (订单处理时)
  ├─ 朗姆酒库存扣减:
  │   ├─ 配方需要: 45ml
  │   ├─ 加上损耗: 45ml × (1 + 5%) = 47.25ml
  │   ├─ 如果库存单位是 "瓶" (1瓶=500ml):
  │   └─ 扣减数量: 47.25ml ÷ 500ml/瓶 = 0.0945 瓶
  │
  └─ 可乐库存扣减:
      ├─ 配方需要: 150ml
      ├─ 加上损耗: 150ml × (1 + 3%) = 154.5ml
      └─ 扣减数量: 154.5ml (库存单位也是 ml)
```

**场景 2: 换算链可视化**

```
用户操作: 在 BOM 换算配置界面测试 "瓶 → ml"

系统显示:
┌──────────────────────────────────────────┐
│  换算路径可视化                           │
├──────────────────────────────────────────┤
│                                          │
│   瓶 ──────→ L ──────→ ml                │
│     750ml/瓶   1000ml/L                  │
│                                          │
│   计算过程:                               │
│   1瓶 × 750ml/瓶 = 750ml ✓               │
│                                          │
│   舍入规则: 体积类保留 1 位小数           │
│   最终结果: 750.0ml                       │
└──────────────────────────────────────────┘
```

**场景 3: 损耗率配置**

```
用户操作: 为 "朗姆酒" 配置损耗率

界面:
┌────────────────────────────────────────┐
│  物料损耗率配置                         │
├────────────────────────────────────────┤
│  物料名称: 朗姆酒                       │
│  损耗率:   [5] %                        │
│                                        │
│  说明: 考虑倾倒、挥发等损耗             │
│                                        │
│  影响范围:                              │
│  • 使用此物料的所有 BOM 配方            │
│  • 订单处理时自动应用损耗率             │
│                                        │
│  计算示例:                              │
│  配方需要 100ml                         │
│  实际扣减 = 100ml × (1 + 5%) = 105ml   │
└────────────────────────────────────────┘
```

#### 3.2.4 界面设计 (已实现)

参考 P002 现有实现:

```
┌────────────────────────────────────────────────────────────┐
│  BOM 单位换算配置                                          │
├────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │ 换算规则总数 │  │ 活跃规则    │  │ 换算链数量   │       │
│  │    45       │  │    42       │  │    12       │       │
│  └─────────────┘  └─────────────┘  └─────────────┘       │
├────────────────────────────────────────────────────────────┤
│  换算测试:                                                 │
│  [瓶 ▼] → [ml ▼]   数量: [1]    = [750.00] ml            │
│  [查看换算路径]                                            │
├────────────────────────────────────────────────────────────┤
│  筛选: [全部分类 ▼]  [仅显示活跃 ☑]        🔍 [搜索...]   │
├──────────┬──────────┬──────────┬──────────┬────────┬───────┤
│ 源单位   │ 目标单位 │ 换算率   │ 换算链   │ 状态   │ 操作  │
├──────────┼──────────┼──────────┼──────────┼────────┼───────┤
│ L        │ ml       │ 1000.00  │ 直接     │ 活跃   │ [详情]│
│ 瓶       │ ml       │ 750.00   │ 直接     │ 活跃   │ [详情]│
│ 杯       │ ml       │ 150.00   │ 直接     │ 活跃   │ [详情]│
│ kg       │ g        │ 1000.00  │ 直接     │ 活跃   │ [详情]│
└──────────┴──────────┴──────────┴──────────┴────────┴───────┘
```

#### 3.2.5 业务规则

**换算优先级 (结合 M001 物料级换算)**

```
当需要换算时 (调用 CommonConversionService):

第 1 层: Material-Level Conversion (物料级换算)
  ├─ 优先级: 最高
  ├─ 条件: materialId 不为空 且 use_global_conversion = false
  └─ 数据来源: material 表的 conversion_rate 字段
      例如: "朗姆酒" 1瓶 = 500ml (覆盖全局规则)

第 2 层: Global Conversion (全局换算)
  ├─ 优先级: 中等
  ├─ 条件: 物料级换算不可用 或 use_global_conversion = true
  └─ 数据来源: unit_conversions 表
      例如: 1L = 1000ml (通用规则)

第 3 层: BOM Conversion with Loss Rate (BOM 损耗换算)
  ├─ 优先级: 应用层
  ├─ 条件: 订单处理、BOM 扣减时
  └─ 计算公式:
      实际扣减 = 配方需要量 × (1 + 损耗率)
      例如: 100ml × (1 + 5%) = 105ml
```

**换算路径选择**

```
当存在多条换算路径时:

情况 1: 直接换算 vs 间接换算
  ├─ 直接换算: 瓶 → ml (存在直接规则)
  └─ 间接换算: 瓶 → L → ml (通过中间单位)

  规则: 优先选择直接换算 (最短路径)

情况 2: 多条间接路径
  ├─ 路径 A: 瓶 → L → ml (2 步)
  └─ 路径 B: 瓶 → 升 → 毫升 → ml (3 步)

  规则: 选择步骤最少的路径 (路径 A)
```

---

## 4. 系统架构整合

### 4.1 三层换算体系

```
┌─────────────────────────────────────────────────────────────┐
│  第 1 层: Material-Level Conversion (物料级换算)             │
│  ├─ 数据来源: material.conversion_rate                      │
│  ├─ 优先级: 最高                                            │
│  ├─ 适用场景: 特殊规格物料 (如 500ml 瓶装朗姆酒)            │
│  └─ 示例: "朗姆酒" 1瓶 = 500ml (覆盖全局 1瓶=750ml)         │
└─────────────────┬───────────────────────────────────────────┘
                  │ 降级
                  ↓
┌─────────────────────────────────────────────────────────────┐
│  第 2 层: Global Conversion (全局换算)                       │
│  ├─ 数据来源: unit_conversions 表                           │
│  ├─ 优先级: 中等                                            │
│  ├─ 适用场景: 标准通用换算 (如 1L = 1000ml)                 │
│  └─ 提供者: C002 功能                                       │
└─────────────────┬───────────────────────────────────────────┘
                  │ 应用
                  ↓
┌─────────────────────────────────────────────────────────────┐
│  第 3 层: BOM Conversion with Loss Rate (BOM 损耗换算)       │
│  ├─ 数据来源: bom_components.loss_rate                      │
│  ├─ 优先级: 应用层                                          │
│  ├─ 适用场景: 订单处理、库存扣减                            │
│  └─ 计算: 实际扣减 = 配方需要 × (1 + 损耗率)                │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 服务调用流程

```java
/**
 * 统一换算服务接口
 * @spec M001-material-unit-system
 * @spec P002-unit-conversion
 */
public interface CommonConversionService {

  /**
   * 自动选择最优换算路径
   *
   * 换算优先级:
   * 1. Material-level conversion (如果 materialId 提供且 use_global_conversion=false)
   * 2. Global conversion (从 unit_conversions 表查找)
   *
   * @param fromUnitCode 源单位代码 (如 "瓶")
   * @param toUnitCode 目标单位代码 (如 "ml")
   * @param quantity 待换算数量
   * @param materialId 可选的物料ID (用于物料级换算)
   * @return 换算结果 (包含换算后数量、来源标识、换算路径)
   */
  ConversionResult convert(
    String fromUnitCode,
    String toUnitCode,
    BigDecimal quantity,
    UUID materialId
  );

  /**
   * 强制使用全局换算
   *
   * @return 换算结果 (source 固定为 GLOBAL)
   */
  ConversionResult convertGlobal(
    String fromUnitCode,
    String toUnitCode,
    BigDecimal quantity
  );
}

/**
 * 换算结果数据对象
 */
record ConversionResult(
  BigDecimal convertedQuantity,  // 换算后数量
  ConversionSource source,        // MATERIAL 或 GLOBAL
  String conversionPath           // 换算路径 (如 "瓶 → ml (material-level)")
);
```

### 4.3 完整业务流程示例

```
┌─────────────────────────────────────────────────────────────┐
│  场景: 处理 "朗姆可乐" 订单并扣减库存                        │
└─────────────────────────────────────────────────────────────┘

步骤 1: 获取 BOM 配方
  ├─ 配方 ID: bom-001
  ├─ 配方名称: "朗姆可乐"
  └─ 组件列表:
      ├─ 朗姆酒: 45ml (损耗率 5%)
      └─ 可乐: 150ml (损耗率 3%)

步骤 2: 换算计算 (组件 1 - 朗姆酒)
  ├─ 配方需要: 45ml
  ├─ 加上损耗: 45ml × (1 + 5%) = 47.25ml
  ├─ 查询物料信息:
  │   ├─ 物料ID: mat-001
  │   ├─ 库存单位: 瓶
  │   ├─ 采购单位: 瓶
  │   ├─ use_global_conversion: false
  │   └─ conversion_rate: 500ml/瓶 (物料级换算)
  │
  ├─ 调用换算服务:
  │   └─ CommonConversionService.convert(
  │         fromUnit: "ml",
  │         toUnit: "瓶",
  │         quantity: 47.25,
  │         materialId: "mat-001"
  │       )
  │
  ├─ 换算结果:
  │   ├─ convertedQuantity: 0.0945 瓶
  │   ├─ source: MATERIAL (使用物料级换算)
  │   └─ conversionPath: "ml → 瓶 (material: 1瓶=500ml)"
  │
  └─ 扣减库存: 0.0945 瓶

步骤 3: 换算计算 (组件 2 - 可乐)
  ├─ 配方需要: 150ml
  ├─ 加上损耗: 150ml × (1 + 3%) = 154.5ml
  ├─ 查询物料信息:
  │   ├─ 物料ID: mat-002
  │   ├─ 库存单位: ml
  │   ├─ use_global_conversion: true (使用全局换算)
  │
  ├─ 调用换算服务:
  │   └─ CommonConversionService.convert(
  │         fromUnit: "ml",
  │         toUnit: "ml",
  │         quantity: 154.5,
  │         materialId: "mat-002"
  │       )
  │
  ├─ 换算结果:
  │   ├─ convertedQuantity: 154.5ml (同单位无需换算)
  │   ├─ source: GLOBAL
  │   └─ conversionPath: "ml → ml (无需换算)"
  │
  └─ 扣减库存: 154.5ml

步骤 4: 库存扣减记录
  ├─ 物料 mat-001: -0.0945 瓶
  └─ 物料 mat-002: -154.5ml
```

---

## 5. 数据流向图

### 5.1 完整数据流

```
┌─────────────────────────────────────────────────────────────┐
│  阶段 1: 系统初始化 (System Setup)                           │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  系统管理员                                              ││
│  │  ↓                                                       ││
│  │  [基础设置 → 单位 & 换算规则管理] (C002)                ││
│  │  ├─ 创建单位主数据: ml, L, 瓶, g, kg, 份               ││
│  │  └─ 配置全局换算规则: 1L=1000ml, 1kg=1000g             ││
│  │                                                          ││
│  │  数据写入:                                               ││
│  │  ├─ units 表                                            ││
│  │  └─ unit_conversions 表                                 ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────┬───────────────────────────────────────────┘
                  │ 单位主数据 + 全局换算规则
                  ↓
┌─────────────────────────────────────────────────────────────┐
│  阶段 2: 物料配置 (Material Configuration)                   │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  采购管理员                                              ││
│  │  ↓                                                       ││
│  │  [BOM → 原料库/物料主数据] (M001)                       ││
│  │  ├─ 创建物料: "朗姆酒"                                  ││
│  │  ├─ 库存单位: 瓶 (从 units 表选择)                     ││
│  │  ├─ 采购单位: 瓶                                        ││
│  │  ├─ conversion_rate: 500ml/瓶 (物料级换算)             ││
│  │  └─ use_global_conversion: false                        ││
│  │                                                          ││
│  │  数据写入:                                               ││
│  │  └─ material 表                                         ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────┬───────────────────────────────────────────┘
                  │ 物料主数据 + 物料级换算配置
                  ↓
┌─────────────────────────────────────────────────────────────┐
│  阶段 3: BOM 配方配置 (Recipe Configuration)                 │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  配方管理员                                              ││
│  │  ↓                                                       ││
│  │  [BOM → 单位换算/损耗率配置] (P002)                     ││
│  │  ├─ 查看换算链: 瓶 → ml                                 ││
│  │  ├─ 测试换算: 1瓶 = ?ml                                 ││
│  │  └─ 配置损耗率: 朗姆酒 5%, 可乐 3%                      ││
│  │                                                          ││
│  │  [BOM → BOM/配方配置]                                   ││
│  │  ├─ 创建配方: "朗姆可乐"                                ││
│  │  ├─ 添加组件: 朗姆酒 45ml (损耗率 5%)                   ││
│  │  └─ 添加组件: 可乐 150ml (损耗率 3%)                    ││
│  │                                                          ││
│  │  数据写入:                                               ││
│  │  └─ bom_components 表                                   ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────┬───────────────────────────────────────────┘
                  │ BOM 配方 + 损耗率配置
                  ↓
┌─────────────────────────────────────────────────────────────┐
│  阶段 4: 订单处理 (Order Processing)                         │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  系统自动处理                                            ││
│  │  ↓                                                       ││
│  │  订单创建 → BOM 扣减计算                                 ││
│  │  ├─ 调用 CommonConversionService.convert()             ││
│  │  │   └─ 自动选择最优换算路径                            ││
│  │  │       ├─ 优先: Material-level conversion            ││
│  │  │       └─ 降级: Global conversion                    ││
│  │  │                                                      ││
│  │  ├─ 应用损耗率                                          ││
│  │  │   └─ 实际扣减 = 配方需要 × (1 + 损耗率)             ││
│  │  │                                                      ││
│  │  └─ 扣减库存                                            ││
│  │      └─ 更新 inventory 表                               ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 5.2 数据依赖关系

```
units (单位主数据)
  ├─ 被引用: unit_conversions.from_unit
  ├─ 被引用: unit_conversions.to_unit
  ├─ 被引用: material.inventory_unit_code
  ├─ 被引用: material.purchase_unit_code
  └─ 被引用: bom_components.unit_code

unit_conversions (全局换算规则)
  ├─ 被使用: CommonConversionService (全局换算)
  └─ 被查询: P002 换算配置界面

material (物料主数据)
  ├─ 依赖: units 表 (单位选择)
  ├─ 提供: 物料级换算率 (覆盖全局)
  └─ 被引用: bom_components.material_id

bom_components (BOM 组件)
  ├─ 依赖: material 表
  ├─ 依赖: units 表
  ├─ 提供: 损耗率配置
  └─ 被使用: 订单处理流程
```

---

## 6. 实施建议

### 6.1 开发优先级

```
阶段 1: 基础设施层 (C002) ⚠️ 待实现
  ├─ 优先级: P0 (最高)
  ├─ 目标: 提供单位主数据和全局换算规则
  ├─ 交付物:
  │   ├─ units 表 CRUD API
  │   ├─ unit_conversions 表 CRUD API
  │   └─ 基础设置管理界面
  │
  └─ 验收标准:
      ├─ 可创建/编辑/删除单位
      ├─ 可配置全局换算规则
      ├─ 删除保护机制生效
      └─ 循环依赖检测正常

阶段 2: 应用层增强 (P002) ✅ 已部分实现
  ├─ 优先级: P1
  ├─ 目标: 完善 BOM 场景的换算配置界面
  ├─ 交付物:
  │   ├─ 换算链可视化
  │   ├─ 损耗率配置界面
  │   └─ 换算测试工具
  │
  └─ 验收标准:
      ├─ 可视化显示换算路径
      ├─ 可配置和查询损耗率
      └─ 换算计算结果准确

阶段 3: 物料级换算 (M001) ✅ 已实现
  ├─ 优先级: P1
  ├─ 目标: 支持物料级换算覆盖全局规则
  ├─ 交付物:
  │   ├─ Material 实体扩展 (conversion_rate 字段)
  │   ├─ CommonConversionService 实现
  │   └─ 三层换算优先级逻辑
  │
  └─ 验收标准:
      ├─ 物料级换算优先生效
      ├─ 降级到全局换算正常
      └─ 换算来源标识准确
```

### 6.2 用户培训路径

```
角色 1: 系统管理员
  └─ 培训内容:
      ├─ 单位主数据管理 (C002)
      ├─ 全局换算规则配置 (C002)
      ├─ 删除保护规则说明
      └─ 循环依赖检测机制

角色 2: 采购管理员
  └─ 培训内容:
      ├─ 物料创建与管理 (M001)
      ├─ 物料级换算配置 (何时使用物料级覆盖)
      └─ 单位选择最佳实践

角色 3: 配方管理员
  └─ 培训内容:
      ├─ BOM 配方创建
      ├─ 换算链测试 (P002)
      ├─ 损耗率配置原则
      └─ 单位选择建议
```

### 6.3 最佳实践建议

#### 单位命名规范

```
推荐:
  ✓ 使用标准单位符号: ml, L, g, kg
  ✓ 中文单位简洁明了: 瓶, 杯, 份, 个
  ✓ 避免歧义: "桶" vs "大桶" vs "小桶" → 使用 "5L桶", "10L桶"

不推荐:
  ✗ 模糊单位: "袋" (多大的袋?)
  ✗ 自定义缩写: "ml" → "毫" (不标准)
  ✗ 混用: 同时存在 "瓶" 和 "bottle"
```

#### 换算规则配置原则

```
1. 基础单位优先
   ✓ 优先配置基础单位换算: L ↔ ml, kg ↔ g
   ✗ 避免配置冗余规则: 瓶 → L → ml (只需 瓶→ml 即可)

2. 最短路径原则
   ✓ 配置直接换算关系减少换算步骤
   ✗ 避免多层嵌套: 瓶 → 升 → 毫升 → ml

3. 业务规则对齐
   ✓ 全局规则采用行业标准 (1L = 1000ml)
   ✓ 物料级规则采用实际规格 (某品牌瓶装 500ml)

4. 损耗率设置合理
   ✓ 液体类: 3-5% (考虑倾倒损耗)
   ✓ 固体类: 1-3% (考虑称重误差)
   ✓ 高价值物料: 适当降低损耗率
```

#### 权限分配建议

```
C002 - 基础设置权限 (系统管理员)
  ├─ 单位管理: 创建、编辑、删除
  ├─ 全局换算规则: 创建、编辑、删除
  └─ 影响范围: 全局 (谨慎操作)

P002 - BOM 换算配置权限 (配方管理员)
  ├─ 换算规则查询: 只读
  ├─ 换算测试: 允许
  ├─ 损耗率配置: 允许
  └─ 影响范围: BOM 模块

M001 - 物料管理权限 (采购管理员)
  ├─ 物料创建: 允许
  ├─ 物料级换算配置: 允许
  ├─ 单位选择: 从已有单位选择 (依赖 C002)
  └─ 影响范围: 物料数据
```

---

## 7. 常见问题 (FAQ)

### Q1: 两个功能是重复的吗？

**A**: 不是。它们是**基础设施层**和**应用层**的关系：

- **C002 (基础设置)**: 提供单位主数据和全局换算规则 (数据源)
- **P002 (BOM 配置)**: 提供 BOM 场景的换算配置界面 (数据消费者)

类比：
- C002 = 数据库表定义
- P002 = 应用程序界面

---

### Q2: 我应该在哪里配置换算规则？

**A**: 取决于换算规则的性质：

| 规则类型 | 配置位置 | 示例 |
|---------|---------|------|
| **通用标准换算** | C002 (基础设置) | 1L = 1000ml, 1kg = 1000g |
| **特殊物料换算** | M001 (物料管理) | "朗姆酒" 1瓶 = 500ml |
| **BOM 损耗率** | P002 (BOM 配置) | 朗姆酒损耗率 5% |

---

### Q3: 全局换算规则和物料级换算的优先级？

**A**: **物料级换算优先**：

```
换算优先级 (从高到低):
  1. Material-level conversion (物料级)
     └─ 条件: use_global_conversion = false

  2. Global conversion (全局)
     └─ 条件: 物料级不可用或 use_global_conversion = true
```

示例：
- 全局规则: 1瓶 = 750ml
- 物料 "朗姆酒": 1瓶 = 500ml (use_global_conversion=false)
- 结果: 换算朗姆酒时使用 **500ml** (物料级覆盖全局)

---

### Q4: 如果修改全局换算规则，会影响已有订单吗？

**A**: 不会影响**已完成订单**，会影响**未来订单**：

- ✓ 已完成订单: 库存扣减已完成，不受影响
- ✓ 进行中订单: 可能使用旧规则 (取决于订单锁定机制)
- ✗ 未来订单: 使用新规则

**建议**: 修改换算规则前通知业务团队，避免成本核算差异。

---

### Q5: 损耗率应该设置多少？

**A**: 根据物料类型和业务经验设置：

| 物料类型 | 建议损耗率 | 说明 |
|---------|-----------|------|
| 液体类 (酒水、饮料) | 3-5% | 考虑倾倒、挥发损耗 |
| 固体类 (粉末、颗粒) | 1-3% | 考虑称重误差 |
| 高价值物料 | 适当降低 | 减少浪费 |
| 低价值物料 | 适当提高 | 简化管理 |

**建议**: 定期根据实际盘点结果调整损耗率。

---

### Q6: 换算链最多支持几层？

**A**: 理论上无限制，但建议**不超过 3 层**：

```
推荐 (2 层):
  瓶 → ml (直接换算)
  L → ml → 瓶 (2 步)

可接受 (3 层):
  桶 → L → ml → 杯 (3 步)

不推荐 (> 3 层):
  大桶 → 中桶 → 小桶 → 瓶 → L → ml (过于复杂)
```

**原因**:
- 每层换算都有精度损失
- 换算步骤越多，计算越慢
- 维护成本增加

---

### Q7: 如何防止循环换算？

**A**: 系统在创建/编辑换算规则时自动检测循环：

```
检测算法:
  1. 使用图算法 (深度优先搜索)
  2. 检测从新规则的 to_unit 出发是否能回到 from_unit

示例:
  现有规则: A → B, B → C
  尝试创建: C → A

  检测结果: 发现循环 A → B → C → A
  操作结果: 阻止创建 + 提示用户
```

---

### Q8: 可以同时使用全局换算和物料级换算吗？

**A**: 可以，系统会**自动选择最优路径**：

```
场景 1: 物料配置了物料级换算
  └─ 使用物料级换算 (优先级高)

场景 2: 物料未配置物料级换算 (use_global_conversion=true)
  └─ 降级到全局换算

场景 3: 无物料上下文 (如通用换算计算)
  └─ 使用全局换算
```

---

## 8. 总结

### 8.1 核心要点

1. **C002 是 P002 的前置依赖**
   - C002 提供单位主数据和全局换算规则
   - P002 提供 BOM 场景的应用配置界面

2. **三层换算体系**
   - 第 1 层: Material-level (物料级，最高优先级)
   - 第 2 层: Global (全局换算，中等优先级)
   - 第 3 层: BOM with Loss Rate (应用层损耗率)

3. **职责分离原则**
   - 基础设施层: 提供标准化数据 (C002)
   - 应用层: 提供业务场景工具 (P002)
   - 数据层: 物料级覆盖全局 (M001)

### 8.2 下一步行动

| 任务 | 负责人 | 优先级 | 状态 |
|------|-------|--------|------|
| 创建 C002 规格文档 | 产品经理 | P0 | ⚠️ 待创建 |
| 实现 C002 后端 API | 后端开发 | P0 | ⚠️ 待开发 |
| 实现 C002 前端界面 | 前端开发 | P0 | ⚠️ 待开发 |
| 完善 P002 可视化功能 | 前端开发 | P1 | 🚧 进行中 |
| 编写用户培训文档 | 产品经理 | P2 | ⚠️ 待编写 |

---

**文档维护**:
- 定期更新架构图和数据流
- 记录新增的换算场景和最佳实践
- 收集用户反馈并优化说明

**相关文档**:
- [单位换算配置功能专项说明](/docs/业务需求/需求专项说明/单位换算配置功能专项说明.md)
- [物料单位体系统一方案专项说明](/docs/业务需求/需求专项说明/物料单位体系统一方案专项说明.md)
- [P002-unit-conversion 规格文档](/specs/P002-unit-conversion/spec.md)
- [M001-material-unit-system 规格文档](/specs/M001-material-unit-system/spec.md)

---

**文档结束**
