# 酒吧现调饮品售卖场景验证分析报告

> **版本**: 1.0  
> **日期**: 2025-12-25  
> **状态**: 待开发功能清单  

---

## 1. 场景概述

**业务场景**：顾客在吧台点一杯"威士忌可乐"，吧台员工制作并交付。

### 1.1 前置条件

| 条件 | 说明 |
|------|------|
| 已创建原料SKU | 威士忌(库存单位:ml)、可乐(库存单位:ml) |
| 已创建包材SKU | 高脚杯(库存单位:个)、吸管(库存单位:根) |
| 已创建成品SKU | 威士忌可乐 |
| 已配置BOM | 威士忌可乐 = 威士忌45ml + 可乐150ml + 高脚杯1个 + 吸管1根 |
| 已配置单位换算 | 1瓶威士忌=700ml |
| 吧台库有库存 | 威士忌1400ml(2瓶)、可乐3000ml、高脚杯50个、吸管100根 |

### 1.2 验证步骤

| 步骤 | 操作 | 预期结果 | 验证点 |
|------|------|---------|--------|
| 1 | 小程序下单：威士忌可乐 x 1 | 订单创建成功 | 订单号生成 |
| 2 | 订单确认 | 库存预占成功 | 可用库存减少：威士忌-45ml、可乐-150ml、杯-1、管-1 |
| 3 | 查看库存状态 | 显示"总量/可用/已占用" | 威士忌：1400/1355/45 |
| 4 | 吧台出品确认 | 实际扣减完成 | 库存总量减少，占用清零 |
| 5 | 查看出品记录 | 记录完整 | 包含订单号、SKU明细、时间 |

### 1.3 异常场景

- **库存不足**：预占时提示"威士忌库存不足，请补货"
- **出品前取消**：释放预占，库存恢复

---

## 2. 功能实现状态分析

### 2.1 前置条件功能状态

| 前置条件 | 状态 | 说明 |
|---------|------|------|
| 创建原料SKU | ✅ 已实现 | `skuType: raw_material`，支持ml/g/个等单位 |
| 创建包材SKU | ✅ 已实现 | `skuType: packaging`，支持标准成本手动输入 |
| 创建成品SKU | ✅ 已实现 | `skuType: finished_product`，可关联BOM |
| 配置BOM配方 | ✅ 已实现 | `bom_components`表存在，成本自动计算 |
| 配置单位换算 | 🟡 部分完成 | 数据库表已创建，**配置界面待开发** |
| 吧台库有库存 | 🟡 部分完成 | 库存数据模型存在，**入库操作功能待开发** |

### 2.2 验证步骤功能状态

| 步骤 | 操作 | 状态 | 详细说明 |
|------|------|------|----------|
| **1** | 小程序下单：威士忌可乐 x 1 | 🔴 **未实现** | 系统无小程序点单模块，无订单创建功能 |
| **2** | 订单确认→库存预占 | 🔴 **未实现** | `InventoryReservation.tsx` 显示"订单预占功能开发中..." |
| **3** | 查看库存状态 | 🟡 部分完成 | `InventoryLedger`可查看库存，但预占字段仅展示mock数据 |
| **4** | 吧台出品确认 | 🔴 **未实现** | 无出品确认功能，BOM展开扣减逻辑未开发 |
| **5** | 查看出品记录 | 🔴 **未实现** | 无出品记录模块 |

### 2.3 异常场景功能状态

| 异常场景 | 状态 | 说明 |
|---------|------|------|
| 库存不足提示 | 🔴 **未实现** | 预占时的库存校验逻辑不存在 |
| 出品前取消释放预占 | 🔴 **未实现** | 取消释放Tab显示"功能开发中..." |

---

## 3. 功能缺失汇总

根据 `BOM_MVP_业务需求书` 的功能完成度表：

| 功能需求 | 完成状态 | 现有基础 | 待开发内容 |
|---------|---------|---------|----------|
| FR-01 主数据 | 🟢 已完成 | SKU/SPU/类目/品牌管理 | - |
| FR-02 单位换算 | 🟡 部分完成 | 数据库表已创建 | 换算配置界面 |
| FR-03 配方BOM | 🟡 部分完成 | BomTab组件 | 损耗率预览+消耗计算 |
| FR-04 BOM版本 | 🔴 待开发 | 菜单入口 | 全部核心功能 |
| FR-05 预占+扣减 | 🔴 待开发 | UI框架 | BOM展开+出品扣减 |
| FR-06 预占释放 | 🔴 待开发 | 取消逻辑框架 | 通用化+超时任务 |
| FR-07 退单冲销 | 🔴 待开发 | 无 | 赠饮/报损单+审批 |

---

## 4. 待开发功能清单

### 4.1 核心缺失（必须开发）

#### 4.1.1 小程序点单模块
- [ ] 订单创建API (`POST /api/orders`)
- [ ] 订单列表页面
- [ ] 订单详情页面
- [ ] 订单关联成品SKU和数量

#### 4.1.2 库存预占功能
- [ ] 订单确认时按BOM展开计算原料需求
- [ ] 预占库存锁定逻辑（可用库存 = 现存 - 预占）
- [ ] 库存不足时的错误提示
- [ ] 预占记录表 (`inventory_reservations`)

#### 4.1.3 出品确认功能
- [ ] 出品确认操作界面
- [ ] 预占转实际扣减逻辑
- [ ] 出品记录生成 (`production_records`)
- [ ] 出品记录查询页面

#### 4.1.4 取消/释放功能
- [ ] 订单取消时释放预占库存
- [ ] 超时自动释放任务（定时Job）

### 4.2 需要完善

#### 4.2.1 单位换算配置界面
- [ ] 前端页面 `/bom/conversion`
- [ ] 换算关系CRUD操作
- [ ] 配置1瓶=700ml等自定义换算

#### 4.2.2 库存入库操作
- [ ] 完善 `InventoryOperations.tsx` 的入库Tab
- [ ] 入库单创建和审批流程

---

## 5. 现有代码基础

以下已有的代码可以复用：

| 模块 | 文件 | 可复用内容 |
|------|------|----------|
| SKU服务 | `frontend/src/services/skuService.ts` | BOM组件数据转换、成本计算 |
| 库存服务 | `frontend/src/services/inventoryService.ts` | 库存查询、交易记录API |
| 库存数据模型 | `frontend/src/types/inventory.ts` | `reservedQty`预占字段已定义 |
| 预占UI框架 | `frontend/src/pages/inventory/InventoryReservation.tsx` | 统计卡片、Tab结构 |
| 单位换算表 | `backend/.../V028__create_unit_conversions.sql` | 基础换算数据(ml↔l等) |
| BOM组件表 | `backend/.../V027__create_sku_tables.sql` | `bom_components`表结构 |

---

## 6. 开发优先级建议

```
阶段1: 订单基础
├── 1️⃣ 订单创建API
├── 2️⃣ 订单数据模型
└── 3️⃣ 订单列表/详情页面

阶段2: 预占逻辑
├── 4️⃣ BOM展开计算服务
├── 5️⃣ 库存预占API
└── 6️⃣ 库存不足校验

阶段3: 出品扣减
├── 7️⃣ 出品确认API
├── 8️⃣ 预占转扣减逻辑
└── 9️⃣ 出品记录生成

阶段4: 释放与完善
├── 🔟 取消释放逻辑
├── 1️⃣1️⃣ 超时自动释放Job
└── 1️⃣2️⃣ 单位换算配置界面
```

---

## 7. 验收标准

场景完整验证需满足以下条件：

- [ ] 可以创建包含成品SKU的订单
- [ ] 订单确认后，按BOM展开预占原料库存
- [ ] 库存台账可查看"总量/可用/已占用"三个维度
- [ ] 出品确认后，预占转为实际扣减
- [ ] 取消订单可释放预占库存
- [ ] 库存不足时有明确错误提示

---

## 附录

### A. 相关文档

- [BOM_MVP_业务需求书_敏捷故事卡片.md](./BOM_MVP_业务需求书_敏捷故事卡片.md)
- [P001-sku-master-data Spec](/specs/P001-sku-master-data/spec.md)
- [库存管理Spec](/specs/003-inventory-management/spec.md)

### B. 成本计算公式

```
标准成本 = Σ(组件数量 × 组件单位成本) × (1 + 损耗率%)

示例 - 威士忌可乐:
- 威士忌 45ml × 0.50元/ml = 22.50元
- 可乐 150ml × 0.02元/ml = 3.00元
- 高脚杯 1个 × 2.00元/个 = 2.00元
- 吸管 1根 × 0.10元/根 = 0.10元
- 组件成本合计: 27.60元
- 损耗率: 5%
- 标准成本 = 27.60 × 1.05 = 28.98元
```
