# 威士忌可乐鸡尾酒 - 上架配置指南

**@spec P001-sku-master-data, P005-bom-inventory-deduction, O003-beverage-order**
**文档类型**: 配置操作手册
**适用版本**: v1.0.0
**创建日期**: 2025-12-31
**适用人员**: 运营人员、系统管理员、后台配置人员

---

## 📋 配置概览

### 配置目标
在影院商品管理中台成功上架"威士忌可乐鸡尾酒"成品饮品，包括：
1. ✅ 配置原料 SKU（威士忌、可乐、玻璃杯、吸管）
2. ✅ 配置成品 SKU（威士忌可乐鸡尾酒）
3. ✅ 配置 BOM 配方（成品与原料的对应关系）
4. ✅ 初始化库存（原料和包材库存）
5. ✅ 设置零售价格
6. ✅ 上架并验证

### 业务流程示意图

```
原料 SKU 配置 → 包材 SKU 配置 → 成品 SKU 创建 → BOM 配方配置
       ↓                                              ↓
   库存初始化 ←←←←←←←←←←←←←←←←←←←←←← 成本自动计算 ← 上架发布
```

### 涉及的系统模块

| 模块 | 功能 | 访问路径 |
|------|------|---------|
| SKU 管理 | 创建原料/包材/成品 SKU | B端管理后台 → 商品管理 → SKU 管理 |
| BOM 管理 | 配置成品配方 | B端管理后台 → BOM 配方管理 |
| 库存管理 | 初始化原料库存 | B端管理后台 → 库存管理 → 库存调整 |
| 价格管理 | 设置零售价 | SKU 创建时设置 `price` 字段 |

---

## 📝 配置准备

### 前置条件

- [ ] B端管理后台已启动（http://localhost:3000）
- [ ] 后端 API 已启动（http://localhost:8080）
- [ ] 数据库已初始化（Supabase PostgreSQL）
- [ ] 管理员账号已登录
- [ ] API 认证已配置（库存 API 不返回 403）

### 配置数据准备

**威士忌可乐鸡尾酒配方**:
- **成品名称**: 威士忌可乐鸡尾酒
- **零售价**: ¥35.00
- **主单位**: 杯
- **BOM 配方**:
  - 威士忌: 45ml（单位成本 ¥0.50/ml）
  - 可乐: 150ml（单位成本 ¥0.02/ml）
  - 玻璃杯: 1 个（单位成本 ¥2.00/个）
  - 吸管: 1 根（单位成本 ¥0.10/根）
- **损耗率**: 5%（制作过程中的液体蒸发和操作损耗）

**成本计算**:
```
标准成本 = (45 × 0.50 + 150 × 0.02 + 1 × 2.00 + 1 × 0.10) × (1 + 5%)
         = (22.50 + 3.00 + 2.00 + 0.10) × 1.05
         = 27.60 × 1.05
         = ¥28.98

零售价 = ¥35.00
毛利率 = (35.00 - 28.98) / 35.00 = 17.2%
```

---

## 🔧 配置步骤（方式一：通过 B端管理后台）

### 步骤 1: 创建原料 SKU - 威士忌

**操作路径**: B端管理后台 → 商品管理 → SKU 管理 → 新建 SKU

**操作步骤**:

1. 点击"新建 SKU"按钮
2. 填写 SKU 基本信息:

| 字段 | 值 | 说明 |
|------|-----|------|
| **SKU 类型** | 原料（RAW_MATERIAL） | 必选 |
| **SKU 编码** | `RAW-WHISKEY-001` | 全局唯一，建议格式: `RAW-{品类}-{编号}` |
| **SKU 名称** | `威士忌` | 显示名称 |
| **主单位** | `ml` | 库存单位（毫升） |
| **标准成本** | `0.50` | 每毫升成本（¥0.50/ml） |
| **门店范围** | `[]`（空数组） | 表示全门店可用 |
| **状态** | `启用（ENABLED）` | 上架状态 |
| **备注** | `进口威士忌，用于调制鸡尾酒` | 可选 |

3. 点击"保存"

**验证**:
- [ ] SKU 列表中显示"威士忌"
- [ ] 状态为"启用"
- [ ] 编码为 `RAW-WHISKEY-001`

---

### 步骤 2: 创建原料 SKU - 可乐

**操作步骤**:

1. 点击"新建 SKU"
2. 填写信息:

| 字段 | 值 |
|------|-----|
| SKU 类型 | 原料（RAW_MATERIAL） |
| SKU 编码 | `RAW-COLA-001` |
| SKU 名称 | `可乐` |
| 主单位 | `ml` |
| 标准成本 | `0.02` |
| 门店范围 | `[]` |
| 状态 | `启用（ENABLED）` |
| 备注 | `可口可乐，用于调制鸡尾酒` |

3. 保存

---

### 步骤 3: 创建包材 SKU - 玻璃杯

**操作步骤**:

1. 点击"新建 SKU"
2. 填写信息:

| 字段 | 值 |
|------|-----|
| SKU 类型 | **包材（PACKAGING）** |
| SKU 编码 | `PKG-CUP-GLASS-001` |
| SKU 名称 | `玻璃杯（250ml）` |
| 主单位 | `个` |
| 标准成本 | `2.00` |
| 门店范围 | `[]` |
| 状态 | `启用（ENABLED）` |
| 备注 | `玻璃材质，容量 250ml` |

3. 保存

---

### 步骤 4: 创建包材 SKU - 吸管

**操作步骤**:

1. 点击"新建 SKU"
2. 填写信息:

| 字段 | 值 |
|------|-----|
| SKU 类型 | **包材（PACKAGING）** |
| SKU 编码 | `PKG-STRAW-001` |
| SKU 名称 | `一次性吸管` |
| 主单位 | `根` |
| 标准成本 | `0.10` |
| 门店范围 | `[]` |
| 状态 | `启用（ENABLED）` |
| 备注 | `一次性塑料吸管` |

3. 保存

---

### 步骤 5: 创建成品 SKU - 威士忌可乐鸡尾酒

**操作步骤**:

1. 点击"新建 SKU"
2. 填写信息:

| 字段 | 值 | 说明 |
|------|-----|------|
| SKU 类型 | **成品（FINISHED_PRODUCT）** | 重要：选择成品类型 |
| SKU 编码 | `PROD-COCKTAIL-WHISKEY-COLA-001` | 建议格式: `PROD-{品类}-{名称}-{编号}` |
| SKU 名称 | `威士忌可乐鸡尾酒` | 显示在 C端的商品名称 |
| 主单位 | `杯` | 销售单位 |
| **零售价** | `35.00` | 售价（¥35.00/杯） |
| **损耗率** | `5.0` | 损耗率 5%（制作过程中的损耗） |
| 标准成本 | `留空` | 系统根据 BOM 自动计算 |
| 门店范围 | `[]` | 全门店可用 |
| **状态** | `草稿（DRAFT）` | ⚠️ 先保存为草稿，配置 BOM 后再上架 |
| 商品描述 | `经典威士忌可乐鸡尾酒，口感醇厚，回味悠长` | 显示在 C端商品详情 |

3. 点击"保存并继续配置 BOM"（或先保存，后续再配置 BOM）

**注意事项**:
- ⚠️ 成品 SKU 的标准成本不需要手动输入，系统会在配置 BOM 后自动计算
- ⚠️ 状态先设置为"草稿"，配置完 BOM 并验证无误后再改为"启用"上架

---

### 步骤 6: 配置 BOM 配方

**操作路径**: B端管理后台 → BOM 配方管理 → 选择"威士忌可乐鸡尾酒" → 配置 BOM

**操作步骤**:

1. 在 SKU 列表中找到"威士忌可乐鸡尾酒"，点击"配置 BOM"
2. 点击"添加组件"，逐一添加原料和包材:

**组件 1: 威士忌**

| 字段 | 值 |
|------|-----|
| 组件 SKU | 选择"威士忌"（`RAW-WHISKEY-001`） |
| 数量 | `45` |
| 单位 | `ml` |
| 是否可选 | `否` |
| 排序 | `1` |

**组件 2: 可乐**

| 字段 | 值 |
|------|-----|
| 组件 SKU | 选择"可乐"（`RAW-COLA-001`） |
| 数量 | `150` |
| 单位 | `ml` |
| 是否可选 | `否` |
| 排序 | `2` |

**组件 3: 玻璃杯**

| 字段 | 值 |
|------|-----|
| 组件 SKU | 选择"玻璃杯（250ml）"（`PKG-CUP-GLASS-001`） |
| 数量 | `1` |
| 单位 | `个` |
| 是否可选 | `否` |
| 排序 | `3` |

**组件 4: 吸管**

| 字段 | 值 |
|------|-----|
| 组件 SKU | 选择"一次性吸管"（`PKG-STRAW-001`） |
| 数量 | `1` |
| 单位 | `根` |
| 是否可选 | `否` |
| 排序 | `4` |

3. 点击"保存 BOM 配置"

**验证**:
- [ ] BOM 组件列表显示 4 个组件
- [ ] 系统自动计算标准成本: **¥28.98**（= (45×0.50 + 150×0.02 + 1×2.00 + 1×0.10) × 1.05）
- [ ] SKU 详情页显示"标准成本: ¥28.98"

**成本自动计算公式**:
```
标准成本 = Σ(组件数量 × 组件单位成本) × (1 + 损耗率)
```

---

### 步骤 7: 初始化库存（原料和包材）

**操作路径**: B端管理后台 → 库存管理 → 库存调整 → 新建调整单

**原则**:
- ✅ 原料和包材需要初始化库存
- ❌ 成品不需要初始化库存（通过销售订单扣减原料，成品是虚拟库存）

**操作步骤**:

1. 点击"新建库存调整单"
2. 选择调整类型: **盘盈**（PROFIT）
3. 选择门店: `测试门店 A`（或您的实际门店）
4. 添加调整明细:

**调整明细 1: 威士忌**

| 字段 | 值 |
|------|-----|
| SKU | 选择"威士忌" |
| 调整数量 | `+1000` |
| 单位 | `ml` |
| 调整原因 | `初始化库存 - 威士忌可乐鸡尾酒原料` |

**调整明细 2: 可乐**

| 字段 | 值 |
|------|-----|
| SKU | 选择"可乐" |
| 调整数量 | `+5000` |
| 单位 | `ml` |
| 调整原因 | `初始化库存 - 威士忌可乐鸡尾酒原料` |

**调整明细 3: 玻璃杯**

| 字段 | 值 |
|------|-----|
| SKU | 选择"玻璃杯（250ml）" |
| 调整数量 | `+100` |
| 单位 | `个` |
| 调整原因 | `初始化库存 - 威士忌可乐鸡尾酒包材` |

**调整明细 4: 吸管**

| 字段 | 值 |
|------|-----|
| SKU | 选择"一次性吸管" |
| 调整数量 | `+500` |
| 单位 | `根` |
| 调整原因 | `初始化库存 - 威士忌可乐鸡尾酒包材` |

5. 点击"保存并提交"

**验证库存**:

导航到: B端管理后台 → 库存管理 → 库存查询

| SKU | 现存库存 (on_hand) | 预占库存 (reserved) | 可用库存 (available) |
|-----|-------------------|-------------------|---------------------|
| 威士忌 | 1000 ml | 0 ml | 1000 ml |
| 可乐 | 5000 ml | 0 ml | 5000 ml |
| 玻璃杯 | 100 个 | 0 个 | 100 个 |
| 吸管 | 500 根 | 0 根 | 500 根 |

**可制作杯数计算**:
```
威士忌: 1000ml ÷ 45ml = 22 杯
可乐: 5000ml ÷ 150ml = 33 杯
玻璃杯: 100 个 ÷ 1 = 100 杯
吸管: 500 根 ÷ 1 = 500 杯

实际可制作: min(22, 33, 100, 500) = 22 杯（受威士忌库存限制）
```

---

### 步骤 8: 设置安全库存（可选）

**操作路径**: B端管理后台 → 库存管理 → 安全库存配置

**推荐设置**:

| SKU | 安全库存 | 说明 |
|-----|---------|------|
| 威士忌 | 500 ml | 当库存低于 500ml 时预警 |
| 可乐 | 2000 ml | 当库存低于 2000ml 时预警 |
| 玻璃杯 | 50 个 | 当库存低于 50 个时预警 |
| 吸管 | 200 根 | 当库存低于 200 根时预警 |

**作用**: 系统会在库存低于安全库存时发送告警通知（需要配置告警服务）

---

### 步骤 9: 上架发布

**操作路径**: B端管理后台 → 商品管理 → SKU 管理 → 找到"威士忌可乐鸡尾酒"

**操作步骤**:

1. 找到 SKU "威士忌可乐鸡尾酒"
2. 点击"编辑"
3. 修改状态: `草稿（DRAFT）` → **`启用（ENABLED）`**
4. 点击"保存"

**验证上架成功**:
- [ ] SKU 列表中状态显示"启用"
- [ ] 标准成本显示: ¥28.98
- [ ] 零售价显示: ¥35.00
- [ ] BOM 配方完整（4 个组件）

---

### 步骤 10: C端验证（小程序/H5）

**操作步骤**:

1. 打开 C端 H5 页面: `http://localhost:10086`
2. 登录测试用户账号
3. 浏览商品页面
4. 查找"威士忌可乐鸡尾酒"
5. 查看商品详情:
   - 商品名称: 威士忌可乐鸡尾酒
   - 价格: ¥35.00
   - 商品描述: 经典威士忌可乐鸡尾酒...
6. 点击"加入购物车"
7. 提交订单

**验证库存预占**:

下单后，查看库存管理 → 库存查询:

| SKU | 现存库存 (on_hand) | 预占库存 (reserved) | 可用库存 (available) |
|-----|-------------------|-------------------|---------------------|
| 威士忌 | **1000 ml**（不变） | **45 ml**（增加） | **955 ml**（减少） |
| 可乐 | **5000 ml**（不变） | **150 ml**（增加） | **4850 ml**（减少） |
| 玻璃杯 | **100 个**（不变） | **1 个**（增加） | **99 个**（减少） |
| 吸管 | **500 根**（不变） | **1 根**（增加） | **499 根**（减少） |

✅ 预占成功：`on_hand` 不变，`reserved` 增加，`available` 减少

---

## 🖥️ 配置步骤（方式二：通过 API）

### API 配置优势
- ✅ 批量导入商品
- ✅ 自动化脚本执行
- ✅ 适合数据迁移

### API 端点清单

| API 端点 | 方法 | 功能 |
|---------|------|------|
| `/api/skus` | POST | 创建 SKU |
| `/api/skus/{id}` | PUT | 更新 SKU |
| `/api/skus/{id}/bom` | PUT | 配置 BOM |
| `/api/inventory/adjustments` | POST | 库存调整 |

### 完整 API 配置脚本

#### 1. 创建原料 SKU

**请求**: `POST /api/skus`

```json
// 威士忌
{
  "code": "RAW-WHISKEY-001",
  "name": "威士忌",
  "skuType": "raw_material",
  "mainUnit": "ml",
  "standardCost": 0.50,
  "storeScope": [],
  "status": "enabled",
  "description": "进口威士忌，用于调制鸡尾酒"
}

// 可乐
{
  "code": "RAW-COLA-001",
  "name": "可乐",
  "skuType": "raw_material",
  "mainUnit": "ml",
  "standardCost": 0.02,
  "storeScope": [],
  "status": "enabled",
  "description": "可口可乐，用于调制鸡尾酒"
}
```

**响应**: 返回创建的 SKU，记录 `id` 字段备用

```json
{
  "id": "uuid-whiskey-001",
  "code": "RAW-WHISKEY-001",
  "name": "威士忌",
  ...
}
```

#### 2. 创建包材 SKU

```json
// 玻璃杯
{
  "code": "PKG-CUP-GLASS-001",
  "name": "玻璃杯（250ml）",
  "skuType": "packaging",
  "mainUnit": "个",
  "standardCost": 2.00,
  "storeScope": [],
  "status": "enabled",
  "description": "玻璃材质，容量 250ml"
}

// 吸管
{
  "code": "PKG-STRAW-001",
  "name": "一次性吸管",
  "skuType": "packaging",
  "mainUnit": "根",
  "standardCost": 0.10,
  "storeScope": [],
  "status": "enabled",
  "description": "一次性塑料吸管"
}
```

#### 3. 创建成品 SKU

**请求**: `POST /api/skus`

```json
{
  "code": "PROD-COCKTAIL-WHISKEY-COLA-001",
  "name": "威士忌可乐鸡尾酒",
  "skuType": "finished_product",
  "mainUnit": "杯",
  "price": 35.00,
  "wasteRate": 5.0,
  "storeScope": [],
  "status": "draft",
  "description": "经典威士忌可乐鸡尾酒，口感醇厚，回味悠长"
}
```

**响应**: 记录成品 SKU 的 `id`（用于配置 BOM）

```json
{
  "id": "uuid-cocktail-001",
  "code": "PROD-COCKTAIL-WHISKEY-COLA-001",
  ...
}
```

#### 4. 配置 BOM

**请求**: `PUT /api/skus/{成品ID}/bom`

```json
{
  "components": [
    {
      "componentId": "uuid-whiskey-001",
      "quantity": 45,
      "unit": "ml",
      "isOptional": false,
      "sortOrder": 1
    },
    {
      "componentId": "uuid-cola-001",
      "quantity": 150,
      "unit": "ml",
      "isOptional": false,
      "sortOrder": 2
    },
    {
      "componentId": "uuid-cup-001",
      "quantity": 1,
      "unit": "个",
      "isOptional": false,
      "sortOrder": 3
    },
    {
      "componentId": "uuid-straw-001",
      "quantity": 1,
      "unit": "根",
      "isOptional": false,
      "sortOrder": 4
    }
  ],
  "wasteRate": 5.0
}
```

**响应**: 返回更新后的 SKU，包含自动计算的 `standardCost`

```json
{
  "id": "uuid-cocktail-001",
  "standardCost": 28.98,
  "bomComponents": [
    {
      "componentId": "uuid-whiskey-001",
      "componentName": "威士忌",
      "quantity": 45,
      "unit": "ml",
      "unitCost": 0.50
    },
    ...
  ]
}
```

#### 5. 初始化库存

**请求**: `POST /api/inventory/adjustments`

```json
{
  "storeId": "store-001",
  "adjustmentType": "profit",
  "reason": "初始化库存 - 威士忌可乐鸡尾酒原料和包材",
  "items": [
    {
      "skuId": "uuid-whiskey-001",
      "quantity": 1000,
      "unit": "ml"
    },
    {
      "skuId": "uuid-cola-001",
      "quantity": 5000,
      "unit": "ml"
    },
    {
      "skuId": "uuid-cup-001",
      "quantity": 100,
      "unit": "个"
    },
    {
      "skuId": "uuid-straw-001",
      "quantity": 500,
      "unit": "根"
    }
  ]
}
```

#### 6. 上架发布

**请求**: `PUT /api/skus/{成品ID}`

```json
{
  "status": "enabled"
}
```

---

## 🛠️ 配置步骤（方式三：通过 SQL）

### SQL 配置优势
- ✅ 适合开发/测试环境快速初始化
- ✅ 批量导入大量商品
- ✅ 数据库直接操作，执行速度快

### 完整 SQL 配置脚本

```sql
-- ============================================
-- 威士忌可乐鸡尾酒 - SQL 配置脚本
-- 执行环境: Supabase SQL Editor 或 PostgreSQL 客户端
-- ============================================

-- 1. 创建原料 SKU（威士忌、可乐）
INSERT INTO skus (id, code, name, sku_type, main_unit, standard_cost, store_scope, status, description, created_at)
VALUES
  (gen_random_uuid(), 'RAW-WHISKEY-001', '威士忌', 'raw_material', 'ml', 0.50, '[]', 'enabled', '进口威士忌，用于调制鸡尾酒', NOW()),
  (gen_random_uuid(), 'RAW-COLA-001', '可乐', 'raw_material', 'ml', 0.02, '[]', 'enabled', '可口可乐，用于调制鸡尾酒', NOW());

-- 2. 创建包材 SKU（玻璃杯、吸管）
INSERT INTO skus (id, code, name, sku_type, main_unit, standard_cost, store_scope, status, description, created_at)
VALUES
  (gen_random_uuid(), 'PKG-CUP-GLASS-001', '玻璃杯（250ml）', 'packaging', '个', 2.00, '[]', 'enabled', '玻璃材质，容量 250ml', NOW()),
  (gen_random_uuid(), 'PKG-STRAW-001', '一次性吸管', 'packaging', '根', 0.10, '[]', 'enabled', '一次性塑料吸管', NOW());

-- 3. 创建成品 SKU（威士忌可乐鸡尾酒）
INSERT INTO skus (id, code, name, sku_type, main_unit, price, waste_rate, store_scope, status, description, created_at)
VALUES
  (gen_random_uuid(), 'PROD-COCKTAIL-WHISKEY-COLA-001', '威士忌可乐鸡尾酒', 'finished_product', '杯', 35.00, 5.0, '[]', 'draft', '经典威士忌可乐鸡尾酒，口感醇厚，回味悠长', NOW());

-- 4. 配置 BOM 组件
-- 注意：需要先查询 SKU 的 UUID，替换下面的 {成品ID}、{原料ID} 等占位符

-- 查询 SKU ID（用于后续 INSERT）
SELECT id, code, name FROM skus WHERE code IN (
  'PROD-COCKTAIL-WHISKEY-COLA-001',
  'RAW-WHISKEY-001',
  'RAW-COLA-001',
  'PKG-CUP-GLASS-001',
  'PKG-STRAW-001'
);

-- 假设查询到的 ID 为：
-- 成品: '11111111-1111-1111-1111-111111111111'
-- 威士忌: '22222222-2222-2222-2222-222222222222'
-- 可乐: '33333333-3333-3333-3333-333333333333'
-- 玻璃杯: '44444444-4444-4444-4444-444444444444'
-- 吸管: '55555555-5555-5555-5555-555555555555'

-- 插入 BOM 组件（替换成实际 UUID）
INSERT INTO bom_components (finished_product_id, component_id, quantity, unit, unit_cost, is_optional, sort_order, created_at)
VALUES
  ('11111111-1111-1111-1111-111111111111', '22222222-2222-2222-2222-222222222222', 45, 'ml', 0.50, false, 1, NOW()),
  ('11111111-1111-1111-1111-111111111111', '33333333-3333-3333-3333-333333333333', 150, 'ml', 0.02, false, 2, NOW()),
  ('11111111-1111-1111-1111-111111111111', '44444444-4444-4444-4444-444444444444', 1, '个', 2.00, false, 3, NOW()),
  ('11111111-1111-1111-1111-111111111111', '55555555-5555-5555-5555-555555555555', 1, '根', 0.10, false, 4, NOW());

-- 5. 更新成品标准成本（手动计算或调用存储过程）
UPDATE skus
SET standard_cost = 28.98,  -- (45*0.50 + 150*0.02 + 1*2.00 + 1*0.10) * 1.05
    updated_at = NOW()
WHERE code = 'PROD-COCKTAIL-WHISKEY-COLA-001';

-- 6. 初始化库存（假设门店 ID 为 'store-001'）
INSERT INTO store_inventory (sku_id, store_id, current_quantity, reserved_quantity, available_quantity, safety_stock, updated_at)
SELECT
  id AS sku_id,
  'store-001' AS store_id,
  CASE code
    WHEN 'RAW-WHISKEY-001' THEN 1000
    WHEN 'RAW-COLA-001' THEN 5000
    WHEN 'PKG-CUP-GLASS-001' THEN 100
    WHEN 'PKG-STRAW-001' THEN 500
  END AS current_quantity,
  0 AS reserved_quantity,
  CASE code
    WHEN 'RAW-WHISKEY-001' THEN 1000
    WHEN 'RAW-COLA-001' THEN 5000
    WHEN 'PKG-CUP-GLASS-001' THEN 100
    WHEN 'PKG-STRAW-001' THEN 500
  END AS available_quantity,
  CASE code
    WHEN 'RAW-WHISKEY-001' THEN 500
    WHEN 'RAW-COLA-001' THEN 2000
    WHEN 'PKG-CUP-GLASS-001' THEN 50
    WHEN 'PKG-STRAW-001' THEN 200
  END AS safety_stock,
  NOW() AS updated_at
FROM skus
WHERE code IN ('RAW-WHISKEY-001', 'RAW-COLA-001', 'PKG-CUP-GLASS-001', 'PKG-STRAW-001');

-- 7. 上架发布（将状态改为 enabled）
UPDATE skus
SET status = 'enabled',
    updated_at = NOW()
WHERE code = 'PROD-COCKTAIL-WHISKEY-COLA-001';

-- ============================================
-- 验证数据
-- ============================================

-- 查询成品 SKU 详情
SELECT
  s.code,
  s.name,
  s.sku_type,
  s.main_unit,
  s.standard_cost,
  s.price,
  s.waste_rate,
  s.status,
  (SELECT COUNT(*) FROM bom_components WHERE finished_product_id = s.id) AS bom_component_count
FROM skus s
WHERE s.code = 'PROD-COCKTAIL-WHISKEY-COLA-001';

-- 查询 BOM 组件明细
SELECT
  s_finished.name AS finished_product_name,
  s_component.code AS component_code,
  s_component.name AS component_name,
  bc.quantity,
  bc.unit,
  bc.unit_cost,
  bc.sort_order
FROM bom_components bc
JOIN skus s_finished ON bc.finished_product_id = s_finished.id
JOIN skus s_component ON bc.component_id = s_component.id
WHERE s_finished.code = 'PROD-COCKTAIL-WHISKEY-COLA-001'
ORDER BY bc.sort_order;

-- 查询库存状态
SELECT
  s.code,
  s.name,
  si.current_quantity,
  si.reserved_quantity,
  si.available_quantity,
  si.safety_stock,
  s.main_unit
FROM store_inventory si
JOIN skus s ON si.sku_id = s.id
WHERE s.code IN ('RAW-WHISKEY-001', 'RAW-COLA-001', 'PKG-CUP-GLASS-001', 'PKG-STRAW-001')
  AND si.store_id = 'store-001';
```

---

## ✅ 配置验证清单

### 数据完整性验证

- [ ] **SKU 验证**:
  - [ ] 威士忌 SKU 存在（类型: 原料，状态: 启用）
  - [ ] 可乐 SKU 存在（类型: 原料，状态: 启用）
  - [ ] 玻璃杯 SKU 存在（类型: 包材，状态: 启用）
  - [ ] 吸管 SKU 存在（类型: 包材，状态: 启用）
  - [ ] 威士忌可乐鸡尾酒 SKU 存在（类型: 成品，状态: 启用）

- [ ] **BOM 验证**:
  - [ ] BOM 组件数量 = 4
  - [ ] 组件 1: 威士忌 45ml
  - [ ] 组件 2: 可乐 150ml
  - [ ] 组件 3: 玻璃杯 1 个
  - [ ] 组件 4: 吸管 1 根
  - [ ] 标准成本 = ¥28.98

- [ ] **库存验证**:
  - [ ] 威士忌库存 = 1000ml（现存）+ 0ml（预占）
  - [ ] 可乐库存 = 5000ml（现存）+ 0ml（预占）
  - [ ] 玻璃杯库存 = 100 个（现存）+ 0 个（预占）
  - [ ] 吸管库存 = 500 根（现存）+ 0 根（预占）

- [ ] **价格验证**:
  - [ ] 零售价 = ¥35.00
  - [ ] 毛利率 = 17.2%

### 功能验证

- [ ] **C端验证**:
  - [ ] 商品列表显示"威士忌可乐鸡尾酒"
  - [ ] 商品详情价格显示 ¥35.00
  - [ ] 可以加入购物车
  - [ ] 可以提交订单

- [ ] **预占验证**:
  - [ ] 下单后原料预占库存增加（威士忌 +45ml）
  - [ ] 可用库存减少（威士忌 -45ml）
  - [ ] 现存库存不变

- [ ] **实扣验证**:
  - [ ] 出品确认后现存库存减少
  - [ ] 预占库存释放（归零）
  - [ ] 库存流水记录完整

---

## ⚠️ 常见问题排查

### 问题 1: 成品 SKU 无法保存，提示"标准成本必填"

**原因**: 成品 SKU 在未配置 BOM 之前，标准成本无法自动计算

**解决方案**:
1. 保存成品 SKU 时，状态选择"草稿（DRAFT）"
2. 先保存，再配置 BOM
3. BOM 配置完成后，系统自动计算标准成本
4. 修改状态为"启用（ENABLED）"上架

---

### 问题 2: BOM 配置保存失败，提示"组件不能是成品类型"

**原因**: BOM 组件只能选择"原料"或"包材"类型的 SKU

**解决方案**:
1. 检查选择的组件 SKU 类型
2. 确保组件类型为 `raw_material` 或 `packaging`
3. 不能选择 `finished_product` 或 `combo` 类型

---

### 问题 3: C端商品列表不显示新上架商品

**原因**: 可能是缓存问题或状态未启用

**解决方案**:
1. 确认 SKU 状态为"启用（ENABLED）"，不是"草稿（DRAFT）"
2. 清除 C端浏览器缓存
3. 刷新商品列表页面
4. 检查门店范围配置（空数组表示全门店可用）

---

### 问题 4: 下单时提示"库存不足"

**原因**: 原料或包材库存不足

**排查步骤**:
1. 查看库存管理 → 库存查询
2. 检查可用库存（available = on_hand - reserved）
3. 计算所需原料:
   - 威士忌: 45ml × 订单数量
   - 可乐: 150ml × 订单数量
   - 玻璃杯: 1 个 × 订单数量
   - 吸管: 1 根 × 订单数量
4. 如果不足，通过"库存调整"功能补充库存

---

### 问题 5: 标准成本计算错误

**原因**: BOM 组件的单位成本快照未更新，或损耗率配置错误

**解决方案**:
1. 检查 BOM 组件的 `unit_cost`（单位成本快照）
2. 确认损耗率设置正确（5.0 表示 5%，不是 0.05）
3. 手动触发成本重新计算:
   - 通过 API: `POST /api/skus/{id}/recalculate-cost`
   - 或重新保存 BOM 配置

**验证公式**:
```
标准成本 = Σ(组件数量 × 组件单位成本) × (1 + 损耗率/100)
         = (45×0.50 + 150×0.02 + 1×2.00 + 1×0.10) × (1 + 5/100)
         = 27.60 × 1.05
         = ¥28.98
```

---

## 📚 相关文档参考

| 文档名称 | 路径 | 说明 |
|---------|------|------|
| SKU 主数据规格 | `specs/P001-sku-master-data/spec.md` | SKU 功能完整说明 |
| BOM 库存扣料规格 | `specs/P005-bom-inventory-deduction/spec.md` | BOM 预占实扣流程 |
| 饮品上架操作指南 | `specs/O003-beverage-order/饮品上架操作指南.md` | 饮品 SQL 配置方式 |
| 商家配置手册 | `specs/O003-beverage-order/商家配置手册.md` | 完整配置参考 |
| API 契约文档 | `specs/P001-sku-master-data/contracts/api.yaml` | REST API 规范 |
| BOM 人工验证方法 | `docs/manual-testing/BOM-库存预占实扣-人工验证方法.md` | 测试验证指南 |

---

## 📊 配置完成后的数据状态

### SKU 数据汇总

| SKU 编码 | SKU 名称 | 类型 | 单位 | 标准成本 | 零售价 | 状态 |
|---------|---------|------|------|---------|--------|------|
| RAW-WHISKEY-001 | 威士忌 | 原料 | ml | ¥0.50 | - | 启用 |
| RAW-COLA-001 | 可乐 | 原料 | ml | ¥0.02 | - | 启用 |
| PKG-CUP-GLASS-001 | 玻璃杯（250ml） | 包材 | 个 | ¥2.00 | - | 启用 |
| PKG-STRAW-001 | 一次性吸管 | 包材 | 根 | ¥0.10 | - | 启用 |
| PROD-COCKTAIL-WHISKEY-COLA-001 | 威士忌可乐鸡尾酒 | 成品 | 杯 | ¥28.98 | ¥35.00 | 启用 |

### BOM 配方汇总

**成品**: 威士忌可乐鸡尾酒（1 杯）

| 序号 | 组件名称 | 数量 | 单位 | 单位成本 | 小计 |
|-----|---------|------|------|---------|------|
| 1 | 威士忌 | 45 | ml | ¥0.50 | ¥22.50 |
| 2 | 可乐 | 150 | ml | ¥0.02 | ¥3.00 |
| 3 | 玻璃杯 | 1 | 个 | ¥2.00 | ¥2.00 |
| 4 | 吸管 | 1 | 根 | ¥0.10 | ¥0.10 |
| - | **合计** | - | - | - | **¥27.60** |
| - | **损耗率** | - | - | - | **5%** |
| - | **标准成本** | - | - | - | **¥28.98** |

### 库存数据汇总

**门店**: 测试门店 A

| SKU 名称 | 现存库存 | 预占库存 | 可用库存 | 安全库存 | 单位 |
|---------|---------|---------|---------|---------|------|
| 威士忌 | 1000 | 0 | 1000 | 500 | ml |
| 可乐 | 5000 | 0 | 5000 | 2000 | ml |
| 玻璃杯 | 100 | 0 | 100 | 50 | 个 |
| 吸管 | 500 | 0 | 500 | 200 | 根 |

**理论可制作数量**: 22 杯（受威士忌库存限制）

---

**配置完成！** 🎉

现在"威士忌可乐鸡尾酒"已成功上架，用户可以在 C端下单购买。系统会自动处理 BOM 库存预占和实扣流程。
