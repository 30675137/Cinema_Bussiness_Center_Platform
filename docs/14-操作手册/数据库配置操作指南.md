# P005 数据库配置操作指南

## 📋 概述

本指南帮助您完成 P005-bom-inventory-deduction 所需的数据库表配置和测试数据导入。

**需要执行的 SQL 脚本**:
1. `backend/src/main/resources/db/migration/V054__p005_manual_setup.sql` - 创建表结构
2. `tests/e2e/setup-test-data-direct.sql` - 导入测试数据

---

## 🚀 方式1: 使用 Supabase Dashboard (推荐)

### 步骤 1: 登录 Supabase Dashboard

1. 打开浏览器访问: https://supabase.com/dashboard
2. 登录您的账号
3. 选择项目: `fxhgyxceqrmnpezluaht`

### 步骤 2: 打开 SQL Editor

1. 在左侧菜单点击 **"SQL Editor"** 或 **"SQL"**
2. 点击 **"New query"** 创建新查询

### 步骤 3: 执行建表脚本

1. **复制建表脚本内容**:
   ```bash
   cat /Users/lining/qoder/Cinema_Bussiness_Center_Platform/backend/src/main/resources/db/migration/V054__p005_manual_setup.sql
   ```

2. **粘贴到 SQL Editor**

3. **点击 "RUN" 或按 Ctrl+Enter 执行**

4. **验证结果**:
   - 应该看到 "Success. No rows returned" 或类似成功提示
   - 检查是否有红色错误信息

### 步骤 4: 执行测试数据脚本

1. **创建新查询** (New query)

2. **复制测试数据脚本内容**:
   ```bash
   cat /Users/lining/qoder/Cinema_Bussiness_Center_Platform/tests/e2e/setup-test-data-direct.sql
   ```

3. **粘贴到 SQL Editor**

4. **点击 "RUN" 执行**

5. **验证结果**:
   - 最后应该看到类似这样的输出:
     ```
     status: "Test data setup complete!"
     test_skus_count: 8
     bom_components_count: 7
     inventory_records_count: 6
     ```

### 步骤 5: 验证数据

在 SQL Editor 中执行以下查询验证数据已导入:

```sql
-- 检查测试 SKU
SELECT * FROM skus WHERE code LIKE 'TEST-%';

-- 检查 BOM 配方
SELECT * FROM bom_components
WHERE parent_sku_id IN (SELECT id FROM skus WHERE code LIKE 'TEST-%');

-- 检查库存
SELECT * FROM store_inventory
WHERE store_id = '00000000-0000-0000-0000-000000000099'::uuid;

-- 检查测试门店
SELECT * FROM stores WHERE code = 'TS-P005';
```

---

## 🖥️ 方式2: 使用命令行工具

### 前提条件

需要安装 PostgreSQL 客户端工具 `psql`。

**macOS 安装**:
```bash
brew install postgresql
```

**验证安装**:
```bash
psql --version
```

### 执行 SQL 脚本

从项目根目录执行:

```bash
# 设置数据库连接信息
export PGPASSWORD='Pgsql.2024'

# 执行建表脚本
psql -h aws-0-ap-southeast-1.pooler.supabase.com \
     -p 6543 \
     -U postgres.fxhgyxceqrmnpezluaht \
     -d postgres \
     -f backend/src/main/resources/db/migration/V054__p005_manual_setup.sql

# 执行测试数据脚本
psql -h aws-0-ap-southeast-1.pooler.supabase.com \
     -p 6543 \
     -U postgres.fxhgyxceqrmnpezluaht \
     -d postgres \
     -f tests/e2e/setup-test-data-direct.sql
```

---

## 🔧 方式3: 使用自动化脚本 (一键执行)

我可以为您创建一个自动化脚本，通过后端 API 或 Node.js 直接连接数据库执行。

**需要吗？请告诉我，我可以立即创建。**

---

## ✅ 完成后验证

### 1. 重启后端服务

```bash
cd /Users/lining/qoder/Cinema_Bussiness_Center_Platform/backend

# 停止当前服务
kill $(cat ../backend.pid) 2>/dev/null

# 启动服务
nohup java -jar target/hall-store-backend-0.0.1-SNAPSHOT.jar > backend.log 2>&1 &
echo $! > ../backend.pid

# 等待启动
sleep 10

# 检查是否启动成功
grep "Started HallStoreBackendApplication" backend.log
```

### 2. 重新运行 E2E 测试

```bash
cd /Users/lining/qoder/Cinema_Bussiness_Center_Platform

NODE_OPTIONS='--experimental-vm-modules --no-warnings' \
npx jest tests/e2e/p005-bom-inventory-simplified.test.ts \
--config jest.e2e.config.cjs --verbose
```

### 3. 预期结果

如果数据库配置成功，应该看到：
- ✅ 测试响应状态码从 500 变为 200/201
- ✅ 可以看到实际的库存预占和扣减数据
- ✅ BOM 展开结果
- ✅ 预占记录创建成功

---

## 🐛 常见问题

### Q1: 连接被拒绝 "connection refused"

**原因**: 网络问题或连接池已满

**解决**:
1. 检查网络连接
2. 等待几分钟后重试
3. 使用 Supabase Dashboard（推荐）

---

### Q2: 表已存在错误 "relation already exists"

**原因**: 表已经创建过了

**解决**:
- V054 脚本使用了 `IF NOT EXISTS`，理论上不会报错
- 如果确实报错，可以跳过建表脚本，直接执行测试数据脚本

---

### Q3: 约束冲突 "violates check constraint"

**原因**: 现有数据不符合约束条件

**解决**:
V054 脚本已包含数据修复逻辑:
```sql
UPDATE store_inventory
SET reserved_qty = 0
WHERE reserved_qty > on_hand_qty;
```

如果仍然报错，在 SQL Editor 中手动执行这段 UPDATE 语句。

---

## 📊 执行后的数据结构

成功后，数据库中将包含：

### 测试门店
- ID: `00000000-0000-0000-0000-000000000099`
- Code: `TS-P005`
- Name: `Test Store P005`

### 测试 SKU (8个)
- 原料: Whiskey, Cola, Cup, Straw, Snack
- 成品: Cocktail, Combo Set A, 4-Level Product

### BOM 配方 (7条)
- Cocktail = 45ml Whiskey + 150ml Cola + 1 Cup + 1 Straw
- Combo Set A = 2 Cocktails + 1 Snack
- 4-Level Product = 1 Combo Set A (用于边界测试)

### 库存记录 (6条)
- 各原料充足库存
- 成品少量库存（测试不足场景）

---

## 🎯 下一步

数据库配置完成后，您可以：

1. **查看实际业务逻辑效果**:
   - 观察库存预占后 `reserved_qty` 的变化
   - 观察库存扣减后 `on_hand_qty` 的变化
   - 查看 BOM 快照表中的版本锁定数据

2. **测试并发场景**:
   - 同时发起多个预占请求
   - 验证悲观锁是否防止了超卖

3. **测试边界条件**:
   - 测试 4 层 BOM 是否被正确拒绝
   - 测试库存不足时的错误提示

---

**需要帮助吗？**

如果遇到任何问题，或者希望我创建自动化脚本执行，请告诉我！
