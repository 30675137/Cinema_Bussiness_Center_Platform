# 用户手册: 饮品订单创建与出品管理

**Feature**: O003-beverage-order
**Version**: 1.0.0
**Date**: 2025-12-28
**适用对象**: C端用户（顾客）、B端用户（吧台/厨房工作人员、店长）

---

## 目录

1. [功能概述](#功能概述)
2. [C端用户操作指南](#c端用户操作指南)
3. [B端订单管理操作指南](#b端订单管理操作指南)
4. [B端饮品配置管理操作指南](#b端饮品配置管理操作指南)
5. [常见问题 FAQ](#常见问题-faq)
6. [注意事项](#注意事项)

---

## 功能概述

### 系统简介

饮品订单管理系统是影院商品管理中台的核心模块之一,支持顾客在小程序上点单购买饮品,吧台/厨房工作人员接收订单并进行制作出品,实现从点单到取餐的全流程数字化管理。

### 核心功能

| 功能模块 | 适用对象 | 说明 |
|---------|---------|------|
| 饮品浏览与点单 | C端用户（顾客） | 浏览菜单、选择规格、下单支付 |
| 订单接收与出品 | B端用户（工作人员） | 实时接收订单、管理制作流程、叫号交付 |
| 饮品配置管理 | B端用户（店长/管理员） | 管理饮品菜单、规格、配方（BOM） |
| 订单历史查询 | C端 + B端 | 查看历史订单、统计分析 |

### 业务流程图

```
C端用户流程:
浏览菜单 → 选择饮品 → 选择规格 → 添加订单 → 支付 → 等待叫号 → 取餐

B端工作人员流程:
接收订单 → 开始制作(自动扣料) → 制作完成 → 叫号 → 交付饮品
```

---

## C端用户操作指南

### 1. 浏览饮品菜单

#### 操作步骤

1. 打开微信小程序/H5页面
2. 进入"饮品订单"模块
3. 查看饮品列表,可按分类筛选:
   - ☕ 咖啡 (COFFEE)
   - 🍵 茶饮 (TEA)
   - 🧃 果汁 (JUICE)
   - 🥤 冰沙 (SMOOTHIE)
   - 🧋 奶茶 (MILK_TEA)
   - 其他 (OTHER)

#### 界面说明

![菜单界面示例](./images/menu-page.png)

- **饮品卡片**: 显示饮品图片、名称、基础价格
- **推荐标签**: 带有"推荐"标签的饮品优先展示
- **缺货标识**: 缺货饮品显示"暂时缺货"灰色标签,不可点击

#### 示例

```
┌─────────────────────────────┐
│  ☕ 咖啡                     │
├─────────────────────────────┤
│ [🏷推荐] 拿铁咖啡  ¥18      │
│ 美式咖啡          ¥15      │
│ 卡布奇诺          ¥20      │
│ [缺货] 摩卡咖啡   ¥22      │
└─────────────────────────────┘
```

---

### 2. 选择饮品与规格

#### 操作步骤

1. 点击饮品卡片进入详情页
2. 查看饮品描述、营养信息、详情图片
3. 选择规格:
   - **大小 (SIZE)**: 中杯、大杯（加价¥3）
   - **温度 (TEMPERATURE)**: 热、冰
   - **甜度 (SWEETNESS)**: 标准糖、半糖、无糖
   - **配料 (TOPPING)**: 不加配料、珍珠（加价¥2）、椰果（加价¥2）
4. 选择数量（默认1杯,可调整）
5. 添加备注（可选,如"少冰""多奶"）
6. 点击"加入订单"按钮

#### 价格计算规则

```
最终价格 = 基础价格 + SUM(所选规格的价格调整) × 数量

示例:
拿铁咖啡基础价格: ¥18
选择: 大杯(+¥3) + 热(¥0) + 半糖(¥0) + 珍珠(+¥2)
单价 = 18 + 3 + 0 + 0 + 2 = ¥23
数量 = 2杯
总价 = 23 × 2 = ¥46
```

#### 界面说明

![规格选择界面](./images/beverage-detail.png)

---

### 3. 提交订单与支付

#### 操作步骤

1. 点击"立即下单"按钮
2. 确认订单信息:
   - 订单项列表（饮品名称、规格、数量、小计）
   - 订单总价
   - 备注信息
3. 点击"确认支付"
4. **支付方式**（MVP阶段）:
   - 点击"支付"按钮即自动完成支付（Mock支付,无需真实付款）
   - 生产环境将集成微信支付

#### 支付完成后

系统自动生成:
- **订单号**: 如 `BO20251228150530ABCD`
- **取餐号**: 如 `001`（当日序号,每日重置）

界面提示:
```
✅ 支付成功！

订单号: BO20251228150530ABCD
取餐号: 001

请等待叫号取餐
您可以在"我的订单"中查看制作进度
```

---

### 4. 查看订单状态

#### 操作步骤

1. 进入"我的订单"页面
2. 查看订单列表,显示订单状态:
   - 🟡 **待支付** (PENDING_PAYMENT): 订单已创建,等待支付
   - 🟠 **待制作** (PENDING_PRODUCTION): 支付完成,等待工作人员开始制作
   - 🔵 **制作中** (PRODUCING): 正在制作中
   - 🟢 **已完成** (COMPLETED): 制作完成,等待叫号取餐
   - ⚪ **已交付** (DELIVERED): 已取餐
   - ⚫ **已取消** (CANCELLED): 订单已取消

#### 订单详情

点击订单卡片查看详情:
- 订单号、取餐号
- 订单项列表（饮品、规格、数量、单价）
- 订单总价、支付方式、支付时间
- 订单状态变更历史
- 制作开始时间、完成时间、交付时间

#### 实时状态更新

- 系统每8秒自动刷新订单状态（轮询）
- 订单状态变更时,界面自动更新
- 制作完成后,显示"请到吧台取餐"提示

#### 界面示例

```
┌────────────────────────────────┐
│ 订单号: BO20251228150530ABCD   │
│ 取餐号: 001                    │
│ 状态: 🔵 制作中                │
├────────────────────────────────┤
│ 拿铁咖啡 x2                    │
│ 大杯/热/半糖/珍珠              │
│ ¥23 × 2 = ¥46                 │
├────────────────────────────────┤
│ 总价: ¥46                      │
│ 支付时间: 2025-12-28 15:05    │
└────────────────────────────────┘
```

---

### 5. 取餐流程

#### 操作步骤

1. 等待吧台叫号（语音播报取餐号）
2. 听到取餐号后,前往吧台取餐
3. 出示订单号或取餐号（可选）
4. 领取饮品

#### MVP阶段叫号方式

- B端工作人员点击"叫号"按钮
- 界面显示"已叫号 - 001"（Mock语音,无实际播报）
- C端订单状态更新为"已完成 - 请到吧台取餐"

#### 生产环境叫号方式（后续版本）

- 集成硬件叫号设备
- 语音播报取餐号
- 显示屏同步显示

---

### 6. 订单历史查询

#### 操作步骤

1. 进入"我的订单"页面
2. 默认显示最近20条订单
3. 可按状态筛选:
   - 全部订单
   - 待支付
   - 待制作/制作中
   - 已完成/已交付
   - 已取消
4. 点击订单查看详情

#### 快速复购

- 在订单详情页点击"再来一单"按钮
- 系统自动填充相同的饮品和规格
- 可修改数量和规格后重新下单

---

## B端订单管理操作指南

### 适用对象

- 吧台工作人员
- 厨房工作人员
- 店长/管理员

---

### 1. 登录与权限

#### MVP阶段登录方式

- 无需登录,直接访问B端管理后台
- 所有功能开放（Mock认证）

#### 生产环境登录方式（后续版本）

- 使用工号和密码登录
- 不同角色权限:
  - **吧台工作人员**: 订单管理、叫号
  - **店长**: 订单管理 + 饮品配置管理
  - **管理员**: 所有权限 + 系统设置

---

### 2. 查看待处理订单列表

#### 操作步骤

1. 进入B端管理后台
2. 导航到"饮品订单管理"模块
3. 查看待处理订单列表:
   - 默认显示"待制作"和"制作中"状态的订单
   - 按创建时间升序排列（先下单先显示）
4. 系统每8秒自动刷新订单列表（轮询）

#### 订单列表字段

| 字段 | 说明 |
|-----|------|
| 订单号 | 如 BO20251228150530ABCD |
| 取餐号 | 如 001 |
| 订单项数量 | 如 2杯 |
| 订单总价 | 如 ¥46 |
| 订单状态 | 待制作/制作中/已完成 |
| 下单时间 | 如 15:05:30 |
| 操作 | 开始制作/完成/叫号/交付 |

#### 界面示例

```
┌────────────────────────────────────────────────────────┐
│ 饮品订单管理                         [自动刷新: 8秒]   │
├────────────────────────────────────────────────────────┤
│ 订单号          | 取餐号 | 状态   | 总价 | 操作       │
├────────────────────────────────────────────────────────┤
│ BO...ABCD       | 001    | 待制作 | ¥46  | [开始制作] │
│ BO...EFGH       | 002    | 制作中 | ¥23  | [完成]     │
│ BO...IJKL       | 003    | 已完成 | ¥38  | [叫号]     │
└────────────────────────────────────────────────────────┘
```

---

### 3. 开始制作订单（触发BOM扣料）

#### 操作步骤

1. 在待处理订单列表中找到订单
2. 点击"开始制作"按钮
3. 系统执行以下操作:
   - 订单状态变更: 待制作 → 制作中
   - **自动BOM扣料**: 根据饮品配方自动扣减原料库存
   - 记录制作开始时间

#### BOM扣料说明

**扣料逻辑**:
1. 系统读取订单中每个饮品的配方（beverage_recipes）
2. 根据饮品规格组合匹配对应配方
3. 计算所需原料总量（配方用量 × 饮品数量）
4. 调用库存管理模块（P004）扣减原料库存

**示例**:

订单内容:
- 拿铁咖啡（大杯） × 2杯

配方（大杯拿铁）:
- 咖啡豆: 20g/杯
- 牛奶: 200ml/杯

扣料计算:
- 咖啡豆: 20g × 2 = 40g
- 牛奶: 200ml × 2 = 400ml

调用P004接口:
```json
POST /api/admin/inventory/adjustments
{
  "type": "BEVERAGE_ORDER_DEDUCTION",
  "order_id": "xxx",
  "items": [
    {"sku_id": "sku-001", "quantity": -40, "unit": "g"},
    {"sku_id": "sku-002", "quantity": -400, "unit": "ml"}
  ]
}
```

#### 库存不足处理

如果原料库存不足:
- 系统提示"库存不足,无法开始制作"
- 订单保持"待制作"状态
- 需要补充库存后再次点击"开始制作"

---

### 4. 完成制作

#### 操作步骤

1. 饮品制作完成后,点击"完成"按钮
2. 系统执行以下操作:
   - 订单状态变更: 制作中 → 已完成
   - 记录完成时间
   - 准备叫号

---

### 5. 叫号通知顾客取餐

#### 操作步骤

1. 在已完成订单列表中找到订单
2. 点击"叫号"按钮
3. MVP阶段:
   - 界面显示"已叫号 - 001"（Mock语音）
   - 取餐号状态变更: 待叫号 → 已叫号
   - C端订单页面更新为"请到吧台取餐"
4. 生产环境（后续版本）:
   - 硬件设备语音播报"001号取餐"
   - 显示屏显示取餐号

---

### 6. 交付饮品

#### 操作步骤

1. 顾客前来取餐
2. 核对取餐号或订单号
3. 将饮品交给顾客
4. 点击"已交付"按钮
5. 系统执行以下操作:
   - 订单状态变更: 已完成 → 已交付
   - 取餐号状态变更: 已叫号 → 已取餐
   - 记录交付时间
   - 订单从待处理列表中移除

---

### 7. 查看订单详情

#### 操作步骤

1. 点击订单号或"查看详情"按钮
2. 查看完整订单信息:
   - 订单基本信息（订单号、取餐号、用户ID、创建时间）
   - 订单项列表（饮品名称、规格快照、数量、单价、小计）
   - 订单总价、支付信息
   - 订单状态变更历史
   - 时间追踪（下单时间、支付时间、制作开始时间、完成时间、交付时间）

#### 订单详情界面示例

```
┌──────────────────────────────────────┐
│ 订单详情                             │
├──────────────────────────────────────┤
│ 订单号: BO20251228150530ABCD         │
│ 取餐号: 001                          │
│ 状态: 已交付                         │
│ 用户ID: user-xxx                     │
├──────────────────────────────────────┤
│ 订单项:                              │
│ 1. 拿铁咖啡 × 2                      │
│    规格: 大杯/热/半糖/珍珠           │
│    单价: ¥23                         │
│    小计: ¥46                         │
├──────────────────────────────────────┤
│ 总价: ¥46                            │
│ 支付方式: MOCK                       │
│ 支付时间: 2025-12-28 15:05:30       │
├──────────────────────────────────────┤
│ 时间追踪:                            │
│ - 下单: 15:05:30                    │
│ - 支付: 15:05:30                    │
│ - 开始制作: 15:06:00                │
│ - 完成: 15:08:00                    │
│ - 叫号: 15:08:10                    │
│ - 交付: 15:10:00                    │
└──────────────────────────────────────┘
```

---

### 8. 订单统计与导出

#### 操作步骤

1. 进入"订单统计"页面
2. 选择统计维度:
   - 日期范围（今日/本周/本月/自定义）
   - 订单状态
   - 饮品分类
3. 查看统计数据:
   - 订单总数
   - 订单总金额
   - 平均订单金额
   - 各状态订单占比
   - 热销饮品 TOP 10
4. 点击"导出Excel"按钮下载报表

#### 统计报表示例

```
┌────────────────────────────────────┐
│ 订单统计 (2025-12-28)              │
├────────────────────────────────────┤
│ 订单总数: 120单                    │
│ 订单总金额: ¥2,580                 │
│ 平均订单金额: ¥21.5                │
├────────────────────────────────────┤
│ 热销饮品 TOP 5:                    │
│ 1. 拿铁咖啡 - 45单                 │
│ 2. 美式咖啡 - 32单                 │
│ 3. 珍珠奶茶 - 28单                 │
│ 4. 抹茶拿铁 - 18单                 │
│ 5. 芒果冰沙 - 15单                 │
└────────────────────────────────────┘
```

---

## B端饮品配置管理操作指南

### 适用对象

- 店长
- 管理员

---

### 1. 饮品管理

#### 1.1 查看饮品列表

1. 进入"饮品配置管理"模块
2. 查看饮品列表:
   - 显示饮品名称、分类、基础价格、状态
   - 支持按分类筛选
   - 支持按状态筛选（上架/下架/缺货）
   - 支持按名称搜索

#### 1.2 新增饮品

1. 点击"新增饮品"按钮
2. 填写饮品信息:
   - **饮品名称** (必填): 如"拿铁咖啡"
   - **分类** (必填): 选择分类（咖啡/茶饮/果汁/冰沙/奶茶/其他）
   - **基础价格** (必填): 输入基础价格（中杯/标准规格价格）
   - **描述**: 饮品介绍（可选）
   - **主图**: 上传主图（建议尺寸: 750x750px）
   - **详情图**: 上传详情图（最多5张）
   - **营养信息**: 填写热量、糖分等（可选）
   - **推荐**: 勾选是否推荐商品
   - **排序权重**: 数字越小越靠前
3. 点击"保存"按钮
4. 新增的饮品默认状态为"下架",需手动上架

#### 1.3 编辑饮品

1. 在饮品列表中找到目标饮品
2. 点击"编辑"按钮
3. 修改饮品信息
4. 点击"保存"按钮

#### 1.4 上架/下架饮品

1. 在饮品列表中找到目标饮品
2. 点击"上架"或"下架"按钮
3. 确认操作

**注意**:
- 下架的饮品在C端菜单中不显示
- 下架不会删除饮品数据,可随时重新上架
- 已有订单的饮品即使下架也不影响历史订单显示（使用快照机制）

#### 1.5 标记缺货

1. 在饮品列表中找到目标饮品
2. 点击"标记缺货"按钮
3. 饮品状态变为"缺货",C端显示"暂时缺货"标签,不可点击

#### 1.6 删除饮品（软删除）

1. 在饮品列表中找到目标饮品
2. 点击"删除"按钮
3. 确认删除操作
4. 饮品状态变为"下架",不会物理删除数据

---

### 2. 规格管理

#### 2.1 查看饮品规格

1. 在饮品列表中点击"规格管理"按钮
2. 查看该饮品的所有规格:
   - 大小规格（SIZE）
   - 温度规格（TEMPERATURE）
   - 甜度规格（SWEETNESS）
   - 配料规格（TOPPING）

#### 2.2 新增规格

1. 点击"新增规格"按钮
2. 填写规格信息:
   - **规格类型** (必填): 选择类型（大小/温度/甜度/配料）
   - **规格名称** (必填): 如"大杯"、"珍珠"
   - **价格调整** (必填): 输入价格调整（正数加价,负数减价,0不调整）
   - **默认选中**: 勾选是否默认选中
   - **排序权重**: 数字越小越靠前
3. 点击"保存"按钮

**业务规则**:
- 同一饮品同一规格类型最多只能有一个默认规格
- 价格调整建议在 -100 ~ 100 元之间

#### 2.3 编辑规格

1. 在规格列表中找到目标规格
2. 点击"编辑"按钮
3. 修改规格信息
4. 点击"保存"按钮

#### 2.4 删除规格

1. 在规格列表中找到目标规格
2. 点击"删除"按钮
3. 确认删除操作

**注意**:
- 删除规格不影响历史订单（使用快照机制）
- 删除后,C端该饮品的规格选项会立即更新

---

### 3. 配方管理（BOM）

#### 3.1 查看饮品配方

1. 在饮品列表中点击"配方管理"按钮
2. 查看该饮品的所有配方:
   - 基础配方（适用所有规格组合）
   - 特定规格组合配方（如"大杯+珍珠"配方）

#### 3.2 新增配方

1. 点击"新增配方"按钮
2. 填写配方信息:
   - **规格组合**: 选择规格组合（留空表示基础配方）
   - **制作步骤**: 输入制作说明（可选）
   - **制作时长**: 输入预计制作时长（秒）
3. 添加原料:
   - 点击"添加原料"按钮
   - 选择原料SKU（从P001库存管理模块获取）
   - 输入用量（支持小数,如20.5g）
   - 确认单位（g/ml/个,需与SKU单位一致）
4. 点击"保存"按钮

#### 配方匹配优先级

系统按以下优先级匹配配方:
1. 精确匹配规格组合的配方（如"大杯+珍珠"）
2. 部分匹配规格组合的配方（如仅匹配"大杯"）
3. 基础配方（规格组合为空）

#### 示例

**基础配方（中杯拿铁）**:
- 咖啡豆: 15g
- 牛奶: 150ml

**大杯配方（大杯拿铁）**:
- 咖啡豆: 20g
- 牛奶: 200ml

**大杯+珍珠配方**:
- 咖啡豆: 20g
- 牛奶: 200ml
- 珍珠: 30g

#### 3.3 编辑配方

1. 在配方列表中找到目标配方
2. 点击"编辑"按钮
3. 修改配方信息或原料
4. 点击"保存"按钮

#### 3.4 删除配方

1. 在配方列表中找到目标配方
2. 点击"删除"按钮
3. 确认删除操作

**注意**:
- 每个饮品至少需要一个基础配方（规格组合为空）
- 删除配方后,新订单将无法匹配该规格组合,可能导致扣料失败

---

## 常见问题 FAQ

### C端用户常见问题

**Q1: 支付后多久开始制作?**

A: 支付完成后,订单立即进入"待制作"状态。工作人员会按照订单创建时间顺序依次制作,通常5-10分钟内开始制作（视订单数量而定）。

**Q2: 如何取消已支付的订单?**

A: MVP阶段暂不支持C端用户自助取消订单。如需取消,请联系店长或工作人员在B端后台操作取消。生产环境后续版本将支持"待制作"状态订单的自助取消（需工作人员审批）。

**Q3: 取餐号忘记了怎么办?**

A: 在"我的订单"中可以查看订单详情,里面会显示取餐号。也可以向工作人员提供订单号查询。

**Q4: 饮品显示"缺货"是什么意思?**

A: 表示该饮品暂时原料不足或暂停供应,无法点单。请选择其他饮品,或稍后再试。

**Q5: 规格价格是怎么计算的?**

A: 最终价格 = 基础价格 + 所有规格的价格调整之和。例如:拿铁基础价¥18,选择大杯(+¥3)和珍珠(+¥2),最终价格 = 18 + 3 + 2 = ¥23。

### B端用户常见问题

**Q1: 点击"开始制作"提示"库存不足"怎么办?**

A: 说明饮品配方所需的原料库存不足。请检查库存管理模块（P003/P004）,补充相应原料后再次点击"开始制作"。

**Q2: 订单列表多久刷新一次?**

A: 系统每8秒自动刷新订单列表（轮询）。也可以点击"立即刷新"按钮手动刷新。

**Q3: 如何修改已创建的订单?**

A: "待制作"状态的订单可以在订单详情页点击"修改订单"按钮。"制作中"及以后状态的订单不可修改（已扣料）。

**Q4: 饮品配方修改后,历史订单会受影响吗?**

A: 不会。订单项使用快照机制,保存了下单时的饮品和规格信息,配方修改只影响新订单。

**Q5: 取餐号超过999怎么办?**

A: 取餐号每日重置,范围是001-999。如果单日订单超过999,系统会从001开始循环使用（已交付的取餐号可以重新分配）。

**Q6: 如何查看某个饮品的销量?**

A: 进入"订单统计"页面,选择日期范围后查看"热销饮品"排行榜。也可以导出Excel报表进行详细分析。

---

## 注意事项

### C端用户注意事项

1. **支付前确认订单**: 支付完成后订单立即生效,无法自助取消,请仔细核对饮品、规格、数量。
2. **及时取餐**: 听到叫号后请尽快前往吧台取餐,避免饮品温度变化影响口感。
3. **保管好订单号**: 如遇问题,提供订单号或取餐号方便工作人员查询。
4. **备注信息**: 特殊需求请在备注中说明（如"少冰""多奶"）,但不保证完全满足。

### B端用户注意事项

1. **及时处理订单**: 请按照订单创建时间顺序处理,避免顾客等待过久。
2. **确认后再开始制作**: 点击"开始制作"会立即扣减原料库存,请确认后再操作,避免误操作。
3. **核对取餐号**: 交付饮品时请核对取餐号或订单号,避免交付错误。
4. **库存预警**: 定期检查库存余量,及时补充原料,避免订单无法制作。
5. **配方准确性**: 新增或修改配方时,请确保原料用量准确,否则会导致库存扣减错误或成本核算不准确。
6. **删除操作谨慎**: 删除饮品、规格、配方都是不可逆操作,请谨慎确认。

### 系统限制（MVP阶段）

1. **Mock支付**: 当前版本支付功能为Mock实现,点击支付即自动成功,无需真实付款。生产环境将集成微信支付。
2. **Mock叫号**: 当前版本叫号功能为Mock实现,点击叫号仅更新状态,无实际语音播报。生产环境将集成硬件叫号设备。
3. **Mock认证**: B端当前无需登录即可访问,所有功能开放。生产环境将集成基于角色的权限管理。
4. **轮询刷新**: 订单列表和状态采用8秒轮询刷新,非实时推送。生产环境将集成WebSocket实时推送。
5. **单门店模式**: 当前版本仅支持单门店场景,后续版本将支持多门店管理。

---

**文档结束**
