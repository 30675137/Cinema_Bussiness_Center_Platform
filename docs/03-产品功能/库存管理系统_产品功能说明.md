# 库存管理系统 - 产品功能说明文档

**版本**: V1.0  
**日期**: 2025-12-26  
**适用对象**: 店长、库存管理员、运营管理人员、系统开发人员

---

## 目录

1. [功能概述](#1-功能概述)
2. [用户故事](#2-用户故事)
3. [业务流程](#3-业务流程)
4. [界面说明](#4-界面说明)
5. [API接口](#5-api接口)
6. [数据模型](#6-数据模型)
7. [附录](#7-附录)

---

## 1. 功能概述

### 1.1 系统定位

库存管理系统是零售业务中台的核心组成部分，负责实时掌控所有仓库/门店的库存状态，实现库存的可视化、可追溯和精细化管理。本系统包含两大核心模块：

1. **门店SKU库存查询（P003-inventory-query）**: 面向店长的只读查询功能，支持查看、搜索、筛选门店库存
2. **库存台账管理（003-inventory-management）**: 面向库存管理员的完整库存管理功能，包括台账查看、流水追踪、库存调整

### 1.2 功能架构

```
库存管理系统
├── 门店SKU库存查询 (P003)
│   ├── 库存列表查看
│   ├── 关键词搜索
│   ├── 多维度筛选
│   └── 库存详情查看
└── 库存台账管理 (003)
    ├── 库存台账查看与筛选
    ├── 库存流水追踪与对账
    ├── 库存调整与异常处理
    └── 库存详情与快速操作
```

### 1.3 核心指标

| 指标 | 说明 | 计算公式 |
|------|------|---------|
| **现存数量** | 实际在仓库中的库存数量 | - |
| **可用数量** | 可用于销售的库存 | 现存数量 - 预占数量 |
| **预占数量** | 已被订单锁定但未出库的数量 | - |
| **在途数量** | 已采购/调拨但未到货的数量 | - |
| **安全库存** | 最低库存警戒线 | - |

### 1.4 库存状态体系

系统采用五级库存状态体系，根据可用库存与安全库存的比例自动计算：

| 状态 | 代码 | 颜色标识 | 判断条件 |
|------|------|---------|----------|
| **充足** | SUFFICIENT | 绿色 | 可用库存 ≥ 安全库存 × 2 |
| **正常** | NORMAL | 蓝色 | 安全库存 ≤ 可用库存 < 安全库存 × 2 |
| **偏低** | BELOW_THRESHOLD | 黄色 | 安全库存 × 0.5 ≤ 可用库存 < 安全库存 |
| **不足** | LOW | 橙色 | 0 < 可用库存 < 安全库存 × 0.5 |
| **缺货** | OUT_OF_STOCK | 红色 | 可用库存 = 0 |

---

## 2. 用户故事

### 2.1 门店SKU库存查询 (P003)

#### US1 - 查看门店库存列表 (Priority: P0)

**用户角色**: 店长

**用户故事**: 作为店长，我希望能够查看门店所有SKU的当前库存数量，以便掌握库存状态。

**验收标准**:

| 场景 | Given | When | Then |
|------|-------|------|------|
| 查看库存列表 | 店长已登录系统并有门店权限 | 进入库存查询页面 | 系统显示当前门店的SKU库存列表，包含SKU编码、名称、现存数量、可用数量、预占数量、库存状态、单位列 |
| 分页浏览 | 库存列表已加载 | 数据超过单页显示量 | 系统提供分页功能，用户可以翻页查看更多数据 |
| 性能要求 | 用户请求加载库存列表 | 系统处理请求 | 列表在2秒内加载完成 |
| 空状态处理 | 门店没有任何SKU库存 | 进入库存查询页面 | 显示空状态提示"暂无库存数据" |

---

#### US2 - 搜索库存 (Priority: P0)

**用户角色**: 店长

**用户故事**: 作为店长，我希望能够按SKU名称/编码搜索库存，以便快速定位商品。

**验收标准**:

| 场景 | Given | When | Then |
|------|-------|------|------|
| 关键词搜索 | 库存列表已加载 | 用户在搜索框输入关键词 | 列表实时筛选显示名称或编码包含该关键词的SKU |
| 模糊匹配 | 用户输入搜索关键词"威" | 系统执行搜索 | 显示名称包含"威"的SKU（如"威士忌"、"威化饼干"） |
| 无结果处理 | 用户输入搜索关键词 | 没有匹配的SKU | 显示空状态提示"未找到匹配的库存" |
| 清空搜索 | 用户已输入搜索关键词 | 清空搜索框 | 恢复显示完整库存列表 |

**技术要求**: 输入防抖300ms

---

#### US3 - 多维度筛选库存 (Priority: P0)

**用户角色**: 店长

**用户故事**: 作为店长，我希望能够按门店、库存状态、商品分类筛选库存，以便快速定位需要关注的商品。

**验收标准**:

| 场景 | Given | When | Then |
|------|-------|------|------|
| 默认门店选择 | 库存列表页面加载完成 | 查看门店筛选器 | 默认选中当前登录用户所属门店 |
| 多门店切换 | 用户有多门店查看权限 | 点击门店下拉筛选 | 显示用户有权限访问的门店列表 |
| 门店筛选生效 | 用户选择了不同门店 | 确认选择 | 库存列表自动刷新显示所选门店的数据 |
| 单门店限制 | 用户只有单门店权限 | 查看门店筛选器 | 筛选器显示该门店且不可切换 |
| 状态多选筛选 | 库存列表已加载 | 选择库存状态筛选"不足"和"缺货" | 列表仅显示状态为不足或缺货的SKU |
| 分类筛选 | 库存列表已加载 | 选择商品分类"酒水饮料" | 列表仅显示该分类下的SKU库存 |
| 组合筛选 | 用户同时设置了门店、状态、分类筛选 | 查看列表 | 显示满足所有筛选条件的SKU（交集） |
| 重置筛选 | 用户已设置筛选条件 | 点击"重置"按钮 | 所有筛选条件恢复默认值 |

---

#### US4 - 查看库存详情 (Priority: P1)

**用户角色**: 店长

**用户故事**: 作为店长，我希望能够查看单个SKU的库存详情，以便了解完整信息。

**验收标准**:

| 场景 | Given | When | Then |
|------|-------|------|------|
| 打开详情 | 库存列表已加载 | 点击某SKU行 | 展开行内详情或打开侧边抽屉显示详细信息 |
| 详情内容 | SKU详情已展开 | 查看详情内容 | 显示现存数量、可用数量、预占数量、库存单位、最后更新时间、安全库存阈值 |
| 关闭详情 | SKU详情已展开 | 点击关闭或点击其他行 | 详情收起或切换到其他SKU详情 |
| 低库存警告 | SKU设置了安全库存阈值 | 当前库存低于阈值 | 详情中以醒目方式提示库存不足 |
| 缺货标签 | SKU库存状态为"缺货" | 查看列表 | 库存状态列显示红色"缺货"标签 |
| 充足标签 | SKU可用库存充足 | 查看列表 | 库存状态列显示绿色"充足"标签 |

---

### 2.2 库存台账管理 (003)

#### US1 - 库存台账查看与筛选 (Priority: P1)

**用户角色**: 库存管理员

**用户故事**: 库存管理员需要实时查看各仓库/门店的商品库存状态，通过多维筛选快速定位库存异常的商品。

**验收标准**:

| 场景 | Given | When | Then |
|------|-------|------|------|
| 查看台账 | 用户有库存台账查看权限 | 访问库存台账页面 | 系统显示所有仓库/门店的SKU库存汇总信息 |
| 关键词查询 | 用户在筛选区域输入SKU关键词 | 点击"查询"按钮 | 表格显示匹配的库存记录并保持筛选条件 |
| 状态筛选 | 用户选择"低于安全库存"状态筛选 | 点击"查询" | 表格显示所有库存不足的商品并用红色标签标识 |
| 排序功能 | 用户点击"库存状态"列标题 | 执行排序操作 | 表格按库存状态重新排序显示 |

---

#### US2 - 库存流水追踪与对账 (Priority: P1)

**用户角色**: 库存管理员

**用户故事**: 库存管理员需要追踪特定商品在特定仓库的库存变动历史，用于问题排查、财务对账和业务审计。

**验收标准**:

| 场景 | Given | When | Then |
|------|-------|------|------|
| 跳转流水 | 用户在台账页点击某SKU的"查看流水" | 页面跳转到流水列表 | 显示该SKU在该仓库的所有库存变动记录 |
| 筛选流水 | 用户在流水页选择时间范围和单据类型筛选 | 点击"查询" | 表格显示符合条件的流水记录 |
| 入库显示 | 用户查看入库类流水记录 | 观察变动数量显示 | 数量以绿色"+"号显示，单据类型用蓝色标签标识 |
| 跳转单据 | 用户点击流水记录的单据号链接 | 执行跳转操作 | 打开对应的业务单据详情页 |

---

#### US3 - 库存调整与异常处理 (Priority: P2)

**用户角色**: 授权库存管理员

**用户故事**: 授权的库存管理员在发现库存差异时，需要通过系统进行库存调整操作（盘盈、盘亏、报损）。

**验收标准**:

| 场景 | Given | When | Then |
|------|-------|------|------|
| 打开调整弹窗 | 用户有库存调整权限 | 在台账页点击"库存调整"按钮 | 弹出库存调整对话框 |
| 二次确认 | 用户在调整对话框选择"盘亏"类型并输入数量 | 点击确认按钮 | 系统显示二次确认提示 |
| 实时更新 | 用户确认库存调整操作 | 操作完成后 | 台账页面的库存数据实时更新并显示新的库存状态 |
| 权限控制 | 用户无库存调整权限 | 访问台账页面 | "库存调整"按钮不显示 |

---

#### US4 - 库存详情查看与快速操作 (Priority: P3)

**用户角色**: 库存管理员

**用户故事**: 库存管理员需要查看特定SKU在特定仓库的详细库存信息，包括各类库存数量、近期流水摘要。

**验收标准**:

| 场景 | Given | When | Then |
|------|-------|------|------|
| 打开详情抽屉 | 用户点击台账中的SKU名称 | 打开详情抽屉 | 显示该SKU在该仓库的完整库存摘要信息 |
| 数据完整性 | 用户在详情抽屉查看库存摘要 | 观察数据展示 | 现存、预占、可用、在途、安全库存等数据完整显示 |
| 跳转流水列表 | 用户在详情抽屉点击"查看全部流水"链接 | 执行跳转 | 打开该SKU的完整流水列表页 |
| 跳转商品详情 | 用户在详情抽屉点击"查看商品详情" | 执行跳转 | 打开商品管理模块的对应商品页 |

---

#### US5 - 设置安全库存阈值 (Priority: P3)

**用户角色**: 库存管理员

**用户故事**: 库存管理员需要设置和编辑SKU的安全库存阈值，系统需要支持并发编辑冲突处理。

**验收标准**:

| 场景 | Given | When | Then |
|------|-------|------|------|
| 编辑安全库存 | 用户在库存详情抽屉中 | 点击安全库存旁的编辑按钮 | 显示输入框，可输入新的安全库存值 |
| 保存成功 | 用户输入有效的安全库存值 | 点击保存按钮 | 安全库存更新成功，提示"安全库存已更新" |
| 乐观锁冲突 | 用户A和用户B同时编辑同一条记录 | 用户B先保存，用户A再保存 | 用户A收到冲突提示"该记录已被他人修改，请刷新后重试"，显示刷新按钮 |
| 刷新数据 | 发生乐观锁冲突 | 用户点击刷新按钮 | 获取最新数据，可重新编辑 |
| 取消编辑 | 用户正在编辑安全库存 | 点击取消按钮 | 退出编辑模式，恢复显示原值 |
| 流水记录生成 | 用户成功更新安全库存 | 查看库存流水 | 自动生成一条类型为"安全库存更新"的流水记录 |

**技术要求**: 
- 使用乐观锁机制（version字段）防止并发冲突
- HTTP 409 状态码表示冲突错误
- 更新成功后自动刷新相关缓存

---

#### US6 - 查看库存流水详情 (Priority: P2)

**用户角色**: 库存管理员

**用户故事**: 库存管理员需要查看单条库存流水的完整详情，包括变动数量、库存变化、来源信息和操作信息。

**验收标准**:

| 场景 | Given | When | Then |
|------|-------|------|------|
| 点击详情按钮 | 用户在流水列表中 | 点击某条流水的"详情"按钮 | 打开流水详情抽屉 |
| 点击行查看详情 | 用户在流水列表中 | 点击某行流水记录 | 打开流水详情抽屉 |
| 详情内容展示 | 流水详情抽屉已打开 | 查看详情内容 | 显示交易概览、库存变化、来源信息、操作信息和备注 |
| 入库类型显示 | 查看入库类型流水 | 观察数量显示 | 数量以绿色"+"号显示 |
| 出库类型显示 | 查看出库类型流水 | 观察数量显示 | 数量以红色"-"号显示 |
| 来源单据复制 | 流水有关联的来源单据 | 点击单据号旁的复制按钮 | 单据号复制到剪贴板 |

---

## 3. 业务流程

### 3.1 库存查询流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                         库存查询流程                                  │
└─────────────────────────────────────────────────────────────────────┘

  [店长登录系统]
        │
        ▼
  ┌─────────────────┐
  │ 进入库存查询页面  │
  │ 默认加载当前门店  │
  └────────┬────────┘
           │
           ▼
  ┌─────────────────┐     ┌─────────────────┐
  │   查看库存列表   │ ──▶ │  需要搜索？      │
  │ 显示7列数据     │     └────────┬────────┘
  └────────┬────────┘              │
           │                    ┌──┴──┐
           │                 是 │     │ 否
           │                    ▼     ▼
           │          ┌─────────────┐  │
           │          │ 输入关键词   │  │
           │          │ 300ms防抖   │  │
           │          └──────┬──────┘  │
           │                 │         │
           ▼                 ▼         │
  ┌─────────────────────────────────────┐
  │            多维度筛选                │
  │  门店 │ 库存状态（多选）│ 商品分类   │
  └────────────────┬────────────────────┘
                   │
                   ▼
  ┌─────────────────┐
  │ 查看筛选结果列表  │
  │ 支持分页 20条/页 │
  └────────┬────────┘
           │
           ▼
  ┌─────────────────┐
  │ 点击行查看详情   │
  │ 抽屉展示完整信息 │
  └────────┬────────┘
           │
           ▼
  ┌─────────────────┐
  │ 关注低库存警告   │
  │ 决定补货计划    │
  └─────────────────┘
```

### 3.2 库存调整流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                         库存调整流程                                  │
└─────────────────────────────────────────────────────────────────────┘

  [发现库存异常]
        │
        ▼
  ┌─────────────────┐
  │ 点击"库存调整"   │
  │ 权限校验         │
  └────────┬────────┘
           │
           ▼
  ┌─────────────────┐
  │ 选择调整类型     │
  │ 盘盈/盘亏/报损   │
  └────────┬────────┘
           │
           ▼
  ┌─────────────────┐
  │ 输入调整数量     │
  │ 填写调整原因     │
  └────────┬────────┘
           │
           ▼
  ┌─────────────────┐
  │ 二次确认         │
  │ 展示调整前后对比 │
  └────────┬────────┘
           │
           ▼
  ┌─────────────────┐
  │ 提交调整         │
  │ 生成流水记录     │
  └────────┬────────┘
           │
           ▼
  ┌─────────────────┐
  │ 台账实时更新     │
  │ 库存状态刷新     │
  └─────────────────┘
```

---

## 4. 界面说明

### 4.1 库存查询页面 (P003)

#### 4.1.1 页面布局

```
┌──────────────────────────────────────────────────────────────────┐
│ 门店SKU库存查询                                                   │
├──────────────────────────────────────────────────────────────────┤
│                         筛选区域                                  │
│ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────┐ │
│ │ 🔍 搜索SKU   │ │ 门店选择 ▼  │ │ 库存状态 ▼  │ │ 分类 ▼  │ │
│ └──────────────┘ └──────────────┘ └──────────────┘ └──────────┘ │
│                                                      [重置]      │
├──────────────────────────────────────────────────────────────────┤
│                         数据表格                                  │
│ ┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐│
│ │SKU编码 │SKU名称 │现存数量│可用数量│预占数量│库存状态│  单位  ││
│ ├────────┼────────┼────────┼────────┼────────┼────────┼────────┤│
│ │SKU0001 │威士忌  │  100   │   80   │   20   │ 🟢充足 │   瓶   ││
│ │SKU0002 │可乐    │   50   │   45   │    5   │ 🔵正常 │   罐   ││
│ │SKU0003 │薯片    │   10   │    5   │    5   │ 🟡偏低 │   包   ││
│ │SKU0004 │矿泉水  │    3   │    2   │    1   │ 🟠不足 │   瓶   ││
│ │SKU0005 │啤酒    │    0   │    0   │    0   │ 🔴缺货 │   瓶   ││
│ └────────┴────────┴────────┴────────┴────────┴────────┴────────┘│
├──────────────────────────────────────────────────────────────────┤
│ 共 100 条记录                           < 1 2 3 4 5 ... 10 >     │
└──────────────────────────────────────────────────────────────────┘
```

#### 4.1.2 库存详情抽屉

```
┌─────────────────────────────────────┐
│ 库存详情                        [X] │
├─────────────────────────────────────┤
│                                     │
│ ⚠️ 低库存警告                        │
│ 当前可用数量 (5) 低于安全库存 (20)   │
│ 请及时补货！                         │
│                                     │
├─────────────────────────────────────┤
│ 基本信息                            │
│ ┌──────────────┬──────────────────┐ │
│ │ SKU编码      │ SKU000003        │ │
│ │ SKU名称      │ 薯片             │ │
│ │ 所属门店     │ 中山路门店       │ │
│ │ 商品分类     │ 零食小吃         │ │
│ │ 库存单位     │ 包               │ │
│ └──────────────┴──────────────────┘ │
│                                     │
│ 库存指标                            │
│ ┌──────────────┬──────────────────┐ │
│ │ 现存数量     │ 10               │ │
│ │ 可用数量     │ 5                │ │
│ │ 预占数量     │ 5                │ │
│ │ 安全库存     │ 20               │ │
│ │ 库存状态     │ 🟡偏低           │ │
│ │ 最后更新     │ 2025-12-26 10:30 │ │
│ └──────────────┴──────────────────┘ │
│                                     │
└─────────────────────────────────────┘
```

### 4.2 库存台账页面 (003)

#### 4.2.1 页面布局

```
┌──────────────────────────────────────────────────────────────────┐
│ 库存台账                                         [导出] [刷新]   │
├──────────────────────────────────────────────────────────────────┤
│                         筛选区域                                  │
│ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────┐ │
│ │ 🔍 关键词    │ │ 仓库/门店 ▼ │ │ 类目筛选 ▼  │ │ 品牌 ▼  │ │
│ └──────────────┘ └──────────────┘ └──────────────┘ └──────────┘ │
│ ┌──────────────┐                                                 │
│ │ 库存状态 ▼  │                            [查询] [重置]        │
│ └──────────────┘                                                 │
├──────────────────────────────────────────────────────────────────┤
│                         数据表格                                  │
│ ┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐│
│ │  SKU   │ 商品名 │ 位置   │现存库存│可用库存│在途库存│ 状态   ││
│ ├────────┼────────┼────────┼────────┼────────┼────────┼────────┤│
│ │SKU0001 │威士忌  │东区仓库│  100   │   80   │   50   │ 🟢正常 ││
│ │        │        │        │        │        │        │[调整]  ││
│ └────────┴────────┴────────┴────────┴────────┴────────┴────────┘│
└──────────────────────────────────────────────────────────────────┘
```

---

## 5. API接口

### 5.1 库存列表查询

**接口路径**: `GET /api/inventory`

**请求参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| storeId | string | 否 | 门店ID |
| keyword | string | 否 | 搜索关键词（匹配SKU编码/名称） |
| categoryId | string | 否 | 商品分类ID |
| statuses | string | 否 | 库存状态（逗号分隔，支持多选） |
| page | number | 否 | 页码，默认1 |
| pageSize | number | 否 | 每页条数，默认20 |

**响应示例**:

```json
{
  "success": true,
  "data": [
    {
      "id": "inv_001",
      "storeId": "store_001",
      "skuId": "sku_001",
      "onHandQty": 100,
      "availableQty": 80,
      "reservedQty": 20,
      "safetyStock": 30,
      "updatedAt": "2025-12-26T10:30:00Z",
      "sku": {
        "code": "SKU000001",
        "name": "威士忌",
        "mainUnit": "瓶"
      },
      "store": {
        "code": "STORE001",
        "name": "中山路门店"
      },
      "category": {
        "id": "cat_001",
        "name": "酒水饮料"
      },
      "inventoryStatus": "SUFFICIENT"
    }
  ],
  "total": 100,
  "page": 1,
  "pageSize": 20
}
```

---

### 5.2 库存详情查询

**接口路径**: `GET /api/inventory/{id}`

**响应示例**:

```json
{
  "success": true,
  "data": {
    "id": "inv_001",
    "storeId": "store_001",
    "skuId": "sku_001",
    "onHandQty": 100,
    "availableQty": 80,
    "reservedQty": 20,
    "safetyStock": 30,
    "updatedAt": "2025-12-26T10:30:00Z",
    "createdAt": "2025-12-01T08:00:00Z",
    "sku": {
      "code": "SKU000001",
      "name": "威士忌",
      "mainUnit": "瓶",
      "categoryId": "cat_001"
    },
    "store": {
      "code": "STORE001",
      "name": "中山路门店"
    },
    "category": {
      "id": "cat_001",
      "name": "酒水饮料"
    },
    "inventoryStatus": "SUFFICIENT"
  }
}
```

---

### 5.3 商品分类列表

**接口路径**: `GET /api/categories`

**请求参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | string | 否 | 状态筛选（ACTIVE/INACTIVE），默认ACTIVE |

**响应示例**:

```json
{
  "success": true,
  "data": [
    {
      "id": "cat_001",
      "code": "CAT001",
      "name": "酒水饮料",
      "parentId": null,
      "level": 1,
      "sortOrder": 1,
      "status": "ACTIVE"
    },
    {
      "id": "cat_002",
      "code": "CAT002",
      "name": "零食小吃",
      "parentId": null,
      "level": 1,
      "sortOrder": 2,
      "status": "ACTIVE"
    }
  ]
}
```

---

### 5.4 可访问门店列表

**接口路径**: `GET /api/stores/accessible`

**说明**: 返回当前登录用户有权限访问的门店列表

**响应示例**:

```json
{
  "success": true,
  "data": [
    {
      "id": "store_001",
      "code": "STORE001",
      "name": "中山路门店",
      "region": "华东区",
      "status": "ACTIVE"
    },
    {
      "id": "store_002",
      "code": "STORE002",
      "name": "解放路门店",
      "region": "华东区",
      "status": "ACTIVE"
    }
  ]
}
```

---

## 6. 数据模型

### 6.1 实体关系图

```
┌─────────────┐     ┌─────────────────┐     ┌─────────────┐
│   stores    │     │ store_inventory │     │    skus     │
├─────────────┤     ├─────────────────┤     ├─────────────┤
│ id (PK)     │◄────│ store_id (FK)   │     │ id (PK)     │
│ code        │     │ sku_id (FK)     │────►│ code        │
│ name        │     │ on_hand_qty     │     │ name        │
│ region      │     │ available_qty   │     │ main_unit   │
│ status      │     │ reserved_qty    │     │ category_id │──┐
└─────────────┘     │ safety_stock    │     │ status      │  │
                    │ updated_at      │     └─────────────┘  │
                    └─────────────────┘                      │
                                                             │
                    ┌─────────────────┐                      │
                    │   categories    │◄─────────────────────┘
                    ├─────────────────┤
                    │ id (PK)         │
                    │ code            │
                    │ name            │
                    │ parent_id (FK)  │
                    │ level           │
                    └─────────────────┘
```

### 6.2 核心实体

#### 6.2.1 store_inventory (门店库存表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | UUID | PK | 主键 |
| store_id | UUID | FK → stores.id, NOT NULL | 门店ID |
| sku_id | UUID | FK → skus.id, NOT NULL | SKU ID |
| on_hand_qty | DECIMAL(12,3) | NOT NULL, DEFAULT 0 | 现存数量 |
| available_qty | DECIMAL(12,3) | NOT NULL, DEFAULT 0 | 可用数量 |
| reserved_qty | DECIMAL(12,3) | NOT NULL, DEFAULT 0 | 预占数量 |
| safety_stock | DECIMAL(12,3) | DEFAULT 0 | 安全库存阈值 |
| updated_at | TIMESTAMPTZ | NOT NULL | 最后更新时间 |
| created_at | TIMESTAMPTZ | NOT NULL | 创建时间 |

**唯一约束**: (store_id, sku_id)

**业务规则**: available_qty = on_hand_qty - reserved_qty

---

#### 6.2.2 categories (商品分类表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | UUID | PK | 主键 |
| code | VARCHAR(50) | UNIQUE, NOT NULL | 分类编码 |
| name | VARCHAR(100) | NOT NULL | 分类名称 |
| parent_id | UUID | FK → categories.id | 父分类ID |
| level | INTEGER | NOT NULL, DEFAULT 1 | 层级深度 |
| sort_order | INTEGER | DEFAULT 0 | 排序序号 |
| status | VARCHAR(20) | DEFAULT 'ACTIVE' | 状态 |
| created_at | TIMESTAMPTZ | NOT NULL | 创建时间 |
| updated_at | TIMESTAMPTZ | NOT NULL | 更新时间 |

---

### 6.3 TypeScript 类型定义

```
// 库存状态枚举
export type InventoryStatus =
  | 'SUFFICIENT'      // 充足
  | 'NORMAL'          // 正常
  | 'BELOW_THRESHOLD' // 偏低
  | 'LOW'             // 不足
  | 'OUT_OF_STOCK';   // 缺货

// 库存状态配置
export const INVENTORY_STATUS_CONFIG: Record<InventoryStatus, {
  label: string;
  color: string;
}> = {
  SUFFICIENT: { label: '充足', color: 'green' },
  NORMAL: { label: '正常', color: 'blue' },
  BELOW_THRESHOLD: { label: '偏低', color: 'gold' },
  LOW: { label: '不足', color: 'orange' },
  OUT_OF_STOCK: { label: '缺货', color: 'red' },
};

// 库存记录
export interface StoreInventory {
  id: string;
  storeId: string;
  skuId: string;
  onHandQty: number;
  availableQty: number;
  reservedQty: number;
  safetyStock: number;
  updatedAt: string;
  createdAt: string;
  sku?: {
    code: string;
    name: string;
    mainUnit: string;
    categoryId?: string;
  };
  store?: {
    code: string;
    name: string;
  };
  category?: {
    id: string;
    name: string;
  };
  inventoryStatus: InventoryStatus;
}

// 查询参数
export interface InventoryQueryParams {
  storeId?: string;
  keyword?: string;
  categoryId?: string;
  statuses?: InventoryStatus[];
  page?: number;
  pageSize?: number;
}
```

---

## 7. 附录

### 7.1 性能要求

| 指标 | 要求 |
|------|------|
| 库存列表加载 | ≤ 2秒 |
| 搜索响应时间 | ≤ 1秒（输入停止后） |
| 详情展开响应 | ≤ 500ms |
| 门店切换刷新 | ≤ 2秒 |
| 支持SKU数量 | 单门店1000+ |

### 7.2 边界情况处理

| 场景 | 处理方式 |
|------|---------|
| 空库存 | 显示友好的空状态提示"暂无库存数据" |
| 搜索无结果 | 显示"未找到匹配的库存" |
| 网络异常 | 显示错误提示并提供重试按钮 |
| 权限不足 | 显示权限不足提示 |
| 大数据量 | 分页加载确保性能 |
| 特殊字符搜索 | 正常处理不报错 |
| 负库存 | 红色字体明显标识，提示盘点检查 |

### 7.3 前端组件清单

| 组件 | 路径 | 功能 |
|------|------|------|
| InventoryPage | /pages/inventory/InventoryPage.tsx | 库存查询主页面 |
| InventoryTable | /features/inventory/components/InventoryTable.tsx | 库存数据表格 |
| InventoryStatusTag | /features/inventory/components/InventoryStatusTag.tsx | 库存状态标签 |
| InventoryFilterBar | /features/inventory/components/InventoryFilterBar.tsx | 筛选栏组件 |
| InventoryDetailDrawer | /features/inventory/components/InventoryDetailDrawer.tsx | 详情抽屉 |
| SearchInput | /features/inventory/components/SearchInput.tsx | 搜索输入框（300ms防抖） |
| SafetyStockEditor | /features/inventory/components/SafetyStockEditor.tsx | 安全库存编辑器（支持乐观锁冲突处理） |
| TransactionList | /features/inventory/components/TransactionList.tsx | 库存流水列表（支持时间筛选） |
| TransactionDetailDrawer | /features/inventory/components/TransactionDetailDrawer.tsx | 流水详情抽屉 |
| TransactionQuantityTag | /features/inventory/components/TransactionQuantityTag.tsx | 流水数量标签（入库绿色+/出库红色-） |

### 7.4 技术栈

| 层次 | 技术选型 |
|------|---------|
| 前端框架 | React 19 + TypeScript |
| UI组件库 | Ant Design 6 |
| 状态管理 | Zustand + TanStack Query |
| 后端框架 | Spring Boot 3.x |
| 数据库 | Supabase (PostgreSQL) |
| API规范 | RESTful + JWT认证 |

---

## 文档更新记录

| 版本 | 日期 | 更新内容 | 作者 |
|-----|------|---------|------|
| V1.0 | 2025-12-26 | 初始版本 | 系统生成 |
| V1.1 | 2025-12-26 | 新增FAQ章节 | 系统生成 |
| V1.2 | 2025-12-26 | 新增审批数据FAQ | 系统生成 |
| V1.3 | 2025-12-26 | 新增US5安全库存编辑、US6流水详情功能；补充组件清单 | 系统生成 |

---

## 8. 常见问题 (FAQ)

### Q1: 库存列表中的数据来源是哪里？

**A**: 库存列表数据来源于 `store_inventory` 表，这是系统的核心门店库存表。

**数据关联关系**:

```
stores (门店) ───┐
                ├──→ store_inventory (门店库存表) ←──┬── skus (SKU商品)
                │    - store_id                      │
                │    - sku_id                        │
                │    - on_hand_qty (现存数量)        │
                │    - available_qty (可用数量)      │
                │    - reserved_qty (预占数量)       │
                │    - safety_stock (安全库存)       └── categories (分类)
                │    - updated_at
```

**数据写入来源**:

| 来源 | 说明 |
|------|------|
| 库存台账管理 (003) | 盘盈、盘亏、报损等调整操作 |
| 进销存业务 | 入库单、出库单、调拨单等业务单据 |
| 订单预占 | 订单锁定库存 → 增加 reserved_qty |
| 系统初始化 | 初始库存数据导入 |

---

### Q2: 要想有库存数据，是否必须先做进销存的入库？

**A**: **不一定！** 有多种方式可以产生库存数据：

| 方式 | 说明 | 推荐场景 |
|------|------|----------|
| **SQL脚本初始化** | 直接通过数据库迁移脚本插入测试数据 | 开发/测试环境 |
| **库存调整（盘盈）** | 通过库存管理模块的调整功能增加库存 | 库存初始化、盘点 |
| **进销存入库单** | 正式的业务流程产生库存 | 生产环境 |

**开发环境方案**:

项目中已有测试数据脚本 `V034__insert_test_inventory_data.sql`，启动后端运行数据库迁移后，会自动为以下门店插入测试库存数据：

| 门店 | 场景模拟 | 数据特点 |
|------|----------|----------|
| 北京五棵松店 | 旗舰店 | 库存充足 |
| 北京慈云寺店 | 普通门店 | 部分商品库存偏低 |
| 房山天街店 | 缺货场景 | 听装可乐缺货、爆米花不足 |
| 广州正佳店 | 正常运营 | 库存充足 |
| 成都西锦店 | 补货预警 | 库存偏低 |

---

### Q3: 库存查询模块(P003)和库存台账管理(003)有什么区别？

**A**:

| 模块 | 用户角色 | 功能范围 | 权限级别 |
|------|----------|----------|----------|
| **门店SKU库存查询 (P003)** | 店长 | 只读查询：列表、搜索、筛选、详情 | 门店级 |
| **库存台账管理 (003)** | 库存管理员 | 完整管理：台账查看、流水追踪、库存调整 | 全局/多门店 |

**简单理解**: P003 是"看库存"，003 是"管库存"。

---

### Q4: 可用数量是如何计算的？

**A**: 

```
可用数量 = 现存数量 - 预占数量
```

- **现存数量 (on_hand_qty)**: 实际在仓库/门店中的库存数量
- **预占数量 (reserved_qty)**: 已被订单锁定但尚未出库的数量
- **可用数量 (available_qty)**: 可以用于新订单销售的库存

---

### Q5: 库存状态是如何自动计算的？

**A**: 系统根据 `可用数量` 与 `安全库存` 的比例自动计算五级状态：

```sql
CASE
  WHEN available_qty = 0 THEN 'OUT_OF_STOCK'               -- 缺货
  WHEN available_qty < safety_stock * 0.5 THEN 'LOW'       -- 不足
  WHEN available_qty < safety_stock THEN 'BELOW_THRESHOLD' -- 偏低
  WHEN available_qty < safety_stock * 2 THEN 'NORMAL'      -- 正常
  ELSE 'SUFFICIENT'                                        -- 充足
END
```

---

### Q6: 如何获取和创建审批数据？

**A**: 库存调整审批是系统的重要风控功能，当调整金额超过阈值时会自动触发审批流程。

#### 6.1 审批触发条件

| 条件 | 说明 |
|------|------|
| **金额阈值** | 调整金额 ≥ ¥1,000.00 时，自动进入审批流程 |
| **状态变更** | 调整记录状态从 `draft` 变为 `pending_approval` |
| **权限要求** | 需要库存管理员权限才能创建调整，需要审批权限才能审批 |

#### 6.2 通过API获取审批记录

**接口路径**: `GET /api/adjustments`

**请求参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | string | 否 | 审批状态筛选，如 `pending_approval`、`approved`、`rejected` |
| page | number | 否 | 页码，默认1 |
| pageSize | number | 否 | 每页条数，默认10 |

**示例请求**:

```bash
# 获取待审批的调整记录
curl -X GET "http://localhost:8080/api/adjustments?status=pending_approval&page=1&pageSize=10" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json"
```

**响应示例**:

```json
{
  "success": true,
  "data": [
    {
      "id": "uuid-xxx",
      "adjustmentNumber": "ADJ202512260001",
      "adjustmentType": "surplus",
      "quantity": 100,
      "unitPrice": 50.00,
      "totalAmount": 5000.00,
      "status": "pending_approval",
      "reasonCode": "STOCK_DIFF",
      "reasonText": "实物盘点发现多余",
      "createdAt": "2025-12-26T10:30:00Z",
      "sku": {
        "id": "sku-uuid",
        "code": "SKU-001",
        "name": "威士忌"
      },
      "operator": {
        "id": "user-uuid",
        "name": "张三"
      }
    }
  ],
  "total": 1,
  "page": 1,
  "pageSize": 10
}
```

#### 6.3 通过API创建需要审批的调整记录

**接口路径**: `POST /api/adjustments`

**请求体**:

```json
{
  "skuId": "550e8400-e29b-41d4-a716-446655440001",
  "storeId": "550e8400-e29b-41d4-a716-446655440002",
  "adjustmentType": "surplus",
  "quantity": 100,
  "reasonCode": "STOCK_DIFF",
  "reasonText": "实物盘点发现多余",
  "remarks": "测试审批流程"
}
```

**示例请求**:

```bash
curl -X POST http://localhost:8080/api/adjustments \
  -H "Content-Type: application/json" \
  -d '{
    "skuId": "550e8400-e29b-41d4-a716-446655440001",
    "storeId": "550e8400-e29b-41d4-a716-446655440002",
    "adjustmentType": "surplus",
    "quantity": 100,
    "reasonCode": "STOCK_DIFF",
    "reasonText": "实物盘点发现多余",
    "remarks": "测试审批流程"
  }'
```

**触发审批的关键**: 当 `quantity × 商品单价 ≥ 1000` 时，记录状态自动变为 `pending_approval`。

#### 6.4 通过页面操作创建和查看审批记录

**创建审批记录**:

1. 进入「库存台账」页面 (`/inventory/ledger`)
2. 找到需要调整的 SKU 商品行
3. 点击操作列的「调整」按钮
4. 在弹出的调整对话框中：
   - 选择调整类型：盘盈、盘亏或报损
   - 输入调整数量（若金额 ≥ ¥1000，将触发审批）
   - 填写调整原因
   - 点击「确认」提交
5. 如果调整金额超过阈值，系统会提示「本次调整需要审批」

**查看审批记录**:

1. 进入「库存调整审批」页面 (`/inventory/approvals`)
2. 页面默认显示所有待审批的调整记录
3. 可通过筛选器按状态筛选：待审批、已通过、已拒绝
4. 点击记录可查看详情，包括：
   - 调整单号 (adjustmentNumber)
   - SKU 信息 (编码、名称)
   - 调整类型 (盘盈/盘亏/报损)
   - 调整数量
   - 调整金额
   - 申请人
   - 申请时间
   - 状态

**审批操作**:

1. 在审批列表页点击待审批记录的「审批」按钮
2. 查看调整详情和调整原因
3. 选择「通过」或「拒绝」
4. 如拒绝需填写拒绝理由
5. 点击确认完成审批

#### 6.5 审批状态说明

| 状态 | 代码 | 说明 |
|------|------|------|
| 待审批 | `pending_approval` | 等待审批人处理 |
| 已通过 | `approved` | 审批通过，库存已更新 |
| 已拒绝 | `rejected` | 审批被拒绝，库存未变化 |
| 草稿 | `draft` | 金额未达到审批阈值，已直接生效 |

---

**文档结束**
