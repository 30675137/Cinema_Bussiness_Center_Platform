{
  "metadata": {
    "title": "端到端测试用例文档 - BOM库存预占与扣减",
    "version": "1.0.0",
    "date": "2025-12-29"
  },
  "test_cases": [
    {
      "id": "TC-P005-001",
      "title": "单品BOM展开与库存预占 - 正向流程（US1）",
      "priority": "high",
      "type": "e2e",
      "preconditions": [
        "威士忌可乐鸡尾酒已配置BOM配方",
        "门店库存充足",
        "C端用户已登录"
      ],
      "test_data": {},
      "steps": [
        {
          "step_number": 1,
          "operator": "C端",
          "operation": "打开商品列表，选择\"威士忌可乐鸡尾酒\"",
          "expected_result": "商品详情展示正确",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 2,
          "operator": "C端",
          "operation": "点击\"加入购物车\"，数量设为1",
          "expected_result": "购物车显示1杯",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 3,
          "operator": "C端",
          "operation": "进入购物车，点击\"去结算\"",
          "expected_result": "跳转到订单确认页",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 4,
          "operator": "C端",
          "operation": "确认订单信息，点击\"提交订单\"",
          "expected_result": "触发订单创建API",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 5,
          "operator": "系统",
          "operation": "创建订单记录（beverage_orders表）",
          "expected_result": "订单状态为PENDING_PAYMENT",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 6,
          "operator": "系统",
          "operation": "调用库存预占API: POST /api/inventory/reservations",
          "expected_result": "API返回200成功",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 7,
          "operator": "系统",
          "operation": "BomExpansionService.expandBom() 展开BOM",
          "expected_result": "展开为4个原料组件",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 8,
          "operator": "系统",
          "operation": "检查威士忌库存：available=1000ml >= 45ml",
          "expected_result": "检查通过",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 9,
          "operator": "系统",
          "operation": "检查可乐库存：available=5000ml >= 150ml",
          "expected_result": "检查通过",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 10,
          "operator": "系统",
          "operation": "检查杯子库存：available=100 >= 1",
          "expected_result": "检查通过",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 11,
          "operator": "系统",
          "operation": "检查吸管库存：available=200 >= 1",
          "expected_result": "检查通过",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 12,
          "operator": "系统",
          "operation": "更新威士忌库存：reserved_qty: 0→45ml",
          "expected_result": "on_hand不变，reserved增加45ml",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 13,
          "operator": "系统",
          "operation": "更新可乐库存：reserved_qty: 0→150ml",
          "expected_result": "on_hand不变，reserved增加150ml",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 14,
          "operator": "系统",
          "operation": "更新杯子库存：reserved_qty: 0→1",
          "expected_result": "on_hand不变，reserved增加1",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 15,
          "operator": "系统",
          "operation": "更新吸管库存：reserved_qty: 0→1",
          "expected_result": "on_hand不变，reserved增加1",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 16,
          "operator": "系统",
          "operation": "创建4条inventory_reservations记录",
          "expected_result": "status=ACTIVE，关联orderId",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 17,
          "operator": "系统",
          "operation": "创建BOM快照（bom_snapshots表）",
          "expected_result": "快照包含4个组件的配方数据",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 18,
          "operator": "C端",
          "operation": "显示Toast提示\"下单成功，库存已预占\"",
          "expected_result": "提示显示正确",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 19,
          "operator": "C端",
          "operation": "自动跳转到支付页面",
          "expected_result": "显示订单ID和待支付金额",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        }
      ],
      "postchecks": []
    },
    {
      "id": "TC-P005-002",
      "title": "订单出品库存实扣 - 正向流程（US2）",
      "priority": "high",
      "type": "e2e",
      "preconditions": [
        "TC-P005-001已执行完成，库存已预占",
        "订单已支付（状态=PENDING_FULFILLMENT）",
        "库存状态："
      ],
      "test_data": {},
      "steps": [
        {
          "step_number": 1,
          "operator": "B端",
          "operation": "登录管理后台，进入\"订单管理\"",
          "expected_result": "显示订单列表",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 2,
          "operator": "B端",
          "operation": "找到测试订单，状态显示\"待出品\"",
          "expected_result": "订单状态正确",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 3,
          "operator": "B端",
          "operation": "点击订单详情，查看商品清单",
          "expected_result": "显示\"威士忌可乐鸡尾酒 × 1\"",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 4,
          "operator": "B端",
          "operation": "点击\"出品确认\"按钮",
          "expected_result": "触发库存扣减API",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 5,
          "operator": "系统",
          "operation": "调用POST /api/inventory/deductions",
          "expected_result": "API返回200成功",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 6,
          "operator": "系统",
          "operation": "查询该订单的ACTIVE预占记录",
          "expected_result": "找到4条预占记录",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 7,
          "operator": "系统",
          "operation": "加载BOM快照（不使用当前配方）",
          "expected_result": "使用订单创建时的配方版本",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 8,
          "operator": "系统",
          "operation": "锁定威士忌库存行（SELECT FOR UPDATE）",
          "expected_result": "悲观锁生效，防止并发修改",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 9,
          "operator": "系统",
          "operation": "验证 on_hand(1000) >= reserved(45)",
          "expected_result": "数据一致性校验通过",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 10,
          "operator": "系统",
          "operation": "扣减威士忌: on_hand: 1000→955ml, reserved: 45→0ml",
          "expected_result": "available保持955ml不变",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 11,
          "operator": "系统",
          "operation": "扣减可乐: on_hand: 5000→4850ml, reserved: 150→0ml",
          "expected_result": "available保持4850ml不变",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 12,
          "operator": "系统",
          "operation": "扣减杯子: on_hand: 100→99, reserved: 1→0",
          "expected_result": "available保持99不变",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 13,
          "operator": "系统",
          "operation": "扣减吸管: on_hand: 200→199, reserved: 1→0",
          "expected_result": "available保持199不变",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 14,
          "operator": "系统",
          "operation": "生成4条库存流水日志",
          "expected_result": "type=BOM_DEDUCTION, quantity为负数",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 15,
          "operator": "系统",
          "operation": "流水日志包含bom_snapshot_id",
          "expected_result": "关联到订单的BOM快照",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 16,
          "operator": "系统",
          "operation": "更新预占记录status: ACTIVE→FULFILLED",
          "expected_result": "标记预占已完成",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 17,
          "operator": "系统",
          "operation": "更新预占记录fulfilled_at字段",
          "expected_result": "记录完成时间戳",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 18,
          "operator": "B端",
          "operation": "显示Toast提示\"出品确认成功\"",
          "expected_result": "提示显示正确",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 19,
          "operator": "B端",
          "operation": "订单状态更新为\"已完成\"",
          "expected_result": "状态流转正确",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        }
      ],
      "postchecks": []
    },
    {
      "id": "TC-P005-003",
      "title": "库存不足拒绝预占 - 异常流程（US1边界）",
      "priority": "high",
      "type": "exception",
      "preconditions": [
        "威士忌库存不足：on_hand=30ml, reserved=0ml, available=30ml",
        "其他原料库存充足",
        "BOM配方：1杯需要45ml威士忌"
      ],
      "test_data": {},
      "steps": [
        {
          "step_number": 1,
          "operator": "C端",
          "operation": "下单1杯威士忌可乐鸡尾酒",
          "expected_result": "触发库存预占API",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 2,
          "operator": "系统",
          "operation": "BOM展开：需要45ml威士忌",
          "expected_result": "计算正确",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 3,
          "operator": "系统",
          "operation": "检查威士忌库存：available=30ml < required=45ml",
          "expected_result": "检查失败",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 4,
          "operator": "系统",
          "operation": "抛出InsufficientInventoryException",
          "expected_result": "异常抛出正确",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 5,
          "operator": "系统",
          "operation": "API返回400错误，包含shortages详情",
          "expected_result": "错误码: INV_BIZ_002",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 6,
          "operator": "系统",
          "operation": "shortages数组包含威士忌短缺信息",
          "expected_result": "available=30, required=45, shortage=15",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 7,
          "operator": "系统",
          "operation": "事务回滚，所有库存数据未修改",
          "expected_result": "所有原料库存保持不变",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 8,
          "operator": "系统",
          "operation": "未创建任何预占记录",
          "expected_result": "inventory_reservations表无新记录",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 9,
          "operator": "系统",
          "operation": "未创建BOM快照",
          "expected_result": "bom_snapshots表无新记录",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 10,
          "operator": "C端",
          "operation": "前端调用handleInventoryError()",
          "expected_result": "错误处理器正确解析",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 11,
          "operator": "C端",
          "operation": "显示Toast: \"威士忌库存不足\"",
          "expected_result": "错误提示友好、具体",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 12,
          "operator": "C端",
          "operation": "显示详细短缺信息（可选）",
          "expected_result": "\"可用30ml，需要45ml，差15ml\"",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        }
      ],
      "postchecks": []
    },
    {
      "id": "TC-P005-004",
      "title": "订单取消释放预占库存 - 正向流程（US1回退）",
      "priority": "high",
      "type": "e2e",
      "preconditions": [
        "TC-P005-001已执行，库存已预占",
        "订单状态=PENDING_PAYMENT（未支付）",
        "库存状态："
      ],
      "test_data": {},
      "steps": [
        {
          "step_number": 1,
          "operator": "C端",
          "operation": "进入\"我的订单\"，找到待支付订单",
          "expected_result": "显示订单详情",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 2,
          "operator": "C端",
          "operation": "点击\"取消订单\"按钮",
          "expected_result": "弹出确认弹窗",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 3,
          "operator": "C端",
          "operation": "确认取消",
          "expected_result": "调用取消订单API",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 4,
          "operator": "系统",
          "operation": "调用DELETE /api/inventory/reservations/{orderId}",
          "expected_result": "API返回200成功",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 5,
          "operator": "系统",
          "operation": "查询该订单的ACTIVE预占记录",
          "expected_result": "找到4条预占记录",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 6,
          "operator": "系统",
          "operation": "锁定威士忌库存行（SELECT FOR UPDATE）",
          "expected_result": "悲观锁生效",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 7,
          "operator": "系统",
          "operation": "释放威士忌预占：reserved: 45→0ml",
          "expected_result": "on_hand保持1000ml不变",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 8,
          "operator": "系统",
          "operation": "释放可乐预占：reserved: 150→0ml",
          "expected_result": "on_hand保持5000ml不变",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 9,
          "operator": "系统",
          "operation": "释放杯子预占：reserved: 1→0",
          "expected_result": "on_hand保持100不变",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 10,
          "operator": "系统",
          "operation": "释放吸管预占：reserved: 1→0",
          "expected_result": "on_hand保持200不变",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 11,
          "operator": "系统",
          "operation": "生成4条RESERVATION_RELEASE日志",
          "expected_result": "quantity=0（只影响reserved_qty）",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 12,
          "operator": "系统",
          "operation": "日志notes包含释放数量信息",
          "expected_result": "\"released_qty: 45\"",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 13,
          "operator": "系统",
          "operation": "更新预占记录status: ACTIVE→CANCELLED",
          "expected_result": "标记预占已取消",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 14,
          "operator": "系统",
          "operation": "API返回释放数量统计",
          "expected_result": "releasedReservations: 4",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 15,
          "operator": "C端",
          "operation": "显示Toast: \"订单已取消\"",
          "expected_result": "提示显示正确",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 16,
          "operator": "C端",
          "operation": "订单列表状态更新为\"已取消\"",
          "expected_result": "状态同步正确",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        }
      ],
      "postchecks": []
    },
    {
      "id": "TC-P005-005",
      "title": "多层级套餐BOM展开 - 复杂场景（US4）",
      "priority": "medium",
      "type": "functional",
      "preconditions": [
        "配置3层BOM结构：",
        "所有原料库存充足"
      ],
      "test_data": {},
      "steps": [
        {
          "step_number": 1,
          "operator": "C端",
          "operation": "下单1份\"情侣套餐\"",
          "expected_result": "订单创建成功",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 2,
          "operator": "系统",
          "operation": "BOM展开：第1层 - 套餐本身",
          "expected_result": "depth=0",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 3,
          "operator": "系统",
          "operation": "BOM展开：第2层 - 鸡尾酒+爆米花",
          "expected_result": "depth=1，2个成品",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 4,
          "operator": "系统",
          "operation": "BOM展开：第3层 - 7个原料",
          "expected_result": "depth=2，到达叶子节点",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 5,
          "operator": "系统",
          "operation": "聚合原料需求",
          "expected_result": "威士忌45ml、可乐150ml、杯子1、吸管1、玉米50g、黄油10g、纸桶1",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 6,
          "operator": "系统",
          "operation": "检查所有7种原料库存",
          "expected_result": "全部充足",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 7,
          "operator": "系统",
          "operation": "预占7种原料的库存",
          "expected_result": "reserved_qty增加",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 8,
          "operator": "系统",
          "operation": "创建7条预占记录",
          "expected_result": "每种原料1条",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 9,
          "operator": "系统",
          "operation": "创建BOM快照",
          "expected_result": "快照包含完整3层结构",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 10,
          "operator": "C端",
          "operation": "显示预占成功提示",
          "expected_result": "Toast正常",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        }
      ],
      "postchecks": []
    },
    {
      "id": "TC-P005-006",
      "title": "BOM深度超限保护 - 边界条件（US4边界）",
      "priority": "medium",
      "type": "functional",
      "preconditions": [
        "配置4层BOM结构（超过MAX_DEPTH=3）"
      ],
      "test_data": {},
      "steps": [
        {
          "step_number": 1,
          "operator": "C端",
          "operation": "尝试下单\"超级套餐\"",
          "expected_result": "触发BOM展开",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 2,
          "operator": "系统",
          "operation": "BOM递归展开到depth=4",
          "expected_result": "触发深度检查",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 3,
          "operator": "系统",
          "operation": "抛出BomDepthExceededException",
          "expected_result": "异常正确抛出",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 4,
          "operator": "系统",
          "operation": "异常信息包含skuId、currentDepth=4、maxDepth=3",
          "expected_result": "错误信息完整",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 5,
          "operator": "系统",
          "operation": "API返回400错误，错误码INV_BIZ_004",
          "expected_result": "HTTP状态码正确",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 6,
          "operator": "系统",
          "operation": "事务回滚，未创建任何预占记录",
          "expected_result": "数据库未污染",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 7,
          "operator": "C端",
          "operation": "显示错误提示: \"商品配置异常\"",
          "expected_result": "用户友好提示",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        }
      ],
      "postchecks": []
    },
    {
      "id": "TC-P005-007",
      "title": "库存流水查询 - B端查询（US3）",
      "priority": "medium",
      "type": "functional",
      "preconditions": [
        "TC-P005-002已执行，已产生BOM扣减流水",
        "测试订单ID: `test-order-001`",
        "流水表存在4条BOM_DEDUCTION记录"
      ],
      "test_data": {},
      "steps": [
        {
          "step_number": 1,
          "operator": "B端",
          "operation": "登录管理后台，进入\"库存管理\"",
          "expected_result": "显示库存模块",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 2,
          "operator": "B端",
          "operation": "点击\"库存流水\"菜单",
          "expected_result": "显示流水查询页面",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 3,
          "operator": "B端",
          "operation": "筛选条件：transactionType=BOM_DEDUCTION",
          "expected_result": "表单填写正常",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 4,
          "operator": "B端",
          "operation": "筛选条件：orderId=test-order-001",
          "expected_result": "表单填写正常",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 5,
          "operator": "B端",
          "operation": "点击\"查询\"按钮",
          "expected_result": "触发查询API",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 6,
          "operator": "系统",
          "operation": "调用GET /api/inventory/transactions?transactionType=BOM_DEDUCTION&orderId=xxx",
          "expected_result": "API返回200",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 7,
          "operator": "系统",
          "operation": "返回分页数据，totalElements=4",
          "expected_result": "记录数正确",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 8,
          "operator": "B端",
          "operation": "显示4条流水记录",
          "expected_result": "列表展示正常",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 9,
          "operator": "B端",
          "operation": "每条记录显示：SKU名称、数量变化、时间",
          "expected_result": "字段显示完整",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 10,
          "operator": "B端",
          "operation": "点击某条流水的\"查看详情\"",
          "expected_result": "进入详情页",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 11,
          "operator": "系统",
          "operation": "调用GET /api/inventory/transactions/{id}",
          "expected_result": "API返回200",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 12,
          "operator": "系统",
          "operation": "返回流水详情+BOM组件清单",
          "expected_result": "bomComponents数组非空",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 13,
          "operator": "B端",
          "operation": "显示BOM快照信息",
          "expected_result": "展示当时的配方数据",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 14,
          "operator": "B端",
          "operation": "BOM组件包含：componentSkuId、standardQuantity、wastageRate、actualQuantity",
          "expected_result": "字段完整",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        }
      ],
      "postchecks": []
    },
    {
      "id": "TC-P005-008",
      "title": "BOM配方变更后版本锁定验证 - 复杂场景（US2边界）",
      "priority": "medium",
      "type": "functional",
      "preconditions": [
        "订单已下单并预占库存（BOM快照已创建）",
        "原配方：45ml威士忌 + 150ml可乐",
        "订单状态=PENDING_FULFILLMENT"
      ],
      "test_data": {},
      "steps": [
        {
          "step_number": 1,
          "operator": "记录",
          "operation": "记录订单创建时的BOM快照",
          "expected_result": "snapshot包含45ml威士忌",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 2,
          "operator": "B端",
          "operation": "进入\"商品管理\"→\"BOM配方管理\"",
          "expected_result": "显示配方列表",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 3,
          "operator": "B端",
          "operation": "修改\"鸡尾酒\"配方：威士忌 45ml → 50ml",
          "expected_result": "配方更新成功",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 4,
          "operator": "系统",
          "operation": "bom_components表更新",
          "expected_result": "quantity字段改为50",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 5,
          "operator": "B端",
          "operation": "进入\"订单管理\"，找到测试订单",
          "expected_result": "显示订单详情",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 6,
          "operator": "B端",
          "operation": "点击\"出品确认\"",
          "expected_result": "触发库存扣减",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 7,
          "operator": "系统",
          "operation": "加载BOM快照（snapshot-xxx）",
          "expected_result": "使用快照数据，而非查询bom_components",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 8,
          "operator": "系统",
          "operation": "从快照读取威士忌数量：45ml",
          "expected_result": "数量为快照版本",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 9,
          "operator": "系统",
          "operation": "扣减威士忌库存：45ml（而非50ml）",
          "expected_result": "扣减量正确",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 10,
          "operator": "验证",
          "operation": "检查库存流水quantity字段",
          "expected_result": "quantity=-45（不是-50）",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 11,
          "operator": "验证",
          "operation": "检查库存表on_hand_qty减少",
          "expected_result": "减少45ml（不是50ml）",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        }
      ],
      "postchecks": []
    },
    {
      "id": "TC-P005-009",
      "title": "并发下单库存竞争 - 压力测试（US1并发）",
      "priority": "medium",
      "type": "concurrent",
      "preconditions": [
        "威士忌库存：on_hand=100ml, reserved=0ml, available=100ml",
        "鸡尾酒配方：需要45ml威士忌",
        "准备10个并发请求，每个下单1杯（总需求450ml）"
      ],
      "test_data": {},
      "steps": [
        {
          "step_number": 1,
          "operator": "测试脚本",
          "operation": "初始化10个并发HTTP客户端",
          "expected_result": "客户端就绪",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 2,
          "operator": "测试脚本",
          "operation": "同时发送10个POST /api/inventory/reservations请求",
          "expected_result": "请求并发发送",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 3,
          "operator": "系统",
          "operation": "第1个请求获取威士忌行锁（SELECT FOR UPDATE）",
          "expected_result": "锁定成功",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 4,
          "operator": "系统",
          "operation": "第2-10个请求等待行锁释放",
          "expected_result": "阻塞等待",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 5,
          "operator": "系统",
          "operation": "第1个请求检查库存：100ml >= 45ml",
          "expected_result": "检查通过",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 6,
          "operator": "系统",
          "operation": "第1个请求预占45ml：reserved: 0→45ml",
          "expected_result": "更新成功",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 7,
          "operator": "系统",
          "operation": "第1个请求事务提交，释放行锁",
          "expected_result": "锁释放",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 8,
          "operator": "系统",
          "operation": "第2个请求获得行锁",
          "expected_result": "锁定成功",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 9,
          "operator": "系统",
          "operation": "第2个请求检查库存：55ml >= 45ml",
          "expected_result": "检查通过",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 10,
          "operator": "系统",
          "operation": "第2个请求预占45ml：reserved: 45→90ml",
          "expected_result": "更新成功",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 11,
          "operator": "系统",
          "operation": "第2个请求事务提交",
          "expected_result": "锁释放",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 12,
          "operator": "系统",
          "operation": "第3个请求获得行锁",
          "expected_result": "锁定成功",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 13,
          "operator": "系统",
          "operation": "第3个请求检查库存：10ml < 45ml",
          "expected_result": "检查失败",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 14,
          "operator": "系统",
          "operation": "第3个请求抛出InsufficientInventoryException",
          "expected_result": "异常抛出",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 15,
          "operator": "系统",
          "operation": "第3-10个请求全部返回400错误",
          "expected_result": "全部失败",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 16,
          "operator": "测试脚本",
          "operation": "统计成功数: 2，失败数: 8",
          "expected_result": "结果符合预期",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        }
      ],
      "postchecks": []
    },
    {
      "id": "TC-P005-010",
      "title": "损耗率计算验证 - 功能测试（US5）",
      "priority": "low",
      "type": "functional",
      "preconditions": [
        "鸡尾酒BOM配方设置损耗率："
      ],
      "test_data": {},
      "steps": [
        {
          "step_number": 1,
          "operator": "C端",
          "operation": "下单1杯鸡尾酒",
          "expected_result": "订单创建",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 2,
          "operator": "系统",
          "operation": "BOM展开计算损耗量",
          "expected_result": "威士忌: 47.25ml, 可乐: 153ml",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 3,
          "operator": "系统",
          "operation": "预占威士忌：reserved增加47.25ml",
          "expected_result": "包含损耗",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 4,
          "operator": "系统",
          "operation": "预占可乐：reserved增加153ml",
          "expected_result": "包含损耗",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 5,
          "operator": "B端",
          "operation": "出品确认",
          "expected_result": "触发实扣",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 6,
          "operator": "系统",
          "operation": "从BOM快照读取wastageRate",
          "expected_result": "wastageRate字段存在",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 7,
          "operator": "系统",
          "operation": "计算实扣量：standardQty * (1 + wastageRate)",
          "expected_result": "公式正确",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 8,
          "operator": "系统",
          "operation": "扣减威士忌：on_hand减少47.25ml",
          "expected_result": "扣减量含损耗",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 9,
          "operator": "系统",
          "operation": "扣减可乐：on_hand减少153ml",
          "expected_result": "扣减量含损耗",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        },
        {
          "step_number": 10,
          "operator": "验证",
          "operation": "检查流水日志quantity字段",
          "expected_result": "-47.25, -153",
          "actual_result": "",
          "pass_status": "☐ 通过 ☐ 失败"
        }
      ],
      "postchecks": []
    }
  ],
  "state_transitions": [],
  "data_validations": {
    "bom_deduction": [],
    "inventory_logs": [],
    "order_data": []
  }
}