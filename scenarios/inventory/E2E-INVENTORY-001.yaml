# E2E Scenario: BOM 库存扣减测试
# Generated by test-scenario-author skill
# Date: 2025-12-30

scenario_id: E2E-INVENTORY-001
spec_ref: P005
title: BOM 库存扣减测试
description: 验证当用户下单时，系统正确扣减 BOM 中所有原料的库存

tags:
  module:
    - inventory
  channel:
    - h5
  deploy:
    - saas
  priority: p2
  smoke: false

preconditions:
  role: normal_user

steps:
  - action: login
    params:
      testdata_ref: inventoryTestData.user_normal
    description: 普通用户登录系统

  - action: browse_product
    params:
      testdata_ref: inventoryTestData.product_with_bom
    description: 浏览一个配置了 BOM 的饮品商品（如爆米花套餐）

  - action: add_to_cart
    params:
      testdata_ref: inventoryTestData.product_with_bom
      quantity: 2
    description: 添加 2 份商品到购物车

  - action: create_order
    params:
      testdata_ref: inventoryTestData.order_data
    description: 创建订单并提交

  - action: pay
    params:
      testdata_ref: inventoryTestData.payment_wechat
    description: 使用微信支付完成订单

assertions:
  - type: ui
    check: element_visible
    params:
      element: order_success_page
    timeout: 5000

  - type: api
    check: database_field_equals
    params:
      table: orders
      field: status
      expected: "paid"
      testdata_ref: inventoryTestData.order_data
    timeout: 3000

  - type: api
    check: inventory_updated
    params:
      table: inventory
      field: quantity
      testdata_ref: inventoryTestData.bom_materials
      expected: "decreased_by_2"
    timeout: 3000

artifacts:
  trace: on-failure
  video: on-failure
