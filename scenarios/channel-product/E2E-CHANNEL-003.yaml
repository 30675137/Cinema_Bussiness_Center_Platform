# E2E Scenario: Edit Channel Product with Hidden Category Display
# Generated by Claude Code for O008-channel-product-category-migration
# Date: 2026-01-04

scenario_id: E2E-CHANNEL-003
spec_ref: O008-channel-product-category-migration
title: 编辑商品时隐藏分类正确显示
description: |
  验证O008迁移后，编辑已关联隐藏分类的商品时：
  1. CategorySelect组件以edit模式加载，包含隐藏分类
  2. 当前关联的隐藏分类显示 "(已隐藏)" 标记
  3. 隐藏分类可见但不可切换到其他隐藏分类
  4. 可以正常切换到可见分类

tags:
  module: [channel-product, menu-category]
  channel: [web]
  deploy: [saas]
  priority: p1
  smoke: false
  user_story: [US2]

preconditions:
  role: admin
  testdata_ref: TD-CHANNEL-PRODUCT-HIDDEN-CATEGORY
  description: |
    - 用户已登录B端管理后台
    - 系统中存在一个渠道商品，关联到已隐藏的分类
    - 该隐藏分类 isVisible=false
    - 系统中存在其他可见分类可供切换

steps:
  # 1. 登录并导航
  - action: login
    description: 登录B端管理后台

  - action: navigate
    description: 访问渠道商品配置列表页
    params:
      path: /channel-products/mini-program

  # 2. 找到并点击编辑关联隐藏分类的商品
  - action: fill_form
    description: 搜索关联隐藏分类的商品
    params:
      fields:
        "keyword": "隐藏分类测试商品"

  - action: wait
    description: 等待搜索结果
    params:
      duration: 500

  - action: click
    description: 点击编辑按钮
    params:
      selector: ".ant-table-row:first-child button:has-text('编辑')"

  # 3. 进入编辑页面
  - action: wait_for_load
    description: 等待编辑页面加载完成

  # 4. 验证CategorySelect显示隐藏分类
  - action: click
    description: 点击分类选择器下拉框
    params:
      selector: "[data-testid='category-select'] .ant-select-selector"

  - action: wait
    description: 等待分类列表加载
    params:
      duration: 500

  # 5. 验证隐藏分类标记
  - action: assert
    description: 验证当前选中的隐藏分类显示"(已隐藏)"标记
    params:
      type: element_contains_text
      selector: "[data-testid='category-select'] .ant-select-selection-item"
      text: "(已隐藏)"

  # 6. 验证隐藏分类在列表中可见
  - action: assert
    description: 隐藏分类选项应在下拉列表中可见
    params:
      type: element_visible
      selector: ".ant-select-dropdown .ant-select-item-option:has-text('(已隐藏)')"

  # 7. 切换到可见分类
  - action: click
    description: 选择一个可见分类（不带"(已隐藏)"标记）
    params:
      selector: ".ant-select-dropdown .ant-select-item-option:not(:has-text('(已隐藏)')):first-child"

  # 8. 保存更改
  - action: click
    description: 保存商品配置
    params:
      selector: "button:has-text('保 存')"

  - action: wait_for_toast
    description: 等待成功提示

assertions:
  # 验证edit模式加载隐藏分类
  - type: ui
    check: element_visible
    description: CategorySelect应以edit模式加载，显示隐藏分类
    params:
      selector: ".ant-select-dropdown .ant-select-item-option:has-text('(已隐藏)')"

  # 验证隐藏分类标记
  - type: ui
    check: element_contains_text
    description: 隐藏分类应显示"(已隐藏)"后缀
    params:
      selector: ".ant-select-dropdown"
      text: "(已隐藏)"

  # 验证切换后保存成功
  - type: api
    check: database_field_equals
    description: 商品的categoryId应更新为新的可见分类
    params:
      table: "channel_product_config"
      field: "category_id"
      condition: "display_name = '隐藏分类测试商品'"
      # expected: 新分类的UUID（动态验证）
      not_null: true

artifacts:
  trace: on-failure
  video: on-failure
  screenshot: only-on-failure

metadata:
  created_at: "2026-01-04T18:00:00Z"
  created_by: "claude-code"
  version: "1.0.0"
  migration_spec: "O008-channel-product-category-migration"
