# E2E Scenario: Channel Product Configuration Flow
# Generated by Claude Code for O005-channel-product-config
# Date: 2026-01-01

scenario_id: E2E-CHANNEL-001
spec_ref: O005-channel-product-config
title: 渠道商品配置流程验证
description: |
  验证渠道商品配置的完整流程，包括：
  1. 从SKU创建渠道商品（小程序）
  2. 配置基础信息和规格选项
  3. 在列表页查看和筛选
  4. 编辑商品和修改规格
  5. 上架/下架操作
  6. 删除商品操作

tags:
  module: [channel-product]
  channel: [web]
  deploy: [saas]
  priority: p1
  smoke: true
  user_story: [US1, US2, US3, US4]

preconditions:
  role: admin
  testdata_ref: TD-SKU-BEVERAGE-001
  description: |
    - 用户已登录B端管理后台
    - 系统中存在类型为 FINISHED_PRODUCT 的成品SKU
    - 该SKU尚未配置到 MINI_PROGRAM 渠道

steps:
  # 1. 导航到渠道商品配置页
  - action: login
    description: 登录B端管理后台

  - action: navigate
    description: 访问渠道商品配置列表页
    params:
      path: /channel-products/mini-program

  # 2. 创建渠道商品
  - action: click
    description: 点击"新增商品"按钮
    params:
      selector: "button:has-text('新增商品')"

  - action: wait_for_modal
    description: 等待SKU选择器弹窗显示

  - action: select_item
    description: 选择一个成品SKU
    params:
      selector: ".ant-table-row:visible" # 选择第一行可见数据

  - action: click
    description: 点击"确定"按钮确认选择
    params:
      selector: "button:has-text('确 定')"

  # 3. 配置商品信息和规格
  - action: wait_for_load
    description: 等待进入编辑/创建页面

  - action: fill_form
    description: 填写基础信息
    params:
      fields:
        "displayName": "测试拿铁"
        "description": "E2E测试商品描述"
        "sortOrder": "1"

  - action: click
    description: 点击"添加规格"按钮
    params:
      selector: "button:has-text('添加规格')"

  - action: fill_form
    description: 填写规格组信息
    params:
      prefix: "specs[0]"
      fields:
        "name": "温度"
        "required": true
        # "type": "TEMPERATURE" # 默认为 CUSTOM，之后可能需要选择

  - action: click
    description: 点击"添加选项"按钮
    params:
      selector: "button:has-text('添加选项')"

  - action: fill_form
    description: 填写规格选项1
    params:
      prefix: "specs[0].options[0]"
      fields:
        "name": "热"
        "priceAdjust": 0

  - action: click
    description: 再次点击"添加选项"按钮
    params:
      selector: "button:has-text('添加选项')"

  - action: fill_form
    description: 填写规格选项2
    params:
      prefix: "specs[0].options[1]"
      fields:
        "name": "冰"
        "priceAdjust": 0

  - action: click
    description: 保存商品配置
    params:
      selector: "button:has-text('保 存')"

  - action: wait_for_load
    description: 等待返回列表页

  # 4. 验证列表显示和筛选
  - action: fill_form
    description: 搜索刚才创建的商品
    params:
      fields:
        "keyword": "测试拿铁"

  - action: wait
    description: 等待搜索结果
    params:
      duration: 1000

  # 5. 上架操作
  - action: click
    description: 点击"上架"按钮
    params:
      selector: "button:has-text('上架')"

  - action: wait_for_toast
    description: 等待成功提示

  # 6. 编辑商品
  - action: click
    description: 点击"编辑"按钮
    params:
      selector: "button:has-text('编辑')"

  - action: wait_for_load
    description: 等待进入编辑页

  - action: fill_form
    description: 修改商品名称
    params:
      fields:
        "displayName": "测试拿铁(已修改)"

  - action: click
    description: 保存并在返回后验证
    params:
      selector: "button:has-text('保 存')"

  # 7. 删除商品
  - action: click
    description: 点击"下架"按钮(只有下架状态才能删除)
    params:
      selector: "button:has-text('下架')"

  - action: wait
    description: 等待下架完成
    params:
      duration: 500

  - action: click
    description: 点击"删除"按钮
    params:
      selector: "button:has-text('删除')"

  - action: click
    description: 确认删除
    params:
      selector: ".ant-popconfirm-buttons button:has-text('确 定')"

assertions:
  # 验证创建后列表显示
  - type: ui
    check: element_visible
    description: 列表中应显示创建的商品
    params:
      selector: ".ant-table-row:has-text('测试拿铁')"

  # 验证数据库记录
  - type: api
    check: database_record_exists
    description: 数据库中应存在该商品配置记录
    params:
      table: "channel_product_config"
      condition: "display_name = '测试拿铁'"

  # 验证Spec存储
  - type: api
    check: database_field_equals
    description: 规格JSON应包含配置的选项
    params:
      test_query: "SELECT count(*) FROM channel_product_config WHERE display_name = '测试拿铁' AND specs @> '[{\"name\": \"温度\"}]'"
      expected_value: 1

  # 验证更新后显示
  - type: ui
    check: element_visible
    description: 列表中应显示修改后的名称
    params:
      selector: ".ant-table-row:has-text('测试拿铁(已修改)')"

  # 验证删除后消失
  - type: ui
    check: element_not_visible
    description: 列表中不应再显示该商品
    params:
      selector: ".ant-table-row:has-text('测试拿铁(已修改)')"

  # 验证软删除
  - type: api
    check: database_record_exists
    description: 数据库记录应标记为deleted_at非空
    params:
      table: "channel_product_config"
      condition: "display_name = '测试拿铁(已修改)' AND deleted_at IS NOT NULL"

artifacts:
  trace: on-failure
  video: on-failure
  screenshot: only-on-failure

metadata:
  created_at: "2026-01-01T12:00:00Z"
  created_by: "claude-code"
  version: "1.0.0"
