# E2E Scenario: Filter Channel Products by Dynamic Category
# Generated by Claude Code for O008-channel-product-category-migration
# Date: 2026-01-04

scenario_id: E2E-CHANNEL-004
spec_ref: O008-channel-product-category-migration
title: 按动态分类筛选渠道商品
description: |
  验证O008迁移后，列表页筛选功能使用动态分类：
  1. CategorySelect组件以create模式加载（仅显示可见分类）
  2. 支持allowClear清除筛选
  3. 选择分类后列表正确过滤
  4. 清除筛选后显示全部商品

tags:
  module: [channel-product, menu-category]
  channel: [web]
  deploy: [saas]
  priority: p1
  smoke: false
  user_story: [US3]

preconditions:
  role: admin
  testdata_ref: TD-CHANNEL-PRODUCTS-MULTI-CATEGORY
  description: |
    - 用户已登录B端管理后台
    - 系统中存在多个不同分类的渠道商品
    - 至少有2个可见分类，各有至少1个商品

steps:
  # 1. 登录并导航
  - action: login
    description: 登录B端管理后台

  - action: navigate
    description: 访问渠道商品配置列表页
    params:
      path: /channel-products/mini-program

  # 2. 记录初始商品数量
  - action: wait_for_load
    description: 等待列表加载完成

  - action: store
    description: 记录初始商品总数
    params:
      selector: ".ant-pagination-total-text"
      variable: "initialTotal"

  # 3. 打开分类筛选器
  - action: click
    description: 点击分类筛选下拉框
    params:
      selector: "[data-testid='category-filter'] .ant-select-selector"

  - action: wait
    description: 等待分类列表加载
    params:
      duration: 500

  # 4. 验证筛选器仅显示可见分类
  - action: assert
    description: 筛选器不应显示隐藏分类
    params:
      type: element_not_visible
      selector: ".ant-select-dropdown .ant-select-item-option:has-text('(已隐藏)')"

  # 5. 选择一个分类进行筛选
  - action: click
    description: 选择第一个分类
    params:
      selector: ".ant-select-dropdown .ant-select-item-option:first-child"

  - action: wait
    description: 等待筛选结果
    params:
      duration: 500

  # 6. 验证筛选结果
  - action: store
    description: 记录筛选后商品数量
    params:
      selector: ".ant-pagination-total-text"
      variable: "filteredTotal"

  - action: assert
    description: 筛选后商品数量应少于或等于初始数量
    params:
      type: compare
      left: "filteredTotal"
      operator: "<="
      right: "initialTotal"

  # 7. 清除筛选
  - action: click
    description: 点击清除按钮
    params:
      selector: "[data-testid='category-filter'] .ant-select-clear"

  - action: wait
    description: 等待清除后刷新
    params:
      duration: 500

  # 8. 验证恢复全部商品
  - action: store
    description: 记录清除后商品数量
    params:
      selector: ".ant-pagination-total-text"
      variable: "clearedTotal"

  - action: assert
    description: 清除筛选后应恢复全部商品
    params:
      type: compare
      left: "clearedTotal"
      operator: "=="
      right: "initialTotal"

assertions:
  # 验证筛选器组件
  - type: ui
    check: element_visible
    description: CategorySelect筛选组件应正确渲染
    params:
      selector: "[data-testid='category-filter']"

  # 验证allowClear功能
  - type: ui
    check: element_visible
    description: 选择分类后应显示清除按钮
    params:
      selector: "[data-testid='category-filter'] .ant-select-clear"
    when: "after_selection"

  # 验证API请求参数
  - type: api
    check: request_params
    description: 筛选时API应发送categoryId参数
    params:
      endpoint: "/api/channel-products"
      method: "GET"
      expected_param: "categoryId"
      # categoryId应为UUID格式

  # 验证筛选结果匹配
  - type: api
    check: database_query
    description: 筛选结果应仅包含选中分类的商品
    params:
      query: |
        SELECT count(DISTINCT cpc.category_id) FROM channel_product_config cpc
        WHERE cpc.deleted_at IS NULL
        -- 结果应为1（仅选中的分类）

artifacts:
  trace: on-failure
  video: on-failure
  screenshot: only-on-failure

metadata:
  created_at: "2026-01-04T18:00:00Z"
  created_by: "claude-code"
  version: "1.0.0"
  migration_spec: "O008-channel-product-category-migration"
