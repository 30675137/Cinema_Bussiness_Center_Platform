# E2E Scenario: Dynamic Category Selection in Channel Product
# Generated by Claude Code for O008-channel-product-category-migration
# Date: 2026-01-04

scenario_id: E2E-CHANNEL-002
spec_ref: O008-channel-product-category-migration
title: 创建商品时使用动态分类选择
description: |
  验证O008迁移后，创建渠道商品时使用动态MenuCategory选择器：
  1. CategorySelect组件正确加载分类列表
  2. 分类选项按sortOrder排序
  3. 搜索过滤功能正常
  4. 选择分类后表单正确提交categoryId (UUID)

tags:
  module: [channel-product, menu-category]
  channel: [web]
  deploy: [saas]
  priority: p1
  smoke: true
  user_story: [US1]

preconditions:
  role: admin
  testdata_ref: TD-MENU-CATEGORY-001
  description: |
    - 用户已登录B端管理后台
    - 系统中存在可见的菜单分类 (isVisible=true)
    - 系统中存在成品SKU可用于配置

steps:
  # 1. 登录并导航
  - action: login
    description: 登录B端管理后台

  - action: navigate
    description: 访问渠道商品配置列表页
    params:
      path: /channel-products/mini-program

  # 2. 开始创建商品
  - action: click
    description: 点击"新增商品"按钮
    params:
      selector: "button:has-text('新增商品')"

  - action: wait_for_modal
    description: 等待SKU选择器弹窗显示

  - action: select_item
    description: 选择一个成品SKU
    params:
      selector: ".ant-table-row:visible"

  - action: click
    description: 点击"确定"按钮确认选择
    params:
      selector: "button:has-text('确 定')"

  # 3. 验证CategorySelect组件加载
  - action: wait_for_load
    description: 等待进入创建页面

  - action: click
    description: 点击分类选择器下拉框
    params:
      selector: "[data-testid='category-select'] .ant-select-selector"

  - action: wait
    description: 等待分类列表加载
    params:
      duration: 500

  # 4. 验证分类列表显示
  - action: assert
    description: 验证分类选项存在
    params:
      type: element_visible
      selector: ".ant-select-dropdown .ant-select-item-option"

  # 5. 搜索分类
  - action: input
    description: 在分类搜索框输入关键词
    params:
      selector: "[data-testid='category-select'] input"
      value: "饮品"

  - action: wait
    description: 等待搜索过滤
    params:
      duration: 300

  # 6. 选择分类
  - action: click
    description: 选择一个分类选项
    params:
      selector: ".ant-select-dropdown .ant-select-item-option:visible:first-child"

  # 7. 填写其他必填字段
  - action: fill_form
    description: 填写商品基础信息
    params:
      fields:
        "displayName": "O008测试商品-动态分类"
        "description": "验证动态分类选择功能"

  # 8. 提交表单
  - action: click
    description: 保存商品配置
    params:
      selector: "button:has-text('保 存')"

  - action: wait_for_toast
    description: 等待成功提示

assertions:
  # 验证CategorySelect加载
  - type: ui
    check: element_visible
    description: CategorySelect组件应正确渲染
    params:
      selector: "[data-testid='category-select']"

  # 验证分类列表非空
  - type: ui
    check: element_count_greater_than
    description: 应显示至少一个分类选项
    params:
      selector: ".ant-select-dropdown .ant-select-item-option"
      min_count: 1

  # 验证提交后数据
  - type: api
    check: database_record_exists
    description: 数据库应存在categoryId为UUID格式的记录
    params:
      table: "channel_product_config"
      condition: "display_name = 'O008测试商品-动态分类' AND category_id IS NOT NULL AND category_id != ''"

  # 验证categoryId关联正确
  - type: api
    check: database_query
    description: categoryId应关联到有效的menu_category记录
    params:
      query: |
        SELECT count(*) FROM channel_product_config cpc
        JOIN menu_category mc ON cpc.category_id = mc.id
        WHERE cpc.display_name = 'O008测试商品-动态分类'
      expected_value: 1

artifacts:
  trace: on-failure
  video: on-failure
  screenshot: only-on-failure

metadata:
  created_at: "2026-01-04T18:00:00Z"
  created_by: "claude-code"
  version: "1.0.0"
  migration_spec: "O008-channel-product-category-migration"
