# 功能规格: 商品订单列表查看与管理

**功能分支**: `O001-product-order-list`
**创建日期**: 2025-12-27
**状态**: 草稿
**规格编号**: O001 (订单管理 - Order Management - 商品订单)

<!--
  重要说明:
  - 商品订单模块(O)和预约订单模块(U/RSV)是两个独立的系统
  - O = 订单管理 (Order Management - 商品订单)
  - U/RSV = 预订管理 (Reservation Management - 预约订单)
-->

## 明确事项

### 会话 2025-12-27

- Q: 前端页面路由路径应该是什么？ → A: 订单列表页使用 `/orders/list`，订单详情页使用 `/orders/:id`
- Q: 后端 API 路由路径应该是什么？ → A: 订单列表接口使用 `/api/orders`（遵循 RESTful 规范）
- Q: 订单号生成格式应该是什么？ → A: 使用 `ORD + YYYYMMDD + 6位随机字母数字` 格式（如 `ORD20251227AB12CD`），兼顾日期可追溯性和随机唯一性
- Q: 手机号脱敏显示格式应该是什么？ → A: 中间4位星号（`138****8000`），保留前3位和后4位
- Q: 未选择时间筛选时默认显示多久的订单？ → A: 默认显示近30天订单，超过30天的订单需通过时间筛选查看
- Q: 订单导出支持哪些文件格式？ → A: 同时支持 Excel（.xlsx）和 CSV（.csv）两种格式

## 用户场景与测试 *(必填)*

### 用户故事 1 - B端订单列表查看 (优先级: P1) 🎯 MVP

**角色**: 运营人员
**需求**: 我需要查看所有商品订单，以便跟踪订单状态和及时处理订单
**价值**: 运营人员能够快速了解订单全貌，提高订单处理效率

**为什么是 P1 优先级**: 这是订单管理的核心功能，没有订单列表就无法进行后续的订单处理操作。这是整个订单管理系统的基础。

**独立测试**:
- 访问订单列表页面（路由：`/orders/list`），能够看到所有商品订单的基本信息（订单号、用户、商品、金额、状态、时间）
- 订单按创建时间倒序排列，最新订单在最前面
- 每页显示 20 条订单，支持翻页

**验收场景**:

1. **Given** 系统中存在多个商品订单，**When** 运营人员访问订单列表页（`/orders/list`），**Then** 显示所有订单，包含订单号、用户名、商品名称、订单金额、订单状态、创建时间
2. **Given** 订单总数超过 20 条，**When** 运营人员查看订单列表，**Then** 系统分页显示，每页 20 条，提供翻页控件
3. **Given** 运营人员在订单列表页，**When** 点击某个订单，**Then** 跳转到订单详情页（`/orders/:id`）展示完整订单信息

---

### 用户故事 2 - 订单多维度筛选 (优先级: P1) 🎯 MVP

**角色**: 运营人员
**需求**: 我需要通过订单状态、时间范围、用户信息等条件快速筛选订单
**价值**: 在大量订单中快速定位目标订单，提高工作效率

**为什么是 P1 优先级**: 筛选功能是订单列表的核心能力,运营人员需要针对特定状态或时间段的订单进行处理，没有筛选功能会导致效率低下。

**独立测试**:
- 通过订单状态筛选，只显示符合条件的订单
- 通过时间范围筛选，只显示指定时间段内创建的订单
- 通过用户信息搜索（用户名/手机号），只显示该用户的订单
- 多个筛选条件可以组合使用

**验收场景**:

1. **Given** 运营人员在订单列表页，**When** 选择"待支付"状态筛选，**Then** 只显示状态为"待支付"的订单
2. **Given** 运营人员在订单列表页，**When** 选择时间范围"2025-12-20 至 2025-12-27"，**Then** 只显示该时间段内创建的订单
3. **Given** 运营人员在订单列表页，**When** 输入用户手机号"13800138000"搜索，**Then** 只显示该手机号用户的订单
4. **Given** 运营人员在订单列表页，**When** 同时选择"已支付"状态和时间范围筛选，**Then** 显示符合两个条件的订单
5. **Given** 运营人员已应用筛选条件，**When** 点击"重置"按钮，**Then** 清空所有筛选条件，恢复显示全部订单

---

### 用户故事 3 - 订单详情查看 (优先级: P1) 🎯 MVP

**角色**: 运营人员
**需求**: 我需要查看订单的完整详细信息
**价值**: 了解订单的所有细节，以便准确处理订单问题

**为什么是 P1 优先级**: 订单详情是处理订单的必要信息，运营人员需要完整的订单信息才能做出正确的处理决策。

**独立测试**:
- 从订单列表点击订单，能够查看订单的所有详细信息
- 订单详情包含：订单基本信息、用户信息、商品信息、支付信息、物流信息、订单日志

**验收场景**:

1. **Given** 运营人员在订单列表页，**When** 点击某个订单，**Then** 进入订单详情页（`/orders/:id`），显示订单号、创建时间、订单状态
2. **Given** 运营人员在订单详情页，**When** 查看用户信息区域，**Then** 显示用户名、手机号、收货地址
3. **Given** 运营人员在订单详情页，**When** 查看商品信息区域，**Then** 显示商品名称、规格、数量、单价、小计
4. **Given** 运营人员在订单详情页，**When** 查看支付信息区域，**Then** 显示支付方式、支付金额、支付时间（如已支付）
5. **Given** 运营人员在订单详情页，**When** 查看订单日志区域，**Then** 显示订单状态变更记录（时间、操作人、变更内容）

---

### 用户故事 4 - 订单状态管理 (优先级: P2)

**角色**: 运营人员
**需求**: 我需要手动更新订单状态（发货、完成、取消）
**价值**: 能够及时更新订单流转状态，确保订单处理流程顺畅

**为什么是 P2 优先级**: 订单状态管理是重要功能，但部分状态可以通过系统自动流转（如支付成功后自动变为"已支付"）。运营人员主要处理发货、完成、异常取消等操作。

**独立测试**:
- 对于"已支付"的订单，可以标记为"已发货"
- 对于"已发货"的订单，可以标记为"已完成"
- 对于"待支付"或"已支付"的订单，可以取消订单
- 状态变更需要记录到订单日志

**验收场景**:

1. **Given** 订单状态为"已支付"，**When** 运营人员点击"标记发货"按钮，**Then** 订单状态更新为"已发货"，订单日志记录此操作
2. **Given** 订单状态为"已发货"，**When** 运营人员点击"标记完成"按钮，**Then** 订单状态更新为"已完成"，订单日志记录此操作
3. **Given** 订单状态为"待支付"或"已支付"，**When** 运营人员点击"取消订单"并填写取消原因，**Then** 订单状态更新为"已取消"，订单日志记录此操作和原因
4. **Given** 订单状态为"已发货"或"已完成"，**When** 运营人员查看操作按钮，**Then** 不显示"取消订单"按钮（不允许取消）
5. **Given** 运营人员更新订单状态，**When** 状态更新成功，**Then** 显示成功提示消息，并刷新订单详情

---

### 边界情况

- 当订单列表为空时，显示"暂无订单"的空状态提示
- 当筛选条件无匹配结果时，显示"未找到符合条件的订单"提示
- 当订单数量过多时（如超过 10000 条），分页加载应保持流畅，避免性能问题
- 当运营人员尝试对不符合条件的订单进行状态变更时（如取消已完成的订单），系统应阻止操作并提示错误信息
- 当多个运营人员同时操作同一订单时，使用乐观锁机制防止状态冲突
- 订单详情页需要处理订单不存在的情况（显示 404 错误）

## 需求 *(必填)*

### 功能性需求

- **FR-001**: 系统必须展示所有商品订单的列表，包含订单号、用户信息、商品摘要、订单金额、订单状态、创建时间
- **FR-002**: 系统必须支持按订单状态筛选订单（待支付、已支付、已发货、已完成、已取消）
- **FR-003**: 系统必须支持按时间范围筛选订单（起始日期、结束日期），默认显示近30天订单
- **FR-004**: 系统必须支持按用户信息搜索订单（用户名、手机号）
- **FR-005**: 系统必须支持多个筛选条件的组合使用
- **FR-006**: 系统必须提供订单详情页，展示订单的完整信息（订单基本信息、用户信息、商品列表、支付信息、物流信息、订单日志）
- **FR-007**: 系统必须允许运营人员更新订单状态（发货、完成、取消），并记录操作日志
- **FR-008**: 系统必须对订单状态变更进行权限校验，阻止非法状态转换（如已完成订单不可取消）
- **FR-009**: 系统必须记录订单的所有状态变更历史，包括时间、操作人、变更内容
- **FR-010**: 系统必须对订单列表进行分页展示，每页显示 20 条记录
- **FR-011**: 系统必须提供订单导出功能，支持 Excel（.xlsx）和 CSV（.csv）两种格式，包含筛选后的订单数据
- **FR-012**: 系统必须使用乐观锁机制防止并发更新冲突
- **FR-013**: 前端订单列表页路由必须为 `/orders/list`，订单详情页路由必须为 `/orders/:id`
- **FR-014**: 后端订单列表查询接口必须为 `GET /api/orders`（支持分页、筛选参数），订单详情接口必须为 `GET /api/orders/:id`

### 关键实体

- **商品订单 (ProductOrder)**:
  - 订单号（唯一标识，格式：`ORD + YYYYMMDD + 6位随机字母数字`，如 `ORD20251227AB12CD`）
  - 用户信息（用户ID、用户名、手机号、收货地址）
  - 订单状态（待支付、已支付、已发货、已完成、已取消）
  - 订单金额（商品总额、运费、优惠金额、实付金额）
  - 创建时间、支付时间、发货时间、完成时间
  - 版本号（用于乐观锁）
  - 与 OrderItem（订单商品项）为一对多关系
  - 与 OrderLog（订单日志）为一对多关系

- **订单商品项 (OrderItem)**:
  - 商品信息（商品ID、商品名称、规格、图片）
  - 数量、单价、小计金额
  - 归属的订单ID

- **订单日志 (OrderLog)**:
  - 操作时间
  - 操作人（操作员ID、操作员名称）
  - 操作类型（创建订单、支付、发货、完成、取消）
  - 状态变更（变更前状态、变更后状态）
  - 备注信息（如取消原因）
  - 归属的订单ID

- **用户 (User)**:
  - 用户ID、用户名、手机号
  - 收货地址（省、市、区、详细地址）
  - 与 ProductOrder 为一对多关系

## 成功标准 *(必填)*

### 可衡量的成果

- **SC-001**: 运营人员能在 3 秒内加载订单列表首页（包含 20 条订单）
- **SC-002**: 运营人员能在 1 秒内完成订单筛选操作并刷新列表
- **SC-003**: 运营人员能在 2 秒内打开订单详情页
- **SC-004**: 运营人员能在 1 秒内完成订单状态变更操作
- **SC-005**: 系统能同时支持 100 个运营人员并发操作订单而不影响性能
- **SC-006**: 订单列表分页加载在订单总数达到 50000 条时仍能保持流畅（每次翻页 ≤ 2 秒）
- **SC-007**: 90% 的运营人员能在首次使用时无需培训即可完成订单查询和状态更新操作
- **SC-008**: 订单状态变更的成功率达到 99.9%（考虑并发冲突等异常情况）
- **SC-009**: 订单数据导出功能能在 30 秒内导出包含 10000 条订单的文件

## 假设与约束

### 假设

- 商品订单的支付功能已经在其他模块实现，本功能仅处理订单列表和状态管理
- 物流跟踪功能暂不包含在本功能范围内，仅记录发货时间
- 订单中的商品信息来自已存在的商品管理模块（P模块）
- 运营人员已通过系统认证，具备订单管理权限
- 默认使用 Supabase 作为数据存储

### 约束

- 订单状态转换遵循固定流程：待支付 → 已支付 → 已发货 → 已完成
- 订单取消只能在"待支付"或"已支付"状态下执行
- 订单一旦标记为"已完成"，状态不可再变更
- 订单详情中的手机号必须脱敏显示（格式：`138****8000`，保留前3位和后4位，中间4位用星号替代）
- 订单列表不包含预约订单（预约订单属于 U/RSV 模块）

### 非功能性需求

- **性能**: 订单列表首屏加载时间 < 3 秒，操作响应时间 < 1 秒
- **可用性**: 界面符合 B端管理后台的一致性设计规范（Ant Design）
- **安全性**: 订单操作需要记录审计日志，包含操作人、操作时间、操作内容
- **可扩展性**: 预留订单批量操作接口（批量发货、批量导出）

## 依赖

- **外部依赖**:
  - 商品管理模块（P模块）：获取订单中的商品详细信息
  - 用户管理模块（U模块）：获取用户基本信息
  - 支付模块（如存在）：订单支付状态同步

- **技术依赖**:
  - Supabase 数据库：存储订单数据
  - Ant Design UI 组件库：B端页面开发
  - Zustand + TanStack Query：状态管理和数据查询

## 范围界定

### 包含在内

- 商品订单列表查看
- 订单多维度筛选（状态、时间、用户）
- 订单详情查看
- 订单状态手动变更（发货、完成、取消）
- 订单操作日志记录
- 订单数据导出

### 不包含

- 订单创建功能（属于 C端用户下单流程）
- 订单支付功能（属于支付模块）
- 订单退款/售后功能（未来版本）
- 物流实时跟踪功能（未来版本）
- 订单自动化流转规则配置（未来版本）
- 预约订单管理（属于 U/RSV 模块）
