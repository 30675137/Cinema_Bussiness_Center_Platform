# Feature Specification: 订单创建时库存预占

**Feature Branch**: `feat/O012-order-inventory-reservation`  
**Created**: 2026-01-14  
**Status**: Draft  
**Input**: User description: "订单创建时预占：下单时自动调用预占服务，展开BOM计算物料需求，检查库存可用性，使用事务+行锁保证原子性扣减库存"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 顾客下单时自动库存预占 (Priority: P1)

当顾客通过C端小程序或B端POS系统创建订单时，系统自动根据订单商品的BOM配方计算所需原料和包材，检查可用库存是否充足，并原子性地锁定(预占)这些库存，防止超卖。

**Why this priority**: 这是防止超卖的核心机制，直接影响业务准确性和用户体验。没有库存预占，多个订单可能同时抢占相同库存导致超卖，出品时发现库存不足，必须取消订单，造成客户投诉。

**Independent Test**: 可通过创建一个成品订单（如"威士忌可乐"），验证系统是否成功展开BOM、检查库存、创建预占记录，以及预占后可用库存是否正确减少。此功能独立可测，不依赖支付或出品流程。

**Acceptance Scenarios**:

1. **Given** 门店库存充足（威士忌50ml，可乐200ml，可用库存均足够）  
   **When** 顾客下单1杯"威士忌可乐"（BOM：45ml威士忌 + 150ml可乐）  
   **Then** 系统成功创建订单，威士忌预占库存增加45ml，可乐预占库存增加150ml，可用库存相应减少，订单状态为"待支付"

2. **Given** 门店库存不足（威士忌仅剩20ml，可乐充足）  
   **When** 顾客下单1杯"威士忌可乐"（需45ml威士忌）  
   **Then** 系统拒绝创建订单，返回明确错误提示"威士忌库存不足：需要45ml，当前可用20ml，缺口25ml"，订单未创建

3. **Given** 同时有5个顾客下单相同商品，门店库存仅够3单  
   **When** 5个订单并发提交  
   **Then** 前3个订单成功预占库存，后2个订单因库存不足被拒绝，不会出现超卖

---

### User Story 2 - 套餐订单的多层级BOM展开与预占 (Priority: P2)

当顾客下单套餐商品（如"双人套餐"）时，系统自动进行多层级BOM展开：先将套餐展开为成品子项（如2杯鸡尾酒+1份爆米花），再将每个成品按BOM展开为底层原料和包材，汇总所有原料后执行库存预占。

**Why this priority**: 套餐是常见销售方式，多层级BOM展开是预占机制的扩展能力。虽然不如P1关键，但对于有套餐业务的门店必不可少。

**Independent Test**: 可通过创建一个套餐订单，验证系统是否正确展开所有层级BOM，计算总原料需求，并成功预占。此功能可独立测试，通过查询预占记录验证原料数量是否正确汇总。

**Acceptance Scenarios**:

1. **Given** 门店有套餐"双人套餐"（包含2杯威士忌可乐 + 1份爆米花），库存充足  
   **When** 顾客下单1份"双人套餐"  
   **Then** 系统展开BOM为：90ml威士忌（45ml×2）+ 300ml可乐（150ml×2）+ 50g玉米 + 2个包装袋，预占所有底层原料，订单创建成功

2. **Given** 套餐BOM有3层结构（套餐→成品→原料）  
   **When** 顾客下单套餐  
   **Then** 系统正确递归展开所有层级，汇总相同原料（如多个成品共用威士忌），按总量预占，不会重复预占

---

### User Story 3 - 订单取消时释放预占库存 (Priority: P1)

当顾客取消订单或订单支付超时被系统自动取消时，系统自动释放已预占的库存，将预占数量归零，可用库存增加，恢复库存可销售状态。

**Why this priority**: 预占释放与预占创建同等重要，否则会导致库存死锁（库存被锁定但订单未完成），影响后续销售。

**Independent Test**: 可通过创建订单后立即取消，验证预占记录是否被标记为"已释放"，预占库存是否正确减少，可用库存是否恢复。此功能可独立测试，不依赖出品流程。

**Acceptance Scenarios**:

1. **Given** 订单已创建，预占库存已锁定（威士忌预占45ml）  
   **When** 顾客在支付前取消订单  
   **Then** 系统释放预占库存，威士忌预占数量减少45ml，可用库存增加45ml，预占记录状态更新为"已释放"

2. **Given** 订单创建后30分钟内未支付  
   **When** 系统定时任务检测到超时订单  
   **Then** 系统自动取消订单并释放预占库存，生成流水记录标注"支付超时释放"

---

### User Story 4 - 库存预占记录与审计追踪 (Priority: P3)

系统为每次库存预占操作创建详细记录，包含订单号、SKU明细、预占数量、操作时间、预占状态，支持操作员查询历史预占记录，审计库存变动。

**Why this priority**: 审计追踪是合规性需求，帮助排查库存异常，但不影响核心业务流程，优先级相对较低。

**Independent Test**: 可通过创建订单后查询预占记录列表，验证记录是否包含完整信息（订单号、SKU、数量、时间戳），支持按订单号或SKU筛选。此功能可独立测试。

**Acceptance Scenarios**:

1. **Given** 系统已创建多个订单，产生多条预占记录  
   **When** 操作员在B端管理后台查询预占记录，按订单号筛选  
   **Then** 系统返回该订单的所有预占明细，包含每个原料的名称、预占数量、单位、预占时间、当前状态

2. **Given** 某原料（威士忌）被多个订单预占  
   **When** 操作员按SKU筛选预占记录  
   **Then** 系统返回所有涉及威士忌的预占记录，显示总预占数量，帮助分析库存占用情况

---

### Edge Cases

- **并发预占冲突**：多个订单同时请求预占相同原料，库存仅够部分订单，如何保证先到先得，后到者明确被拒？
  - 使用数据库行级锁（SELECT FOR UPDATE）串行化预占操作，事务隔离级别为READ_COMMITTED，保证原子性

- **BOM配方缺失**：订单商品在BOM表中无配方记录，如何处理？
  - 检查BOM配方完整性，若缺失则拒绝订单创建，返回错误"该商品BOM配方未配置，请联系管理员"

- **库存允许负数设置**：某些SKU配置允许负库存销售，预占时如何处理？
  - 预占时跳过库存充足性检查，直接增加预占数量（可用库存可为负），但需在流水中标注"负库存销售"

- **部分原料不足**：套餐BOM展开后，部分原料充足，部分不足，如何处理？
  - 全部回滚，不做任何预占，返回所有不足原料的明细，保证事务原子性

- **预占超时未释放**：系统定时任务异常，超时订单未自动释放预占，如何兜底？
  - 提供手动释放预占接口，允许管理员批量释放超时预占；同时监控预占记录超过2小时未释放的异常情况，触发告警

- **订单修改场景**：订单创建后，顾客修改数量或商品，如何调整预占？
  - 当前版本不支持订单修改，要求先取消原订单（释放预占），再创建新订单（重新预占）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在订单创建时，根据订单商品的BOM配方自动展开计算所需原料和包材的数量，若商品无BOM配方则拒绝订单创建并提示"BOM配方未配置"

- **FR-002**: 系统必须检查每个BOM组件的可用库存（现存库存 - 预占库存）是否满足需求数量，若任一组件库存不足则拒绝订单创建，并返回详细缺口信息（组件名称、需求数量、可用数量、缺口数量）

- **FR-003**: 系统必须使用数据库行级锁（SELECT FOR UPDATE）串行化库存预占操作，保证高并发场景下同一原料的预占按先后顺序处理，防止超卖

- **FR-004**: 系统必须原子性地增加所有BOM组件的预占库存数量，若任一组件操作失败则回滚全部预占操作，保证事务一致性

- **FR-005**: 系统必须为每次预占操作创建预占记录（InventoryReservation），包含订单ID、门店ID、SKU ID、预占数量、预占时间、预占状态（ACTIVE/RELEASED/EXPIRED），状态初始为ACTIVE

- **FR-006**: 系统必须在订单取消时，根据预占记录释放已预占的库存，原子性地减少所有组件的预占数量、增加可用库存，并将预占记录状态更新为RELEASED

- **FR-007**: 系统必须支持多层级套餐BOM展开（最大深度3层），先将套餐展开为成品子项，再将每个成品按BOM展开为原料/包材，汇总相同原料的数量后执行预占

- **FR-008**: 系统必须在BOM展开时应用损耗率配置，按公式（标准用量 × (1 + 损耗率)）计算实际预占数量，损耗率默认为0%，支持在BOM配方中配置。**舍入规则**: 使用 `BigDecimal.ROUND_HALF_UP` 模式舍入到小数点后2位

- **FR-009**: 系统必须锁定订单创建时的BOM配方版本，创建BOM快照（BomSnapshot），出品时按快照版本扣减库存，避免配方变更影响已下单订单

- **FR-010**: 系统必须支持定时任务自动释放超时订单的预占库存，超时阈值默认为30分钟（可配置），释放时将预占记录状态更新为EXPIRED

- **FR-011**: 系统必须提供预占记录查询接口，支持按订单号、门店ID、SKU ID、预占状态、时间范围筛选，返回预占明细列表

- **FR-012**: 系统必须在预占失败时，生成详细错误日志，包含失败原因（库存不足/BOM缺失/并发冲突等）、涉及SKU、缺口数量，便于问题排查

- **FR-013**: 系统必须支持SKU级别的"允许负库存"配置，若SKU配置允许负库存，则预占时跳过库存充足性检查，直接增加预占数量

- **FR-014**: 系统必须在预占库存时，同时记录操作人信息（操作员ID或顾客ID）、操作来源（POS/小程序/管理后台），便于审计追踪

- **FR-015**: 系统当前版本不支持订单修改（数量或商品），顾客如需修改需先取消原订单（释放预占），再创建新订单（重新预占）

### Key Entities

- **InventoryReservation（库存预占记录）**: 记录订单预占库存的明细，包含订单ID、门店ID、SKU ID、预占数量、预占时间、预占状态、创建人、释放时间
  - **ReservationStatus（预占状态枚举）**:
    - `ACTIVE`: 预占中（订单创建后，出品前）
    - `FULFILLED`: 已消费（出品时转换，实际扣减库存）
    - `CANCELLED`: 用户取消（订单取消时转换）
    - `RELEASED`: 手动释放（管理员操作）
    - `EXPIRED`: 超时释放（定时任务自动转换）

- **BomSnapshot（BOM配方快照）**: 锁定订单创建时的BOM配方版本，包含订单ID、成品SKU ID、组件SKU ID、组件数量、损耗率、快照创建时间

- **Inventory（库存表）**: 存储门店SKU的库存信息，包含现存库存（on_hand_qty）、预占库存（reserved_qty）、可用库存计算公式（on_hand_qty - reserved_qty）

- **BomComponent（BOM组件）**: 定义成品或套餐的原料组成，包含父SKU ID、子SKU ID、标准用量、单位、损耗率

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 订单创建时库存预占成功率达到99.5%以上（排除库存不足导致的正常拒绝）

- **SC-002**: 并发场景下（100个订单同时抢占相同原料），系统保证零超卖，先到先得，后到者明确被拒绝

- **SC-003**: BOM展开与库存预占的总响应时间在1秒以内（单订单包含10个成品，每个成品BOM有5个原料）

- **SC-004**: 订单取消后，预占库存在3秒内释放完成，可用库存恢复，其他顾客可立即下单

- **SC-005**: 套餐订单（3层BOM嵌套）的展开与预占在2秒内完成，计算准确无误

- **SC-006**: 超时订单的预占释放延迟不超过5分钟（定时任务每5分钟执行一次）

- **SC-007**: 库存死锁（预占超过2小时未释放）的发生率低于0.1%，99.9%的预占在2小时内正常释放或转为实扣

- **SC-008**: 操作员查询预占记录时，响应时间在500毫秒以内（数据量1万条以内）

## Assumptions

- BOM配方在订单创建前已正确配置，包含所有必需组件及标准用量
- 门店库存数据实时同步，不存在跨系统延迟导致的库存不准
- 数据库支持行级锁（SELECT FOR UPDATE），事务隔离级别为READ_COMMITTED或更高
- 预占超时阈值默认为30分钟，可在系统配置中调整
- 损耗率小数计算采用四舍五入到小数点后2位（如47.256ml → 47.26ml）
- 同一订单内的BOM组件预占作为单一数据库事务处理，保证原子性
- 库存允许为负数的配置默认为"否"，扣减不足时强制失败（可在SKU主数据中配置）
- 订单创建后不支持修改商品或数量，要求先取消再重新下单
- 跨门店调拨时检查目标原料是否有预占，有预占则阻止调拨（由调拨功能模块实现）
