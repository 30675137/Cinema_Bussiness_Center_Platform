# P004-inventory-adjustment 快速验证指南

## 概述

本文档提供库存调整管理功能的端到端验证步骤。

## 前置条件

1. 前端开发服务器运行中 (`npm run dev`)
2. MSW Mock 服务已启用
3. 已登录系统

## 前端访问链接

| 功能模块 | 访问地址 | 说明 |
|----------|----------|------|
| 库存查询 | [http://localhost:3000/inventory/query](http://localhost:3000/inventory/query) | 门店SKU库存查询，支持搜索、筛选、详情查看 |
| 库存台账 | [http://localhost:3000/inventory/ledger](http://localhost:3000/inventory/ledger) | 库存台账查看，包含调整入口 |
| 库存流水 | [http://localhost:3000/inventory/movements](http://localhost:3000/inventory/movements) | 库存变动日志/审计追踪 |
| 库存调整审批 | [http://localhost:3000/inventory/approvals](http://localhost:3000/inventory/approvals) | P004新增：审批列表页面 |

## 验证流程

### US1: 录入库存调整

**访问地址**: [http://localhost:3000/inventory/ledger](http://localhost:3000/inventory/ledger)

**场景**: 库存管理员录入盘盈调整

1. 进入「库存管理」→「库存台账」页面
2. 在表格中找到需要调整的SKU行（需要有库存数据）
3. 点击操作列的「调整」按钮（需要「调整库存」权限）
4. 在弹出的调整表单中填写：
   - 调整类型：盘盈（库存增加）
   - 调整数量：10
   - 调整原因：从下拉列表选择（如「实物盘点发现多余」）
   - 备注说明：可选填写
5. 点击「提交」进入二次确认
6. 确认无误后点击「确认调整」
7. **预期结果**: 显示成功提示，列表刷新显示新记录

### US2: 查看库存流水

**访问地址**: [http://localhost:3000/inventory/query](http://localhost:3000/inventory/query) 或 [http://localhost:3000/inventory/movements](http://localhost:3000/inventory/movements)

**场景**: 查看某SKU的流水记录

1. 进入「库存管理」→「库存查询」页面
2. 点击任意库存记录的「详情」
3. 在详情抽屉中切换到「流水记录」标签页
4. **预期结果**: 
   - 显示该SKU的历史流水记录
   - 入库显示绿色 `+` 数量
   - 出库显示红色 `-` 数量
   - 支持时间筛选

**流水详情查看**:

1. 在流水列表中，点击某行流水记录（或点击「详情」按钮）
2. **预期结果**:
   - 打开流水详情抽屉
   - 显示交易概览（类型标签、数量、时间）
   - 显示库存变化（变动前后对比）
   - 显示来源信息（来源类型、单据号）
   - 显示操作信息（操作人、时间）
   - 备注信息（如有）

### US3: 调整原因必填

**访问地址**: [http://localhost:3000/inventory/ledger](http://localhost:3000/inventory/ledger)

**场景**: 验证原因字段必填

1. 在库存台账页面，点击某行操作列的「调整」按钮
2. 填写所有字段，但不选择原因
3. 点击提交
4. **预期结果**: 显示「请选择调整原因」错误提示

### US4: 大额调整审批

**访问地址**: [http://localhost:3000/inventory/approvals](http://localhost:3000/inventory/approvals)

**场景**: 调整金额 ≥ ¥1000 需要审批

1. 新建库存调整：
   - 调整数量：100
   - 商品单价：¥15（总金额 ¥1500）
2. 提交调整
3. **预期结果**: 状态变为「待审批」

**审批操作**:

1. 以运营总监身份登录
2. 进入「审批管理」页面
3. 找到待审批记录，点击「通过」
4. 输入审批意见，确认
5. **预期结果**: 状态变为「已通过」

**撤回操作**:

1. 以申请人身份查看待审批记录
2. 点击「撤回」按钮
3. 确认撤回
4. **预期结果**: 状态变为「已撤回」

### US5: 安全库存编辑

**访问地址**: [http://localhost:3000/inventory/query](http://localhost:3000/inventory/query)

**场景**: 修改安全库存阈值

1. 在库存查询页面进入库存详情抽屉
2. 在「安全库存」行点击编辑图标
3. 输入新值：15
4. 点击保存
5. **预期结果**: 
   - 安全库存更新成功
   - 库存状态重新计算
   - 自动生成一条类型为「安全库存更新」的流水记录

**流水记录验证**:

1. 成功更新安全库存后，切换到「流水记录」标签页
2. **预期结果**:
   - 最新一条流水类型为「安全库存更新」
   - 变动数量为 0（安全库存变更不影响实际库存）
   - 备注显示「安全库存从 X 调整为 Y」

**冲突处理**:

1. 在另一个浏览器/标签页中打开同一记录
2. 修改安全库存并保存
3. 回到第一个标签页修改安全库存
4. **预期结果**: 显示「数据已被他人修改」警告，提供刷新按钮

## API 端点验证

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/adjustments` | GET | 获取调整列表 |
| `/api/adjustments` | POST | 创建调整记录 |
| `/api/adjustments/:id` | GET | 获取调整详情 |
| `/api/adjustments/:id/approve` | POST | 审批通过 |
| `/api/adjustments/:id/reject` | POST | 审批拒绝 |
| `/api/adjustments/:id/withdraw` | POST | 撤回申请 |
| `/api/transactions` | GET | 获取流水记录 |
| `/api/inventory/:id/safety-stock` | PUT | 更新安全库存 |
| `/api/reasons` | GET | 获取原因字典 |

## 验证检查清单

- [ ] US1: 可以成功创建盘盈、盘亏、报损调整
- [ ] US2: 流水记录按时间倒序显示，颜色正确
- [ ] US2: 点击流水行/详情按钮可打开详情抽屉
- [ ] US2: 流水详情抽屉显示完整信息
- [ ] US3: 原因字段必填验证生效
- [ ] US4: 大额调整进入审批流程
- [ ] US4: 审批通过/拒绝功能正常
- [ ] US4: 撤回功能正常
- [ ] US5: 安全库存可编辑保存
- [ ] US5: 安全库存更新后自动生成流水记录
- [ ] US5: 乐观锁冲突处理正常（显示警告和刷新按钮）
- [ ] 所有列表有加载状态
- [ ] 所有操作有错误处理

## 已知限制

1. MSW Mock 数据在页面刷新后重置
2. 审批阈值硬编码为 ¥1000
3. 用户角色权限由 Mock 模拟

## 故障排除

### 问题: 提交调整失败

1. 检查 Network 面板是否有 API 请求
2. 确认 MSW 是否正确加载
3. 查看控制台错误信息

### 问题: 流水记录不显示

1. 确认已选择有效的 SKU 和门店
2. 检查时间筛选条件是否正确

### 问题: 安全库存更新失败

1. 检查版本号是否正确传递
2. 确认没有其他用户同时修改
