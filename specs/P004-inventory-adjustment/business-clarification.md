# 业务澄清：库存查询与库存台账

> **文档版本**: 1.0  
> **创建日期**: 2025-12-27  
> **功能分支**: P004-inventory-adjustment

---

## 1. 业务概念对比

### 1.1 库存台账 (Inventory Ledger)

**定义**：特定位置特定SKU的**库存状态快照**，是库存管理系统的核心数据实体。

**核心指标**：

| 指标 | 英文 | 说明 |
|------|------|------|
| 现存数量 | OnHand Qty | 实际在仓库/门店中的商品数量 |
| 可用数量 | Available Qty | 现存数量 - 预占数量 |
| 预占数量 | Reserved Qty | 已被订单锁定但尚未出库的数量 |
| 在途数量 | In-Transit Qty | 已采购/调拨但尚未到货的数量 |
| 安全库存 | Safety Stock | 库存警戒线 |

### 1.2 库存查询 (Inventory Query)

**定义**：基于库存台账数据的**查询视图**，提供多条件筛选和展示能力。

---

## 2. 核心异同点

| 维度 | 库存台账 | 库存查询 |
|------|---------|---------|
| **本质** | 数据实体（Data Entity） | 查询视图（Query View） |
| **关系** | 底层数据源 | 上层展示层 |
| **数据范围** | 存储完整库存指标 | 展示部分关键指标 |
| **操作能力** | 支持库存调整操作入口 | 侧重只读查询 |
| **前端路由** | `/inventory/ledger` | `/inventory/query` |
| **功能定位** | 综合库存管理（查看+调整） | 快速库存检索 |

---

## 3. 功能层级关系

```
库存台账 (完整数据实体)
    │
    ├── 库存查询 ← 只读视图，快速检索
    │
    ├── 库存调整 ← 盘盈/盘亏/报损操作
    │
    ├── 库存流水 ← 变动历史追踪
    │
    └── 库存预警 ← 状态监控
```

---

## 4. 总结

**简单理解**：

- **库存台账** = 库存数据的"原始账本"，包含所有指标和操作入口
- **库存查询** = 快速查看库存的"搜索窗口"，侧重高效检索

在本项目实现中，两者共用同一个底层数据源（`store_inventory` 表），但提供不同的前端界面和交互体验。

---

---

## 5. 订单管理模块功能分析

### 5.1 订单管理概述

订单管理模块负责处理场景包预约订单的全生命周期，包括订单创建、状态流转、支付处理和履约管理。

### 5.2 已实现功能

| 功能 | B端(管理后台) | C端(小程序) | 实现文件 |
|------|:-----:|:-----:|------|
| **订单创建** | - | ✅ | `ReservationOrderService.createReservation()` |
| **订单列表查询** | ✅ | ✅ | `ReservationController`, `reservationService.ts` |
| **订单详情查看** | ✅ | ✅ | 包含加购项、操作日志 |
| **订单确认** | ✅ | - | `confirmReservation()` |
| **订单取消** | ✅ | ✅ | `cancelReservation()` |
| **待处理数量统计** | - | ✅ | `getPendingCount()` |
| **支付回调接口** | ✅ | - | `payment-callback` 骨架 |
| **操作日志记录** | ✅ | ✅ | `ReservationOperationLog` |

### 5.3 订单状态流转（已实现）

```
PENDING(待确认) ──确认──▶ CONFIRMED(已确认,需支付) ──支付──▶ COMPLETED(已完成)
       │                        │
       │                        └──────取消──────▶ CANCELLED
       │
       └──确认(不需支付)──▶ COMPLETED(直接完成)
```

**状态定义**：

| 状态 | 英文 | 说明 |
|------|------|------|
| 待确认 | PENDING | 用户提交预约，等待商家确认 |
| 已确认 | CONFIRMED | 商家确认，等待用户支付 |
| 已完成 | COMPLETED | 订单完成（已支付或无需支付） |
| 已取消 | CANCELLED | 订单已取消 |

### 5.4 缺失功能模块

| 功能 | 优先级 | 影响 | 说明 |
|------|:------:|------|------|
| **微信支付对接** | P0 | 阻塞交易闭环 | 只有回调骨架，未对接微信支付API |
| **库存预占** | P0 | 可能超卖 | 下单时未锁定库存 |
| **出品确认** | P1 | 履约无系统支撑 | 吧台工作台待开发 |
| **退款处理** | P1 | 无法处理售后 | 无退款申请、审批流程 |
| **核销管理** | P1 | 到店体验缺失 | 到店核销功能待开发 |
| **BOM扣料** | P1 | 原料库存不准 | 出品时原料自动扣减待开发 |

---

## 6. 订单管理与库存预占的关联关系

### 6.1 业务关联图

```
┌─────────────────────────────────────────────────────────────────┐
│                        订单生命周期中的库存预占                    │
└─────────────────────────────────────────────────────────────────┘

      订单创建             支付成功             出品完成             退款/取消
         │                   │                   │                   │
         ▼                   ▼                   ▼                   ▼
    ┌─────────┐         ┌─────────┐         ┌─────────┐         ┌─────────┐
    │ 库存预占 │────────▶│ 预占保持 │────────▶│ 预占转扣减│         │ 预占释放 │
    │ +N      │         │         │         │ -N      │         │ -N      │
    └─────────┘         └─────────┘         └─────────┘         └─────────┘
         │                                       │                   │
         ▼                                       ▼                   ▼
    可用库存 -N                            现存库存 -N           可用库存 +N
```

### 6.2 库存预占触发时机

| 订单事件 | 库存操作 | 影响字段 | 说明 |
|---------|---------|---------|------|
| **订单创建** | 创建预占 | `reserved_qty += N` | 锁定库存，防止超卖 |
| **支付超时** | 释放预占 | `reserved_qty -= N` | 归还可用库存 |
| **用户取消** | 释放预占 | `reserved_qty -= N` | 归还可用库存 |
| **出品完成** | 预占→扣减 | `on_hand_qty -= N`, `reserved_qty -= N` | 实际出库 |
| **退款** | 库存回补 | `on_hand_qty += N` (视情况) | 根据商品状态决定 |

### 6.3 当前实现差距

| 能力 | 应有状态 | 当前状态 | 差距分析 |
|------|---------|---------|----------|
| 下单预占 | 订单创建时锁定库存 | 🔴 未实现 | 可能导致超卖 |
| 超时释放 | 支付超时自动释放 | 🔴 未实现 | 可能库存死锁 |
| 出品扣减 | 出品完成时扣减 | 🔴 未实现 | 库存不准确 |
| 取消释放 | 取消订单释放预占 | 🔴 未实现 | 可能库存死锁 |

### 6.4 实现建议

**Phase 1 - 基础预占（P0）**：
1. 订单创建时调用库存预占接口
2. 预占失败则阻止下单
3. 取消订单时释放预占

**Phase 2 - 自动释放（P1）**：
1. 支付超时定时任务
2. 自动释放超时预占
3. 通知用户订单已取消

**Phase 3 - 出品扣减（P1）**：
1. 出品确认触发库存扣减
2. BOM配方联动扣料
3. 生成库存流水记录

---

## 7. 相关文档

| 文档 | 路径 |
|-----|------|
| 库存台账功能专项说明 | `docs/业务需求/需求专项说明/库存台账功能专项说明.md` |
| 业务需求规约文档 | `docs/业务需求规约文档.md` |
| 零售行业解决方案白皮书 | `docs/业务需求/零售行业解决方案白皮书.md` |
| 业务闭环缺口分析 | `specs/P004-inventory-adjustment/business-gap-analysis.md` |
| 预约订单管理规格 | `specs/U001-reservation-order-management/spec.md` |
