# Feature Specification: 库存调整管理 (Inventory Adjustment Management)

**Feature Branch**: `P004-inventory-adjustment`
**Created**: 2025-12-26
**Status**: Draft
**Input**: User description: "INV-010~INV-014 库存调整录入、流水查看、原因追溯、大额审批、安全库存设置"

<!--
  规格编号格式说明 (Spec ID Format):
  P004: P=商品/库存模块, 004=模块内递增编号
-->

## Clarifications

### Session 2025-12-26

- Q: 库存调整的用户角色应该是店长(门店级)还是库存管理员(全局级)？ → A: 库存管理员（需授权才能调整，可跨门店操作，与产品功能文档一致）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 录入库存调整 (Priority: P1)

作为库存管理员，我希望能够录入库存调整（盘盈/盘亏/报损），以便处理盘点差异和日常损耗。

**Why this priority**: 这是库存调整的核心功能，没有调整录入能力，其他功能（流水、审批）都无法使用。库存管理员日常盘点后需要立即录入差异，是最高频使用场景。

**Independent Test**: 可以通过"创建一条盘盈调整记录并验证库存数量变化"独立测试，交付后库存管理员可以立即处理盘点差异。

**Acceptance Scenarios**:

1. **Given** 库存管理员进入库存调整页面，**When** 选择某个SKU并填写调整类型为"盘盈"、数量为10、原因为"盘点发现"，**Then** 系统保存调整记录并立即更新该SKU的库存数量+10。

2. **Given** 库存管理员录入一条"盘亏"调整，数量为5，**When** 提交保存，**Then** 该SKU库存减少5，且生成一条变动类型为"盘亏"的流水记录。

3. **Given** 库存管理员录入一条"报损"调整，**When** 提交保存，**Then** 系统扣减库存并标记变动来源为"报损"。

4. **Given** 库存管理员未选择调整原因，**When** 尝试提交，**Then** 系统阻止提交并提示"请选择调整原因"。

5. **Given** 库存管理员填写完调整信息，**When** 点击确认提交，**Then** 系统显示二次确认对话框，展示调整前后库存对比。

---

### User Story 2 - 查看库存流水记录 (Priority: P2)

作为库存管理员，我希望能够查看库存流水记录，以便追溯库存变动历史。

**Why this priority**: 流水查询是库存管理的基础追溯能力，对于排查差异、审计合规至关重要。依赖P1的调整记录数据，但可以展示所有类型的库存变动。

**Independent Test**: 可以通过"进入某SKU详情页查看流水列表"独立测试，显示该SKU的所有历史变动记录。

**Acceptance Scenarios**:

1. **Given** 库存管理员在库存详情页面，**When** 点击"流水记录"标签，**Then** 显示该SKU的所有变动记录列表，包含变动类型、数量、时间、操作人字段。

2. **Given** 流水列表有多条记录，**When** 查看任一记录，**Then** 可以看到变动前库存和变动后库存数量。

3. **Given** 库存管理员想按时间筛选流水，**When** 选择日期范围，**Then** 仅显示该时间段内的流水记录。

4. **Given** 流水列表显示入库类记录，**When** 查看变动数量，**Then** 数量以绿色"+"号显示。

5. **Given** 流水列表显示出库类记录，**When** 查看变动数量，**Then** 数量以红色"-"号显示。

---

### User Story 3 - 填写调整原因（必填） (Priority: P2)

作为库存管理员，我希望库存调整必须填写原因，以便后续分析差异根因。

**Why this priority**: 原因记录是数据分析和运营改进的基础，与P1调整录入紧密关联。没有原因记录，无法进行后续的差异分析。

**Independent Test**: 可以通过"尝试提交无原因的调整记录"测试，验证系统强制要求原因字段。

**Acceptance Scenarios**:

1. **Given** 库存管理员在调整录入页面，**When** 未选择原因直接提交，**Then** 系统阻止提交并高亮原因字段。

2. **Given** 调整原因下拉框，**When** 点击展开，**Then** 显示预设的原因字典选项（如：盘点差异、货物损坏、过期报废、入库错误等）。

3. **Given** 库存管理员选择了原因，**When** 还需要补充说明，**Then** 可在备注字段输入更详细的描述（可选）。

---

### User Story 4 - 大额库存调整审批 (Priority: P3)

作为运营总监，我希望大额库存调整需要审批，以便控制资产风险。

**Why this priority**: 审批机制是风险控制手段，优先级低于基础的录入和查询功能。当调整金额超过阈值时触发，保护公司资产。

**Independent Test**: 可以通过"录入一条金额超过阈值的调整，验证进入待审批状态"独立测试。

**Acceptance Scenarios**:

1. **Given** 库存管理员录入一条调整，调整金额（数量×单价）超过设定阈值（如1000元），**When** 提交，**Then** 调整记录进入"待审批"状态，库存暂不更新。

2. **Given** 运营总监进入审批列表，**When** 审批通过某条待审批记录，**Then** 库存立即更新，状态变为"已审批"。

3. **Given** 审批人拒绝某条调整申请，**When** 操作完成，**Then** 库存不变，状态变为"已拒绝"，申请人收到拒绝通知。

4. **Given** 任何人查看已审批的调整记录，**When** 查看详情，**Then** 可以看到完整的审批记录（审批人、审批时间、审批意见）。

---

### User Story 5 - 设置安全库存阈值 (Priority: P3)

作为库存管理员，我希望能够设置SKU的安全库存阈值，以便自定义预警标准。

**Why this priority**: 安全库存设置是对现有库存查询功能（P003）的增强，允许库存管理员根据门店/仓库情况自定义阈值，使预警更加精准。

**Independent Test**: 可以通过"在SKU详情中编辑安全库存值，保存后验证库存状态标识更新"独立测试。

**Acceptance Scenarios**:

1. **Given** 库存管理员在库存详情抽屉中，**When** 点击编辑安全库存，**Then** 可以输入新的安全库存数值。

2. **Given** 库存管理员修改了安全库存值并保存，**When** 保存成功，**Then** 新阈值立即生效，库存列表中该SKU的状态标识根据新阈值重新计算。

3. **Given** 某SKU可用库存为10，原安全库存为5（状态正常），**When** 库存管理员将安全库存调整为15，**Then** 状态变为"偏低"或"不足"。

---

### Edge Cases

- **空调整数量**：调整数量为0时，系统拒绝提交并提示"调整数量不能为0"。
- **负数输入**：不允许输入负数，盘亏通过选择"盘亏"类型实现，数量始终为正数。
- **审批阈值边界**：调整金额刚好等于阈值时，进入审批流程（>=阈值）。
- **并发编辑安全库存**：多人同时编辑同一SKU的安全库存时，以最后保存者为准，前者收到"已被他人修改"提示。
- **审批中撤回**：已提交待审批的调整，申请人可在审批前撤回。
- **无权限访问**：非库存管理员角色尝试录入调整时，显示无权限提示；无审批权限的用户无法进入审批页面。
- **SKU不存在**：调整目标SKU已被删除时，阻止调整并提示"该商品不存在"。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须支持三种调整类型：盘盈（增加库存）、盘亏（减少库存）、报损（减少库存并标记损耗）。
- **FR-002**: 调整提交后，系统必须立即更新对应SKU的库存数量（除非需要审批）。
- **FR-003**: 系统必须记录每次调整的变动前库存和变动后库存。
- **FR-004**: 库存流水必须显示：变动类型、变动数量、变动时间、操作人、变动前库存、变动后库存。
- **FR-005**: 调整原因必须为必填字段，未填写时阻止提交。
- **FR-006**: 系统必须提供预设的调整原因字典供选择（盘点差异、货物损坏、过期报废、入库错误、其他）。
- **FR-007**: 系统必须支持填写调整备注（可选字段，最大500字符）。
- **FR-008**: 当调整金额（数量×SKU单价）超过审批阈值时，调整必须进入待审批状态。
- **FR-009**: 待审批状态的调整，库存不更新，直到审批通过。
- **FR-010**: 审批通过后，系统必须立即更新库存并记录审批信息。
- **FR-011**: 审批拒绝后，库存保持不变，记录拒绝原因。
- **FR-012**: 库存管理员必须能够在库存详情中编辑安全库存阈值。
- **FR-013**: 安全库存修改后必须立即生效，影响库存状态计算。
- **FR-014**: 流水记录必须支持按时间范围筛选。
- **FR-015**: 系统必须支持撤回待审批状态的调整申请。
- **FR-016**: 库存调整提交前必须显示二次确认对话框，展示调整前后库存对比，用户确认后才执行调整。
- **FR-017**: 流水列表中入库类变动数量以绿色"+"号显示，出库类变动数量以红色"-"号显示。

### Key Entities

- **InventoryAdjustment（库存调整）**: 代表一次库存调整操作，包含调整类型、数量、原因、操作人、审批状态等。关联SKU和门店。

- **AdjustmentReason（调整原因字典）**: 预设的调整原因列表，包含原因代码和名称，用于标准化原因录入。

- **InventoryTransaction（库存流水）**: 记录每次库存变动，包含变动类型、数量、前后库存、时间戳、操作人。已在P003中定义，本功能复用并扩展。

- **ApprovalRecord（审批记录）**: 记录调整审批的完整历史，包含审批人、时间、状态、意见。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 店长可以在2分钟内完成一条库存调整的录入（从进入页面到提交成功）。
- **SC-002**: 库存流水查询在500ms内返回结果（100条记录以内）。
- **SC-003**: 100%的库存调整都有原因记录（强制必填）。
- **SC-004**: 审批流程不阻塞正常业务操作，待审批状态的调整可继续录入新调整。
- **SC-005**: 安全库存修改后，库存状态在1秒内更新显示。
- **SC-006**: 流水记录准确率100%（变动前后库存与实际一致）。
- **SC-007**: 95%的用户能在首次使用时成功完成库存调整操作（无需培训）。
- **SC-008**: 审批阈值触发准确率100%（金额>=阈值时必进入审批）。

## Assumptions

1. **审批阈值配置**: 假设审批阈值为固定值1000元，后续可通过系统配置调整。
2. **SKU单价来源**: 假设SKU的单价数据已存在于SKU主数据中，用于计算调整金额。
3. **角色权限**: 假设库存管理员（授权）角色可录入调整和编辑安全库存，运营总监角色可审批，权限体系已在系统中实现。库存管理员可跨门店操作。
4. **原因字典初始化**: 系统上线时预置常用调整原因，后续可由管理员维护。
5. **通知机制**: 假设系统已有消息通知能力，审批结果可通过现有通知渠道推送。
6. **库存查询基础**: 本功能基于P003-inventory-query已实现的库存查询和详情展示能力扩展。
7. **二次确认机制**: 库存调整提交前需要二次确认，展示调整前后库存对比，与产品功能文档一致。

## Out of Scope

1. **批量调整**: 本期不支持批量导入调整记录，仅支持逐条录入。
2. **调整模板**: 不支持保存调整模板或复制历史调整。
3. **自动调整**: 不支持根据盘点结果自动生成调整（需手动录入）。
4. **审批层级**: 本期仅支持单级审批，不支持多级审批流程。
5. **移动端审批**: 本期审批仅在B端管理后台，不支持小程序或移动端审批。
6. **调整金额统计报表**: 不在本期范围，后续可作为独立报表功能。
7. **原因字典管理**: 原因字典的新增、修改、删除由系统管理员后台管理，不在本功能范围。
8. **库存预警推送**: 安全库存阈值变更后的预警推送不在本期范围。
