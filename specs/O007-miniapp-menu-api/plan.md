# Implementation Plan: 小程序菜单与商品API集成（阶段一）

**Branch**: `O007-miniapp-menu-api` | **Date**: 2026-01-03 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/O007-miniapp-menu-api/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

实现 miniapp-ordering-taro 前端与后端商品 API 的完整集成，使用户能够在小程序中查看商品分类菜单(4个核心分类:经典特调、精品咖啡、经典饮品、主厨小食)，按分类浏览商品列表，查看商品卡片信息(图片、名称、价格、标签)。

**技术方案**:
- **后端**: 复用现有 `GET /api/client/channel-products/mini-program` API (100%完成)
- **前端框架**: Taro 4.1.9 + React + TypeScript
- **状态管理**: Zustand (客户端状态) + TanStack Query (服务器状态)
- **分类映射**: 建立后端枚举(ALCOHOL/COFFEE/BEVERAGE/SNACK)到中文显示名("经典特调"/"精品咖啡"/"经典饮品"/"主厨小食")的映射字典
- **价格格式化**: 实现分(cents)到元(yuan)的格式化工具函数
- **性能优化**: 图片懒加载、TanStack Query缓存(5分钟staleTime)、防抖处理(300ms)

## Technical Context

<!--
  ACTION REQUIRED: Replace the content in this section with the technical details
  for the project. The structure here is presented in advisory capacity to guide
  the iteration process.
-->

**Language/Version**:
- **C端（小程序）**: TypeScript 5.4.0 + Taro 4.1.9 + React 18.3.1
- **后端**: Java 17 + Spring Boot 3.3.5 (已完成，仅需验证)

**Primary Dependencies**:
- **Taro 4.1.9**: 多端统一开发框架
- **Zustand 4.5.5**: 客户端状态管理(selectedCategory, searchKeyword)
- **TanStack Query 5.90.12**: 服务器状态管理(API数据缓存、重试、轮询)
- **Zod 4.1.13**: 运行时数据验证(ChannelProductDTO校验)
- **Taro.request**: 网络请求封装(支持Token认证、错误拦截)
- **Taro.setStorageSync**: 本地存储(Token持久化)

**Storage**:
- **后端**: Supabase (PostgreSQL, Storage)，商品数据和图片已存储
- **前端**: Taro.setStorageSync 存储Token，TanStack Query内存缓存API数据

**Testing**:
- **单元测试**: Vitest + @testing-library/react (工具函数、组件测试)
- **集成测试**: 微信开发者工具 + H5浏览器手动测试
- **覆盖率目标**: 工具函数≥80%，组件≥70%

**Target Platform**:
- **主要平台**: 微信小程序 (WeChat Mini Program)
- **次要平台**: H5 (移动端浏览器)

**Project Type**:
- **C端客户应用**: 多端统一的小程序/H5点餐应用

**Performance Goals** (规则09-quality-standards.md):
- 首屏加载时间 ≤ 1.5秒 (20个商品含图片)
- 分类切换加载 ≤ 1秒 (有缓存 ≤ 500ms)
- API响应时间 P95 ≤ 1秒
- 小程序主包体积 < 2MB
- 列表滚动 FPS ≥ 50

**Constraints** (项目规则约束):
- **规则04-frontend-c-tech-stack.md**: 必须使用Taro框架，禁用Ant Design/Element UI
- **规则05-state-management.md**: 必须使用Zustand + TanStack Query分层管理状态
- **规则06-code-quality.md**: 所有代码文件必须添加 `@spec O007-miniapp-menu-api` 标识
- **规则09-quality-standards.md**: 必须使用Zod验证API数据，实现Token过期自动刷新

**Scale/Scope**:
- **Phase 1 范围**: 商品菜单(4个分类) + 商品列表 + 商品卡片
- **Out of Scope**: 商品详情页、购物车、搜索功能(Phase 2)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### 必须满足的宪法原则检查：

- [x] **功能分支绑定**: ✅ 分支名 `O007-miniapp-menu-api`，active_spec指向 `specs/O007-miniapp-menu-api/spec.md`
- [x] **测试驱动开发**: ✅ 已规划工具函数单元测试(价格格式化、分类映射)和组件测试(CategoryTabs, ProductCard)
- [x] **组件化架构**: ✅ 设计遵循原子设计:
  - **Molecules**: CategoryTabs (分类导航), ProductCard (商品卡片)
  - **Organisms**: ProductList (商品列表)
  - **Pages**: MenuPage (菜单页面)
- [x] **前端技术栈分层**: ✅ 本功能为C端小程序，使用Taro框架，不使用Ant Design
- [x] **数据驱动状态管理**: ✅ 使用Zustand管理UI状态(selectedCategory)，TanStack Query管理API数据(缓存、重试、轮询)
- [x] **代码质量工程化**: ✅ 所有代码文件添加 `@spec O007-miniapp-menu-api` 标识，TypeScript严格模式，ESLint检查
- [x] **后端技术栈约束**: ✅ 后端已使用Spring Boot + Supabase，本功能仅集成现有API，无需修改后端

### 性能与标准检查：
- [x] **性能标准**: ✅ 已规划性能优化措施:
  - 首屏加载 ≤ 1.5秒 (图片懒加载)
  - 分类切换 ≤ 1秒 (TanStack Query缓存5分钟)
  - 防抖处理300ms (快速切换分类)
- [x] **安全标准**: ✅ 使用Zod验证API数据(ChannelProductDTO)，Token认证，防止XSS(避免dangerouslySetInnerHTML)
- [ ] **可访问性标准**: ⚠️ Phase 1不强制要求WCAG 2.1 AA，仅确保基本可用性(按钮可点击、文字可读)

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (Taro Project)

```text
miniapp-ordering-taro/                # Taro小程序项目根目录
├── src/
│   ├── pages/                       # Taro页面
│   │   └── menu/                   # 菜单页面 (本功能)
│   │       ├── index.tsx           # 页面组件
│   │       └── index.module.scss   # 页面样式
│   │
│   ├── components/                  # 组件库 (Atomic Design)
│   │   ├── CategoryTabs/           # 分类导航组件 (Molecule)
│   │   │   ├── index.tsx
│   │   │   └── index.module.scss
│   │   ├── ProductCard/            # 商品卡片组件 (Molecule)
│   │   │   ├── index.tsx
│   │   │   └── index.module.scss
│   │   └── ProductList/            # 商品列表组件 (Organism)
│   │       ├── index.tsx
│   │       └── index.module.scss
│   │
│   ├── services/                    # API服务层
│   │   └── channelProductService.ts # 商品API封装
│   │
│   ├── stores/                      # Zustand状态管理
│   │   └── productListStore.ts     # 商品列表状态
│   │
│   ├── types/                       # TypeScript类型定义
│   │   └── product.ts              # 商品相关类型
│   │
│   ├── utils/                       # 工具函数
│   │   ├── price.ts                # 价格格式化
│   │   └── category.ts             # 分类映射
│   │
│   └── assets/                      # 静态资源
│       └── images/
│           └── placeholder.png     # 商品占位图
│
├── config/                          # Taro配置
│   └── index.ts                    # 构建配置
│
├── package.json                     # 依赖管理
├── project.config.json              # 微信小程序配置
└── tsconfig.json                    # TypeScript配置

specs/O007-miniapp-menu-api/         # 规格文档
├── spec.md                          # 功能规格
├── plan.md                          # 实施计划 (本文件)
├── research.md                      # 技术研究
├── data-model.md                    # 数据模型
├── quickstart.md                    # 快速上手
├── contracts/
│   └── api.yaml                    # API契约 (OpenAPI 3.0)
└── checklists/
    └── requirements.md             # 需求验收清单
```

**Structure Decision**: Taro multi-platform mini-program application. Components follow Atomic Design principles, state management uses Zustand + TanStack Query, API services use Taro.request wrapper, and styles use SCSS modules with rpx units.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**无宪法违规** ✅

所有宪法原则检查均已通过，无需额外复杂度跟踪。Phase 1 仅包含：
- 前端API集成（复用现有后端）
- 3个基础组件（CategoryTabs, ProductCard, ProductList）
- 2个工具函数（价格格式化、分类映射）
- Zustand + TanStack Query标准状态管理

无额外架构复杂度或技术债务。
