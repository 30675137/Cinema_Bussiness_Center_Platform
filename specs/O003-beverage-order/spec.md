# Feature Specification: 饮品订单创建与出品管理

**Feature Branch**: `O003-beverage-order`
**System**: 商品管理中台
**Module**: 订单管理
**SubModule**: 饮品订单
**Created**: 2025-12-27
**Status**: Draft
**Input**: User description: "饮品订单创建与出品管理 - C端下单、B端出品、BOM扣料、叫号取餐"

<!--
  规格编号格式说明 (Spec ID Format):
  O### - Order Management (订单管理)
  本规格: O003-beverage-order (饮品订单，堂食/吧台场景)

  与其他订单模块的区别:
  - O001: B端商品订单管理（未来电商功能）
  - O002: C端商品订单创建（未来电商功能，已废弃）
  - O003: 饮品订单（当前规格，堂食/吧台场景）
  - U###: 预约订单（影厅场景包预约）
-->

## User Scenarios & Testing *(mandatory)*

### User Story 1 - C端饮品下单 (Priority: P1) 🎯 MVP

作为顾客（到店消费），我希望在小程序上浏览菜单、选择饮品并下单，以便快速完成点单而无需排队等待。

**Why this priority**: 这是整个饮品订单系统的起点，顾客必须能够下单才能触发后续的出品流程。没有下单功能，整个系统无法运作。这是 MVP 的核心能力。

**Independent Test**: 可以独立测试 - 顾客打开小程序 → 浏览饮品菜单 → 选择饮品和规格 → 提交订单 → 支付 → 获得订单号和取餐号。即使不实现 B端出品功能，这个用户故事也能独立交付价值（顾客可以完成下单和支付）。

**Acceptance Scenarios**:

1. **Given** 顾客已登录小程序，**When** 进入饮品菜单页，**Then** 看到按分类组织的饮品列表（咖啡、茶饮、果汁等），每个饮品显示图片、名称、价格、描述、库存状态
2. **Given** 顾客在菜单页，**When** 点击某个饮品，**Then** 进入饮品详情页，显示饮品大图、详细描述、规格选择器（大小、温度、甜度、配料）、当前库存、价格
3. **Given** 顾客在饮品详情页，**When** 选择规格（如：大杯、热、半糖、加珍珠）并点击"加入订单"，**Then** 饮品添加到当前订单，显示成功提示
4. **Given** 顾客已添加饮品到订单，**When** 点击"查看订单"或"结算"，**Then** 进入订单确认页，显示所有已选饮品（名称、规格、数量、单价、小计）、总价
5. **Given** 顾客在订单确认页，**When** 点击"提交订单"并完成微信支付，**Then** 订单创建成功，显示订单号、取餐号、预计制作时间
6. **Given** 顾客完成支付，**When** 在"我的订单"页查看，**Then** 看到订单状态（待制作/制作中/已完成/已交付）实时更新

---

### User Story 2 - B端订单接收与出品 (Priority: P1) 🎯 MVP

作为吧台/厨房工作人员，我希望实时接收订单并管理出品流程（制作 → 完成 → 叫号），以便高效完成订单并通知顾客取餐。

**Why this priority**: 这是饮品订单系统的执行端，必须有出品流程才能将顾客的订单转化为实际交付的饮品。与 US1 同等重要，共同构成 MVP 的核心闭环（下单 → 出品 → 交付）。

**Independent Test**: 可以独立测试 - B端工作人员登录系统 → 实时接收新订单通知 → 查看订单详情 → 标记制作中 → 标记已完成 → 叫号通知顾客。可以用 mock 订单数据独立测试出品流程，不依赖 C端下单功能。

**Acceptance Scenarios**:

1. **Given** B端工作人员已登录系统（Web/平板），**When** 有新订单生成，**Then** 系统发出语音/震动提醒，订单列表自动刷新显示新订单（订单号、取餐号、饮品、规格、数量、下单时间）
2. **Given** 工作人员在订单列表页，**When** 点击某个订单，**Then** 进入订单详情页，显示完整信息（顾客备注、饮品配方、所需原料、制作步骤）
3. **Given** 工作人员查看订单详情，**When** 点击"开始制作"，**Then** 订单状态更新为"制作中"，系统自动执行 BOM 扣料（扣减原料库存），C端用户看到状态更新
4. **Given** 工作人员正在制作饮品，**When** 完成制作并点击"已完成"，**Then** 订单状态更新为"已完成"，系统触发叫号通知（语音播报取餐号），C端用户收到取餐提醒
5. **Given** 订单状态为"已完成"，**When** 顾客取餐后工作人员点击"已交付"，**Then** 订单状态更新为"已交付"，订单归档到历史记录
6. **Given** 工作人员开始制作订单，**When** 发现某原料库存不足无法完成，**Then** 可以标记"缺料"状态，系统通知顾客并提供退款或更换选项

---

### User Story 3 - 订单历史与统计 (Priority: P2)

作为顾客和商家，我希望查看历史订单和营业数据，以便顾客可以复购、商家可以统计分析经营情况。

**Why this priority**: 这是订单管理的辅助功能，提升用户体验和运营效率，但不是下单和出品的必要条件。用户可以先完成下单和出品，后续再查看历史数据。属于 P2 优先级的支持性功能。

**Independent Test**: 可以独立测试 - C端用户查看历史订单列表 → 查看订单详情 → 一键复购；B端查看营业统计 → 查看销量排行 → 导出报表。可以用历史数据 mock 独立测试，不依赖实时下单和出品功能。

**Acceptance Scenarios**:

1. **Given** C端顾客已登录，**When** 进入"我的订单"页，**Then** 看到历史订单列表（按时间倒序），显示订单号、下单时间、饮品、总价、订单状态
2. **Given** 顾客在历史订单列表，**When** 点击某个订单，**Then** 进入订单详情页，显示完整信息（饮品、规格、价格、支付时间、取餐号）
3. **Given** 顾客在订单详情页，**When** 点击"再来一单"，**Then** 系统自动填充相同的饮品和规格到当前订单，顾客可以直接提交
4. **Given** B端管理员已登录，**When** 进入"营业统计"页，**Then** 看到今日/本周/本月的订单数量、销售额、热销饮品排行
5. **Given** B端管理员在统计页，**When** 选择时间范围并点击"导出报表"，**Then** 系统生成 Excel 文件，包含订单明细、销售汇总、原料消耗统计
6. **Given** B端管理员在统计页，**When** 查看饮品销量排行，**Then** 看到每个饮品的销量、销售额、占比，帮助优化菜单和备料

---

### Edge Cases

- **库存不足**: 顾客选择饮品时该饮品或原料库存不足，显示"暂时缺货"提示，无法加入订单
- **支付失败**: 顾客提交订单后支付失败（余额不足、网络中断），订单标记为"待支付"，顾客可以重新支付或取消
- **重复提交**: 顾客快速连续点击"提交订单"，系统防抖处理，只创建一个订单
- **BOM 扣料失败**: 工作人员标记"制作中"时发现原料库存不足（其他订单已消耗），系统阻止扣料并提示"原料不足，请补货或取消订单"
- **订单超时未制作**: 订单创建后 30 分钟内未被接单或制作，系统自动提醒工作人员或通知顾客可申请退款
- **叫号系统故障**: 语音叫号设备故障，系统改为小程序推送通知或短信通知顾客取餐
- **并发订单**: 高峰期多个订单同时到达，订单列表按下单时间排序，工作人员可以手动调整优先级（VIP 订单优先）
- **网络异常**: C端提交订单时网络中断，显示"网络异常，请稍后重试"，订单未创建，用户选择的饮品数据保留在本地
- **取消订单**: 顾客支付后申请取消订单（未开始制作），系统自动退款；已开始制作则需要工作人员审批
- **修改订单**: 顾客支付后发现选错规格，在"待制作"状态下可以修改（如温度、甜度），已制作则无法修改

## Requirements *(mandatory)*

### Functional Requirements

**C端下单模块（US1）**:
- **FR-001**: 小程序底部导航栏必须包含"点餐菜单"tab，点击后导航到饮品菜单页（作为本功能的入口）
- **FR-002**: 系统必须展示饮品菜单，按分类组织（咖啡、茶饮、果汁等），每个饮品显示图片、名称、价格、描述、库存状态
- **FR-003**: 用户必须能够点击饮品进入详情页，查看饮品大图、详细描述、营养信息、规格选择器（大小、温度、甜度、配料）
- **FR-004**: 系统必须提供规格选择器，用户可以选择大小（小/中/大）、温度（冷/热/去冰）、甜度（无糖/半糖/标准/多糖）、配料（珍珠/椰果/布丁等）
- **FR-005**: 用户必须能够将选定的饮品（含规格）添加到当前订单，系统显示成功提示并更新订单商品数量
- **FR-006**: 用户必须能够查看当前订单，显示所有已选饮品（名称、规格、数量、单价、小计）、总价
- **FR-007**: 用户必须能够修改订单中的饮品数量或删除饮品，订单总价实时更新
- **FR-008**: 用户必须能够提交订单并通过Mock支付完成支付(点击支付按钮后自动标记为支付成功),支付成功后生成订单号和取餐号
- **FR-009**: 系统必须在支付成功后显示订单确认页,包含订单号、取餐号、预计制作时间、订单状态
- **FR-010**: 用户必须能够在"我的订单"页查看订单状态（待制作/制作中/已完成/已交付）实时更新

**B端出品模块（US2）**:
- **FR-011**: 系统必须实时接收新订单并通知 B端工作人员（语音提醒/震动提醒/屏幕弹窗）
- **FR-012**: 工作人员必须能够查看订单列表，按下单时间排序，显示订单号、取餐号、饮品、规格、数量、下单时间、订单状态
- **FR-013**: 工作人员必须能够点击订单查看详情，显示顾客备注、饮品配方、所需原料、制作步骤
- **FR-014**: 工作人员必须能够标记订单状态（待制作 → 制作中 → 已完成 → 已交付）
- **FR-015**: 系统必须在订单标记为"制作中"时自动执行 BOM 扣料（根据饮品配方扣减原料库存）
- **FR-016**: 系统必须在 BOM 扣料前校验原料库存，库存不足时阻止扣料并提示工作人员
- **FR-017**: 系统必须在订单标记为"已完成"时触发叫号通知(B端显示"已叫号"状态并Mock语音播报、C端小程序推送通知)
- **FR-018**: 工作人员必须能够标记订单为"已交付"，订单归档到历史记录

**订单历史与统计（US3）**:
- **FR-019**: 用户必须能够查看历史订单列表，按时间倒序排列，显示订单号、下单时间、饮品、总价、订单状态
- **FR-020**: 用户必须能够点击历史订单查看详情，显示完整信息（饮品、规格、价格、支付时间、取餐号）
- **FR-021**: 用户必须能够对历史订单进行"再来一单"操作，系统自动填充相同的饮品和规格到当前订单
- **FR-022**: B端管理员必须能够查看营业统计，显示今日/本周/本月的订单数量、销售额、热销饮品排行
- **FR-023**: B端管理员必须能够导出报表（Excel 格式），包含订单明细、销售汇总、原料消耗统计

**数据同步与错误处理**:
- **FR-024**: 系统必须在网络异常时显示友好的错误提示，并保留用户输入的数据（如已选饮品）
- **FR-025**: 系统必须防止重复提交订单（按钮防抖、提交后禁用按钮）
- **FR-026**: 所有 API 请求必须包含用户认证 Token，Token 过期时自动刷新
- **FR-027**: 系统必须记录关键操作日志（下单、支付、BOM 扣料、订单状态变更），便于问题排查

### Key Entities

- **Beverage（饮品）**: 代表菜单中的饮品，包含饮品ID、名称、描述、分类（咖啡/茶饮/果汁）、价格、主图、详情图、上架状态、推荐标签。一个饮品可以有多个规格组合。
- **BeverageSpec（饮品规格）**: 代表饮品的可选规格，包含规格类型（大小/温度/甜度/配料）、规格选项（如大小：小/中/大）、价格调整（如大杯+5元）。每个饮品可以关联多个规格类型。
- **BeverageRecipe（饮品配方/BOM）**: 代表饮品的制作配方，包含配方ID、饮品ID、原料列表（如：咖啡豆 20g、牛奶 200ml、糖浆 10ml）、制作步骤。用于自动扣料和指导工作人员制作。
- **Ingredient（原料）**: 代表制作饮品所需的原料，包含原料ID、名称、单位（g/ml/个）、当前库存、安全库存、供应商。关联到饮品配方，用于 BOM 扣料。
- **BeverageOrder（饮品订单）**: 代表一笔饮品订单，包含订单ID、订单号、取餐号、用户ID、订单状态（待支付/待制作/制作中/已完成/已交付/已取消）、总价、支付时间、创建时间、完成时间。一个订单包含多个订单项。
- **BeverageOrderItem（订单项）**: 代表订单中的一个饮品项，包含订单项ID、订单ID、饮品ID、饮品名称（快照）、选中的规格（快照，如：大杯/热/半糖/加珍珠）、数量、单价（快照）、小计。记录下单时的饮品信息快照，避免菜单变更影响订单。
- **QueueNumber（取餐号）**: 代表叫号系统的取餐号，包含取餐号ID、取餐号码（如 001、002）、订单ID、生成时间、叫号状态（待叫号/已叫号/已取餐）。用于叫号系统和顾客取餐。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 顾客能够在 **2分钟内** 完成从浏览菜单到提交订单的完整流程（浏览 → 选择饮品 → 选择规格 → 提交 → 支付）
- **SC-002**: 订单提交成功率达到 **95%以上**（排除用户主动取消、库存不足等正常失败场景）
- **SC-003**: B端工作人员能够在 **30秒内** 接收到新订单通知并查看订单详情
- **SC-004**: BOM 扣料准确率 **100%**（扣减的原料数量与饮品配方完全一致，不允许重复扣料或漏扣料）
- **SC-005**: 订单状态更新延迟不超过 **3秒**（B端标记状态后，C端用户看到状态更新）
- **SC-006**: 叫号通知到达率 **95%以上**（订单完成后，顾客能够及时收到取餐通知）
- **SC-007**: 菜单页面首屏加载时间不超过 **2秒**（包含饮品图片加载）
- **SC-008**: 系统支持 **高峰期 100 个并发订单** 无性能下降（订单接收、状态更新、叫号通知）
- **SC-009**: 历史订单查询响应时间不超过 **1秒**（分页加载，单页 20 条订单）
- **SC-010**: **90%的顾客** 能够在首次使用时成功完成下单流程（无需帮助文档或客服协助）

## Clarifications

### Session 2025-12-27

- Q: 支付模块实现方式？ → A: 支付模块先通过mock实现,不考虑接入实际的支付系统
- Q: 叫号系统在MVP阶段应该如何实现? → A: Mock语音播报(仅在B端显示"已叫号"状态,不实际播放语音),小程序推送通知正常实现
- Q: B端订单实时通知在MVP阶段应该如何实现? → A: 使用轮询(Polling)实现,每5-10秒查询一次新订单,简化MVP实现
- Q: 饮品菜单和配方数据在MVP阶段应该如何提供? → A: 真实后端API,需要先实现后端饮品管理模块,前端通过API获取数据
- Q: BOM扣料的原料库存数据在MVP阶段应该如何获取? → A: 真实库存数据,集成P003/P004库存管理模块的API,实现真实的库存查询和扣减
- Q: 小程序底部导航栏如何配置? → A: 小程序下边栏需要增加"点餐菜单"tab来绑定饮品订单功能页面(饮品菜单页)

## Assumptions & Constraints *(optional)*

### Assumptions

- **用户认证**: 假设用户已通过静默登录（silent login）完成微信授权，所有订单相关操作需要用户登录状态
- **饮品数据来源**: 饮品菜单、规格、配方数据由后端管理员维护(需先实现后端饮品管理模块),前端通过真实API获取,不使用Mock数据
- **支付功能**: 使用 Mock 数据模拟支付流程,点击"支付"按钮后自动标记为支付成功,订单状态从"待支付"变更为"待制作",无需接入真实的微信支付API
- **叫号系统**: MVP阶段使用Mock语音播报(B端仅显示"已叫号"状态,不实际播放语音),小程序推送通知正常实现;后续版本可集成真实TTS服务
- **BOM 扣料时机**: 假设订单标记为"制作中"时立即扣减原料库存（预占库存），订单取消或失败时释放库存
- **原料库存管理**: 假设原料库存由后端管理员手动录入或通过进销存系统同步，前端只查询和扣减库存
- **取餐号生成**: 假设取餐号按日期和序号生成（如 001、002），每天 0 点重置，避免号码过大
- **配方数据**: 假设饮品配方由后端管理员维护，包含原料列表和用量，前端只读取配方用于扣料

### Constraints

- **技术栈限制**: C端必须使用 Taro 4.1.9 + React 18.3.1 开发，兼容微信小程序和 H5 平台；B端使用 React 19.2.0 + Ant Design 6.1.0 开发
- **UI 限制**: C端必须使用 Taro UI 或 NutUI 组件库；B端必须使用 Ant Design 组件库
- **导航限制**: 小程序底部导航栏（tabBar）必须包含"点餐菜单"tab，配置在 `hall-reserve-taro/src/app.config.ts` 的 tabBar 配置中，指向饮品菜单页
- **状态管理**: 必须使用 Zustand 管理订单、菜单状态，使用 TanStack Query 管理服务器数据
- **认证限制**: 所有 API 请求必须通过 `utils/request.ts` 统一处理，自动附加认证 Token 和处理 Token 刷新
- **图片存储**: 饮品图片必须存储在 Supabase Storage，前端通过 URL 引用，不得存储在小程序本地
- **小程序包体积**: 小程序主包体积必须 < 2MB，饮品图片等资源必须按需加载
- **实时通知**: MVP阶段B端订单通知使用轮询(Polling)实现,每5-10秒查询一次新订单;后续版本可升级为WebSocket或SSE实现真正的实时推送
- **叫号语音**: 叫号语音播报必须使用 Web Speech API 或第三方 TTS 服务（如阿里云、腾讯云）
- **离线功能**: C端菜单浏览支持离线访问（缓存菜单数据），订单提交必须在线（依赖后端 API）

## Dependencies *(optional)*

### Internal Dependencies

- **现有认证系统**: 依赖 `hall-reserve-taro/src/services/authService.ts` 提供的静默登录和 Token 管理功能
- **现有请求封装**: 依赖 `hall-reserve-taro/src/utils/request.ts` 提供的统一请求处理（认证、错误处理、Token 刷新）
- **现有用户状态**: 依赖 `hall-reserve-taro/src/stores/userStore.ts` 提供的用户信息存储
- **库存管理模块**: 依赖P003-inventory-query和P004-inventory-adjustment提供的原料库存查询和扣减API,MVP阶段直接集成真实库存数据,不使用Mock

### External Dependencies

- **Supabase 饮品数据表**: 依赖 `beverages`, `beverage_specs`, `beverage_recipes`, `ingredients` 表提供饮品和配方数据
- **Supabase 订单数据表**: 依赖 `beverage_orders`, `beverage_order_items`, `queue_numbers` 表存储订单数据
- **支付功能**: 使用 Mock 数据模拟支付流程,无需接入真实支付系统(微信支付等)
- **叫号语音 TTS**: MVP阶段使用Mock实现,B端仅显示"已叫号"状态,无需依赖真实TTS服务
- **实时通知服务**: MVP阶段使用轮询(每5-10秒)查询新订单,无需WebSocket/SSE服务

### 与现有预约订单功能的区别

| 维度 | 预约订单（Reservation） | 饮品订单（Beverage Order） |
|------|------------------------|---------------------------|
| 业务模式 | 预约影厅场景包，预付费 | 堂食饮品点单，到店消费 |
| 数据表 | `reservations`, `reservation_orders` | `beverage_orders`, `beverage_order_items` |
| 模块前缀 | U/RSV | O |
| 购物车 | 无需购物车，单次预约 | 需要订单（类似购物车），支持多个饮品 |
| 地址 | 无需配送地址，到店消费 | 无需配送地址，堂食取餐 |
| 库存 | 影厅时段可用性 | 饮品原料库存（BOM 扣料） |
| 支付时机 | 预约时即支付 | 下单时支付 |
| 状态流转 | 待确认 → 已确认 → 已完成/已取消 | 待支付 → 待制作 → 制作中 → 已完成 → 已交付/已取消 |
| 取餐方式 | 到店按预约时间入场 | 叫号取餐（语音播报取餐号） |
| BOM 扣料 | 无 | 有（根据饮品配方扣减原料库存） |

### 集成点

- **共享认证系统**: 饮品订单和预约订单共享同一套用户认证和 Token 管理机制
- **共享请求封装**: 使用同一个 `utils/request.ts` 处理 API 请求
- **共享用户状态**: 使用同一个 `userStore.ts` 存储用户信息
- **共享 UI 组件**: 可复用 `EmptyState`, `ErrorState`, `LoadingSpinner` 等通用组件
- **独立业务逻辑**: 饮品订单和预约订单的业务逻辑、数据模型、状态管理完全独立，互不干扰

## Scope *(optional)*

### In Scope

- ✅ 饮品菜单浏览（分类、图片、价格、描述、库存状态）
- ✅ 饮品详情查看（大图、描述、规格选择器、营养信息）
- ✅ 规格选择（大小、温度、甜度、配料）
- ✅ 订单管理（添加饮品、修改数量、删除饮品、提交订单）
- ✅ 微信支付集成（支付、支付回调、支付状态查询）
- ✅ 订单号和取餐号生成（自动生成、避免重复）
- ✅ B端订单接收（实时通知、订单列表、订单详情）
- ✅ BOM 扣料（根据饮品配方自动扣减原料库存、库存校验）
- ✅ 订单状态管理（待制作 → 制作中 → 已完成 → 已交付）
- ✅ 叫号系统（语音播报取餐号、小程序推送通知）
- ✅ 订单历史查询（C端历史订单、B端订单归档）
- ✅ 营业统计（订单数量、销售额、热销饮品排行）
- ✅ 一键复购（基于历史订单快速下单）
- ✅ 网络异常处理（友好错误提示、数据保留）
- ✅ 重复提交防护（按钮防抖、状态锁定）

### Out of Scope

- ❌ 外卖配送功能（配送地址、配送员、配送状态跟踪） - 当前只支持堂食取餐
- ❌ 会员积分/优惠券（积分累积、优惠券发放、满减活动） - 后续版本实现
- ❌ 饮品评价功能（用户评分、评论、晒单） - 后续版本实现
- ❌ 饮品搜索与筛选（关键词搜索、分类筛选、价格排序） - 后续版本实现
- ❌ 桌号/座位号管理（扫码点单、桌号绑定） - 后续版本实现
- ❌ 排队叫号（等位取号、排队进度查询） - 后续版本实现
- ❌ 多门店支持（门店选择、跨店订单） - 当前只支持单门店
- ❌ 打印小票（后厨小票打印、顾客小票打印） - 后续版本实现
- ❌ B端饮品/配方管理（饮品上架、编辑、下架、配方维护） - 已在其他模块实现
- ❌ B端原料库存管理（原料入库、盘点、预警） - 已在 P003/P004 实现
- ❌ 第三方平台订单对接（美团、饿了么） - 后续版本实现

---

**总结**: 本规格定义了饮品订单创建与出品管理功能的完整需求，包括 3 个独立用户故事（C端下单、B端出品、订单历史），26 个功能需求，10 个成功标准。核心业务流程为：顾客小程序下单 → 微信支付 → B端接收订单 → BOM 自动扣料 → 工作人员制作 → 标记完成 → 叫号通知顾客取餐。与预约订单功能独立实现，共享认证和请求基础设施，确保业务解耦和系统稳定性。
