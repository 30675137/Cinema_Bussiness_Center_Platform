# Feature Specification: 订单列表与状态查看 (Order List & Status View)

**Feature Branch**: `U004-order-list-view`
**Created**: 2025-12-27
**Status**: Draft
**Input**: User description: "基于影院业务中台系统的订单管理模块，继续开发\"订单列表/状态查看\"功能。该功能需要在现有的预约订单管理基础上进行完善和优化。"

<!--
  规格编号格式说明 (Spec ID Format):
  U004: U=用户/预订管理, 004=模块内递增编号
-->

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看订单列表(全量订单) (Priority: P1)

作为影院运营人员,我希望能够在后台管理平台的订单管理模块中查看所有预约订单的完整列表,这样我可以全面掌握影院的订单情况,快速定位需要处理的订单。

**Why this priority**: 订单列表是订单管理的核心入口,没有列表功能就无法进行任何后续的订单管理操作。这是最基础的MVP功能,必须优先实现。

**Independent Test**: 可以通过登录后台管理平台,进入订单管理模块(`/orders/list` 或 `/reservation-orders`),验证订单列表能够正确加载并展示所有订单数据(包括订单号、客户信息、状态、金额、时间等关键字段)来独立测试。

**Acceptance Scenarios**:

1. **Given** 运营人员登录后台管理平台,**When** 点击"订单管理"菜单进入订单列表页面,**Then** 应显示所有预约订单,默认按创建时间倒序排列(最新订单在最前)
2. **Given** 订单列表页面已加载,**When** 查看订单列表,**Then** 每条订单应显示:订单号、客户姓名、客户手机号、场景包名称、预订时段、订单状态、订单金额、创建时间、操作按钮(查看详情)
3. **Given** 订单列表有超过20条记录,**When** 页面加载完成,**Then** 应显示分页控件,默认每页显示20条订单,并支持切换页码和调整每页显示数量(10/20/50/100)
4. **Given** 订单列表页面加载中,**When** 数据尚未返回,**Then** 应显示加载动画(Ant Design Spin组件),避免用户误以为页面卡顿
5. **Given** 系统中没有任何订单数据,**When** 订单列表页面加载完成,**Then** 应显示空状态提示"暂无订单数据",并提供引导文案(如"客户预约后订单将出现在此列表中")
6. **Given** 订单列表页面已加载,**When** 运营人员点击某条订单行,**Then** 应高亮显示该行,并显示"查看详情"操作按钮
7. **Given** 订单列表页面已加载,**When** 后端返回错误(如网络超时、服务器错误),**Then** 应显示友好的错误提示"加载失败,请稍后重试",并提供"重新加载"按钮

---

### User Story 2 - 订单状态筛选与展示 (Priority: P1)

作为影院运营人员,我希望能够按订单状态(待确认、已确认、已完成、已取消)筛选订单列表,并且每种状态用不同的颜色或标签清晰展示,这样我可以快速找到需要处理的特定状态的订单,提高工作效率。

**Why this priority**: 状态筛选是订单管理的核心功能,运营人员需要按状态分类处理订单(如优先处理"待确认"订单)。没有状态筛选,列表将难以使用。这是P1功能。

**Independent Test**: 可以通过在订单列表页面使用状态筛选器(Ant Design Tabs或Select组件),选择不同状态,验证列表正确过滤并显示对应状态的订单,且状态标签颜色符合规范来独立测试。

**Acceptance Scenarios**:

1. **Given** 订单列表页面已加载,**When** 运营人员查看订单状态列,**Then** 每个订单的状态应以彩色标签(Ant Design Tag组件)显示:
   - "待确认" - 橙色(warning)
   - "已确认" - 蓝色(processing)
   - "已完成" - 绿色(success)
   - "已取消" - 灰色(default)
2. **Given** 订单列表页面顶部,**When** 运营人员查看筛选区域,**Then** 应显示状态筛选器(Tabs形式),包含选项:"全部"、"待确认"、"已确认"、"已完成"、"已取消",默认选中"全部"
3. **Given** 运营人员点击"待确认"标签,**When** 筛选条件应用,**Then** 订单列表应仅显示状态为"待确认"的订单,分页重置为第1页,并显示筛选后的总数(如"待确认订单: 15条")
4. **Given** 运营人员已选择特定状态筛选,**When** 点击"全部"标签,**Then** 筛选条件应清除,列表应重新显示所有订单
5. **Given** 运营人员选择某个状态筛选,**When** 该状态下没有任何订单,**Then** 应显示空状态提示"暂无[状态名]订单"(如"暂无待确认订单")
6. **Given** 订单状态在后台被变更(如从"待确认"变为"已确认"),**When** 运营人员刷新页面或切换筛选条件,**Then** 订单应出现在正确的状态分类中

---

### User Story 3 - 时间范围筛选 (Priority: P2)

作为影院运营人员,我希望能够按时间范围(创建时间)筛选订单,例如选择"最近7天"、"最近30天"或自定义日期范围,这样我可以查看特定时期的订单数据,进行数据分析或处理历史订单。

**Why this priority**: 时间范围筛选对于历史数据查询和报表分析很重要,但不影响日常的订单处理流程。大部分情况下运营人员关注最新订单,因此时间筛选可以作为P2功能。

**Independent Test**: 可以通过在订单列表页面使用时间范围筛选器(Ant Design DatePicker.RangePicker组件),选择不同时间范围,验证列表正确过滤并显示该时间段内创建的订单来独立测试。

**Acceptance Scenarios**:

1. **Given** 订单列表页面筛选区域,**When** 运营人员查看,**Then** 应显示时间范围筛选器,包含快捷选项:"今天"、"最近7天"、"最近30天"、"自定义范围",默认不筛选(显示所有时间)
2. **Given** 运营人员点击"最近7天"快捷选项,**When** 筛选条件应用,**Then** 订单列表应仅显示最近7天内创建的订单,并显示时间范围提示(如"2025-12-20 至 2025-12-27")
3. **Given** 运营人员点击"自定义范围",**When** 日期选择器弹出,**Then** 应支持选择开始日期和结束日期,结束日期不能早于开始日期,日期选择器应限制不能选择未来日期
4. **Given** 运营人员选择了自定义时间范围(如2025-12-01至2025-12-15),**When** 点击"确定",**Then** 订单列表应仅显示该时间范围内创建的订单,分页重置为第1页
5. **Given** 运营人员已应用时间范围筛选,**When** 点击"清空筛选"按钮,**Then** 时间筛选条件应清除,列表恢复显示所有时间段的订单
6. **Given** 运营人员同时应用了状态筛选和时间范围筛选,**When** 两个筛选条件生效,**Then** 订单列表应显示同时满足两个条件的订单(AND逻辑)

---

### User Story 4 - 客户手机号搜索 (Priority: P2)

作为影院运营人员,我希望能够通过客户手机号快速搜索订单,这样当客户来电咨询订单时,我可以立即找到对应的订单并提供服务。

**Why this priority**: 手机号搜索对于客服场景很有价值,但不是核心的订单处理流程。大部分订单管理操作通过状态筛选即可完成,因此搜索功能可以作为P2优先级。

**Independent Test**: 可以通过在订单列表页面的搜索框(Ant Design Input.Search组件)输入客户手机号,验证列表实时过滤并显示匹配的订单来独立测试。

**Acceptance Scenarios**:

1. **Given** 订单列表页面顶部,**When** 运营人员查看,**Then** 应显示搜索框,占位符文本为"请输入客户手机号搜索订单",支持实时搜索(输入时即过滤)
2. **Given** 运营人员在搜索框输入手机号前4位(如"1380"),**When** 输入完成,**Then** 订单列表应实时过滤,仅显示客户手机号包含"1380"的订单
3. **Given** 运营人员输入完整手机号(如"13800138000"),**When** 匹配到订单,**Then** 列表应显示该客户的所有订单,匹配的手机号部分应高亮显示
4. **Given** 运营人员输入的手机号无匹配订单,**When** 搜索完成,**Then** 应显示空状态提示"未找到匹配的订单,请检查手机号是否正确"
5. **Given** 运营人员在搜索框输入了非数字字符(如字母),**When** 输入完成,**Then** 系统应容错处理,仅匹配数字部分,或提示"请输入有效的手机号"
6. **Given** 运营人员已输入搜索关键词,**When** 点击搜索框的清除按钮(×),**Then** 搜索条件应清除,列表恢复显示所有订单
7. **Given** 运营人员同时使用了搜索和筛选功能,**When** 两个条件同时生效,**Then** 订单列表应显示同时满足搜索和筛选条件的订单(AND逻辑)

---

### User Story 5 - 查看订单详情 (Priority: P1)

作为影院运营人员,我希望能够点击订单列表中的某条订单,查看该订单的完整详情(包括场景包信息、预订时段、套餐、加购项、客户信息、金额明细、操作日志等),这样我可以全面了解订单情况,做出正确的处理决策。

**Why this priority**: 查看详情是订单处理的必需步骤,运营人员需要了解订单的完整信息才能进行确认、取消等操作。这是核心功能,必须在MVP中实现。

**Independent Test**: 可以通过在订单列表中点击某条订单的"查看详情"按钮,验证订单详情抽屉(Ant Design Drawer组件)正确打开并展示完整的订单信息来独立测试。

**Acceptance Scenarios**:

1. **Given** 订单列表页面已加载,**When** 运营人员点击某条订单的"查看详情"按钮,**Then** 应从页面右侧滑出订单详情抽屉(Drawer组件),宽度约720px
2. **Given** 订单详情抽屉已打开,**When** 运营人员查看,**Then** 应显示以下信息分组:
   - **订单基本信息**: 订单号、订单状态(彩色标签)、创建时间、最后更新时间
   - **客户信息**: 客户姓名、手机号、备注(如有)
   - **场景包信息**: 场景包名称、预订日期、预订时段、所选套餐名称、套餐价格
   - **加购项明细**: 加购项名称、数量、单价、小计(以表格形式展示)
   - **金额明细**: 套餐金额、加购项合计、订单总金额(突出显示)
   - **操作日志**: 按时间倒序显示订单的状态变更记录(如"2025-12-27 10:00 - 订单创建"、"2025-12-27 10:30 - 运营人员张三确认订单")
3. **Given** 订单详情抽屉已打开,**When** 订单状态为"待确认",**Then** 抽屉底部应显示操作按钮:"确认订单"、"取消订单"、"关闭"
4. **Given** 订单详情抽屉已打开,**When** 订单状态为"已确认"或"已完成"或"已取消",**Then** 抽屉底部应仅显示"关闭"按钮,不显示操作按钮(因为订单已处于终态)
5. **Given** 订单详情抽屉已打开,**When** 运营人员点击"确认订单"或"取消订单"按钮,**Then** 应触发相应的操作(调用U001现有的确认/取消功能),操作成功后刷新订单列表并关闭抽屉
6. **Given** 订单详情抽屉已打开,**When** 运营人员点击抽屉遮罩层或"关闭"按钮,**Then** 抽屉应关闭并返回订单列表页面
7. **Given** 订单详情抽屉加载失败(如订单ID不存在),**When** 抽屉打开,**Then** 应显示错误提示"订单详情加载失败",并提供"重新加载"按钮

---

### User Story 6 - 订单状态变更操作(集成U001功能) (Priority: P1)

作为影院运营人员,我希望能够在订单列表页面或订单详情页面直接执行订单状态变更操作(确认订单、取消订单),无需跳转到其他页面,这样我可以快速处理订单,提高工作效率。

**Why this priority**: 状态变更操作是订单管理的核心流程,必须与列表和详情功能紧密集成。这是运营人员的主要工作内容,必须在MVP中实现。

**Independent Test**: 可以通过在订单列表或详情页面点击"确认订单"或"取消订单"按钮,验证操作成功后订单状态正确更新,列表数据实时刷新来独立测试。

**Acceptance Scenarios**:

1. **Given** 订单列表页面已加载,**When** 运营人员查看某条"待确认"状态的订单,**Then** 订单行应显示快捷操作按钮:"确认"、"取消"(以图标按钮形式展示,节省空间)
2. **Given** 运营人员在订单列表中点击"确认"按钮,**When** 确认对话框弹出,**Then** 应显示与U001一致的确认选项:"要求客户支付"或"直接完成(无需支付)",以及订单摘要信息
3. **Given** 运营人员在确认对话框中选择确认方式并点击"确定",**When** 操作成功,**Then** 订单状态应立即更新(待确认→已确认或已完成),订单列表应自动刷新,操作成功提示显示在页面顶部
4. **Given** 运营人员在订单列表中点击"取消"按钮,**When** 取消对话框弹出,**Then** 应显示取消原因填写表单(与U001一致),包含常见原因选项和自定义文本框
5. **Given** 运营人员填写取消原因并确认,**When** 操作成功,**Then** 订单状态应立即更新为"已取消",订单列表应自动刷新,取消原因应记录到订单操作日志中
6. **Given** 运营人员在订单详情抽屉中点击"确认订单"或"取消订单"按钮,**When** 操作完成,**Then** 详情抽屉应关闭,订单列表应刷新并反映最新状态,成功提示显示在列表页面顶部
7. **Given** 订单状态在后台已被其他运营人员变更,**When** 当前运营人员尝试操作,**Then** 系统应返回错误"订单状态已变更,请刷新页面",并自动刷新订单列表
8. **Given** 运营人员操作订单时网络请求失败,**When** 操作失败,**Then** 应显示错误提示"操作失败,请重试",订单状态保持不变,用户可重新尝试操作

---

### Edge Cases

- **并发状态变更**: 当多个运营人员同时操作同一订单时,系统应通过乐观锁或版本控制机制防止冲突,后操作者应收到"订单状态已变更"提示
- **大量订单加载性能**: 当订单总数超过10000条时,列表加载应保持在2秒内完成,通过后端分页和前端虚拟滚动(如有必要)优化性能
- **筛选条件组合**: 当同时应用多个筛选条件(状态+时间范围+搜索)时,系统应正确处理AND逻辑,确保结果准确
- **订单详情加载失败**: 当订单ID无效或订单已被删除时,详情抽屉应显示友好的错误提示而非白屏或崩溃
- **空状态处理**: 当筛选或搜索后无结果时,应显示明确的空状态提示,避免用户误以为系统出错
- **手机号格式容错**: 搜索功能应容错处理手机号格式(如忽略空格、横线),仅匹配数字部分
- **时间范围边界**: 当选择"今天"时,应包含当天0:00:00至23:59:59的所有订单,避免遗漏
- **分页数据一致性**: 当订单列表跨页时,状态变更后应保持在当前页或合理跳转,避免用户迷失

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在订单管理模块提供订单列表页面,路径为`/orders/list`或`/reservation-orders`,显示所有预约订单
- **FR-002**: 订单列表必须显示以下关键字段:订单号、客户姓名、客户手机号、场景包名称、预订时段、订单状态、订单金额、创建时间、操作按钮
- **FR-003**: 订单列表必须支持分页功能,默认每页显示20条记录,支持切换每页显示数量(10/20/50/100条)
- **FR-004**: 订单列表必须按创建时间倒序排列,最新订单显示在最前
- **FR-005**: 系统必须提供订单状态筛选功能,支持筛选:全部、待确认、已确认、已完成、已取消
- **FR-006**: 订单状态必须使用彩色标签(Ant Design Tag)展示:待确认(橙色)、已确认(蓝色)、已完成(绿色)、已取消(灰色)
- **FR-007**: 系统必须提供时间范围筛选功能,支持快捷选项(今天、最近7天、最近30天)和自定义日期范围
- **FR-008**: 系统必须提供客户手机号搜索功能,支持实时搜索(输入时即过滤)
- **FR-009**: 系统必须支持同时应用多个筛选条件(状态+时间范围+搜索),使用AND逻辑组合
- **FR-010**: 系统必须提供订单详情查看功能,点击订单后从右侧滑出详情抽屉(Ant Design Drawer)
- **FR-011**: 订单详情必须显示完整信息:订单基本信息、客户信息、场景包信息、加购项明细、金额明细、操作日志
- **FR-012**: 订单详情抽屉必须根据订单状态动态显示操作按钮:
  - 待确认状态:显示"确认订单"、"取消订单"、"关闭"按钮
  - 其他状态(已确认/已完成/已取消):仅显示"关闭"按钮
- **FR-013**: 系统必须在订单列表和详情页面集成U001的确认订单功能,支持"要求客户支付"和"直接完成(无需支付)"两种确认方式
- **FR-014**: 系统必须在订单列表和详情页面集成U001的取消订单功能,要求填写取消原因
- **FR-015**: 系统必须在订单状态变更后立即刷新订单列表,反映最新状态
- **FR-016**: 系统必须处理并发操作冲突,当订单状态已被其他用户变更时,提示"订单状态已变更,请刷新页面"
- **FR-017**: 系统必须在数据加载中显示加载动画(Ant Design Spin),避免用户误以为页面卡顿
- **FR-018**: 系统必须在无数据或筛选无结果时显示友好的空状态提示
- **FR-019**: 系统必须在操作成功或失败时显示明确的提示消息(Ant Design Message或Notification)
- **FR-020**: 系统必须使用Ant Design组件库实现所有UI组件,确保与现有系统UI风格一致

### Key Entities

- **Order (订单)**: 代表一个预约订单,包含订单号、客户信息、场景包信息、预订时段、套餐、加购项、状态、金额、时间戳等属性。与U001的ReservationOrder实体一致。
- **OrderStatus (订单状态)**: 订单的生命周期状态,包含:待确认(PENDING)、已确认(CONFIRMED)、已完成(COMPLETED)、已取消(CANCELLED)。状态定义与U001一致。
- **Customer (客户)**: 下单客户的基本信息,包含姓名、手机号、备注等属性。
- **ScenarioPackage (场景包)**: 订单关联的场景包,包含场景包名称、描述等属性。
- **Timeslot (时段)**: 预订的时段信息,包含日期、时段标识等属性。
- **套餐 (Package)**: 订单选择的套餐,包含套餐名称、价格等属性。
- **加购项 (AddOn)**: 订单中的加购项,包含名称、数量、单价、小计等属性。
- **OperationLog (操作日志)**: 记录订单的状态变更历史,包含操作时间、操作人、操作类型、状态变化等属性。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 运营人员可在2秒内加载并查看订单列表(100条订单以内)
- **SC-002**: 运营人员可在1秒内通过状态筛选找到特定状态的订单
- **SC-003**: 运营人员可在3秒内通过手机号搜索找到客户的订单
- **SC-004**: 运营人员可在1秒内打开订单详情抽屉查看完整订单信息
- **SC-005**: 运营人员可在5秒内完成订单确认或取消操作(从点击按钮到操作成功)
- **SC-006**: 订单列表在状态变更后1秒内自动刷新并反映最新状态
- **SC-007**: 系统支持同时展示10000条订单数据而无性能问题(通过分页优化)
- **SC-008**: 95%的运营人员能在首次使用时成功完成订单筛选和查看详情操作(无需培训)
- **SC-009**: 订单状态筛选准确率100%(筛选结果与实际状态完全匹配)
- **SC-010**: 并发操作冲突检测准确率100%(多人同时操作同一订单时正确提示冲突)

## Assumptions

1. **现有功能依赖**: 假设U001-reservation-order-management已完整实现订单的CRUD功能、状态变更逻辑(确认、取消)、操作日志记录,本功能仅需集成调用这些API
2. **数据库表结构**: 假设订单数据存储在Supabase的`reservation_orders`表中,包含所有必需字段(订单号、客户信息、状态、金额、时间戳等),表结构与U001一致
3. **权限控制**: 假设系统已实现角色权限控制,仅运营人员和管理员角色可访问订单管理模块,本功能复用现有权限机制
4. **实时性要求**: 假设订单列表不需要实时推送更新(如WebSocket),用户通过手动刷新或自动刷新(可选)获取最新数据
5. **状态定义一致性**: 假设订单状态枚举与U001保持一致:PENDING(待确认)、CONFIRMED(已确认)、COMPLETED(已完成)、CANCELLED(已取消)
6. **操作通知**: 假设系统已有消息通知能力(如短信、站内信),订单状态变更时自动发送通知给客户,本功能无需额外实现通知逻辑
7. **支付状态**: 假设订单支付状态由U001管理,"已确认"状态下可能包含"待支付"和"已支付"两种子状态,详情页显示完整支付信息
8. **分页默认值**: 假设默认每页显示20条订单为合理值,基于常见后台管理系统的分页规范
9. **时间范围计算**: 假设"最近7天"指从今天0:00:00往前推7个完整日历日,"今天"指当天0:00:00至23:59:59
10. **手机号格式**: 假设客户手机号存储格式为11位数字字符串,搜索时仅匹配数字部分,容错处理空格和横线

## Out of Scope

1. **订单创建功能**: 本功能不包含订单创建(下单)流程,订单创建由U001的C端预约功能和B端手动创建功能实现
2. **订单编辑功能**: 本功能不包含订单信息编辑(如修改客户姓名、手机号、预订时段),编辑功能由U001的订单修改功能实现
3. **批量操作**: 本期不支持批量确认、批量取消等批量操作功能,仅支持单条订单操作
4. **高级搜索**: 本期不支持多条件组合搜索(如同时按订单号+场景包名称搜索),仅支持单一手机号搜索
5. **订单导出**: 本期不支持导出订单列表为Excel或CSV文件,导出功能后续作为独立功能实现
6. **订单统计报表**: 本期不包含订单统计分析功能(如每日订单数、收入统计),报表功能后续独立实现
7. **订单删除**: 本期不支持物理删除订单,已取消订单仅做状态标记,数据保留用于审计
8. **自定义列显示**: 本期不支持用户自定义列表显示字段或调整列顺序,列配置固定
9. **订单打印**: 本期不支持打印订单详情或生成PDF,打印功能后续扩展
10. **移动端适配**: 本功能仅针对B端管理后台(桌面端),不包含移动端或响应式布局
11. **实时推送**: 本期不支持订单状态实时推送更新,用户需手动刷新或通过自动刷新(可选)获取最新数据
12. **高级筛选**: 本期不支持按场景包、门店、套餐类型等复杂条件筛选,仅支持状态、时间、手机号三种筛选
