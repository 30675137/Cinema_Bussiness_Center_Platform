# Implementation Plan: å°ç¨‹åºèœå•åˆ†ç±»åŠ¨æ€é…ç½®

**Branch**: `O002-miniapp-menu-config` | **Date**: 2026-01-04 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/O002-miniapp-menu-config/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

å°†ç¡¬ç¼–ç çš„ `ChannelCategory` æšä¸¾è¿ç§»åˆ°æ•°æ®åº“è¡¨ `menu_category`ï¼Œå®ç°å®Œå…¨åŠ¨æ€çš„å•†å“åˆ†ç±»ç®¡ç†ç³»ç»Ÿã€‚æ ¸å¿ƒå˜æ›´åŒ…æ‹¬ï¼š

1. **ç»Ÿä¸€åˆ†ç±»æ¥æº**: `menu_category` è¡¨æˆä¸ºåˆ†ç±»çš„å”¯ä¸€æ•°æ®æº
2. **å•†å“å…³è”å˜æ›´**: `channel_product_config.channel_category` æšä¸¾å­—æ®µæ”¹ä¸º `category_id` å¤–é”®
3. **æ–°å¢åˆ†ç±» API**: å°ç¨‹åºä» API åŠ¨æ€è·å–åˆ†ç±»åˆ—è¡¨ï¼Œä¸å†ä½¿ç”¨å‰ç«¯ç¡¬ç¼–ç æ˜ å°„
4. **å‘åå…¼å®¹**: å•†å“åˆ—è¡¨ API åŒæ—¶æ”¯æŒ `categoryId` å’Œ `category` å‚æ•°

æŠ€æœ¯æ–¹æ¡ˆï¼š
- **åç«¯**: Spring Boot 3.3.5 + Supabase (PostgreSQL) + JPA
- **Bç«¯**: React 19 + Ant Design 6 + @dnd-kit/sortableï¼ˆæ‹–æ‹½æ’åºï¼‰
- **Cç«¯**: Taro 4.1.9 å°ç¨‹åºï¼ŒTanStack Queryï¼ˆæ— ç¼“å­˜ï¼Œå®æ—¶è¯·æ±‚ï¼‰
- **æ•°æ®è¿ç§»**: Flyway è„šæœ¬å®ç° enum â†’ table è¿ç§» + 24h ç´§æ€¥å›æ»šç­–ç•¥
- **å¹¶å‘æ§åˆ¶**: JPA @Version ä¹è§‚é”
- **éªŒè¯åŒæ­¥**: Zod schema (å‰ç«¯) + OpenAPI spec (åç«¯ç”ŸæˆéªŒè¯)

## Technical Context

**Language/Version**:
- Bç«¯ï¼ˆç®¡ç†åå°ï¼‰: TypeScript 5.9.3 + React 19.2.0, Java 17 + Spring Boot 3.3.5
- Cç«¯ï¼ˆå°ç¨‹åºï¼‰: TypeScript + Taro 4.1.9 + React 18.3.1

**Primary Dependencies**:
- Bç«¯: Ant Design 6.1.0, @dnd-kit/sortable 9.0.0, Zustand 5.0.9, TanStack Query 5.90.12, React Hook Form 7.68.0, Zod 4.1.13, MSW 2.12.4
- åç«¯: Spring Boot 3.3.5, Spring Data JPA, Supabase PostgreSQL client, Flyway (migration), Caffeine (caching)
- Cç«¯: Taro 4.1.9, TanStack Query 5.90.12, Zustand 4.5.5

**Storage**: Supabase PostgreSQL 14+ as single source of truth

**Testing**:
- Bç«¯: Vitest (unit tests) + Playwright (e2e tests) + Testing Library
- åç«¯: JUnit 5 + Spring Boot Test + TestContainers
- Cç«¯: Taro test framework + å¾®ä¿¡å¼€å‘è€…å·¥å…·

**Target Platform**:
- Bç«¯: Web browser (Chrome, Firefox, Safari, Edge)
- åç«¯: Spring Boot REST API on JVM 17
- Cç«¯: å¾®ä¿¡å°ç¨‹åº + H5

**Project Type**:
- Full-stack feature: Spring Boot backend + React admin interface + Taro mini-program client

**Performance Goals**:
- Bç«¯: <500ms page transitions, drag-drop reorder <200ms feedback
- Cç«¯: <1s mini-program category loading, <1.5s first screen render
- API: P95 response time â‰¤ 1s

**Constraints**:
- å¿…é¡»éµå¾ª Feature Branch Binding (O002 specId alignment)
- å¿…é¡»éµå¾ª Test-Driven Developmentï¼ˆTDDï¼‰
- Bç«¯å¿…é¡»ä½¿ç”¨ React + Ant Designï¼ŒCç«¯å¿…é¡»ä½¿ç”¨ Taro
- åç«¯å¿…é¡»ä½¿ç”¨ Spring Boot + Supabase
- æ•°æ®è¿ç§»å¿…é¡»ä¿ç•™ 24h å›æ»šçª—å£æœŸ

**Scale/Scope**:
- é¢„è®¡ 6 ä¸ªåˆ†ç±»åˆå§‹æ•°æ®ï¼Œæ”¯æŒæ‰©å±•åˆ° 50+ åˆ†ç±»
- 1 ä¸ª Bç«¯ç®¡ç†é¡µé¢ï¼ˆåˆ—è¡¨+è¡¨å•ï¼‰
- 1 ä¸ª Cç«¯åˆ†ç±» API endpoint
- ä¿®æ”¹ 1 ä¸ªå•†å“åˆ—è¡¨ APIï¼ˆå¢åŠ  categoryId å‚æ•°ï¼‰
- 1 ä¸ªæ•°æ®è¿ç§»è„šæœ¬ + 1 ä¸ªå›æ»šè„šæœ¬

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### å¿…é¡»æ»¡è¶³çš„å®ªæ³•åŸåˆ™æ£€æŸ¥ï¼š

- [x] **åŠŸèƒ½åˆ†æ”¯ç»‘å®š**: âœ… å½“å‰åˆ†æ”¯ `O002-miniapp-menu-config`ï¼Œactive_spec æŒ‡å‘ `specs/O002-miniapp-menu-config/spec.md`
- [x] **æµ‹è¯•é©±åŠ¨å¼€å‘**: âœ… Spec æ˜ç¡®è¦æ±‚ TDDï¼Œå…³é”®ä¸šåŠ¡é€»è¾‘ï¼ˆåˆ†ç±»åˆ é™¤ã€è¿ç§»ï¼‰éœ€ 100% æµ‹è¯•è¦†ç›–ç‡
- [x] **ç»„ä»¶åŒ–æ¶æ„**: âœ… Bç«¯ä½¿ç”¨ Ant Design Table + ç‹¬ç«‹è¡¨å•é¡µï¼Œç¬¦åˆåŸå­è®¾è®¡ç†å¿µ
- [x] **å‰ç«¯æŠ€æœ¯æ ˆåˆ†å±‚**: âœ… Bç«¯ä½¿ç”¨ React 19 + Ant Design 6ï¼ŒCç«¯ä½¿ç”¨ Taro 4.1.9ï¼ŒæŠ€æœ¯æ ˆåˆ†ç¦»æ¸…æ™°
- [x] **æ•°æ®é©±åŠ¨çŠ¶æ€ç®¡ç†**: âœ… Zustand (å®¢æˆ·ç«¯çŠ¶æ€) + TanStack Query (æœåŠ¡å™¨çŠ¶æ€ï¼ŒCç«¯æ— ç¼“å­˜é…ç½®)
- [x] **ä»£ç è´¨é‡å·¥ç¨‹åŒ–**: âœ… TypeScript strict mode, Zod éªŒè¯, ESLint + Prettier, @spec O002 å½’å±æ ‡è¯†
- [x] **åç«¯æŠ€æœ¯æ ˆçº¦æŸ**: âœ… Spring Boot 3.3.5 + Supabase PostgreSQLï¼ŒJPA ä½œä¸ºæ•°æ®è®¿é—®å±‚

### æ€§èƒ½ä¸æ ‡å‡†æ£€æŸ¥ï¼š
- [x] **æ€§èƒ½æ ‡å‡†**: âœ… API P95 â‰¤ 1s, Bç«¯æ‹–æ‹½æ’åº <200ms åé¦ˆ, Cç«¯åˆ†ç±»åŠ è½½ <1s
- [x] **å®‰å…¨æ ‡å‡†**: âœ… Zod å‰ç«¯éªŒè¯ + OpenAPI åç«¯éªŒè¯åŒæ­¥ï¼Œé˜²æ­¢ XSS å’Œæ³¨å…¥æ”»å‡»
- [x] **å¯è®¿é—®æ€§æ ‡å‡†**: âœ… Ant Design ç»„ä»¶è‡ªå¸¦ WCAG 2.1 AA æ”¯æŒï¼Œé”®ç›˜å¯¼èˆªå’Œå±å¹•é˜…è¯»å™¨å…¼å®¹

**è¯„ä¼°ç»“æœ**: âœ… é€šè¿‡æ‰€æœ‰å®ªæ³•åŸåˆ™æ£€æŸ¥ï¼Œæ— è¿è§„é¡¹

## Project Structure

### Documentation (this feature)

```text
specs/O002-miniapp-menu-config/
â”œâ”€â”€ spec.md              # Feature specification (completed)
â”œâ”€â”€ plan.md              # This file (/speckit.plan command output)
â”œâ”€â”€ research.md          # Phase 0 output (to be generated)
â”œâ”€â”€ data-model.md        # Phase 1 output (to be generated)
â”œâ”€â”€ quickstart.md        # Phase 1 output (to be generated)
â”œâ”€â”€ contracts/           # Phase 1 output (to be generated)
â”‚   â””â”€â”€ api.yaml        # OpenAPI 3.0 specification
â””â”€â”€ tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
backend/src/main/java/com/cinema/
â”œâ”€â”€ category/
â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â”œâ”€â”€ MenuCategoryController.java          # Admin API
â”‚   â”‚   â””â”€â”€ ClientMenuCategoryController.java    # Client API
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ MenuCategoryService.java
â”‚   â”‚   â””â”€â”€ CategoryAuditService.java            # Audit logging
â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”œâ”€â”€ MenuCategoryRepository.java
â”‚   â”‚   â””â”€â”€ CategoryAuditLogRepository.java
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”œâ”€â”€ MenuCategory.java                    # @Version for optimistic locking
â”‚   â”‚   â””â”€â”€ CategoryAuditLog.java
â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”œâ”€â”€ MenuCategoryDTO.java
â”‚   â”‚   â”œâ”€â”€ CategoryCreateRequest.java
â”‚   â”‚   â”œâ”€â”€ CategoryUpdateRequest.java
â”‚   â”‚   â””â”€â”€ BatchSortRequest.java
â”‚   â””â”€â”€ exception/
â”‚       â”œâ”€â”€ CategoryNotFoundException.java
â”‚       â””â”€â”€ DefaultCategoryException.java
â”œâ”€â”€ product/
â”‚   â””â”€â”€ entity/
â”‚       â””â”€â”€ ChannelProductConfig.java            # Modified: category_id FK
â””â”€â”€ migration/
    â”œâ”€â”€ V001__create_menu_category_table.sql
    â”œâ”€â”€ V002__migrate_channel_category_data.sql
    â””â”€â”€ R001__rollback_to_enum.sql               # Emergency rollback

backend/src/main/resources/
â””â”€â”€ application.yml                               # Supabase connection config

frontend/src/
â”œâ”€â”€ features/
â”‚   â””â”€â”€ channel-products/
â”‚       â””â”€â”€ menu-categories/
â”‚           â”œâ”€â”€ components/
â”‚           â”‚   â”œâ”€â”€ CategoryList.tsx             # @dnd-kit/sortable table
â”‚           â”‚   â”œâ”€â”€ CategoryForm.tsx             # Create/Edit form
â”‚           â”‚   â””â”€â”€ DeleteConfirmModal.tsx
â”‚           â”œâ”€â”€ hooks/
â”‚           â”‚   â”œâ”€â”€ useCategories.ts             # TanStack Query
â”‚           â”‚   â”œâ”€â”€ useCreateCategory.ts
â”‚           â”‚   â”œâ”€â”€ useUpdateCategory.ts
â”‚           â”‚   â””â”€â”€ useDeleteCategory.ts
â”‚           â”œâ”€â”€ services/
â”‚           â”‚   â””â”€â”€ categoryService.ts           # API calls
â”‚           â”œâ”€â”€ types/
â”‚           â”‚   â””â”€â”€ category.types.ts            # Zod schemas
â”‚           â””â”€â”€ pages/
â”‚               â”œâ”€â”€ MenuCategoryListPage.tsx
â”‚               â””â”€â”€ MenuCategoryFormPage.tsx
â””â”€â”€ schemas/
    â””â”€â”€ category.schema.ts                        # Zod validation (sync with OpenAPI)

hall-reserve-taro/src/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ category.ts                              # TanStack Query (no cache)
â””â”€â”€ types/
    â””â”€â”€ category.ts                              # Category DTO types

specs/O002-miniapp-menu-config/contracts/
â””â”€â”€ api.yaml                                      # OpenAPI 3.0 (validation source)
```

**Structure Decision**: Full-stack feature with clear separation:
- Backend: Spring Boot layered architecture (Controller â†’ Service â†’ Repository â†’ Entity)
- Bç«¯: React feature module with Ant Design components + @dnd-kit for drag-drop
- Cç«¯: Taro service layer with TanStack Query (caching disabled)
- Contracts: OpenAPI spec as single source of truth for validation

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**è¯„ä¼°ç»“æœ**: æ— è¿è§„é¡¹ï¼Œæ— éœ€å¡«å†™æ­¤è¡¨ã€‚

---

## Phase 0: Research & Technical Decisions

**Status**: âœ… Completed via clarification session

æ‰€æœ‰æŠ€æœ¯å†³ç­–å·²åœ¨ `spec.md` çš„ **Clarifications** éƒ¨åˆ†æ˜ç¡®ï¼Œæ— éœ€é¢å¤– research.md æ–‡æ¡£ã€‚

### å·²æ˜ç¡®çš„å†³ç­– (Session 2026-01-04)

1. **è¡¨æ ¼äº¤äº’æ¨¡å¼**: æ ‡å‡† Ant Design è¡¨æ ¼ + ç‹¬ç«‹è¡¨å•é¡µ
2. **æ‹–æ‹½æ’åºä¿å­˜æ—¶æœº**: æ‹–æ‹½ç»“æŸç«‹å³ä¿å­˜ï¼ˆè°ƒç”¨æ‰¹é‡æ’åº APIï¼‰
3. **å¯è§æ€§åˆ‡æ¢**: è¡¨æ ¼å†…åµŒ Switch å¼€å…³ï¼ˆç‚¹å‡»ç«‹å³åˆ‡æ¢å¹¶ä¿å­˜ï¼‰
4. **æ‹–æ‹½åº“é€‰æ‹©**: @dnd-kit/sortableï¼ˆç°ä»£åŒ–ã€æ€§èƒ½å¥½ã€ç»´æŠ¤æ´»è·ƒï¼‰
5. **èœå•æ ‡ç­¾æ ¼å¼**: O002-èœå•åˆ†ç±»ï¼ˆæ˜¾ç¤º spec ID å‰ç¼€ï¼‰
6. **å¹¶å‘æ§åˆ¶ç­–ç•¥**: ä¹è§‚é”ï¼ˆJPA @Version å­—æ®µæ£€æµ‹å†²çªï¼‰
7. **ç¼“å­˜ç­–ç•¥**: æ— ç¼“å­˜ï¼ˆå°ç¨‹åºæ¯æ¬¡å®æ—¶è¯·æ±‚ APIï¼‰
8. **å®¡è®¡æ—¥å¿—ç­–ç•¥**: ä»…è®°å½•å…³é”®æ“ä½œï¼ˆDELETE, BATCH_SORTï¼‰
9. **è¡¨å•éªŒè¯ç­–ç•¥**: Zod + OpenAPI ç”Ÿæˆï¼ˆå‰åç«¯éªŒè¯åŒæ­¥ï¼‰
10. **è¿ç§»å›æ»šç­–ç•¥**: 24h å†…ç´§æ€¥å›æ»š + åœæœºéªŒè¯

**Research Output**: æ‰€æœ‰ NEEDS CLARIFICATION é¡¹å·²è§£å†³ï¼Œç›´æ¥è¿›å…¥ Phase 1ã€‚

---

## Phase 1: Design & Contracts

**Status**: ğŸš§ In Progress

### 1.1 Data Model (data-model.md)

å°†åœ¨ä¸‹ä¸€æ­¥ç”Ÿæˆå®Œæ•´çš„æ•°æ®æ¨¡å‹æ–‡æ¡£ï¼ŒåŒ…æ‹¬ï¼š
- MenuCategory å®ä½“ï¼ˆå« @Version å­—æ®µï¼‰
- CategoryAuditLog å®ä½“ï¼ˆä»…è®°å½• DELETE, BATCH_SORTï¼‰
- ChannelProductConfig ä¿®æ”¹ï¼ˆcategory_id FKï¼‰
- Flyway è¿ç§»è„šæœ¬ç»“æ„
- å›æ»šè„šæœ¬è®¾è®¡

### 1.2 API Contracts (contracts/api.yaml)

å°†åœ¨ä¸‹ä¸€æ­¥ç”Ÿæˆ OpenAPI 3.0 è§„èŒƒï¼ŒåŒ…æ‹¬ï¼š
- Admin API: CRUD + batch sort + visibility toggle
- Client API: GET /api/client/menu-categories
- Product API: æ‰©å±• categoryId å‚æ•°æ”¯æŒ
- Zod schema æ˜ å°„ï¼ˆå‰åç«¯éªŒè¯å¯¹é½ï¼‰

### 1.3 Quickstart (quickstart.md)

å°†åœ¨ä¸‹ä¸€æ­¥ç”Ÿæˆå¼€å‘å¿«é€Ÿå…¥é—¨æ–‡æ¡£ï¼ŒåŒ…æ‹¬ï¼š
- ç¯å¢ƒå‡†å¤‡ï¼ˆSupabase, Spring Boot, React dev serverï¼‰
- è¿è¡Œè¿ç§»è„šæœ¬
- å¯åŠ¨å¼€å‘æœåŠ¡å™¨
- å¸¸è§é—®é¢˜æ’æŸ¥

---

## Next Steps

1. âœ… Generate `research.md` (skipped - all decisions clarified in spec)
2. ğŸš§ Generate `data-model.md`
3. ğŸš§ Generate `contracts/api.yaml`
4. ğŸš§ Generate `quickstart.md`
5. ğŸš§ Update agent context (`.specify/context/CLAUDE.md`)
6. ğŸš§ Re-evaluate Constitution Check

**Command ends after Phase 1 completion**. Use `/speckit.tasks` to generate task breakdown.
