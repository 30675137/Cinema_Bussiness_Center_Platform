# Feature Specification: BOM配方库存预占与扣料

**Feature Branch**: `P005-bom-inventory-deduction`
**Created**: 2025-12-29
**Status**: Draft
**Input**: User description: "了解 spec P001 (SKU主数据)
  ↓
P003 (库存查询)
  ↓
P004 (库存调整)
  ↓
┌──────────┬──────────┐
│          │          │
O003       U001       003
(BOM扣料)  (场次库存) (综合管理)
实现:
阶段一:交易下单(预占阶段)
当顾客在POS或小程序下单\"威士忌可乐\"时:
1. 查询可用性:系统根据BOM反算原料(威士忌、可乐)的可用库存是否足够。
2. 锁定库存:并不直接扣减物理库存,而是增加原料的预占库存。
    ◦ 目的:防止超卖,同时保持高并发下的性能。
阶段二:出品/履约(实扣阶段)
当吧台点击\"出品确认\"或发货完成时:
1. BOM 展开:系统读取BOM配方,计算实际消耗。
    ◦ 例子:1杯酒 = 扣减45ml威士忌 + 150ml可乐 + 1个杯子。
2. 事务处理:
    ◦ 减少原料的现存库存。
    ◦ 释放原料的预占库存。
    ◦ 生成库存变动流水(Inventory Transaction Log),用于审计。"

<!--
  规格编号格式说明 (Spec ID Format):
  P005 - P=商品/库存模块, 005=模块内递增编号
-->

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 下单时库存预占 (Priority: P1)

当顾客在POS或小程序下单成品SKU(如"威士忌可乐鸡尾酒")时,系统根据BOM配方反算所需原料和包材,检查可用库存是否充足,并锁定(预占)这些库存,以便防止超卖和保障订单履约。

**Why this priority**: 这是BOM扣料功能的核心入口。没有预占机制,高并发场景下会出现超卖问题,导致订单无法履约和顾客投诉。这是保障订单可履约性的第一道防线。

**Independent Test**: 可以通过"为成品SKU下单,验证系统检查BOM组件库存并增加预占数量"独立测试。即使不实际出品,预占功能本身可完整验证,交付后立即阻止超卖。

**Acceptance Scenarios**:

1. **Given** 顾客在POS下单1杯"威士忌可乐鸡尾酒",该SKU的BOM包含45ml威士忌+150ml可乐+1个杯子+1根吸管, **When** 提交订单, **Then** 系统检查威士忌现存库存≥45ml且可用库存(现存-预占)≥45ml,同理检查可乐、杯子、吸管,全部满足则订单创建成功

2. **Given** 威士忌当前现存库存100ml、预占库存0ml、可用库存100ml, **When** 下单1杯威士忌可乐(需45ml威士忌), **Then** 威士忌预占库存增加到45ml,可用库存降为55ml,现存库存保持100ml不变

3. **Given** 可乐当前可用库存仅100ml,下单需求150ml, **When** 提交订单, **Then** 系统拒绝订单并提示"可乐库存不足,当前可用100ml,需求150ml",不创建订单

4. **Given** 顾客下单包含2杯威士忌可乐, **When** 提交订单, **Then** 系统按BOM展开计算总需求(威士忌90ml、可乐300ml、杯子2个、吸管2根),检查所有组件库存,全部满足则锁定对应数量

5. **Given** 下单时威士忌可用库存40ml,需求45ml, **When** 提交订单, **Then** 订单创建失败,提示具体缺货SKU及缺口数量,现有库存预占不变

6. **Given** 多个顾客同时下单同一成品(高并发场景), **When** 系统处理订单, **Then** 按先后顺序锁定库存,后到达的订单若库存不足则失败,保证不超卖

---

### User Story 2 - 出品时实际扣减库存 (Priority: P1)

当吧台或厨房确认出品完成时,系统根据BOM配方实际扣减原料和包材的现存库存,同时释放预占库存,并生成库存变动流水记录,用于审计和追溯。

**Why this priority**: 这是库存管理的最终落地环节。预占只是锁定,实扣才真正反映物理消耗。没有实扣,库存账面永远与实际不符,无法支撑盘点和成本核算。与P1预占并列为MVP核心。

**Independent Test**: 可以通过"为已预占的订单点击出品确认,验证系统扣减现存库存、释放预占、生成流水"独立测试。即使没有后续报表功能,库存数据正确性立即可验证。

**Acceptance Scenarios**:

1. **Given** 订单预占了45ml威士忌(现存100ml、预占45ml、可用55ml), **When** 吧台点击"出品确认", **Then** 威士忌现存库存减少到55ml,预占库存减少到0ml,可用库存保持55ml不变

2. **Given** 订单包含BOM组件:威士忌45ml、可乐150ml、杯子1个、吸管1根, **When** 确认出品, **Then** 系统一次性扣减所有组件的现存库存,原子性保证全部成功或全部失败

3. **Given** 出品确认操作成功, **When** 查看库存变动流水, **Then** 生成4条流水记录(威士忌-45ml、可乐-150ml、杯子-1个、吸管-1根),每条记录包含变动类型"BOM扣料"、关联订单号、操作人、操作时间、变动前后库存

4. **Given** 订单已预占库存但尚未出品, **When** 顾客取消订单, **Then** 系统释放预占库存(预占-45ml,可用+45ml),不扣减现存库存,生成流水记录标注"订单取消释放预占"

5. **Given** 出品时发现原料实际消耗量与BOM不符(如实际用了50ml威士忌而非45ml), **When** 操作员手动调整扣减数量, **Then** 系统按实际数量扣减现存库存并记录调整原因到流水备注

6. **Given** 系统执行BOM扣料时检测到某组件现存库存不足(如杯子预占了但被其他操作误调整), **When** 出品确认, **Then** 事务回滚,订单状态保持"待出品",提示管理员处理库存异常

---

### User Story 3 - 查看BOM扣料流水记录 (Priority: P2)

作为库存管理员或店长,我希望能够查看BOM扣料产生的库存变动流水,以便追溯成品销售对原料消耗的影响,支持成本核算和差异分析。

**Why this priority**: 流水查询是追溯和审计的基础能力,依赖P1的预占和实扣功能产生数据。虽然重要,但对于保障交易本身不是必需,可以在MVP之后补充。

**Independent Test**: 可以通过"进入库存流水页面筛选变动类型为'BOM扣料',查看关联订单和组件明细"独立测试。

**Acceptance Scenarios**:

1. **Given** 库存管理员进入库存流水页面, **When** 筛选变动类型为"BOM扣料", **Then** 显示所有因出品成品而产生的原料/包材扣减记录,包含SKU名称、扣减数量、关联订单号、出品时间、操作人

2. **Given** 流水列表显示威士忌的一条BOM扣料记录, **When** 点击查看详情, **Then** 展开显示该订单完整BOM组件列表(威士忌45ml、可乐150ml、杯子1个、吸管1根)及每个组件的扣减记录

3. **Given** 店长需要分析某日威士忌消耗量, **When** 选择日期范围并筛选SKU为"威士忌"、变动类型为"BOM扣料", **Then** 汇总显示该时段威士忌总消耗量,支持与销售数量交叉验证

4. **Given** 库存管理员发现某笔扣料记录数量异常, **When** 查看流水详情, **Then** 可以看到操作人、操作时间、订单号,并支持跳转到订单详情进行核查

---

### User Story 4 - 套餐BOM层级展开扣料 (Priority: P2)

当顾客下单套餐SKU(如"观影小吃套餐"=爆米花+可乐)时,系统将套餐展开为子项成品,再将每个成品按BOM展开为原料和包材,实现多层级库存预占和扣减。

**Why this priority**: 套餐是增值销售场景,依赖成品BOM扣料功能已实现。虽然能提升营收,但对基本BOM扣料流程不是必需,可以在单品扣料稳定后实现。

**Independent Test**: 可以通过"为包含多个成品的套餐下单,验证系统递归展开BOM并正确预占所有底层原料"独立测试。

**Acceptance Scenarios**:

1. **Given** 顾客下单"观影小吃套餐"(包含成品:大份爆米花+中杯可乐), **When** 提交订单, **Then** 系统先展开套餐为2个成品,再分别按各自BOM展开(爆米花需玉米100g+黄油10g+盐1g+纸桶1个,可乐需可乐糖浆50ml+气泡水200ml+杯子1个),汇总所有原料后检查库存并预占

2. **Given** 套餐订单已预占所有底层原料库存, **When** 吧台确认套餐出品, **Then** 系统按汇总后的原料清单一次性扣减(玉米-100g、黄油-10g、盐-1g、纸桶-1个、可乐糖浆-50ml、气泡水-200ml、杯子-1个),生成流水记录关联套餐订单

3. **Given** 套餐包含的某个成品BOM原料库存不足, **When** 下单套餐, **Then** 订单创建失败,提示具体哪个成品的哪个原料不足及缺口数量(如"可乐成品所需可乐糖浆不足,当前可用30ml,需求50ml")

---

### User Story 5 - BOM损耗率自动计算 (Priority: P3)

在BOM配方中配置损耗率(如5%),下单时系统自动按(标准用量 × (1 + 损耗率))计算实际预占和扣减数量,以便反映真实的原料消耗情况。

**Why this priority**: 损耗率提升成本核算准确性,但对保障交易流程不是必需。可以在初期使用标准用量,待业务稳定后根据实际损耗数据配置损耗率。

**Independent Test**: 可以通过"为配置了5%损耗率的BOM下单,验证系统按1.05倍标准用量预占库存"独立测试。

**Acceptance Scenarios**:

1. **Given** 威士忌可乐的BOM配置威士忌标准用量45ml、损耗率5%, **When** 下单1杯, **Then** 系统预占威士忌库存47.25ml(45 × 1.05),出品时扣减47.25ml现存库存

2. **Given** 某原料BOM未配置损耗率(默认0%), **When** 下单, **Then** 系统按标准用量预占和扣减,不额外增加

3. **Given** 套餐包含多个成品,每个成品BOM配置了不同损耗率, **When** 下单套餐, **Then** 系统分别计算每个成品组件的损耗后汇总预占

---

### Edge Cases

- **并发扣减冲突**: 当多笔订单同时出品且竞争相同原料库存时,系统如何保证库存扣减的原子性和数据一致性?需使用数据库行锁或乐观锁机制。

- **预占超时释放**: 如果订单长时间停留在"待出品"状态(如顾客下单后未取餐),预占库存如何处理?是否需要超时自动释放机制(如30分钟后释放)?

- **部分取消场景**: 如果顾客下单2杯威士忌可乐但取消1杯,系统如何部分释放预占库存(释放1杯的BOM组件预占,保留另1杯)?

- **BOM配方变更影响**: 如果订单预占后、出品前,BOM配方被修改(如威士忌用量从45ml改为50ml),出品时应该按哪个版本扣减?需锁定订单时的BOM版本。

- **原料库存负数**: 如果因系统异常或人工误操作导致扣减时现存库存不足,是否允许库存为负?还是强制阻止扣减并触发告警?

- **跨门店调拨影响**: 如果订单预占了门店A的库存,但出品前原料被调拨到门店B,出品时如何处理?需阻止预占库存的跨店调拨。

- **损耗率小数精度**: 当损耗率计算导致数量为小数(如45ml × 1.05 = 47.25ml)时,系统如何处理小数精度?是向上取整、四舍五入还是保留小数?

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在成品订单创建时,根据BOM配方反算所需原料和包材,检查每个组件的可用库存(现存库存-预占库存)是否满足需求数量

- **FR-002**: 系统必须在库存检查通过后,原子性地增加所有BOM组件的预占库存数量,若任一组件操作失败则回滚全部预占操作

- **FR-003**: 系统必须在库存不足时拒绝订单创建,并明确提示哪些原料/包材不足、当前可用数量、需求数量及缺口数量

- **FR-004**: 系统必须支持高并发场景下的库存预占,使用数据库行级锁或乐观锁机制防止超卖,保证同一时刻多笔订单竞争相同原料时按先后顺序锁定

- **FR-005**: 系统必须在出品确认时,根据BOM配方原子性地扣减所有组件的现存库存、释放对应预占库存,保证事务一致性(全部成功或全部失败)

- **FR-006**: 系统必须在出品扣减库存时,验证现存库存是否充足,若不足则回滚事务并保持订单状态为"待出品",触发库存异常告警

- **FR-007**: 系统必须为每次BOM扣料操作生成库存变动流水记录,包含SKU、变动类型(BOM扣料)、数量、变动前后库存、关联订单号、操作人、操作时间

- **FR-008**: 系统必须支持订单取消时释放预占库存,将预占数量归零、可用库存增加,并生成流水记录标注"订单取消释放预占"

- **FR-009**: 系统必须支持套餐SKU的多层级BOM展开,先将套餐展开为成品子项,再将每个成品按BOM展开为原料/包材,汇总所有底层原料后执行预占和扣减

- **FR-010**: 系统必须支持在BOM配方中配置损耗率,预占和扣减时按(标准用量 × (1 + 损耗率))计算实际数量,默认损耗率为0%

- **FR-011**: 系统必须锁定订单创建时的BOM配方版本,出品时按锁定版本扣减库存,避免配方变更影响已下单订单

- **FR-012**: 系统必须允许操作员在出品时手动调整实际扣减数量(如因损耗实际多用了原料),调整后按实际数量扣减并在流水备注中记录调整原因

- **FR-013**: 系统必须在库存流水页面支持按变动类型"BOM扣料"筛选,显示所有成品销售产生的原料消耗记录,支持按SKU、日期范围、订单号筛选

- **FR-014**: 系统必须在流水详情中展示完整BOM组件明细,包含每个原料/包材的名称、规格、扣减数量、单位,支持跳转到关联订单

### Key Entities

- **库存预占记录**: 记录某笔订单对某SKU库存的预占数量,关联订单号、SKU ID、预占数量、预占时间、释放状态

- **库存变动流水**: 记录所有库存变动的审计日志,包含流水ID、SKU ID、变动类型(BOM扣料/订单取消释放/库存调整等)、变动数量、变动前库存、变动后库存、关联订单号、操作人、操作时间、备注

- **BOM配方版本快照**: 订单创建时锁定的BOM配方副本,包含配方ID、订单ID、组件列表(SKU ID、标准用量、损耗率、单位)、快照时间

- **库存账户**: 扩展现有库存表,增加预占库存字段,计算逻辑为可用库存=现存库存-预占库存,关联门店ID、SKU ID

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 顾客下单成品时,系统在500毫秒内完成BOM展开、库存检查、预占锁定全流程,支持高峰期每秒100笔并发订单无超卖

- **SC-002**: 吧台确认出品时,系统在1秒内完成所有BOM组件的库存扣减、流水生成,出品操作成功率≥99.9%(排除库存不足等业务异常)

- **SC-003**: 库存管理员查询BOM扣料流水时,列表在2秒内加载完成,支持按时间范围、SKU、订单号筛选,单次查询结果≤10000条时响应时间<3秒

- **SC-004**: 并发场景下(10个顾客同时下单同一成品),系统保证库存预占的原子性,0笔超卖订单,后到达的订单在库存不足时立即失败并提示准确缺口

- **SC-005**: 订单取消时,系统在2秒内释放预占库存并更新可用库存,释放成功率100%(无遗留锁定库存)

- **SC-006**: 套餐订单BOM展开层级≤3层(套餐→成品→原料),展开计算时间<1秒,支持套餐包含≤10个成品子项

- **SC-007**: BOM扣料产生的库存流水记录完整性100%(每笔出品操作都生成对应流水),流水数据保留≥1年支持审计追溯

- **SC-008**: 库存账面数据(现存、预占、可用)的一致性≥99.99%,每日自动校验机制检测并告警不一致记录

## Dependencies

- **P001-sku-master-data**: 依赖SKU主数据中的BOM配方定义(成品关联的原料/包材组件、标准用量、损耗率)

- **P003-inventory-query**: 依赖库存查询功能提供的实时库存数据(现存库存、预占库存、可用库存)

- **P004-inventory-adjustment**: 依赖库存调整功能的流水记录表结构,BOM扣料流水复用相同数据模型

- **O003-beverage-order**: 饮品订单模块需调用BOM预占接口完成下单,调用实扣接口完成出品

- **U001-reservation-order-management**: 场次预订订单(包含商品加购)需调用BOM预占和实扣接口

## Assumptions

- BOM配方在订单创建前已正确配置,包含所有必需组件及标准用量

- 门店库存数据实时同步,不存在跨系统延迟导致的库存不准

- 预占库存默认无超时自动释放机制,需人工取消订单才释放(超时释放作为后续优化)

- 损耗率小数计算采用四舍五入到小数点后2位(如47.256ml → 47.26ml)

- 同一订单内的BOM组件扣减作为单一数据库事务处理,保证原子性

- 库存允许为负数的配置默认为"否",扣减不足时强制失败(可在SKU主数据中配置)

- 跨门店调拨时检查目标原料是否有预占,有预占则阻止调拨(由调拨功能模块实现)
