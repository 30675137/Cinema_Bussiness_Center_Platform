# Feature Specification: SKU编辑页面数据加载修复

**Feature Branch**: `P001-fix-sku-edit-data`
**Created**: 2025-12-31
**Status**: Draft
**Input**: User description: "Bugfix 编码：FIN-COCKTAIL的威士忌可乐鸡尾酒在SKU管理编辑没有带出SPU的数据同时BOM的配方也没有带出来"

## Clarifications

### Session 2025-12-31

- Q: E2E测试数据准备策略 - 如何为SKU/SPU/BOM测试用例准备测试数据？ → A: 通过API在测试开始前动态创建测试数据，测试结束后清理
- Q: 并发编辑冲突解决策略 - 多个用户同时编辑同一SKU时检测到冲突如何处理？ → A: 最后保存者胜出,显示覆盖警告（"数据已被其他用户修改,您确认要覆盖吗?"）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看完整的SKU信息 (Priority: P1)

运营人员在编辑已上架的成品SKU（如"威士忌可乐鸡尾酒"）时，需要查看该SKU关联的SPU（标准产品单元）基础信息，包括产品名称、分类、品牌等，以便了解产品的完整背景信息和确保编辑的一致性。

**Why this priority**: 这是核心功能缺陷，直接影响运营人员对产品信息的完整理解。缺少SPU数据会导致编辑时信息不全，可能造成数据不一致或错误修改。

**Independent Test**: 可以通过打开任意已关联SPU的SKU编辑页面，验证SPU信息是否正确显示（如产品名称、分类、品牌），即可独立测试此功能。

**Acceptance Scenarios**:

1. **Given** 存在编码为"FIN-COCKTAIL"的SKU，该SKU已关联到某个SPU，**When** 运营人员点击"编辑"按钮进入SKU编辑页面，**Then** 页面应显示该SKU关联的SPU完整信息（产品名称、分类、品牌、描述等）
2. **Given** SKU编辑页面已加载SPU数据，**When** 运营人员查看页面，**Then** SPU字段应为只读状态，不可编辑（因为SPU是主数据）
3. **Given** 某个SKU未关联任何SPU（历史数据或测试数据），**When** 打开编辑页面，**Then** SPU信息区域应显示"未关联SPU"提示

---

### User Story 2 - 查看完整的BOM配方数据 (Priority: P1)

运营人员在编辑成品SKU时，需要查看该SKU的BOM配方详细信息（原料清单、用量、单位），以便核对配方是否正确、是否需要调整配方或了解成本构成。

**Why this priority**: BOM配方是成品SKU的核心数据，缺少配方信息会导致运营人员无法核对配方准确性，可能影响成本核算、库存预占和实际生产流程。

**Independent Test**: 可以通过打开任意配置了BOM的成品SKU编辑页面，验证BOM配方列表是否正确显示（包含原料名称、数量、单位），即可独立测试此功能。

**Acceptance Scenarios**:

1. **Given** "威士忌可乐鸡尾酒"SKU已配置BOM配方（包含4种原料：威士忌45ml、可乐150ml、玻璃杯1个、吸管1根），**When** 运营人员打开SKU编辑页面，**Then** 页面应显示完整的BOM配方列表，包含每个原料的名称、数量、单位
2. **Given** BOM配方列表已加载，**When** 运营人员查看配方，**Then** 应显示每个原料的完整信息（SKU编码、原料名称、用量、单位、标准成本）
3. **Given** 某个成品SKU未配置BOM配方，**When** 打开编辑页面，**Then** BOM配方区域应显示"未配置配方"或提供"添加配方"入口
4. **Given** BOM配方包含损耗率设置，**When** 加载配方数据，**Then** 损耗率应正确显示（如5%）

---

### User Story 3 - 编辑SKU时保持数据完整性 (Priority: P2)

运营人员在修改SKU信息（如价格、库存、状态）时，需要确保关联的SPU和BOM数据保持一致，避免因数据加载问题导致关联关系丢失或数据错误。

**Why this priority**: 这是数据一致性保障，确保编辑操作不会因数据加载问题破坏现有关联关系，避免数据丢失或不一致。

**Independent Test**: 可以通过编辑SKU的非关键字段（如价格），提交后检查SPU关联和BOM配方是否保持不变，即可独立测试此功能。

**Acceptance Scenarios**:

1. **Given** SKU编辑页面已加载SPU和BOM数据，**When** 运营人员修改SKU价格并保存，**Then** SPU关联关系应保持不变，BOM配方数据应保持不变
2. **Given** 编辑页面加载失败（网络错误或后端异常），**When** 页面显示错误提示，**Then** 应明确提示"数据加载失败，请刷新重试"，而不是显示空白或不完整数据
3. **Given** SKU数据加载完成但SPU数据加载失败，**When** 页面显示，**Then** 应明确标注"SPU信息加载失败"，并允许运营人员继续查看SKU基本信息

---

### Edge Cases

- 当SKU已关联SPU，但SPU数据在数据库中已被删除（脏数据），如何处理？系统应显示"SPU已失效"提示，而不是报错或显示空白。
- 当BOM配方引用的原料SKU已被删除或禁用，如何显示？系统应标注"原料已失效"，但保留原配方记录供查看。
- 当用户网络不稳定导致部分数据加载成功（如SKU加载成功但BOM加载失败），如何处理？系统应分区域显示加载状态，允许已加载部分正常显示，失败部分显示重试按钮。
- 当SKU编辑页面被并发访问（多个用户同时编辑同一SKU），数据加载是否保证一致性？系统应加载最新版本数据，并在保存时检测冲突。冲突检测到后，系统应显示覆盖警告弹窗："数据已被其他用户修改，您确认要覆盖吗？"，允许用户选择覆盖或取消。
- 当BOM配方包含大量原料（如超过20种），页面性能是否受影响？系统应支持分页或虚拟滚动，保证加载速度。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: SKU编辑页面打开时，系统MUST加载该SKU关联的SPU完整信息（产品名称、分类、品牌、描述、状态等）
- **FR-002**: SKU编辑页面打开时，系统MUST加载该SKU的BOM配方完整列表（包含每个原料的SKU编码、名称、数量、单位、成本）
- **FR-003**: 加载的SPU数据MUST在页面上以只读形式显示，禁止在SKU编辑页面修改SPU信息
- **FR-004**: 加载的BOM配方数据MUST包含损耗率信息（如果已配置）
- **FR-005**: 系统MUST处理数据加载失败场景，当SPU或BOM数据加载失败时，应显示明确的错误提示（如"SPU信息加载失败，请刷新重试"）
- **FR-006**: 系统MUST支持部分数据加载成功的场景，当SKU基本信息加载成功但关联数据加载失败时，应允许查看已加载部分，并提供重试按钮
- **FR-007**: 系统MUST在修改SKU并保存时，确保SPU关联关系和BOM配方数据不因编辑操作而丢失或损坏
- **FR-008**: 系统MUST处理脏数据场景（如引用的SPU或BOM原料已被删除），应标注"已失效"而不是报错或显示空白
- **FR-009**: 用户MUST能够在编辑页面清晰区分SKU基本信息、SPU关联信息和BOM配方信息（通过视觉分组或标签页）
- **FR-010**: 系统MUST在页面加载时显示加载状态指示器（如骨架屏或加载动画），避免用户误以为页面卡死
- **FR-011**: 系统MUST在保存SKU编辑时检测并发冲突（通过版本号或时间戳机制），当检测到数据已被其他用户修改时，MUST显示覆盖警告弹窗："数据已被其他用户修改，您确认要覆盖吗？"，允许用户选择继续保存或取消操作

### Testing Requirements

- **TR-001**: E2E测试MUST通过API动态创建测试数据（包括SKU、SPU、BOM配方及原料），测试结束后MUST清理所创建的数据，确保测试环境的可重复性和隔离性

### Key Entities

- **SKU (Stock Keeping Unit)**: 库存量单位，代表可销售的具体商品规格（如"威士忌可乐鸡尾酒 500ml"），包含SKU编码、名称、价格、库存数量、状态、关联的SPU ID
- **SPU (Standard Product Unit)**: 标准产品单元，代表产品的抽象概念（如"威士忌可乐鸡尾酒"），包含产品名称、分类、品牌、描述，一个SPU可以对应多个SKU
- **BOM (Bill of Materials)**: 物料清单/配方，定义成品SKU由哪些原料SKU组成，包含原料SKU列表、每个原料的用量、单位、损耗率
- **BOM Component**: BOM配方组成项，代表BOM中的一条原料记录，包含原料SKU ID、数量、单位、标准成本

**关系说明**:
- 一个SKU关联一个SPU（多对一关系）
- 一个成品SKU关联一个BOM配方（一对一关系）
- 一个BOM配方包含多个BOM Component（一对多关系）
- 每个BOM Component引用一个原料SKU（多对一关系）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 运营人员打开SKU编辑页面后，SPU信息和BOM配方数据应在2秒内完成加载并显示（P95）
- **SC-002**: 100%的已关联SPU的SKU在编辑页面能正确显示SPU完整信息（产品名称、分类、品牌等）
- **SC-003**: 100%的已配置BOM的SKU在编辑页面能正确显示BOM配方列表（原料名称、数量、单位）
- **SC-004**: 数据加载失败时，95%的用户能通过错误提示明确了解问题（通过用户反馈或日志统计）
- **SC-005**: 修复后，因SKU编辑页面数据不全导致的客服咨询减少90%（对比修复前一周数据）
- **SC-006**: 运营人员编辑SKU并保存后，SPU关联和BOM配方数据保持100%一致性（无数据丢失或损坏）
- **SC-007**: 页面加载性能不因加载SPU和BOM数据而降级，首屏渲染时间保持在1.5秒以内（P95）
