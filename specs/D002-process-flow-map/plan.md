# Implementation Plan: 业务端到端流程地图

**Branch**: `D002-process-flow-map` | **Date**: 2026-01-14 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/D002-process-flow-map/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command based on the clarified specification.

## Summary

在现有的业务全景中台服务地图（泳道架构）基础上，新增业务端到端流程地图视图。两种视图通过标签页式按钮组切换，流程地图按照5个业务阶段（基础建设→供应生产→营销发布→交易履约→经营洞察）展示12个业务模块，模块间用箭头连接形成完整流程链。

**核心目标**：
- 在 Dashboard 页面新增流程视图，与现有泳道视图并存
- 实现标签页式视图切换（"全景视图" | "流程视图"）
- 展示5个业务阶段，每个阶段包含标题和副标题
- 使用箭头连接所有业务模块卡片，形成端到端流程链
- 视图切换时保持用户状态（折叠、滚动位置）

**技术方案**：
- 纯前端实现，复用 D001 的 ModuleCard 组件和数据结构
- 新增 ProcessFlowView 组件，与 SwimlaneView 并列
- 使用 React state 管理视图切换状态
- 使用 CSS/SVG 实现流程箭头连接
- 保持与 D001 一致的视觉风格

## Technical Context

**Language/Version**: TypeScript 5.9.3, React 19.2.0  
**Primary Dependencies**: 
- Ant Design 6.1.0 (UI 组件库)
- React Router 7.10.1 (路由管理)
- Zustand 5.0.9 (状态管理，预留)
- Ant Design Icons (图标库)

**Storage**: N/A (纯前端组件，无后端存储)  
**Testing**: Vitest (单元测试必须), Playwright (E2E测试可选)  
**Target Platform**: Web 浏览器 (Chrome, Firefox, Safari, Edge)  
**Project Type**: Web 前端 (管理后台)  
**Performance Goals**: 
- 视图切换时间 < 2秒
- 流程地图首次渲染 < 1秒
- 动画帧率 60fps
- 页面总大小增量 < 50KB

**Constraints**: 
- 必须复用 D001 ModuleCard 组件和权限过滤逻辑
- 必须保持与 D001 一致的视觉风格（颜色、字体、间距、圆角）
- 不能修改 D001 核心代码，仅通过扩展实现
- 必须兼容桌面端（1920x1080）和移动端（375x667）
- TypeScript 编译无错误

**Scale/Scope**: 
- 5个业务流程阶段
- 12个业务模块（复用 D001 配置）
- 2个视图组件（SwimlaneView + ProcessFlowView）
- 1个视图切换组件（ViewSwitcher）
- 预计 3-4 个新组件 + 1个页面修改

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| 原则 | 状态 | 说明 |
|------|------|------|
| **一、功能分支绑定** | ✅ PASS | 分支 `D002-process-flow-map` 符合命名规范（D=Dashboard模块，002编号），规格文件位于 `specs/D002-process-flow-map/spec.md` |
| **二、代码归属标识** | ✅ PASS | 所有新增组件必须添加 `@spec D002-process-flow-map` 注释 |
| **三、测试驱动开发** | ✅ PASS | 必须编写单元测试，E2E 测试可选 |
| **四、组件化架构** | ✅ PASS | 遵循 React 组件化设计，复用 D001 组件，使用 TypeScript 类型注解 |
| **五、前端技术栈分层** | ✅ PASS | B端管理后台使用 React + Ant Design 技术栈 |
| **六、数据驱动与状态管理** | ✅ PASS | 使用 React state 管理视图切换状态 |
| **七、代码质量与工程化** | ✅ PASS | 使用 TypeScript 5.9.3，遵循 ESLint + Prettier 规范 |
| **八、Claude Code Skills 开发规范** | N/A | 非 skill 开发，不适用 |
| **九、认证与权限要求分层** | ✅ PASS | B端管理后台，复用 D001 权限过滤逻辑 |
| **十、Lark PM 项目管理集成** | N/A | 本项目未启用 Lark PM 集成 |
| **Spring Boot + Supabase** | N/A | 纯前端功能，无后端开发 |
| **C端开发技术栈** | N/A | B端管理后台功能，不涉及C端 |
| **API 响应格式标准化** | N/A | 无 API 开发 |
| **API 异常编号规范** | N/A | 无 API 开发 |
| **API 测试规范** | N/A | 无 API 开发 |
| **业务概念澄清文档要求** | ⚠️ OPTIONAL | 基于 D001 扩展，业务概念已澄清，可选性创建 `business-clarification.md` |

**结论**: 所有适用的宪法原则均通过检查。可以开始 Phase 0 研究。

## Project Structure

### Documentation (this feature)

```text
specs/D002-process-flow-map/
├── spec.md              # Feature specification (already exists)
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (N/A - no API contracts needed)
├── reference-process-view.png  # UI reference screenshot (already exists)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
frontend/
├── src/
│   ├── components/
│   │   ├── common/
│   │   │   ├── ModuleCard.tsx          # 现有: 复用自 D001 (@spec D001-menu-panel)
│   │   │   ├── ViewSwitcher.tsx        # 新增: 标签页式视图切换组件 (@spec D002-process-flow-map)
│   │   │   ├── ViewSwitcher.test.tsx
│   │   │   └── ProcessFlowArrow.tsx    # 新增: 流程箭头组件 (@spec D002-process-flow-map)
│   │   └── dashboard/
│   │       ├── SwimlaneView.tsx        # 新增: 泳道视图组件 (从 Dashboard/index.tsx 拆分) (@spec D002-process-flow-map)
│   │       ├── SwimlaneView.test.tsx
│   │       ├── ProcessFlowView.tsx     # 新增: 流程视图组件 (@spec D002-process-flow-map)
│   │       └── ProcessFlowView.test.tsx
│   ├── pages/
│   │   └── Dashboard/
│   │       └── index.tsx               # 修改: 重构为视图容器，管理视图切换 (@spec D002-process-flow-map)
│   ├── types/
│   │   ├── module.ts                   # 现有: 复用自 D001 (@spec D001-menu-panel)
│   │   └── view.ts                     # 新增: 视图相关类型定义 (@spec D002-process-flow-map)
│   ├── constants/
│   │   ├── modules.ts                  # 现有: 复用自 D001 (@spec D001-menu-panel)
│   │   └── processStages.ts            # 新增: 5个流程阶段配置 (@spec D002-process-flow-map)
│   └── utils/
│       ├── permission.ts               # 现有: 复用自 D001 (@spec D001-menu-panel)
│       └── viewState.ts                # 新增: 视图状态管理工具 (@spec D002-process-flow-map)
└── tests/
    ├── unit/
    │   └── components/
    │       ├── ViewSwitcher.test.tsx
    │       ├── ProcessFlowView.test.tsx
    │       └── SwimlaneView.test.tsx
    └── e2e/                # 可选的 E2E 测试
        └── view-switching.spec.ts
```

**Structure Decision**: 选择 Web 应用结构，纯前端开发。所有代码位于 `frontend/` 目录。

**新增文件**（6个）:
1. `ViewSwitcher.tsx` - 标签页式视图切换组件
2. `ProcessFlowArrow.tsx` - 流程箭头组件
3. `SwimlaneView.tsx` - 泳道视图组件（从 Dashboard 拆分）
4. `ProcessFlowView.tsx` - 流程视图组件
5. `view.ts` - 视图类型定义
6. `processStages.ts` - 流程阶段配置
7. `viewState.ts` - 视图状态管理

**修改文件**（1个）:
- `pages/Dashboard/index.tsx` - 重构为视图容器

**复用文件**（4个）:
- `ModuleCard.tsx` - 模块卡片组件
- `module.ts` - 模块类型定义
- `modules.ts` - 模块配置
- `permission.ts` - 权限过滤工具

---

## Phase 0: Research & Technical Decisions

**Status**: ✅ COMPLETED (2026-01-14)

**Objectives**:
- 解决视图切换实现方案
- 解决流程箭头绘制技术选型
- 解决视图状态保持策略
- 解决响应式布局适配方案
- 评估性能优化策略

### Research Tasks

#### R1: 视图切换实现方案

**Question**: 如何实现两种视图之间的切换，确保性能和用户体验？

**Options to Evaluate**:
- **Option A**: 条件渲染（推荐） - 使用 state 控制当前视图，条件渲染对应组件
- **Option B**: React Router 子路由 - `/dashboard/panorama` 和 `/dashboard/process`
- **Option C**: CSS 显示/隐藏 - 两个视图都渲染，通过 CSS 切换显示

**Evaluation Criteria**:
- 切换性能（目标 < 2秒）
- 状态保持能力
- 代码复杂度
- 与现有路由结构的兼容性

**Expected Output**: 选定方案 + 实现示例代码

---

#### R2: 流程箭头绘制技术

**Question**: 如何实现模块间的流程箭头连接？

**Options to Evaluate**:
- **Option A**: CSS 伪元素 + 三角形 border - 纯 CSS 实现，性能最优
- **Option B**: SVG 连接线 - 使用 SVG path 绘制箭头，灵活度高
- **Option C**: Canvas 绘制 - 动态计算坐标，适合复杂布局
- **Option D**: React Flow / React Diagram - 第三方图形库

**Evaluation Criteria**:
- 实现复杂度
- 性能开销
- 响应式适配难度
- 是否需要额外依赖

**Expected Output**: 选定方案 + 箭头样式 demo

---

#### R3: 视图状态保持策略

**Question**: 如何在视图切换时保持用户状态（折叠状态、滚动位置）？

**Options to Evaluate**:
- **Option A**: React state 存储 - 在父组件 state 中记录状态
- **Option B**: localStorage - 持久化存储用户偏好
- **Option C**: URL query params - 状态反映到 URL
- **Option D**: Zustand store - 全局状态管理

**Evaluation Criteria**:
- 状态恢复准确度
- 实现复杂度
- 是否需要持久化
- 对现有代码的侵入性

**Expected Output**: 选定方案 + 状态结构设计

---

#### R4: 响应式布局适配

**Question**: 如何在桌面端和移动端实现不同的流程展示？

**Options to Evaluate**:
- **Option A**: CSS Media Query - 使用 Ant Design 断点系统
- **Option B**: React Hooks (useMediaQuery) - 动态监听屏幕变化
- **Option C**: 独立移动端组件 - 为移动端创建单独组件

**Evaluation Criteria**:
- 实现复杂度
- 代码复用率
- 维护成本
- 用户体验一致性

**Expected Output**: 选定方案 + 断点定义

---

#### R5: 性能优化策略

**Question**: 如何确保视图切换和流程地图渲染的性能？

**Areas to Research**:
- React.memo 优化策略
- useMemo / useCallback 使用场景
- 虚拟滚动是否必要
- 动画性能优化
- Bundle size 控制

**Expected Output**: 优化策略清单 + 关键性能指标

---

#### R6: 流程阶段数据结构

**Question**: 如何定义5个流程阶段的数据结构？

**Requirements**:
- 阶段标题和副标题
- 包含的业务模块列表
- 阶段顺序
- 与 D001 模块配置的映射关系

**Expected Output**: 数据结构定义 + processStages.ts 示例

---

### Research Output ✅

**Generated Artifacts**:
- `research.md` (800 lines) - 6个技术决策，所有 NEEDS CLARIFICATION 已解决

**Key Decisions**:
1. 视图切换：条件渲染方案
2. 流程箭头：CSS 伪元素 + SVG 混合
3. 状态保持：React state + sessionStorage
4. 响应式：Ant Design 断点系统
5. 性能优化：React.memo + useMemo
6. 数据结构：分层配置（阶段→模块）

---

## Phase 1: Design & Contracts

**Status**: ✅ COMPLETED (2026-01-14)

**Objectives**:
- 定义视图相关数据模型
- 定义流程阶段配置格式
- 生成快速上手指南
- 更新 agent context

### Generated Artifacts ✅

1. **data-model.md** (773 lines) - 完整数据模型定义
   - 8 个核心接口（ViewState, ProcessStage, ViewPreferences 等）
   - 3 个常量配置（PROCESS_STAGES, DEFAULT_VIEW_STATE 等）
   - 9 个辅助函数（getModulesByStage, validateStageConfig 等）
   - 测试数据（MOCK_PROCESS_STAGE, MOCK_VIEW_STATE）

2. **quickstart.md** (936 lines) - 完整开发指南
   - 6 个开发阶段（类型定义 → 组件实现 → 测试）
   - TDD 测试示例代码
   - 常见问题解答（4个）
   - 验收标准清单

3. **contracts/** - **跳过**（纯前端功能，无需 API 接口）

4. **Agent context** - **跳过**（无 .specify/scripts/bash/update-agent-context.sh 脚本）

---

## Constitution Re-Check (Post-Design)

**Status**: ✅ PASSED (2026-01-14)

**Re-evaluation Results**:

| 原则 | 状态 | 说明 |
|------|------|------|
| **二、代码归属标识** | ✅ PASS | quickstart.md 所有示例代码包含 `@spec D002-process-flow-map` 注释 |
| **三、测试驱动开发** | ✅ PASS | quickstart.md 包含完整 TDD 流程，先写测试再实现组件 |
| **四、组件化架构** | ✅ PASS | 设计文档明确 6 个新组件，复用 D001 组件，职责清晰 |
| **六、数据驱动与状态管理** | ✅ PASS | data-model.md 定义 ViewState 和状态管理工具 |
| **七、代码质量与工程化** | ✅ PASS | quickstart.md 包含 TypeScript、ESLint、Prettier 检查步骤 |

**结论**: 设计阶段符合所有宪法原则，可以进入实施阶段（Phase 2）。

---

## Next Steps

**Planning Phase Complete**: ✅ All planning artifacts generated

### What's Been Done

1. ✅ **Phase 0 完成**: research.md (800 lines, 6个技术决策)
2. ✅ **Phase 1 完成**: data-model.md (773 lines) + quickstart.md (936 lines)
3. ✅ **宪法复查**: 所有原则通过验证

### What's Next: Implementation (Phase 2)

**Ready to Start Development**. 请运行下一个命令：

```bash
# 进入实施阶段（不在 /speckit.plan 范围内）
# 可选：生成任务分解
/speckit.tasks

# 或者直接开始开发（推荐）
# 按照 quickstart.md 指南，从 Phase 1: 类型定义与配置 开始
cd frontend
npm install
npm run dev
```

**Estimated Implementation Time**: 4-6 hours  
**Developer Prerequisites**: 熟悉 React 19 + TypeScript + Ant Design  
**Dependencies**: D001 功能已完成

---

**Plan Generated**: 2026-01-14  
**Plan Version**: 1.0  
**Spec Version**: Based on spec.md (clarified 2026-01-14)
