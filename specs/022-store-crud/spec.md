# Feature Specification: 门店管理 - 增删改功能

**Feature Branch**: `022-store-crud`
**Created**: 2025-12-22
**Updated**: 2025-12-22
**Status**: Draft
**Input**: User description: "基于 014和 016 实现门店管理支持增删改"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 创建新门店 (Priority: P1)

作为运营人员,我希望在门店管理页面中创建新门店,填写门店名称、所属区域、城市、详细地址、联系电话等基本信息,这样系统中就可以为新开业的门店配置影厅资源和预约设置,支持该门店的正常运营。

**Why this priority**: 创建门店是门店管理的最基础功能,没有创建功能就无法添加新的门店到系统中。这是整个门店管理CRUD的入口,是P1最高优先级。

**Independent Test**: 只实现本故事时,运营人员可以通过门店管理页面的"新建门店"按钮打开表单,填写所有必填字段(名称、区域、城市、地址、电话),点击保存后新门店出现在门店列表中,且数据正确保存到Supabase数据库。

**Acceptance Scenarios**:

1. **Given** 运营人员在门店管理页面,**When** 点击"新建门店"按钮并填写所有必填字段(名称"北京朝阳店"、区域"华北"、城市"北京"、地址"朝阳区建国路1号"、电话"010-12345678"),**Then** 表单验证通过,新门店创建成功,列表刷新后显示该门店,状态默认为"启用"
2. **Given** 运营人员在创建门店表单中,**When** 未填写必填字段(如门店名称为空)并点击保存,**Then** 系统显示表单验证错误"门店名称不能为空",阻止提交
3. **Given** 运营人员填写了重复的门店名称,**When** 点击保存,**Then** 系统返回错误提示"门店名称已存在,请使用不同的名称",阻止创建
4. **Given** 运营人员填写了无效的电话号码格式(如"abc123"),**When** 点击保存,**Then** 系统显示验证错误"请输入有效的电话号码",阻止提交

---

### User Story 2 - 编辑门店信息 (Priority: P1)

作为运营人员,我希望编辑已存在门店的基本信息(如名称、区域、城市、地址、联系电话),这样当门店信息发生变更(如搬迁、更名、联系方式变更)时,可以及时更新系统中的记录,确保信息准确性。

**Why this priority**: 门店信息会随着业务发展而变化(搬迁、更名等),编辑功能是维护数据准确性的关键,与创建功能同等重要,因此也是P1优先级。

**Independent Test**: 只实现本故事时,运营人员可以在门店列表中点击某个门店的"编辑"按钮,打开编辑表单(预填充该门店的现有数据),修改任意字段(如将地址从"朝阳区建国路1号"改为"朝阳区建国路2号"),点击保存后门店信息更新,列表中显示最新数据。

**Acceptance Scenarios**:

1. **Given** 门店"北京朝阳店"已存在,**When** 运营人员点击该门店的"编辑"按钮,修改地址为"朝阳区建国路2号"并保存,**Then** 门店信息更新成功,列表中该门店的地址显示为"朝阳区建国路2号"
2. **Given** 运营人员在编辑表单中,**When** 将门店名称清空(违反必填规则)并点击保存,**Then** 系统显示验证错误"门店名称不能为空",阻止提交
3. **Given** 运营人员编辑门店A的名称,**When** 将其改为已存在的门店B的名称并保存,**Then** 系统返回错误提示"门店名称已存在",阻止更新
4. **Given** 门店"北京朝阳店"已有关联的影厅和预约设置,**When** 运营人员修改该门店的区域或城市,**Then** 仅门店基本信息更新,关联的影厅和预约设置不受影响

---

### User Story 3 - 停用/启用门店 (Priority: P2)

作为运营人员,我希望将暂时关闭或永久停业的门店标记为"停用"状态,或将停用的门店重新启用,这样可以控制哪些门店在C端预约页面中可见,避免用户预约已关闭的门店。

**Why this priority**: 停用/启用是状态管理功能,虽然重要但不是创建和编辑的前置条件。门店可以先创建和编辑,停用功能可以后续添加,因此优先级为P2。

**Independent Test**: 只实现本故事时,运营人员可以在门店列表中选择某个状态为"启用"的门店,点击"停用"按钮,确认后该门店状态变为"停用",前端C端预约页面不再显示该门店。反之可以将"停用"的门店重新"启用"。

**Acceptance Scenarios**:

1. **Given** 门店"北京朝阳店"当前状态为"启用",**When** 运营人员点击该门店的"停用"按钮并确认,**Then** 门店状态更新为"停用",列表中该门店显示"停用"标签,C端预约页面不再显示该门店
2. **Given** 门店"北京朝阳店"当前状态为"停用",**When** 运营人员点击该门店的"启用"按钮并确认,**Then** 门店状态更新为"启用",列表中该门店显示"启用"标签,C端预约页面重新显示该门店
3. **Given** 门店"北京朝阳店"已停用,**When** 该门店有未来的预约记录,**Then** 停用操作前系统提示"该门店有未来的预约记录,停用后用户将无法访问,是否确认停用?",运营人员确认后才执行停用
4. **Given** 门店"北京朝阳店"已停用,**When** 运营人员尝试编辑该门店的预约设置,**Then** 系统提示"门店已停用,请先启用门店再配置预约设置",阻止配置

---

### User Story 4 - 删除门店 (Priority: P3)

作为系统管理员,我希望删除错误创建或测试用的门店记录,这样可以保持数据库的整洁性,避免无效数据干扰正常运营。

**Why this priority**: 删除是高风险操作,且在实际业务中使用频率很低(通常用"停用"代替"删除")。只有在特定场景(如测试数据清理)下才需要,因此优先级最低为P3。

**Independent Test**: 只实现本故事时,系统管理员可以在门店列表中选择某个门店,点击"删除"按钮,系统提示确认(包括警告信息),确认后该门店从数据库中永久删除,列表中不再显示。

**Acceptance Scenarios**:

1. **Given** 门店"测试门店"没有关联的影厅、预约设置或预约记录,**When** 系统管理员点击该门店的"删除"按钮并在确认对话框中确认,**Then** 门店从数据库中删除,列表刷新后不再显示该门店
2. **Given** 门店"北京朝阳店"已有关联的影厅或预约设置,**When** 系统管理员尝试删除该门店,**Then** 系统提示"该门店有关联的影厅或预约设置,请先删除关联数据再删除门店",阻止删除
3. **Given** 门店"北京朝阳店"有历史或未来的预约记录,**When** 系统管理员尝试删除该门店,**Then** 系统提示"该门店有预约记录,无法删除。建议使用停用功能代替删除",阻止删除
4. **Given** 系统管理员在删除确认对话框中,**When** 点击"取消"按钮,**Then** 删除操作取消,门店数据不受影响

---

### Edge Cases

- 并发编辑冲突:两个运营人员同时编辑同一门店时如何处理?(建议使用乐观锁或最后写入覆盖策略,并提示用户)
- 门店名称唯一性校验范围:是否区分大小写?是否允许前后空格?(建议去除前后空格,不区分大小写)
- 删除门店时关联数据处理:如果门店有关联的影厅、预约设置、预约记录,是否支持级联删除?(建议阻止删除,要求先清理关联数据)
- 停用门店后现有预约处理:停用门店后,已预约该门店的用户是否能查看和取消预约?(建议停用不影响已有预约,用户可正常查看和取消)
- 门店信息修改后影厅归属:修改门店区域或城市后,该门店下的影厅是否需要同步更新?(建议仅更新门店信息,影厅数据不变)
- 电话号码格式验证:是否只支持中国大陆手机号?是否支持座机?(建议支持手机号和座机,使用正则验证格式)
- 区域和城市数据来源:区域和城市是自由输入还是从预定义列表选择?(建议使用下拉选择,避免数据不一致)

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须允许运营人员创建新门店,必填字段包括门店名称、所属区域、城市、详细地址、联系电话,创建成功后门店默认状态为"启用"
- **FR-002**: 系统必须对创建门店时的输入数据进行验证,包括门店名称唯一性(去除前后空格,不区分大小写)、电话号码格式(支持手机号和座机),验证失败时返回明确错误提示
- **FR-003**: 系统必须允许运营人员编辑已存在门店的基本信息(名称、区域、城市、地址、电话),编辑时复用创建表单的验证规则,保存成功后列表刷新显示最新数据
- **FR-004**: 系统必须在编辑门店名称时检查唯一性约束,如果新名称与其他门店重复(排除当前编辑的门店),则返回错误提示"门店名称已存在",阻止更新
- **FR-005**: 系统必须允许运营人员将门店状态从"启用"切换为"停用",停用操作需二次确认,停用后该门店在C端预约页面不可见,但已有预约记录不受影响
- **FR-006**: 系统必须允许运营人员将门店状态从"停用"切换为"启用",启用后该门店在C端预约页面重新可见,可接受新预约
- **FR-007**: 系统必须在停用门店前检查该门店是否有未来的预约记录,如果有则在确认对话框中显示警告信息"该门店有未来的预约记录,停用后用户将无法访问,是否确认停用?"
- **FR-008**: 系统必须允许系统管理员删除门店,删除操作需满足前置条件:门店无关联的影厅、无关联的预约设置、无任何预约记录(历史或未来),违反任一条件则阻止删除并提示原因
- **FR-009**: 系统必须在删除门店前显示确认对话框,包含警告信息"删除操作不可恢复,是否确认删除门店[门店名称]?",用户确认后才执行删除
- **FR-010**: 系统必须为所有门店操作(创建、编辑、停用/启用、删除)记录操作日志,包含操作类型、操作人、操作时间、修改前后的值(编辑时),便于审计和问题排查
- **FR-011**: 系统必须在门店管理页面的操作列中提供"编辑"、"停用/启用"、"删除"按钮,根据门店状态和用户权限动态显示可用操作(如停用的门店显示"启用"按钮,启用的门店显示"停用"按钮)
- **FR-012**: 系统必须确保门店信息修改后,关联的影厅数据(如影厅所属门店ID)和预约设置(如门店预约时间段配置)保持关联关系,不因门店信息变更而失效

### Key Entities *(include if feature involves data)*

- **Store(门店)**: 在014-hall-store-backend和020-store-address基础上扩展,增加完整的CRUD操作支持
  - id(系统内部唯一标识,UUID)
  - name(门店名称,唯一约束,去除前后空格后不区分大小写)
  - region(所属区域,如"华北"、"华东")
  - city(所属城市,如"北京"、"上海")
  - province(所属省份,如"北京市"、"上海市")
  - district(所属区县,如"朝阳区")
  - address(详细地址,如"建国路1号")
  - phone(联系电话,支持手机号和座机格式)
  - status(门店状态,枚举:ACTIVE启用/INACTIVE停用)
  - halls(关联的影厅列表,一对多关系)
  - reservationSettings(关联的预约设置,一对一关系)
  - createdAt(创建时间)
  - updatedAt(更新时间)
  - createdBy(创建人ID)
  - updatedBy(最后修改人ID)

- **StoreOperationLog(门店操作日志)**: 记录门店所有操作的审计日志
  - id(日志唯一标识,UUID)
  - storeId(关联的门店ID,外键关联Store)
  - operationType(操作类型,枚举:CREATE创建/UPDATE编辑/STATUS_CHANGE状态变更/DELETE删除)
  - operatorId(操作人ID,关联用户表)
  - operatorName(操作人名称,冗余字段便于查询)
  - beforeValue(修改前的值,JSON格式,仅UPDATE和STATUS_CHANGE操作有值)
  - afterValue(修改后的值,JSON格式)
  - operationTime(操作时间)
  - ipAddress(操作IP地址)
  - remark(备注,如删除原因)

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 运营人员可以在2分钟内完成新门店的创建,包括填写所有必填字段和验证通过,创建成功后门店立即出现在列表中
- **SC-002**: 门店信息编辑后,列表页面在3秒内刷新并显示最新数据,用户无需手动刷新页面
- **SC-003**: 门店停用操作生效后,C端预约页面在5秒内不再显示该门店,用户无法选择已停用的门店进行预约
- **SC-004**: 门店创建和编辑时的表单验证错误提示清晰准确,用户首次尝试通过率达到90%以上(即90%的用户首次提交时填写正确)
- **SC-005**: 门店删除操作的前置条件检查准确率100%,不允许删除有关联数据的门店,避免数据孤岛和级联删除风险
- **SC-006**: 所有门店操作(创建、编辑、停用/启用、删除)的操作日志记录完整性100%,每次操作都有对应的审计日志,包含操作人、时间、修改内容
- **SC-007**: 并发编辑冲突时,系统能够正确处理并提示用户"门店信息已被他人修改,请刷新后重试",避免数据覆盖
- **SC-008**: 门店管理页面的操作按钮根据门店状态和用户权限动态显示,操作权限控制准确率100%,普通运营人员无法看到"删除"按钮

## Assumptions

- 门店名称唯一性检查不区分大小写,且去除前后空格后比较(例如"北京朝阳店"和" 北京朝阳店 "视为重复)
- 门店状态变更(停用/启用)不影响已有的预约记录,用户仍可查看和取消已预约的门店
- 门店删除是硬删除(物理删除),而非软删除(标记删除),因此删除前必须严格检查关联数据
- 区域和城市字段假设使用下拉选择而非自由输入,以避免数据不一致(具体选项列表由产品提供)
- 电话号码格式支持中国大陆手机号(11位数字)和座机号(带区号,如010-12345678),使用正则表达式验证
- 门店信息修改(如区域、城市变更)不影响关联的影厅数据,影厅仍保持原有的门店归属关系
- 操作日志中的beforeValue和afterValue使用JSON格式存储,便于灵活查询和对比变更内容
- 删除操作仅对系统管理员开放,普通运营人员无删除权限(通过角色权限控制实现)
- 新创建的门店默认状态为"启用",无需运营人员手动激活
- 门店管理页面的搜索和筛选功能(014-hall-store-backend已实现)在本功能中复用,不重复开发
