# Feature Specification: 场景包多标签页编辑界面

**Feature Branch**: `001-scenario-package-tabs`
**Created**: 2025-12-23
**Status**: Draft
**Input**: User description: "将修改为 多tab  场景包编辑页面 (/scenario-packages/:id/edit)
├── Tab 1: 基础信息(名称、描述、分类、图片)
├── Tab 2: 套餐管理 ← 新增
├── Tab 3: 加购项配置 ← 新增
├── Tab 4: 时段管理 ← 新增
└── Tab 5: 发布设置"

## Clarifications

### Session 2025-12-23

- Q: 套餐应该包含原价和标签字段吗？ → A: 是 - 包含 `原价`（用于显示折扣）和 `标签`（如"推荐"、"限时优惠"）
- Q: 加购项应该是全局管理还是场景包专属？ → A: 全局管理 - 加购项为全局资源,可关联多个场景包,支持穿梭框选择
- Q: 时段管理应该支持模板化配置吗？ → A: 支持模板化 - 按星期几配置默认时段+特定日期覆盖(新增/修改/取消)
- Q: 发布时应该强制要求配置可预订时段吗？ → A: 是 - 发布需满足: 至少1个套餐 + 至少1个可预订时段(周模板或日期覆盖)

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 多标签页导航与基础信息编辑 (Priority: P1)

作为运营人员,我希望在场景包编辑页面能够通过标签页切换不同的配置模块,首先在"基础信息"标签页中编辑场景包的名称、描述、分类和图片,这样我就能清晰地组织场景包的各项配置,避免在单一长页面中滚动查找。

**Why this priority**: 基础信息是场景包的核心属性,必须最先完成。标签页导航是整个界面的骨架,是其他功能的前提。这是最小可行产品的基础。

**Independent Test**: 可以通过访问编辑页面并验证标签页切换功能和基础信息表单来独立测试。测试人员能够在标签页间切换,填写并保存基础信息,确认数据持久化。

**Acceptance Scenarios**:

1. **Given** 用户进入场景包编辑页面,**When** 页面加载完成,**Then** 应该默认显示"基础信息"标签页,且该标签处于激活状态
2. **Given** 用户在"基础信息"标签页,**When** 点击其他标签页(如"套餐管理"),**Then** 界面应切换到对应标签页内容,且标签样式变为激活状态
3. **Given** 用户在"基础信息"标签页填写了场景包名称、描述、选择了分类,**When** 点击保存按钮,**Then** 基础信息应成功保存,并显示成功提示
4. **Given** 用户上传了场景包主图,**When** 保存后刷新页面,**Then** 已上传的图片应正确显示在图片预览区域
5. **Given** 用户在某个标签页进行了未保存的修改,**When** 切换到其他标签页,**Then** 系统应提示用户是否保存当前修改

---

### User Story 2 - 套餐管理配置 (Priority: P1)

作为运营人员,我希望在"套餐管理"标签页中为场景包添加、编辑和删除多个套餐选项,每个套餐包含名称、价格、原价、标签和服务内容,这样我就能为用户提供多种价格层级的选择,展示折扣优惠,满足不同预算需求。

**Why this priority**: 套餐是场景包的核心售卖单元,没有套餐就无法定价和销售。原价和标签能够提升转化率和运营灵活性。这是必须在 MVP 中实现的功能。

**Independent Test**: 可以通过进入"套餐管理"标签页并测试套餐的增删改查功能来独立验证。测试人员能够创建多个套餐,设置原价和标签,编辑套餐详情,删除套餐,并验证数据正确保存。

**Acceptance Scenarios**:

1. **Given** 用户进入"套餐管理"标签页,**When** 点击"添加套餐"按钮,**Then** 应显示套餐配置表单,包含名称、价格、原价、标签、服务内容等字段
2. **Given** 用户填写了套餐信息(名称"豪华套餐",价格 3888,原价 4999,标签["推荐", "限时优惠"]),**When** 点击确认,**Then** 新套餐应出现在套餐列表中,显示折扣标记
3. **Given** 用户设置了套餐原价低于售价,**When** 保存时,**Then** 系统应显示验证错误"原价必须大于或等于售价"
4. **Given** 场景包已有多个套餐,**When** 用户在列表中点击某个套餐的编辑按钮,**Then** 应弹出编辑表单,预填充该套餐的现有信息(包括原价和标签)
5. **Given** 用户修改了套餐标签,**When** 保存后,**Then** 套餐列表应显示更新后的标签
6. **Given** 用户点击删除套餐按钮,**When** 确认删除操作,**Then** 该套餐应从列表中移除,且系统提示删除成功
7. **Given** 场景包没有任何套餐,**When** 用户尝试发布场景包,**Then** 系统应阻止发布并提示"至少需要配置一个套餐"

---

### User Story 3 - 加购项关联配置 (Priority: P2)

作为运营人员,我希望在"加购项配置"标签页中从全局加购项库中选择并关联到当前场景包,设置排序和是否必选,这样用户在预订时可以看到相关的增值服务选项,提升客单价。同时,我希望能够在全局加购项库中统一管理所有加购项的名称、价格、分类和库存。

**Why this priority**: 加购项能够提升营收,但不影响基本的场景包销售流程。全局管理模式便于跨场景包复用和统一库存控制。可以在套餐配置完成后独立开发和测试。

**Independent Test**: 可以通过进入"加购项配置"标签页并测试加购项关联功能来独立验证。测试人员能够从全局库中选择加购项,设置排序和必选标记,取消关联,并验证C端正确显示。

**Acceptance Scenarios**:

1. **Given** 用户进入"加购项配置"标签页,**When** 点击"选择加购项"按钮,**Then** 应显示穿梭框,左侧列出所有可用的全局加购项,右侧显示已关联的加购项
2. **Given** 用户从左侧穿梭框中选择了"高端茶歇"和"鲜花布置"两个加购项,**When** 点击确认,**Then** 这两个加购项应出现在右侧已选列表中
3. **Given** 用户在已选加购项列表中拖拽调整顺序,**When** 保存后,**Then** C端应按新的排序顺序展示加购项
4. **Given** 用户将某个加购项标记为"必选",**When** 保存后,**Then** C端该加购项默认数量为1且不可减为0
5. **Given** 用户取消关联某个加购项,**When** 保存后,**Then** 该加购项不再出现在C端该场景包的预订页面中
6. **Given** 全局加购项库中某个加购项被设置为"下架",**When** C端查询时,**Then** 所有关联该加购项的场景包都不显示该加购项

---

### User Story 4 - 时段模板化管理配置 (Priority: P2)

作为运营人员,我希望在"时段管理"标签页中按星期几配置默认可预订时段(如每周一至周五 10:00-13:00),并能为特定日期添加覆盖规则(如节假日取消某时段或新增临时时段),这样我就能减少重复配置工作,同时灵活应对特殊日期调整。

**Why this priority**: 时段管理对于合理分配场地资源很重要,模板化配置可以大幅提升运营效率。但用户可以先在没有时段限制的情况下预订场景包。可以作为独立功能后续添加。

**Independent Test**: 可以通过进入"时段管理"标签页并测试时段模板配置和日期覆盖功能来独立验证。测试人员能够创建周模板,添加特定日期覆盖,并验证C端查询结果正确应用覆盖规则。

**Acceptance Scenarios**:

1. **Given** 用户进入"时段管理"标签页,**When** 点击"配置周模板"按钮,**Then** 应显示周视图(周一至周日),可为每天添加多个时段模板
2. **Given** 用户为周一至周五配置了默认时段(10:00-13:00, 14:30-17:30, 19:00-22:00),**When** 保存后,**Then** 周模板列表应显示这些配置
3. **Given** 用户点击日历视图中的"2025-12-25"(周三),**When** 选择"取消时段",**Then** 应能选择取消该日的某个或全部时段
4. **Given** 用户为2025-12-31添加了特殊时段覆盖(仅19:00-22:00跨年场),**When** C端查询该日时段,**Then** 应仅返回19:00-22:00,不显示周模板中的其他时段
5. **Given** 某个时段的容量已被预订满,**When** 其他用户尝试预订该时段,**Then** 系统应提示"该时段已满,请选择其他时段"
6. **Given** 用户为某时段设置了价格上调10%,**When** 用户选择该时段预订,**Then** 系统应自动计算并显示调整后的价格
7. **Given** 用户修改了周三模板的时段时间,**When** 保存后,**Then** 未来所有周三应用新模板,已有预订不受影响

---

### User Story 5 - 发布设置与状态管理 (Priority: P1)

作为运营人员,我希望在"发布设置"标签页中控制场景包的上架/下架状态,设置生效时间范围和预订规则,这样我就能在完成所有配置后一键发布,或临时下架场景包进行调整。系统应在发布前验证至少配置了1个套餐和1个可预订时段,确保用户能够正常预订。

**Why this priority**: 发布控制是场景包生命周期管理的关键环节,直接影响用户能否看到和预订该场景包。发布前验证能够避免无法预订的场景包上线。必须在 MVP 中实现。

**Independent Test**: 可以通过进入"发布设置"标签页并测试发布/下架功能来独立验证。测试人员能够设置发布状态,验证发布前的完整性检查,确认用户端的可见性变化。

**Acceptance Scenarios**:

1. **Given** 用户进入"发布设置"标签页,**When** 选择"立即发布"并点击保存,**Then** 场景包状态应变为"已发布",且在用户端可见
2. **Given** 场景包当前为"已发布"状态,**When** 用户选择"下架"并确认,**Then** 场景包应从用户端隐藏,已有预订不受影响
3. **Given** 用户设置了生效时间范围(2025-01-01 至 2025-03-31),**When** 当前日期在范围外,**Then** 场景包应自动不可见
4. **Given** 用户设置了预订规则(提前 3 天预订),**When** 用户尝试预订 2 天后的场次,**Then** 系统应提示"请至少提前 3 天预订"
5. **Given** 用户在发布前缺少必填配置(如无套餐),**When** 点击发布按钮,**Then** 系统应阻止发布并列出缺失项
6. **Given** 用户已配置套餐但未配置任何时段(无周模板且无日期覆盖),**When** 点击发布按钮,**Then** 系统应阻止发布并提示"至少需要配置一个可预订时段"
7. **Given** 用户已配置套餐和时段,**When** 点击发布按钮,**Then** 系统应通过验证并成功发布场景包

### Edge Cases

- **标签页切换时表单数据未保存**: 用户在某个标签页修改了数据但未保存,直接切换到其他标签页,系统应提示保存或丢弃修改,避免数据丢失
- **套餐数量限制**: 当场景包已添加大量套餐(如 10+ 个)时,界面应提供搜索或分页功能,避免列表过长影响操作
- **套餐原价校验**: 用户设置套餐原价低于售价时,系统应阻止保存并提示"原价必须大于或等于售价"
- **全局加购项被多个场景包引用**: 运营人员在全局库中修改加购项价格,所有关联该加购项的场景包应自动生效新价格
- **加购项下架影响**: 运营人员在全局库中下架某个加购项,所有关联场景包的C端页面应立即不显示该加购项
- **加购项库存不足**: 用户在前端预订时选择了某个加购项,但在提交订单前库存被其他用户抢完,系统应实时检测并提示库存不足
- **时段模板冲突检测**: 用户在同一星期几创建的新时段模板与现有模板在时间上重叠(如 9:00-12:00 和 11:00-14:00),系统应警告可能的资源冲突
- **日期覆盖复杂度**: 当某个日期同时存在多个覆盖规则时(如既有新增又有取消),系统应按规则优先级正确合并,CANCEL > MODIFY > ADD
- **发布验证时段要求**: 用户配置了套餐但未配置任何可预订时段(周模板为空且无新增/修改类型的日期覆盖),点击发布时系统应阻止发布并提示"至少需要配置一个可预订时段"
- **发布后修改配置**: 场景包已发布且有用户预订,运营人员修改了套餐价格或时段规则,系统应明确提示修改仅对新订单生效,或要求下架后才能修改关键配置
- **图片上传失败**: 用户上传场景包图片时网络中断或文件格式不支持,系统应显示友好的错误提示并允许重新上传
- **多人同时编辑**: 两个运营人员同时打开同一个场景包的编辑页面并修改不同标签页的内容,系统应检测并发修改并提示冲突
- **必填字段校验**: 用户在"基础信息"标签页中未填写必填字段(如场景包名称),直接切换到其他标签页,系统应阻止切换并高亮显示缺失字段

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须提供包含 5 个标签页的场景包编辑界面,标签页依次为: 基础信息、套餐管理、加购项配置、时段管理、发布设置
- **FR-002**: 标签页必须支持点击切换,当前激活的标签页应有明显的视觉标识(如高亮颜色或下划线)
- **FR-003**: 用户必须能够在"基础信息"标签页中填写场景包名称(必填,最大 100 字符)、描述(可选,最大 500 字符)、选择分类(必填,从预定义列表中选择)、上传主图(必填,支持 JPG/PNG,最大 5MB)
- **FR-004**: 系统必须在用户切换标签页时检测当前标签页是否有未保存的修改,如有则弹出确认对话框询问是否保存
- **FR-005**: 用户必须能够在"套餐管理"标签页中添加、编辑、删除套餐,每个套餐包含: 名称(必填)、价格(必填,正数,精确到分)、原价(可选,必须≥售价)、标签(可选,数组格式如["推荐", "限时优惠"])、服务内容描述(可选)
- **FR-006**: 系统必须确保每个场景包至少配置 1 个套餐后才能发布
- **FR-007**: 系统必须在套餐保存时校验原价≥售价,不满足时显示错误"原价必须大于或等于售价"
- **FR-008**: 用户必须能够在"加购项配置"标签页中使用穿梭框从全局加购项库中选择加购项并关联到当前场景包
- **FR-009**: 用户必须能够为已关联的加购项设置排序顺序(支持拖拽)和是否必选标记
- **FR-010**: 系统必须支持在全局加购项库中管理所有加购项,包括: 名称、价格、分类(餐饮/饮品/服务/布置)、图片、库存、上下架状态
- **FR-011**: 系统必须在用户预订时实时检查加购项库存,库存为 0 或加购项已下架时应禁止选择并显示"已售罄"或"已下架"
- **FR-012**: 系统必须在C端仅展示 is_active=true 的加购项,按场景包关联表的排序顺序展示
- **FR-013**: 用户必须能够在"时段管理"标签页中配置按星期几(周日=0,周一=1...周六=6)的时段模板,每个模板时段包含: 开始时间、结束时间、容量限制(可选,默认无限制)
- **FR-014**: 用户必须能够为特定日期添加时段覆盖规则,覆盖类型包括: 新增时段(ADD)、修改容量(MODIFY)、取消时段(CANCEL)
- **FR-015**: 系统必须在C端查询特定日期时段时,优先应用日期覆盖规则,无覆盖时使用周模板计算该日时段
- **FR-016**: 系统必须支持在时段模板和日期覆盖中设置价格调整(可选,如"+10%"或"-50元")
- **FR-017**: 系统必须在时段容量达到上限时阻止新预订,并提示"该时段已满"
- **FR-018**: 用户必须能够在"发布设置"标签页中控制场景包的发布状态(草稿/已发布/已下架),设置生效时间范围(可选,开始日期和结束日期),配置预订规则(如"提前 N 天预订")
- **FR-019**: 系统必须在用户点击发布按钮前验证必填配置是否完整(基础信息必填字段、至少 1 个套餐、至少 1 个可预订时段),可预订时段可以是周模板中的任意一个时段或日期覆盖中的新增/修改时段,如不完整则阻止发布并列出缺失项
- **FR-020**: 场景包发布后必须在用户端可见,下架后必须从用户端隐藏,但已有预订不受影响
- **FR-021**: 系统必须在保存任何标签页的数据时显示加载指示器,保存成功后显示成功提示,失败时显示错误信息
- **FR-022**: 系统必须支持图片上传功能,包括文件格式验证(仅 JPG/PNG)、大小限制(最大 5MB)、上传进度显示、上传失败后重试
- **FR-023**: 系统必须在用户编辑已发布场景包的关键配置(套餐价格、时段规则)时弹出警告,提示修改仅对新订单生效或需要下架后修改
- **FR-024**: 系统必须检测多人同时编辑同一场景包的情况,当用户保存时发现数据已被其他人修改,应提示冲突并显示最新数据
- **FR-025**: 系统必须在用户创建新时段模板时检测同一星期同一时间的重叠,如有重叠应显示警告提示
- **FR-026**: 系统必须对所有表单字段进行前端校验(必填性、格式、长度限制),并在字段失去焦点时即时显示验证错误
- **FR-027**: 系统必须在页面加载时从后端获取场景包的完整数据,并正确分发到各个标签页的表单中
- **FR-028**: 系统必须支持套餐拖拽排序功能,保存后C端按排序顺序展示套餐
- **FR-029**: 系统必须在全局加购项库中修改加购项信息(价格、库存等)后,所有关联该加购项的场景包自动生效最新信息
- **FR-030**: 系统必须提供周视图界面展示时段模板配置,支持批量复制某天的配置到其他天
- **FR-031**: 系统必须提供日历视图(显示未来30天或指定范围),标记有特殊覆盖的日期,点击可编辑该日覆盖规则

### Key Entities

- **场景包(Scenario Package)**: 包含基础信息(名称、描述、分类、主图)、套餐列表、加购项关联列表、时段列表、发布设置。关联多个套餐和时段,通过关联表引用全局加购项
- **套餐(Package Tier)**: 隶属于某个场景包,包含名称、价格、原价、标签数组、服务内容描述、排序顺序。是场景包的核心售卖单元
- **加购项(Add-on Item)**: 全局资源,包含名称、价格、分类、图片、库存、上下架状态。可被多个场景包关联引用
- **场景包-加购项关联(Scenario Package Add-on)**: 记录场景包与加购项的关联关系,包含排序顺序、是否必选标记
- **时段模板(Time Slot Template)**: 隶属于某个场景包,按星期几(0-6)定义默认时段,包含开始时间、结束时间、容量限制、是否启用
- **时段日期覆盖(Time Slot Override)**: 隶属于某个场景包,为特定日期定义覆盖规则,包含日期、时段时间、容量、覆盖类型(新增/修改/取消)、原因说明
- **时段库存(Time Slot Inventory)**: 记录特定日期特定时段的实际库存状态,包含总容量、已预订数量、更新时间
- **发布设置(Publishing Settings)**: 隶属于某个场景包,包含发布状态(草稿/已发布/已下架)、生效时间范围(开始日期、结束日期)、预订规则(如提前天数)

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 运营人员能够在 5 分钟内完成一个场景包的完整配置(包括基础信息、1 个套餐、2 个加购项关联、2 个时段、发布设置)
- **SC-002**: 标签页切换响应时间不超过 300 毫秒,用户感知流畅无延迟
- **SC-003**: 表单数据保存成功率达到 99% 以上(排除网络故障),失败时有明确的错误提示
- **SC-004**: 用户在切换标签页时,100% 的未保存修改能够被检测并提示确认
- **SC-005**: 发布前的配置完整性校验能够覆盖 100% 的必填项和业务规则,无漏检
- **SC-006**: 减少场景包配置错误率 60% 以上(通过分标签页组织和实时校验)
- **SC-007**: 90% 的运营人员在首次使用时能够顺利完成场景包配置,无需额外培训
- **SC-008**: 图片上传成功率达到 95% 以上(在正常网络条件下),失败时提供重试机制
- **SC-009**: 多人并发编辑冲突检测率达到 100%,避免数据被意外覆盖

## Assumptions

- 假设运营人员已熟悉基本的表单操作和文件上传流程
- 假设场景包编辑功能仅对具有运营权限的用户开放,无需在此功能中实现权限控制逻辑
- 假设后端已提供场景包增删改查的 API 接口,前端无需关心数据持久化细节
- 假设图片上传后由后端返回可访问的 URL,前端直接存储该 URL
- 假设时段管理中的"容量限制"指的是同一时段内可同时进行的场次数量,而非人数限制
- 假设发布后的场景包修改不会影响已确认的订单,仅对新订单生效
- 假设全局加购项库由系统管理员或高级运营人员统一维护,场景包编辑人员仅能关联已有加购项

## Dependencies

- **依赖后端 API**: 场景包的 CRUD 操作、图片上传、发布状态管理、全局加购项库 API
- **依赖现有分类数据**: 基础信息中的分类选择依赖预定义的分类列表
- **依赖用户权限系统**: 确保只有授权的运营人员能够访问编辑页面
- **依赖全局加购项库**: 加购项配置依赖全局加购项库的存在和管理功能

## Related Features

- **场景包列表页面**: 提供进入编辑页面的入口,展示所有场景包的摘要信息
- **用户预订流程**: 使用场景包配置的套餐、加购项、时段信息进行预订
- **订单管理系统**: 关联场景包的预订记录,受发布状态和时段规则影响
- **全局加购项管理**: 独立的加购项库管理页面,用于创建、编辑、上下架加购项
