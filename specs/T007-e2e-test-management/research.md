# Research: E2E 测试管理规范

**@spec T007-e2e-test-management**

**Date**: 2025-12-31
**Purpose**: Resolve technical unknowns and establish best practices for E2E test management skill implementation

## Research Tasks

### 1. Existing E2E Skill Ecosystem Analysis

**Task**: Analyze existing E2E skills to understand patterns and integration points

**Findings**:

| Skill | Location | Key Capabilities | Integration Points |
|-------|----------|------------------|-------------------|
| e2e | `.claude/skills/e2e/` | Unified entry wrapper | Dispatches to other skills |
| test-scenario-author | `.claude/skills/test-scenario-author/` | Scenario YAML creation, validation, listing | Outputs to `scenarios/` |
| e2e-test-generator | `.claude/skills/e2e-test-generator/` | YAML → Playwright script | Reads `scenarios/`, outputs to `frontend/tests/e2e/` |
| e2e-runner | `.claude/skills/e2e-runner/` | Multi-environment execution | Runs Playwright tests |
| e2e-testdata-planner | `.claude/skills/e2e-testdata-planner/` | Test data blueprints, fixtures | Outputs to `testdata/` |
| e2e-report-configurator | `.claude/skills/e2e-report-configurator/` | Report configuration, CI/CD | Configures Playwright reporters |
| e2e-admin | `.claude/skills/e2e-admin/` | Test orchestration | Coordinates all skills |

**Decision**: Extend existing `e2e` skill with new subcommands; create new `manual-testcase-generator` skill following established patterns.

**Rationale**: Maintains consistency with existing ecosystem; unified entry point reduces cognitive load for users.

**Alternatives Considered**:
- Create standalone skills for each new feature → Rejected: fragments user experience
- Merge all functionality into e2e-admin → Rejected: violates single responsibility principle

---

### 2. Manual Test Case YAML Schema Design

**Task**: Define YAML schema for manual test cases compatible with existing testdata-planner

**Findings**:

Existing E2E scenario YAML structure (T001/T005):
```yaml
scenario_id: E2E-MODULE-001
title: ...
module: ...
tags: [...]
preconditions: [...]
steps: [...]
```

Manual test case requires additional fields for human execution:
- `testcase_id`: TC-MODULE-NUMBER format
- `priority`: P0/P1/P2 for test prioritization
- `test_data.testdata_ref`: Reference to testdata-planner blueprints
- `steps[].action`, `steps[].input`, `steps[].expected`: Human-readable format
- `assertions`: High-level verification points
- `executions`: Execution history records

**Decision**: Use schema defined in spec.md Appendix A with `testdata_ref` supporting testdata-planner integration.

**Rationale**: Enables data reuse across automated and manual testing; maintains consistency with existing YAML conventions.

---

### 3. Markdown Document Generation Patterns

**Task**: Determine best approach for YAML → Markdown conversion

**Findings**:

Two input sources require handling:
1. **TC YAML** (testcases/): Contains human-readable steps directly
2. **E2E YAML** (scenarios/): Contains automation-oriented steps with selectors

**Decision**:
- For TC YAML: Direct field mapping (title, preconditions, steps, assertions)
- For E2E YAML: Extract metadata + step descriptions only (per clarification Q4)

**Rationale**: Markdown docs serve as QA-friendly operation guides; technical details (selectors, assertions code) should not appear.

**Template Structure**:
```markdown
# [Title]

**用例ID**: [ID]
**模块**: [Module]
**优先级**: [Priority]

## 前置条件
[List preconditions]

## 测试数据
[Resolved testdata or reference]

## 测试步骤
| 步骤 | 操作 | 输入 | 预期结果 |
|------|------|------|----------|
| 1 | ... | ... | ... |

## 验证点
[Assertions list]

---
*Generated by manual-testcase-generator | Source: [path]*
```

---

### 4. Service Automation Best Practices

**Task**: Research patterns for service lifecycle management in test environments

**Findings**:

Common patterns:
1. **Port detection**: `lsof -i :PORT` or `netstat` to check occupancy
2. **Health check**: HTTP GET to health endpoint with retry logic
3. **Process management**: Use `npm run` with `spawn()`, capture PID for cleanup
4. **Timeout handling**: Configurable startup timeout with graceful failure

Existing service config structure (from e2e-admin):
```yaml
services:
  c-end:
    port: 10086
    start_command: "npm run dev:h5"
    health_check_url: "http://localhost:10086"
    startup_timeout: 60000
```

**Decision**: Use configuration-driven approach with service-config.yaml; implement port conflict strategy (prompt/auto-kill/fail).

**Rationale**: Flexibility for different environments; explicit conflict resolution prevents silent failures.

---

### 5. Report Portal Implementation

**Task**: Research static report aggregation approaches

**Findings**:

Options evaluated:
1. **Playwright HTML Reporter**: Built-in, generates per-run HTML
2. **Custom aggregation page**: Simple HTML + JSON index for history
3. **Third-party tools**: Allure, ReportPortal → Heavyweight for current needs

**Decision**: Use Playwright HTML Reporter for individual runs + custom `e2e-portal/index.html` for aggregation.

**Rationale**:
- Leverages existing Playwright reporting
- Lightweight custom portal for history/comparison
- No additional dependencies

**Portal data structure** (reports.json):
```json
{
  "portal_version": "1.0.0",
  "reports": [
    {
      "run_id": "...",
      "timestamp": "...",
      "summary": { "total": N, "passed": N, "failed": N },
      "report_path": "./run-.../index.html"
    }
  ]
}
```

---

### 6. Skill YAML Frontmatter Requirements

**Task**: Verify YAML frontmatter format for new skills

**Findings**:

Per Constitution Principle 8.1, all skill.md files MUST include:
```yaml
---
name: skill-name
description: Detailed description with trigger keywords (中英文)
version: 1.0.0
---
```

Existing skills follow this pattern (verified: test-scenario-author, e2e-test-generator).

**Decision**: New `manual-testcase-generator` skill.md will include proper frontmatter.

**Rationale**: Required for Claude Code to recognize and load the skill.

---

## Summary of Decisions

| Area | Decision | Rationale |
|------|----------|-----------|
| Architecture | Extend e2e skill + new manual-testcase-generator | Consistency with ecosystem |
| TC YAML Schema | Fields from spec Appendix A | Human-readable, testdata-planner compatible |
| Markdown Generation | Template-based, metadata + descriptions only | QA-friendly, no technical details |
| Service Management | Config-driven with conflict strategy | Flexibility and explicit handling |
| Report Portal | Playwright HTML + custom aggregation | Lightweight, no new dependencies |
| Skill Format | YAML frontmatter with trigger keywords | Constitution compliance |

## Open Items (None)

All technical unknowns resolved. Ready for Phase 1: Design & Contracts.
