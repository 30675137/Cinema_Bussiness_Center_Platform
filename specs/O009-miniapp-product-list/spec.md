# Feature Specification: 小程序商品列表API加载与展示

**Feature Branch**: `O009-miniapp-product-list`
**Created**: 2026-01-05
**Status**: Draft
**Input**: 实现小程序miniapp-ordering-taro通过api加载商品列表的展示

## Clarifications

### Session 2026-01-05
- Q: 小程序应该如何获取和使用商品分类？ → A: 从 `GET /api/client/menu-categories` API 动态获取分类列表，使用 `code` 或 `id` 字段进行筛选（与 O008 架构决策保持一致，支持动态分类管理）
- Q: 商品列表API应该使用哪种参数格式来进行分类筛选？ → A: 使用 `categoryId`（UUID 格式），直接使用数据库主键，查询性能更好，与后端数据模型（ChannelProductConfig.categoryId）一致
- Q: 用户下拉刷新商品列表时，是否需要同时刷新分类列表？ → A: 仅刷新商品列表，保持当前选中的分类不变（分类数据变化频率低，减少不必要的API调用，用户体验更连贯）
- Q: 推荐商品和非推荐商品在列表中应该如何混合排序？ → A: 推荐商品置顶显示，推荐商品内部按 sortOrder 排序，非推荐商品置后按 sortOrder 排序（标准电商做法，确保运营重点商品优先展示）

---

## 背景与问题

### 现状

基于 O007-miniapp-menu-api 规格，后端已完成商品API的开发，包括:
- 商品列表查询接口（支持分类筛选、分页、渠道过滤）
- 商品详情接口
- 动态菜单分类系统（从 `menu_category` 表获取，支持分类管理）
- 图片存储与访问（Supabase Storage）

`miniapp-ordering-taro` 项目现有基础组件和页面框架，但商品列表展示功能尚未与后端API完全集成。

### 问题

1. **商品列表数据源未集成**: 当前使用静态mock数据或空列表，未调用后端API
2. **数据加载状态缺失**: 缺少骨架屏、加载动画、错误提示等用户反馈
3. **性能优化不足**: 未实现列表分页加载、虚拟滚动或缓存策略
4. **商品卡片组件未完善**: 缺少商品图片展示、价格格式化、推荐标签等关键信息

### 核心目标

完善 miniapp-ordering-taro 的商品列表功能，通过集成后端API实现:
- 商品列表的动态加载与展示
- 友好的加载状态与错误处理
- 流畅的用户交互体验（滚动加载、下拉刷新）
- 完整的商品信息展示（图片、价格、标签、规格）

---

## User Scenarios & Testing

### User Story 1 - 加载并展示商品列表 (Priority: P1)

作为小程序用户，我希望在进入商品页面时，能够看到所有可售商品的列表，每个商品卡片展示图片、名称、价格等关键信息，方便我快速浏览和选择商品。

**Why this priority**: 这是商品展示的核心功能，是用户浏览和选购商品的基础，没有商品列表展示，用户无法进行任何购买操作。

**Independent Test**: 用户打开商品列表页 → 查看页面显示商品卡片 → 验证每个卡片包含图片、名称、价格、推荐标签 → 滚动查看更多商品。

**Acceptance Scenarios**:

1. **Given** 用户首次打开商品列表页，**When** 页面加载，**Then** 显示骨架屏或加载动画，提示"加载中..."
2. **Given** API返回商品数据，**When** 数据加载完成，**Then** 按以下规则排序展示商品卡片：推荐商品（`isRecommended=true`）置顶显示，推荐商品内部按 `sortOrder` 升序排序；非推荐商品置后显示，内部按 `sortOrder` 升序排序
3. **Given** 商品卡片渲染，**When** 用户查看卡片，**Then** 显示商品主图、名称、最小销售单位价格、推荐标签（如有）
4. **Given** 商品主图URL有效，**When** 图片加载，**Then** 显示商品实际图片；如加载失败，显示默认占位图
5. **Given** 商品价格为分单位（如2800），**When** 价格格式化，**Then** 显示为"¥28.00"或"¥28"
6. **Given** 商品为推荐商品（`isRecommended: true`），**When** 卡片渲染，**Then** 显示"推荐"角标（左上角或醒目位置）

---

### User Story 2 - 按分类筛选商品 (Priority: P1)

作为小程序用户，我希望能够通过分类标签筛选商品，只查看我感兴趣的类别，提高浏览效率。

**Why this priority**: 分类筛选是商品浏览的核心导航功能，直接影响用户找到目标商品的效率，与商品列表展示同等重要。

**Independent Test**: 用户在商品列表页 → 点击分类标签 → 验证列表仅显示该分类商品 → 切换不同分类 → 验证筛选逻辑正确。

**Acceptance Scenarios**:

1. **Given** 用户在商品列表页，**When** 页面加载完成，**Then** 调用 `GET /api/client/menu-categories` 获取分类列表，顶部显示动态分类标签栏（如：全部、经典特调、精品咖啡、经典饮品、主厨小食）
2. **Given** 用户点击某个分类标签（如"精品咖啡"），**When** 切换分类，**Then** 调用商品列表API并传递该分类的 `id` 参数（如 `categoryId={uuid}`），列表仅显示该分类的商品
3. **Given** 用户点击"全部"标签，**When** 清除分类筛选，**Then** 调用API获取所有商品（不传递 `categoryId` 参数）
4. **Given** 某分类无商品，**When** 用户选择该分类，**Then** 显示"暂无该分类商品"空状态提示
5. **Given** 用户切换分类，**When** API调用中，**Then** 显示加载状态，防止重复点击
6. **Given** 分类列表API加载失败，**When** 页面初始化，**Then** 显示默认分类（全部），并提供重试按钮重新加载分类列表

---

### User Story 3 - 分页加载与下拉刷新 (Priority: P2)

作为小程序用户，我希望在滚动到列表底部时自动加载更多商品，并且能够通过下拉刷新重新加载最新数据，避免一次性加载过多数据导致页面卡顿。

**Why this priority**: 分页加载和下拉刷新是提升用户体验的重要功能，能够优化性能并保持数据新鲜度，但不影响基础的商品浏览功能。

**Independent Test**: 用户滚动到列表底部 → 验证自动加载下一页 → 下拉页面 → 验证重新加载数据并重置列表。

**Acceptance Scenarios**:

1. **Given** 商品列表有超过20条数据，**When** 用户滚动到底部（距底部50px内），**Then** 自动触发加载下一页，显示"加载更多..."提示
2. **Given** 用户加载下一页，**When** API返回数据，**Then** 追加到当前列表末尾，无重复商品
3. **Given** 已加载所有商品，**When** 用户滚动到底部，**Then** 显示"已加载全部商品"提示，不再请求API
4. **Given** 用户下拉列表页面，**When** 触发下拉刷新，**Then** 重新调用商品列表API获取第一页数据（保持当前选中的分类筛选条件），替换当前列表，分类标签栏保持不变
5. **Given** 下拉刷新中，**When** API返回数据，**Then** 替换当前列表，滚动位置回到顶部，当前选中的分类标签状态不变

---

### User Story 4 - 处理网络异常与错误 (Priority: P2)

作为小程序用户，我希望在网络异常或API调用失败时，能够看到清晰的错误提示和重试选项，而不是白屏或无响应，避免不知所措。

**Why this priority**: 良好的错误处理能提升用户体验和应用稳定性，虽然不是核心功能，但对用户留存有重要影响。

**Independent Test**: 断开网络 → 打开商品列表页 → 验证显示错误提示和重试按钮 → 恢复网络 → 点击重试 → 验证成功加载数据。

**Acceptance Scenarios**:

1. **Given** 用户打开商品列表页，**When** 网络断开，**Then** 显示"网络已断开，请检查网络连接"错误提示和重试按钮
2. **Given** API请求超时（>10秒），**When** 请求失败，**Then** 显示"网络超时，请检查网络后重试"提示和重试按钮
3. **Given** 后端返回500错误，**When** API调用失败，**Then** 显示"服务异常，请稍后重试"提示
4. **Given** 用户点击重试按钮，**When** 触发重新加载，**Then** 再次调用API，显示加载状态
5. **Given** 后端返回空数据（`data: []`），**When** 数据加载完成，**Then** 显示"暂无商品"空状态提示，不显示错误

---

### User Story 5 - 商品卡片交互与详情跳转 (Priority: P3)

作为小程序用户，我希望点击商品卡片后能够跳转到商品详情页，查看更完整的商品信息（规格、描述、加购选项等）。

**Why this priority**: 商品详情页是用户进一步了解商品和下单的入口，但用户可以先在列表页完成浏览，详情页可作为后续迭代功能。

**Independent Test**: 用户在商品列表页 → 点击任一商品卡片 → 验证跳转到详情页 → 验证传递正确的商品ID参数。

**Acceptance Scenarios**:

1. **Given** 用户在商品列表页，**When** 点击商品卡片，**Then** 跳转到商品详情页（路由：`/pages/product-detail/index?id={productId}`）
2. **Given** 用户点击卡片时，**When** 触发跳转，**Then** 卡片显示点击反馈（如背景色变化），提升交互感
3. **Given** 用户跳转到详情页，**When** 详情页加载，**Then** 根据传递的`productId`调用商品详情API
4. **Given** 商品详情页不存在或未开发，**When** 用户点击卡片，**Then** 显示"商品详情功能开发中"提示（临时方案）

---

### Edge Cases

- **大量商品加载**: 当商品数量超过100条时，如何优化列表渲染性能？
  - 使用Taro的虚拟列表组件（`<VirtualList>`）或分页加载限制单页数量（默认20条）
- **图片加载慢**: 当商品主图较大或网络慢时，如何避免页面卡顿？
  - 使用图片懒加载（`lazy-load="true"`），配合占位图
- **价格为0或null**: 如何展示价格异常的商品？
  - 价格为0显示"¥0.00"，价格为null显示"价格待定"
- **推荐商品过多**: 如果推荐商品超过单页数量（20条），如何处理？
  - 推荐商品内部按 `sortOrder` 排序，超过单页容量的推荐商品将在第二页继续展示（仍然置顶于非推荐商品之前）
- **分类切换频繁**: 用户快速切换分类时，如何避免重复请求？
  - 使用TanStack Query的debounce或取消前一个请求
- **无网络时下拉刷新**: 离线状态下拉刷新，如何处理？
  - 显示"网络已断开，无法刷新"提示，隐藏刷新动画

---

## Requirements

### Functional Requirements

- **FR-001**: 系统必须调用后端商品列表API（`GET /api/client/channel-products`），获取指定渠道（`channel=MINIAPP`）和分类（`categoryId`，UUID 格式）的商品数据
- **FR-002**: 系统必须在商品列表页展示商品卡片，每个卡片包含：商品主图、名称、最小销售单位价格、推荐标签（如有）
- **FR-003**: 系统必须调用 `GET /api/client/menu-categories` 获取动态分类列表，并根据返回的分类数据渲染分类标签栏（仅显示 `isVisible=true` 的分类）
- **FR-004**: 系统必须支持分类筛选，用户点击分类标签后，使用该分类的 `id` 字段（UUID 格式）作为 `categoryId` 参数调用商品列表API进行筛选
- **FR-005**: 系统必须按以下规则排序商品列表：推荐商品（`isRecommended=true`）置顶显示并按 `sortOrder` 升序排序，非推荐商品置后显示并按 `sortOrder` 升序排序
- **FR-006**: 系统必须支持分页加载，用户滚动到列表底部时，自动加载下一页数据（默认每页20条）
- **FR-007**: 系统必须支持下拉刷新，用户下拉列表时，重新加载第一页数据并重置列表（仅刷新商品数据，不刷新分类列表，保持当前选中的分类）
- **FR-008**: 系统必须格式化商品价格，将后端返回的分单位价格（如2800）转换为元单位（¥28.00）
- **FR-009**: 系统必须处理图片加载失败，当商品主图加载失败时，显示默认占位图
- **FR-010**: 系统必须在数据加载中显示骨架屏或加载动画，提示用户"加载中..."
- **FR-011**: 系统必须处理API错误，网络异常或API失败时，显示错误提示和重试按钮
- **FR-012**: 系统必须支持商品卡片点击，点击后跳转到商品详情页（传递`productId`参数）
- **FR-013**: 系统必须缓存商品列表数据和分类列表数据，避免重复请求（使用TanStack Query缓存策略，默认缓存5分钟）
- **FR-014**: 系统必须在无商品数据时显示空状态提示，区分"暂无商品"和"加载失败"两种情况

### Key Entities

- **商品卡片（Product Card）**: 商品列表中的单个展示单元，包含商品ID、名称、主图URL、最小销售单位价格、推荐标签、分类、渠道等信息
- **分类标签（Category Tab）**: 商品分类导航栏中的单个标签，从 `menu_category` 表动态获取，包含分类ID（UUID）、分类编码（code，如"ALCOHOL"）、显示名称（displayName，如"经典特调"）、选中状态
- **商品列表响应（Product List Response）**: 后端API返回的数据结构，包含商品数组、总数、当前页、每页数量、是否有下一页等分页信息
- **菜单分类响应（Menu Category Response）**: 菜单分类API返回的数据结构，包含分类数组，每个分类包含id、code、displayName、iconUrl、productCount等字段

---

## Success Criteria

### Measurable Outcomes

- **SC-001**: 用户打开商品列表页，首屏商品（前20条）在2秒内完成加载并展示
- **SC-002**: 用户切换分类标签，筛选后的商品列表在1秒内完成加载并更新
- **SC-003**: 用户滚动到列表底部，下一页商品在1秒内完成追加加载
- **SC-004**: 商品列表支持至少200条商品的流畅滚动，无明显卡顿（帧率≥50fps）
- **SC-005**: 用户在网络异常或API失败时，能够看到清晰的错误提示和重试按钮，90%的用户能够通过重试成功加载数据
- **SC-006**: 商品卡片图片加载成功率达到95%以上（在正常网络环境下）
- **SC-007**: 用户完成商品列表浏览（滚动查看至少10个商品）并进入详情页的任务成功率达到85%以上

---

## Assumptions

1. **后端API已就绪**: 假设后端商品列表API（`/api/client/channel-products`）和菜单分类API（`/api/client/menu-categories`）已完成开发并部署，数据结构符合前端预期
2. **图片存储稳定**: 假设Supabase Storage的图片服务稳定可用，公开URL访问无需认证
3. **渠道参数固定**: 假设小程序渠道参数固定为`channel=MINIAPP`，无需动态配置
4. **分页默认值**: 假设后端分页默认每页20条，前端无需自定义分页大小
5. **商品详情页存在**: 假设商品详情页路由（`/pages/product-detail/index`）已存在或将同步开发，用于卡片点击跳转
6. **TanStack Query已集成**: 假设`miniapp-ordering-taro`项目已集成TanStack Query用于数据管理和缓存
7. **分类系统已迁移**: 假设后端已完成从硬编码枚举到 `menu_category` 表的迁移（参考 O008），菜单分类API可正常返回动态分类数据

---

## Dependencies

- **后端商品API**: 依赖`GET /api/client/channel-products`接口正常运行
- **后端菜单分类API**: 依赖`GET /api/client/menu-categories`接口正常运行，用于动态获取分类列表
- **Supabase Storage**: 依赖图片存储服务的稳定性和访问性能
- **TanStack Query**: 依赖该库的数据缓存、分页加载和错误处理功能
- **Taro组件库**: 依赖Taro的`ScrollView`、`Image`、`PullToRefresh`等组件
- **商品详情页**: 依赖详情页路由和页面的开发完成（可作为后续迭代）
- **O008-channel-product-category-migration**: 依赖分类系统从硬编码枚举迁移到数据库驱动的完成

---

## Out of Scope

以下功能不在本规格范围内，可作为后续迭代：

- **商品搜索**: 按关键词搜索商品功能
- **商品排序**: 按价格、销量、评分等维度排序
- **商品收藏**: 将商品添加到收藏夹
- **加入购物车**: 从列表页直接加入购物车（需先跳转详情页）
- **商品评价展示**: 在列表卡片显示评分或评论数
- **多选操作**: 批量加入购物车或批量收藏
- **个性化推荐**: 基于用户行为的智能推荐算法
- **实时库存展示**: 在列表卡片显示库存数量（当前仅显示"有货/无货"状态）

---

## Related Specs

- **O007-miniapp-menu-api**: 小程序菜单与商品API集成（阶段一），定义了商品API的基础接口和数据结构
- **O006-miniapp-channel-order**: 渠道商品配置功能，定义了商品数据模型和后端实现
- **O002-miniapp-menu-config**: 小程序菜单配置功能，定义了分类枚举和菜单结构
- **O008-channel-product-category-migration**: B端商品配置动态菜单分类集成，将分类系统从硬编码枚举迁移到数据库驱动（`menu_category` 表）
