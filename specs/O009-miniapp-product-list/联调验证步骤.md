# O009-miniapp-product-list 联调验证步骤

**Feature**: O009-miniapp-product-list
**验证日期**: 2026-01-05
**状态**: 待验证

---

## 一、验证概述

本文档用于验证 O009-miniapp-product-list 功能的完整性，包括后端 API 验证和前端功能验证。

### 验证目标

基于 spec.md 中定义的 5 个用户故事和 14 项功能需求，验证以下核心功能：

1. 商品列表 API 集成与数据展示
2. 分类标签动态获取与筛选功能
3. 下拉刷新功能
4. 错误处理与重试机制
5. 商品卡片交互

### 验证环境

| 组件 | 配置 |
|------|------|
| 前端项目 | `miniapp-ordering-taro` |
| 前端端口 | 10089 (H5 模式) |
| 后端端口 | 8080 |
| 后端 API | `http://localhost:8080/api/client/*` |
| 数据模式 | **直接调用后端 API**（已关闭 Mock） |

---

## 二、前置条件检查

### 2.1 后端服务状态（必须）

> ⚠️ **重要**: 前端已配置为直接调用后端 API（`USE_MOCK = false`），后端服务必须正常运行。

```bash
# 检查后端服务是否运行
curl -s http://localhost:8080/api/client/menu-categories | head -100
```

**预期结果**: 返回 JSON 格式的分类列表数据（真实数据库数据）

### 2.2 前端依赖安装

```bash
cd miniapp-ordering-taro
npm install
```

### 2.3 启动前端开发服务器

```bash
cd miniapp-ordering-taro
npm run dev:h5
```

**预期结果**: 服务启动在 http://localhost:10089

---

## 三、后端 API 验证

### 3.1 菜单分类 API

**接口**: `GET /api/client/menu-categories`

```bash
curl -X GET "http://localhost:8080/api/client/menu-categories" \
  -H "Content-Type: application/json"
```

**验证项**:
- [ ] 返回状态码 200
- [ ] 返回 JSON 格式数据
- [ ] data 数组包含分类对象
- [ ] 每个分类对象包含: id, code, displayName
- [ ] 仅返回 isVisible=true 的分类

**预期响应结构**:
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid-xxx",
      "code": "ALCOHOL",
      "displayName": "经典特调",
      "iconUrl": null,
      "productCount": 5
    }
  ]
}
```

### 3.2 商品列表 API（无分类筛选）

**接口**: `GET /api/client/channel-products/mini-program`

```bash
curl -X GET "http://localhost:8080/api/client/channel-products/mini-program" \
  -H "Content-Type: application/json"
```

**验证项**:
- [ ] 返回状态码 200
- [ ] 返回 JSON 格式数据
- [ ] data 数组包含商品对象
- [ ] 商品对象包含: id, productName, priceInCents, mainImageUrl, isRecommended, sortOrder

### 3.3 商品列表 API（分类筛选）

**接口**: `GET /api/client/channel-products/mini-program?categoryId={uuid}`

```bash
# 先获取分类 ID
CATEGORY_ID=$(curl -s "http://localhost:8080/api/client/menu-categories" | jq -r '.data[0].id')

# 使用分类 ID 筛选商品
curl -X GET "http://localhost:8080/api/client/channel-products/mini-program?categoryId=$CATEGORY_ID" \
  -H "Content-Type: application/json"
```

**验证项**:
- [ ] 返回状态码 200
- [ ] 返回的商品仅属于指定分类
- [ ] 分类 ID 不存在时返回空数组（非错误）

---

## 四、前端功能验证

### 4.1 用户故事 1：加载并展示商品列表 (P1)

**访问页面**: `http://localhost:10089/pages/menu/index`

#### 验证步骤

| 步骤 | 操作 | 预期结果 | 验证 |
|------|------|----------|------|
| 1 | 打开菜单页面 | 显示加载动画/骨架屏 | [ ] |
| 2 | 等待数据加载 | 商品列表展示 | [ ] |
| 3 | 查看商品卡片 | 每张卡片显示：图片、名称、价格 | [ ] |
| 4 | 验证价格格式 | 分单位转元（如 2800 → ¥28.00） | [ ] |
| 5 | 验证图片加载 | 图片正常显示或显示占位图 | [ ] |
| 6 | 验证推荐标签 | 推荐商品显示特殊标识 | [ ] |
| 7 | 验证排序 | 推荐商品置顶，按 sortOrder 排序 | [ ] |

#### 控制台检查

```javascript
// Chrome DevTools Console
// 检查 API 调用
// 预期看到: GET http://localhost:8080/api/client/channel-products/mini-program
// 确认返回真实后端数据
```

### 4.2 用户故事 2：按分类筛选商品 (P1)

**访问页面**: `http://localhost:10089/pages/menu/index`

#### 验证步骤

| 步骤 | 操作 | 预期结果 | 验证 |
|------|------|----------|------|
| 1 | 查看左侧分类栏 | 显示动态分类列表 | [ ] |
| 2 | 点击某个分类 | 该分类高亮显示 | [ ] |
| 3 | 等待列表刷新 | 显示该分类下的商品 | [ ] |
| 4 | 切换到另一分类 | 商品列表更新为新分类 | [ ] |
| 5 | 验证空分类 | 显示"暂无商品"提示 | [ ] |

#### 控制台检查

```javascript
// 检查分类 API 调用
// 预期看到: GET http://localhost:8080/api/client/menu-categories
// 确认返回真实后端分类数据
```

### 4.3 用户故事 3：下拉刷新 (P2)

**注意**: H5 模式下拉刷新可能需要特殊配置

#### 验证步骤

| 步骤 | 操作 | 预期结果 | 验证 |
|------|------|----------|------|
| 1 | 在列表页面下拉 | 触发刷新动画 | [ ] |
| 2 | 等待刷新完成 | 列表数据更新 | [ ] |
| 3 | 刷新时保持分类 | 当前选中分类不变 | [ ] |

### 4.4 用户故事 4：错误处理 (P2)

#### 模拟错误测试

**方法: 停止后端服务**

1. 停止后端服务 (kill 8080 端口)
2. 刷新前端页面
3. 观察错误处理行为

#### 验证步骤

| 步骤 | 操作 | 预期结果 | 验证 |
|------|------|----------|------|
| 1 | 模拟网络错误 | 显示"网络已断开"提示 | [ ] |
| 2 | 显示重试按钮 | 页面显示"重试"按钮 | [ ] |
| 3 | 点击重试 | 重新加载数据 | [ ] |
| 4 | 恢复网络后重试 | 成功加载数据 | [ ] |

### 4.5 用户故事 5：商品卡片交互 (P3)

#### 验证步骤

| 步骤 | 操作 | 预期结果 | 验证 |
|------|------|----------|------|
| 1 | 点击商品卡片 | 显示点击反馈 | [ ] |
| 2 | 触发跳转逻辑 | 显示 Toast 提示或跳转详情页 | [ ] |
| 3 | 点击添加按钮 | 触发添加回调（如有） | [ ] |

---

## 五、功能需求验证矩阵

基于 spec.md 中的 14 项功能需求：

| 需求ID | 描述 | 验证方法 | 状态 |
|--------|------|----------|------|
| FR-001 | 调用后端商品列表 API | 控制台检查网络请求 | [ ] |
| FR-002 | 商品卡片展示完整信息 | UI 验证 | [ ] |
| FR-003 | 调用菜单分类 API | 控制台检查网络请求 | [ ] |
| FR-004 | 分类筛选使用 categoryId | 检查请求参数 | [ ] |
| FR-005 | 推荐商品置顶排序 | UI 验证商品顺序 | [ ] |
| FR-006 | 支持分页加载 | 滚动到底部验证 | [ ] |
| FR-007 | 支持下拉刷新 | 下拉操作验证 | [ ] |
| FR-008 | 价格格式化（分→元） | UI 验证价格显示 | [ ] |
| FR-009 | 图片加载失败显示占位图 | 模拟图片加载失败 | [ ] |
| FR-010 | 加载中显示骨架屏 | 刷新页面观察 | [ ] |
| FR-011 | API 错误显示提示和重试按钮 | 模拟网络错误 | [ ] |
| FR-012 | 商品卡片可点击 | 点击卡片验证 | [ ] |
| FR-013 | 数据缓存（5分钟） | 切换页面后返回验证 | [ ] |
| FR-014 | 空数据显示空状态提示 | 选择无商品分类验证 | [ ] |

---

## 六、自动化验证脚本

### 6.1 后端 API 自动化验证

```bash
#!/bin/bash
# 文件: verify-backend-api.sh

echo "=== O009 后端 API 验证 ==="

# 1. 验证菜单分类 API
echo "1. 验证菜单分类 API..."
CATEGORIES_RESPONSE=$(curl -s "http://localhost:8080/api/client/menu-categories")
if echo "$CATEGORIES_RESPONSE" | jq -e '.data | length > 0' > /dev/null 2>&1; then
  echo "   ✅ 分类 API 返回数据成功"
  echo "   分类数量: $(echo "$CATEGORIES_RESPONSE" | jq '.data | length')"
else
  echo "   ❌ 分类 API 返回数据失败"
fi

# 2. 验证商品列表 API
echo "2. 验证商品列表 API..."
PRODUCTS_RESPONSE=$(curl -s "http://localhost:8080/api/client/channel-products/mini-program")
if echo "$PRODUCTS_RESPONSE" | jq -e '.data | length >= 0' > /dev/null 2>&1; then
  echo "   ✅ 商品列表 API 返回数据成功"
  echo "   商品数量: $(echo "$PRODUCTS_RESPONSE" | jq '.data | length')"
else
  echo "   ❌ 商品列表 API 返回数据失败"
fi

# 3. 验证分类筛选
echo "3. 验证分类筛选..."
FIRST_CATEGORY_ID=$(echo "$CATEGORIES_RESPONSE" | jq -r '.data[0].id')
if [ "$FIRST_CATEGORY_ID" != "null" ]; then
  FILTERED_RESPONSE=$(curl -s "http://localhost:8080/api/client/channel-products/mini-program?categoryId=$FIRST_CATEGORY_ID")
  echo "   ✅ 分类筛选 API 调用成功 (categoryId: $FIRST_CATEGORY_ID)"
  echo "   筛选后商品数量: $(echo "$FILTERED_RESPONSE" | jq '.data | length')"
else
  echo "   ⚠️ 无法获取分类 ID，跳过分类筛选验证"
fi

echo "=== 验证完成 ==="
```

### 6.2 前端 UI 自动化验证（Chrome DevTools）

```javascript
// 在 Chrome DevTools Console 中执行

(async function verifyO009() {
  console.log('=== O009 前端功能验证 ===');
  
  // 1. 检查分类侧边栏
  const categoryTabs = document.querySelectorAll('.category-item, .category-tab');
  console.log(`1. 分类标签数量: ${categoryTabs.length}`, categoryTabs.length > 0 ? '✅' : '❌');
  
  // 2. 检查商品卡片
  const productCards = document.querySelectorAll('.product-card, .grid-item');
  console.log(`2. 商品卡片数量: ${productCards.length}`, productCards.length > 0 ? '✅' : '❌');
  
  // 3. 检查商品图片
  const productImages = document.querySelectorAll('.product-image, .product-card img');
  const imagesWithSrc = Array.from(productImages).filter(img => img.src && !img.src.includes('undefined'));
  console.log(`3. 商品图片加载: ${imagesWithSrc.length}/${productImages.length}`, imagesWithSrc.length > 0 ? '✅' : '❌');
  
  // 4. 检查价格显示
  const priceElements = document.querySelectorAll('.price, .price-info, [class*="price"]');
  const validPrices = Array.from(priceElements).filter(el => el.textContent && el.textContent.includes('¥'));
  console.log(`4. 价格显示元素: ${validPrices.length}`, validPrices.length > 0 ? '✅' : '❌');
  
  // 5. 检查骨架屏组件
  const skeleton = document.querySelector('.skeleton, .loading, [class*="skeleton"]');
  console.log(`5. 骨架屏组件存在: ${skeleton ? '已加载' : '当前不可见'}`, '✅');
  
  // 6. 检查错误状态组件
  const errorState = document.querySelector('.error-state, [class*="error"]');
  console.log(`6. 错误状态组件: ${errorState ? '显示中' : '未显示（正常）'}`, '✅');
  
  console.log('=== 验证完成 ===');
})();
```

---

## 七、验证结论模板

### 验证结果汇总

| 验证类别 | 总项数 | 通过 | 失败 | 跳过 |
|----------|--------|------|------|------|
| 后端 API | 3 | - | - | - |
| US1 商品列表展示 | 7 | - | - | - |
| US2 分类筛选 | 5 | - | - | - |
| US3 下拉刷新 | 3 | - | - | - |
| US4 错误处理 | 4 | - | - | - |
| US5 卡片交互 | 3 | - | - | - |
| 功能需求 (FR) | 14 | - | - | - |

### 发现的问题

| 问题ID | 描述 | 严重程度 | 状态 |
|--------|------|----------|------|
| - | - | - | - |

### 验证结论

- [ ] **通过** - 所有验证项均通过，功能符合规格要求
- [ ] **有条件通过** - 核心功能通过，存在非阻塞问题
- [ ] **不通过** - 存在阻塞性问题，需要修复后重新验证

---

## 八、验证执行顺序

1. **启动服务** (5分钟)
   - 启动后端服务 (端口 8080)
   - 启动前端开发服务器 (端口 10089)

2. **后端 API 验证** (5分钟)
   - 执行 curl 命令验证 3 个 API

3. **前端功能验证** (15分钟)
   - 打开浏览器访问菜单页面
   - 按用户故事顺序验证功能
   - 使用 Chrome DevTools 检查网络请求和控制台输出

4. **问题记录与修复** (按需)
   - 记录发现的问题
   - 定位问题原因
   - 修复并重新验证

5. **填写验证结论** (5分钟)
   - 更新验证结果汇总
   - 记录最终结论

---

**文档版本**: 1.0
**创建日期**: 2026-01-05
**维护者**: Cinema Business Center Platform Team
