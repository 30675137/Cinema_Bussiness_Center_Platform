openapi: 3.0.3
info:
  title: SKU编辑页面数据加载API
  description: |
    SKU编辑页面数据加载修复功能的API契约定义

    **@spec P006-fix-sku-edit-data**

    本API提供SKU、SPU、BOM数据的聚合查询和SKU更新功能，支持：
    - 单次API调用加载完整SKU编辑页面数据
    - 乐观锁并发冲突检测
    - 部分加载失败场景的优雅降级
  version: 1.0.0
  contact:
    name: Cinema Business Center Platform
    email: dev@cinema-platform.com

servers:
  - url: http://localhost:8080
    description: 本地开发环境
  - url: https://api-staging.cinema-platform.com
    description: 预发布环境
  - url: https://api.cinema-platform.com
    description: 生产环境

tags:
  - name: SKU Management
    description: SKU管理相关API

paths:
  /api/skus/{id}/details:
    get:
      tags:
        - SKU Management
      summary: 获取SKU详情（聚合查询）
      description: |
        获取SKU详情，包含关联的SPU和BOM数据。

        **特性**:
        - 单次API调用返回SKU+SPU+BOM聚合数据
        - 支持部分加载失败场景（通过metadata字段标识）
        - 后端使用Caffeine缓存SPU数据（5分钟TTL）
        - 前端使用TanStack Query缓存（2分钟staleTime）

        **性能目标**:
        - 响应时间 <2秒 (P95)
        - 包含BOM时最多加载100个原料组成项
      operationId: getSKUDetails
      parameters:
        - name: id
          in: path
          required: true
          description: SKU的唯一标识符
          schema:
            type: string
            example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: 成功获取SKU详情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SKUDetailSuccessResponse'
              examples:
                完整数据加载成功:
                  $ref: '#/components/examples/FullDataSuccess'
                SPU未关联:
                  $ref: '#/components/examples/NoSPULinked'
                SPU已失效:
                  $ref: '#/components/examples/SPUInvalid'
                BOM加载失败:
                  $ref: '#/components/examples/BOMLoadFailed'
        '404':
          description: SKU不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                SKU不存在:
                  value:
                    success: false
                    error: "SKU_NTF_001"
                    message: "SKU不存在，请检查SKU ID"
                    details:
                      skuId: "550e8400-e29b-41d4-a716-446655440000"
                    timestamp: "2025-12-31T10:30:00Z"
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                内部错误:
                  value:
                    success: false
                    error: "SKU_SYS_001"
                    message: "服务器内部错误，请稍后重试"
                    details:
                      skuId: "550e8400-e29b-41d4-a716-446655440000"
                      errorType: "DatabaseConnectionTimeout"
                    timestamp: "2025-12-31T10:30:00Z"
      security:
        - bearerAuth: []

  /api/skus/{id}:
    put:
      tags:
        - SKU Management
      summary: 更新SKU信息
      description: |
        更新SKU基本信息，支持乐观锁并发冲突检测。

        **并发冲突检测**:
        - 请求必须包含`version`字段（乐观锁版本号）
        - 如果版本号不匹配，返回422错误并提示用户刷新
        - 前端显示覆盖警告弹窗："数据已被其他用户修改，您确认要覆盖吗？"

        **注意事项**:
        - SPU关联关系和BOM配方数据不会因此接口修改而丢失
        - 成功更新后版本号自动递增
      operationId: updateSKU
      parameters:
        - name: id
          in: path
          required: true
          description: SKU的唯一标识符
          schema:
            type: string
            example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SKUUpdateRequest'
            examples:
              更新价格:
                value:
                  price: 3500
                  version: 5
              更新状态:
                value:
                  status: "inactive"
                  version: 7
              完整更新:
                value:
                  name: "威士忌可乐鸡尾酒（限时促销）"
                  price: 2800
                  stockQuantity: 100
                  status: "active"
                  version: 3
      responses:
        '200':
          description: 成功更新SKU
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SKUUpdateSuccessResponse'
              examples:
                更新成功:
                  value:
                    success: true
                    data:
                      id: "550e8400-e29b-41d4-a716-446655440000"
                      code: "FIN-COCKTAIL"
                      name: "威士忌可乐鸡尾酒（限时促销）"
                      price: 2800
                      stockQuantity: 100
                      status: "active"
                      spuId: "660e8400-e29b-41d4-a716-446655440001"
                      version: 6
                      updatedAt: "2025-12-31T10:35:00Z"
                      updatedBy: "admin-001"
                    message: "SKU更新成功"
                    timestamp: "2025-12-31T10:35:00Z"
        '400':
          description: 请求参数验证失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                价格为负数:
                  value:
                    success: false
                    error: "SKU_VAL_002"
                    message: "价格不能为负数"
                    details:
                      field: "price"
                      invalidValue: -100
                    timestamp: "2025-12-31T10:30:00Z"
                缺少版本号:
                  value:
                    success: false
                    error: "SKU_VAL_004"
                    message: "版本号不能为空"
                    details:
                      field: "version"
                    timestamp: "2025-12-31T10:30:00Z"
        '404':
          description: SKU不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                SKU不存在:
                  value:
                    success: false
                    error: "SKU_NTF_001"
                    message: "SKU不存在，请检查SKU ID"
                    details:
                      skuId: "550e8400-e29b-41d4-a716-446655440000"
                    timestamp: "2025-12-31T10:30:00Z"
        '422':
          description: 并发冲突（版本号不匹配）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                版本冲突:
                  value:
                    success: false
                    error: "SKU_BIZ_001"
                    message: "数据已被其他用户修改，请刷新后重试"
                    details:
                      expectedVersion: 5
                      actualVersion: 7
                      lastUpdatedBy: "admin-002"
                      lastUpdatedAt: "2025-12-31T10:32:00Z"
                    timestamp: "2025-12-31T10:35:00Z"
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT认证，通过 Authorization header 传递 token

  schemas:
    # ============ 成功响应 ============
    SKUDetailSuccessResponse:
      type: object
      required:
        - success
        - data
        - timestamp
      properties:
        success:
          type: boolean
          example: true
          description: 请求是否成功
        data:
          $ref: '#/components/schemas/SKUDetailData'
        timestamp:
          type: string
          format: date-time
          example: "2025-12-31T10:30:00Z"
          description: 响应时间戳

    SKUDetailData:
      type: object
      required:
        - sku
        - spu
        - bom
        - metadata
      properties:
        sku:
          $ref: '#/components/schemas/SKU'
        spu:
          allOf:
            - $ref: '#/components/schemas/SPU'
          nullable: true
          description: 关联的SPU信息（可为null）
        bom:
          allOf:
            - $ref: '#/components/schemas/BOM'
          nullable: true
          description: 关联的BOM配方（可为null）
        metadata:
          $ref: '#/components/schemas/LoadMetadata'

    SKUUpdateSuccessResponse:
      type: object
      required:
        - success
        - data
        - timestamp
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/SKU'
        message:
          type: string
          example: "SKU更新成功"
        timestamp:
          type: string
          format: date-time
          example: "2025-12-31T10:35:00Z"

    # ============ 实体模型 ============
    SKU:
      type: object
      required:
        - id
        - code
        - name
        - price
        - stockQuantity
        - status
        - version
        - createdAt
        - updatedAt
        - createdBy
        - updatedBy
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
          description: SKU唯一标识符
        code:
          type: string
          example: "FIN-COCKTAIL"
          pattern: "^[A-Z0-9-]+$"
          minLength: 3
          maxLength: 50
          description: SKU编码（唯一）
        name:
          type: string
          example: "威士忌可乐鸡尾酒"
          minLength: 1
          maxLength: 100
          description: SKU名称
        price:
          type: integer
          example: 3500
          minimum: 0
          description: 销售价格（单位：分）
        stockQuantity:
          type: integer
          example: 50
          minimum: 0
          description: 库存数量
        status:
          type: string
          enum: [active, inactive, deleted]
          example: "active"
          description: SKU状态
        spuId:
          type: string
          format: uuid
          nullable: true
          example: "660e8400-e29b-41d4-a716-446655440001"
          description: 关联的SPU ID
        version:
          type: integer
          example: 5
          minimum: 0
          description: 乐观锁版本号
        createdAt:
          type: string
          format: date-time
          example: "2025-12-30T08:00:00Z"
          description: 创建时间
        updatedAt:
          type: string
          format: date-time
          example: "2025-12-31T10:30:00Z"
          description: 更新时间
        createdBy:
          type: string
          example: "admin-001"
          description: 创建人ID
        updatedBy:
          type: string
          example: "admin-001"
          description: 更新人ID

    SPU:
      type: object
      required:
        - id
        - name
        - categoryId
        - description
        - status
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          example: "660e8400-e29b-41d4-a716-446655440001"
          description: SPU唯一标识符
        name:
          type: string
          example: "威士忌可乐鸡尾酒"
          minLength: 1
          maxLength: 200
          description: 产品名称
        categoryId:
          type: string
          format: uuid
          example: "770e8400-e29b-41d4-a716-446655440002"
          description: 产品分类ID
        brandId:
          type: string
          format: uuid
          nullable: true
          example: "880e8400-e29b-41d4-a716-446655440003"
          description: 品牌ID（可选）
        description:
          type: string
          example: "威士忌与可乐的经典组合，口感醇厚清爽"
          maxLength: 2000
          description: 产品描述
        status:
          type: string
          enum: [valid, invalid]
          example: "valid"
          description: SPU状态
        createdAt:
          type: string
          format: date-time
          example: "2025-12-20T08:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-12-25T10:00:00Z"

    BOM:
      type: object
      required:
        - id
        - skuId
        - wasteRate
        - status
        - components
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          example: "990e8400-e29b-41d4-a716-446655440004"
          description: BOM唯一标识符
        skuId:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
          description: 关联的成品SKU ID
        name:
          type: string
          nullable: true
          example: "标准配方"
          maxLength: 100
          description: 配方名称（可选）
        wasteRate:
          type: number
          example: 5
          minimum: 0
          maximum: 100
          description: 损耗率（百分比）
        status:
          type: string
          enum: [active, inactive]
          example: "active"
          description: BOM状态
        components:
          type: array
          items:
            $ref: '#/components/schemas/BOMComponent'
          minItems: 1
          description: BOM组成项列表
        createdAt:
          type: string
          format: date-time
          example: "2025-12-20T08:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-12-25T10:00:00Z"

    BOMComponent:
      type: object
      required:
        - id
        - bomId
        - ingredientSkuId
        - ingredientSkuCode
        - ingredientSkuName
        - quantity
        - unit
        - status
        - sortOrder
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          example: "aa0e8400-e29b-41d4-a716-446655440005"
          description: BOM组成项唯一标识符
        bomId:
          type: string
          format: uuid
          example: "990e8400-e29b-41d4-a716-446655440004"
          description: 关联的BOM ID
        ingredientSkuId:
          type: string
          format: uuid
          example: "bb0e8400-e29b-41d4-a716-446655440006"
          description: 原料SKU ID
        ingredientSkuCode:
          type: string
          example: "MAT-WHISKEY"
          description: 原料SKU编码
        ingredientSkuName:
          type: string
          example: "威士忌（杰克丹尼）"
          description: 原料SKU名称
        quantity:
          type: number
          example: 45
          exclusiveMinimum: 0
          description: 用量
        unit:
          type: string
          enum: [ml, g, kg, 个, 瓶, 升]
          example: "ml"
          description: 单位
        standardCost:
          type: integer
          nullable: true
          example: 1200
          minimum: 0
          description: 标准成本（单位：分）
        status:
          type: string
          enum: [valid, invalid]
          example: "valid"
          description: 组成项状态
        sortOrder:
          type: integer
          example: 1
          minimum: 0
          description: 排序顺序
        createdAt:
          type: string
          format: date-time
          example: "2025-12-20T08:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-12-25T10:00:00Z"

    LoadMetadata:
      type: object
      required:
        - spuLoadSuccess
        - bomLoadSuccess
        - spuStatus
        - bomStatus
      properties:
        spuLoadSuccess:
          type: boolean
          example: true
          description: SPU加载是否成功
        bomLoadSuccess:
          type: boolean
          example: true
          description: BOM加载是否成功
        spuStatus:
          type: string
          enum: [valid, invalid, not_linked]
          example: "valid"
          description: SPU状态（valid=有效，invalid=失效，not_linked=未关联）
        bomStatus:
          type: string
          enum: [active, inactive, not_configured]
          example: "active"
          description: BOM状态（active=有效，inactive=禁用，not_configured=未配置）

    # ============ 请求模型 ============
    SKUUpdateRequest:
      type: object
      required:
        - version
      properties:
        code:
          type: string
          pattern: "^[A-Z0-9-]+$"
          minLength: 3
          maxLength: 50
          description: SKU编码（可选，通常不允许修改）
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: SKU名称
        price:
          type: integer
          minimum: 0
          description: 销售价格（单位：分）
        stockQuantity:
          type: integer
          minimum: 0
          description: 库存数量
        status:
          type: string
          enum: [active, inactive, deleted]
          description: SKU状态
        spuId:
          type: string
          format: uuid
          nullable: true
          description: 关联的SPU ID
        version:
          type: integer
          minimum: 0
          description: 乐观锁版本号（必填）

    # ============ 错误响应 ============
    ErrorResponse:
      type: object
      required:
        - success
        - error
        - message
        - timestamp
      properties:
        success:
          type: boolean
          example: false
          description: 请求是否成功
        error:
          type: string
          example: "SKU_NTF_001"
          description: 错误编号（格式：<模块>_<类别>_<序号>）
        message:
          type: string
          example: "SKU不存在，请检查SKU ID"
          description: 错误消息
        details:
          type: object
          additionalProperties: true
          description: 错误详细信息（可选）
        timestamp:
          type: string
          format: date-time
          example: "2025-12-31T10:30:00Z"
          description: 响应时间戳

  # ============ 响应示例 ============
  examples:
    FullDataSuccess:
      summary: 完整数据加载成功
      description: SKU、SPU、BOM数据全部加载成功
      value:
        success: true
        data:
          sku:
            id: "550e8400-e29b-41d4-a716-446655440000"
            code: "FIN-COCKTAIL"
            name: "威士忌可乐鸡尾酒"
            price: 3500
            stockQuantity: 50
            status: "active"
            spuId: "660e8400-e29b-41d4-a716-446655440001"
            version: 5
            createdAt: "2025-12-30T08:00:00Z"
            updatedAt: "2025-12-31T10:30:00Z"
            createdBy: "admin-001"
            updatedBy: "admin-001"
          spu:
            id: "660e8400-e29b-41d4-a716-446655440001"
            name: "威士忌可乐鸡尾酒"
            categoryId: "770e8400-e29b-41d4-a716-446655440002"
            brandId: null
            description: "威士忌与可乐的经典组合，口感醇厚清爽"
            status: "valid"
            createdAt: "2025-12-20T08:00:00Z"
            updatedAt: "2025-12-25T10:00:00Z"
          bom:
            id: "990e8400-e29b-41d4-a716-446655440004"
            skuId: "550e8400-e29b-41d4-a716-446655440000"
            name: "标准配方"
            wasteRate: 5
            status: "active"
            components:
              - id: "aa0e8400-e29b-41d4-a716-446655440005"
                bomId: "990e8400-e29b-41d4-a716-446655440004"
                ingredientSkuId: "bb0e8400-e29b-41d4-a716-446655440006"
                ingredientSkuCode: "MAT-WHISKEY"
                ingredientSkuName: "威士忌（杰克丹尼）"
                quantity: 45
                unit: "ml"
                standardCost: 1200
                status: "valid"
                sortOrder: 1
                createdAt: "2025-12-20T08:00:00Z"
                updatedAt: "2025-12-25T10:00:00Z"
              - id: "cc0e8400-e29b-41d4-a716-446655440007"
                bomId: "990e8400-e29b-41d4-a716-446655440004"
                ingredientSkuId: "dd0e8400-e29b-41d4-a716-446655440008"
                ingredientSkuCode: "MAT-COLA"
                ingredientSkuName: "可乐（可口可乐）"
                quantity: 150
                unit: "ml"
                standardCost: 300
                status: "valid"
                sortOrder: 2
                createdAt: "2025-12-20T08:00:00Z"
                updatedAt: "2025-12-25T10:00:00Z"
              - id: "ee0e8400-e29b-41d4-a716-446655440009"
                bomId: "990e8400-e29b-41d4-a716-446655440004"
                ingredientSkuId: "ff0e8400-e29b-41d4-a716-446655440010"
                ingredientSkuCode: "MAT-GLASS"
                ingredientSkuName: "玻璃杯（350ml）"
                quantity: 1
                unit: "个"
                standardCost: 500
                status: "valid"
                sortOrder: 3
                createdAt: "2025-12-20T08:00:00Z"
                updatedAt: "2025-12-25T10:00:00Z"
              - id: "110e8400-e29b-41d4-a716-446655440011"
                bomId: "990e8400-e29b-41d4-a716-446655440004"
                ingredientSkuId: "220e8400-e29b-41d4-a716-446655440012"
                ingredientSkuCode: "MAT-STRAW"
                ingredientSkuName: "吸管（一次性）"
                quantity: 1
                unit: "个"
                standardCost: 10
                status: "valid"
                sortOrder: 4
                createdAt: "2025-12-20T08:00:00Z"
                updatedAt: "2025-12-25T10:00:00Z"
            createdAt: "2025-12-20T08:00:00Z"
            updatedAt: "2025-12-25T10:00:00Z"
          metadata:
            spuLoadSuccess: true
            bomLoadSuccess: true
            spuStatus: "valid"
            bomStatus: "active"
        timestamp: "2025-12-31T10:30:00Z"

    NoSPULinked:
      summary: SKU未关联SPU
      description: SKU数据加载成功，但未关联任何SPU
      value:
        success: true
        data:
          sku:
            id: "550e8400-e29b-41d4-a716-446655440000"
            code: "FIN-COCKTAIL"
            name: "威士忌可乐鸡尾酒"
            price: 3500
            stockQuantity: 50
            status: "active"
            spuId: null
            version: 5
            createdAt: "2025-12-30T08:00:00Z"
            updatedAt: "2025-12-31T10:30:00Z"
            createdBy: "admin-001"
            updatedBy: "admin-001"
          spu: null
          bom: null
          metadata:
            spuLoadSuccess: true
            bomLoadSuccess: true
            spuStatus: "not_linked"
            bomStatus: "not_configured"
        timestamp: "2025-12-31T10:30:00Z"

    SPUInvalid:
      summary: SPU已失效（脏数据）
      description: SKU关联的SPU在数据库中已被删除或失效
      value:
        success: true
        data:
          sku:
            id: "550e8400-e29b-41d4-a716-446655440000"
            code: "FIN-COCKTAIL"
            name: "威士忌可乐鸡尾酒"
            price: 3500
            stockQuantity: 50
            status: "active"
            spuId: "660e8400-e29b-41d4-a716-446655440001"
            version: 5
            createdAt: "2025-12-30T08:00:00Z"
            updatedAt: "2025-12-31T10:30:00Z"
            createdBy: "admin-001"
            updatedBy: "admin-001"
          spu: null
          bom: null
          metadata:
            spuLoadSuccess: false
            bomLoadSuccess: true
            spuStatus: "invalid"
            bomStatus: "not_configured"
        timestamp: "2025-12-31T10:30:00Z"

    BOMLoadFailed:
      summary: BOM数据加载失败
      description: SKU和SPU加载成功，但BOM数据加载失败（网络错误或数据库异常）
      value:
        success: true
        data:
          sku:
            id: "550e8400-e29b-41d4-a716-446655440000"
            code: "FIN-COCKTAIL"
            name: "威士忌可乐鸡尾酒"
            price: 3500
            stockQuantity: 50
            status: "active"
            spuId: "660e8400-e29b-41d4-a716-446655440001"
            version: 5
            createdAt: "2025-12-30T08:00:00Z"
            updatedAt: "2025-12-31T10:30:00Z"
            createdBy: "admin-001"
            updatedBy: "admin-001"
          spu:
            id: "660e8400-e29b-41d4-a716-446655440001"
            name: "威士忌可乐鸡尾酒"
            categoryId: "770e8400-e29b-41d4-a716-446655440002"
            brandId: null
            description: "威士忌与可乐的经典组合，口感醇厚清爽"
            status: "valid"
            createdAt: "2025-12-20T08:00:00Z"
            updatedAt: "2025-12-25T10:00:00Z"
          bom: null
          metadata:
            spuLoadSuccess: true
            bomLoadSuccess: false
            spuStatus: "valid"
            bomStatus: "not_configured"
        timestamp: "2025-12-31T10:30:00Z"
