# 功能规格说明：单位换算系统

**功能分支**: `P002-unit-conversion`
**创建日期**: 2025-12-25
**状态**: 草稿
**输入**: 用户描述："实现 FR-02 配置单位换算体系，支持瓶↔ml↔杯、g↔份等换算链，包括单位换算关系表和配置界面开发"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 配置基础单位换算 (优先级: P1)

作为系统管理员，我需要配置基础单位换算关系（例如 1瓶 = 750ml，1杯 = 150ml），以便系统在计算 BOM 组件和库存扣减时能够自动进行单位换算。

**优先级原因**: 这是所有其他单位换算功能的基础能力。没有这个功能，系统无法在包装单位和计量单位之间进行任何自动换算。

**独立测试**: 可以通过在配置界面创建换算规则（例如"1瓶 = 750ml"）并验证规则正确保存和检索来完整测试。通过建立换算关系数据模型立即交付价值。

**验收场景**:

1. **假设** 我在单位换算配置页面，**当** 我创建新的换算规则"1瓶 = 750ml"，**那么** 规则成功保存并出现在换算列表中
2. **假设** 存在一条换算规则，**当** 我编辑规则将"750ml"改为"700ml"，**那么** 更新后的规则被保存并在系统中生效
3. **假设** 存在多条换算规则，**当** 我查看换算列表，**那么** 我看到所有配置的规则按基础单位分组显示
4. **假设** 我尝试创建重复的换算规则（相同的源单位/目标单位），**当** 我提交表单，**那么** 我收到错误消息提示规则已存在

---

### 用户故事 2 - 在 BOM 计算中应用换算 (优先级: P2)

作为吧台经理，当我使用不同单位定义 BOM 配方时（例如"从750ml瓶装威士忌中取45ml"），系统应该自动计算将以基础计量单位扣减多少库存。

**优先级原因**: 这使换算系统能够在实际业务场景中得到应用，将配置连接到实际运营工作流。

**独立测试**: 可以通过创建混合单位的 BOM（例如配方指定"1杯 = 150ml"但库存以ml为单位跟踪）并验证系统在使用配方时正确计算ml扣减来测试。

**验收场景**:

1. **假设** BOM 配方需要"1杯"可乐且存在换算规则"1杯 = 150ml"，**当** 创建订单时，**那么** 系统正确从可乐库存预占150ml
2. **假设** BOM 配方需要"45ml"威士忌且库存以瓶为单位跟踪（1瓶 = 750ml），**当** 处理订单时，**那么** 系统正确计算扣减0.06瓶（45/750）
3. **假设** 存在换算链（1瓶 = 750ml，1杯 = 150ml），**当** 计算多个组件需求时，**那么** 所有换算都被正确应用
4. **假设** 缺少所需的换算规则，**当** 处理 BOM 时，**那么** 系统显示错误提示指明需要哪个换算规则

---

### 用户故事 3 - 处理换算中的舍入规则 (优先级: P3)

作为系统管理员，我需要为单位换算配置舍入规则（例如四舍五入到0.1ml或1ml），以便库存扣减精确且符合业务惯例。

**优先级原因**: 这是改善精度并与业务惯例对齐的增强功能。虽然对准确性很重要，但不会阻碍基本功能。

**独立测试**: 可以通过配置舍入规则（例如"ml保留1位小数"）并验证所有库存计算都遵守该规则来测试。通过确保所有计算的一致精度来交付价值。

**验收场景**:

1. **假设** 舍入规则设置为"ml保留1位小数"，**当** 计算结果为45.67ml，**那么** 系统四舍五入为45.7ml
2. **假设** 舍入规则设置为"g取整数"，**当** 计算结果为12.8g，**那么** 系统四舍五入为13g
3. **假设** 不同单位类型有不同的舍入规则，**当** 处理多组件 BOM 时，**那么** 每个组件遵守其单位类型的舍入规则
4. **假设** 某单位未配置舍入规则，**当** 发生计算时，**那么** 系统使用默认精度2位小数

---

### 边界情况

- 尝试建立循环换算时会发生什么（例如 A→B→C→A）？
- 中间步骤产生非常小的分数时系统如何处理换算（例如 0.00001ml）？
- 如果用户删除当前在活跃 BOM 中使用的换算规则会发生什么？
- 系统如何处理不兼容单位类型之间的换算（例如没有密度数据的ml到克的换算）？
- 更新换算规则影响现有库存预占时会发生什么？

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须支持配置基础单位之间的换算关系（瓶、L、ml、g、份、个、杯）
- **FR-002**: 系统必须支持换算链（例如 1瓶 = 750ml；1杯 = 150ml，其中杯是销售单位，ml是库存计量单位）
- **FR-003**: 系统必须在创建/编辑换算规则时实时检测循环依赖，当检测到回路时显示具体的回路路径（例如："检测到循环：A→B→C→A"）并阻止保存
- **FR-004**: 系统必须允许管理员通过 `/bom/conversion` 界面创建、读取、更新和删除换算规则
- **FR-005**: 系统必须在计算 BOM 组件需求时自动应用换算规则
- **FR-006**: 系统必须支持按单位类型（体积/重量/计数）配置默认舍入规则（例如体积类保留1位小数，重量类保留0位小数），该类型下所有单位换算默认使用此精度
- **FR-007**: 系统必须在尝试处理需要缺失换算规则的 BOM 时显示清晰的错误消息
- **FR-008**: 系统必须支持双向换算（如果 1瓶 = 750ml，那么 1ml = 1/750 瓶）
- **FR-009**: 系统必须防止删除被任何 BOM（包括草稿和已发布状态）引用的换算规则，删除前实时检查所有 BOM 的引用关系
- **FR-010**: 系统必须将换算规则存储在前后端都可访问的专用数据库表中
- **FR-011**: 系统必须验证换算规则输入（仅正数，有效的单位类型）
- **FR-012**: 系统必须支持同一基础单位的多个换算路径（例如 1瓶 = 750ml 且 1瓶 = 0.75L），当多条路径存在时，自动选择最短路径（最少中间步骤）进行计算
- **FR-013**: 前端界面必须遵循 UIDEMO 参考设计的布局结构和交互逻辑（包括：统计卡片、搜索过滤、模态框表单、可视化换算链、实时验证反馈），样式元素（颜色、字体、间距）可根据项目设计规范调整

### 关键实体

- **单位换算规则** (对应表 `unit_conversions`): 表示两个单位之间的换算关系。字段包括：
  - `from_unit` (源单位，如"瓶")
  - `to_unit` (目标单位，如"ml")
  - `conversion_rate` (换算率，1 源单位 = ? 目标单位)
  - `category` (类别，值为：'volume'/'weight'/'quantity')
  - 唯一约束确保同一对 (from_unit, to_unit) 只能有一条规则
- **单位类型配置** (需新建配置表或使用应用配置): 管理三种单位类别的默认舍入精度：
  - 'volume'（体积）→ 前端显示为 VOLUME
  - 'weight'（重量）→ 前端显示为 WEIGHT
  - 'quantity'（数量）→ 前端显示为 COUNT
  - 每个类别对应默认舍入小数位（例如：体积 1 位，重量 0 位）
- **BOM 组件**: 引用单位换算规则，基于配方数量和换算率计算实际库存扣减。

## 成功标准 *(必填)*

### 可衡量的成果

- **SC-001**: 管理员能够在30秒内创建和配置一条单位换算规则
- **SC-002**: 使用转换单位的 BOM 计算在100毫秒内完成（最多10个组件的配方）
- **SC-003**: 系统能正确处理最多5个中间步骤的换算链而无计算错误
- **SC-004**: 应用换算规则时，100% 的库存扣减与预期值匹配（计算错误零容忍）
- **SC-005**: 用户能够成功完成端到端工作流（配置换算 → 创建 BOM → 处理订单 → 验证库存扣减）而不遇到错误
- **SC-006**: 系统防止100%的无效换算配置（循环依赖、负值、不兼容单位）被保存

## 假设 *(可选)*

- 所有单位都假定为标准单位（例如 ml 是毫升，而不是任何自定义计量）
- 换算系数假定在配置时固定，不因上下文而变化（例如温度、压力）
- 系统假定基于密度的换算（例如将液体的ml转换为克）不在此功能范围内
- `/bom/conversion` 菜单项已存在于导航结构中
- 访问换算配置界面的用户认证和授权已经实现
- **复用现有数据库表 `unit_conversions`（由 V028 迁移脚本创建），不创建新表**
- 现有表中已包含基础换算数据（ml↔l, g↔kg 等），本功能将扩展支持更多换算规则
- 现有表的 `category` 字段使用小写值（'volume'/'weight'/'quantity'），前端需要进行大小写映射

## 依赖项 *(可选)*

- 现有 SKU 主数据系统（瓶、ml、杯、g 等单位定义必须已存在）
- 现有 BOM 配置界面（用于集成换算计算）
- **V028 数据库迁移脚本已执行**，`unit_conversions` 表已存在，包含以下结构：
  - `id` (UUID, 主键)
  - `from_unit` (VARCHAR(20), 源单位)
  - `to_unit` (VARCHAR(20), 目标单位)
  - `conversion_rate` (DECIMAL(10,6), 换算率)
  - `category` (VARCHAR(20), 类别：'volume'/'weight'/'quantity')
  - 唯一约束：(from_unit, to_unit)
- **基础换算数据已存在**（由 V028 插入），包括：
  - 体积换算：ml↔l, ml↔升, l↔升
  - 重量换算：g↔kg, g↔克, kg↔千克, 千克↔g
  - 数量换算：个↔打, 瓶↔箱, 片↔包, 根↔包, 个↔件, 杯↔个, 桶↔个
- 后端 API 框架用于暴露换算规则的 CRUD 操作

## 范围外 *(可选)*

- 需要额外物理属性的复杂密度换算（例如将非标准液体的ml转换为克）
- 根据外部因素变化的动态换算率（例如汇率、市场价格）
- 换算规则变更的历史跟踪（审计日志）
- 换算规则的批量导入/导出
- 单位名称的多语言支持
- 与外部单位换算 API 或服务的集成

## 澄清事项

### 会话 2025-12-25

- Q: 当系统存在多个换算路径时（例如：瓶→ml 直接换算 且 瓶→L→ml 间接换算），系统应该如何处理？ → A: 支持多路径但仅应用最短路径（最少中间步骤）
- Q: FR-009 提到"防止删除当前在活跃 BOM 中被引用的换算规则"，这里的"活跃 BOM"具体指什么范围？ → A: 实时检查所有 BOM（包括草稿和已发布），如有引用则阻止删除
- Q: FR-003 提到"验证换算规则在数学上是一致的（无循环依赖）"，系统应该何时进行循环依赖检测？ → A: 创建/编辑时实时检测，显示具体回路路径并阻止保存
- Q: FR-006 提到"按单位类型配置舍入规则"，舍入规则的配置粒度应该是什么？ → A: 按单位类型（体积/重量/计数）配置默认舍入规则
- Q: 用户提到"实现过程前端 UI 要参考 UIDEMO 下的文件"，这个参考的约束程度是什么？ → A: 必须遵循 UI 布局和交互逻辑，样式（颜色/字体/间距）可调整
- **补充说明**: 复用现有数据库表 `unit_conversions`（V028 迁移脚本创建）及其基础换算数据（ml↔l, g↔kg等），不创建新表。需注意表中 category 字段使用小写值 ('volume'/'weight'/'quantity')，前端需要映射为大写显示
