# Implementation Plan: 单位换算系统

**Branch**: `P002-unit-conversion` | **Date**: 2025-12-25 | **Spec**: [specs/P002-unit-conversion/spec.md](./spec.md)
**Input**: Feature specification from `/specs/P002-unit-conversion/spec.md`

## Summary

实现单位换算配置系统，支持 BOM/配方组件的多级换算链（瓶↔ml↔杯、g↔份等）。系统复用现有 `unit_conversions` 表（V028 迁移脚本已创建），提供 CRUD 管理界面和换算计算服务。前端参考 UIDEMO 设计实现统计卡片、搜索过滤、模态框表单和可视化换算链展示。后端新增 Spring Boot Controller/Service 层暴露 REST API。

## Technical Context

**Language/Version**:
- B端（管理后台）: TypeScript 5.9.3 + React 19.2.0 (frontend), Java 21 + Spring Boot 3.x (backend)

**Primary Dependencies**:
- B端前端: Ant Design 6.1.0, Zustand 5.0.9, TanStack Query 5.90.12, React Router 7.10.1, MSW 2.12.4, Zod 4.1.13
- B端后端: Spring Boot Web, Supabase Java Client, Jakarta Validation

**Storage**:
- 复用现有 Supabase PostgreSQL 表 `unit_conversions`（V028 迁移脚本已创建）
- 表结构: id(UUID), from_unit(VARCHAR), to_unit(VARCHAR), conversion_rate(DECIMAL), category(VARCHAR)
- 前端开发阶段使用 MSW + localStorage 进行 Mock

**Testing**:
- B端: Vitest (unit tests) + Playwright (e2e tests) + Testing Library

**Target Platform**:
- B端: Web browser (Chrome, Firefox, Safari, Edge) + Spring Boot backend API

**Project Type**:
- Full-stack web application (Spring Boot backend + React frontend for B端 admin interface)
- 本功能仅涉及 B端管理后台，不涉及 C端

**Performance Goals**:
- 管理员能够在30秒内创建换算规则 (SC-001)
- BOM 计算在100毫秒内完成（最多10个组件） (SC-002)
- 支持最多5个中间步骤的换算链 (SC-003)

**Constraints**:
- 复用现有 `unit_conversions` 表，不创建新表
- 前端需要将数据库中的小写 category ('volume'/'weight'/'quantity') 映射为大写显示 (VOLUME/WEIGHT/COUNT)
- 必须遵循 UIDEMO 参考设计的布局结构和交互逻辑

**Scale/Scope**:
- 单页面 CRUD 管理界面
- 预估数据规模: 50-200 条换算规则

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### 必须满足的宪法原则检查：

- [x] **功能分支绑定**: 当前分支 `P002-unit-conversion` = active_spec `specs/P002-unit-conversion` ✓
- [x] **测试驱动开发**: 将先编写单元测试和 E2E 测试，确保关键业务流程测试覆盖率100%
- [x] **组件化架构**: 前端组件将遵循原子设计理念分层（atoms/molecules/organisms）
- [x] **前端技术栈分层**: 本功能仅涉及 B端，使用 React + Ant Design，不涉及 C端
- [x] **数据驱动状态管理**: 使用 TanStack Query 管理 API 数据，Zustand 管理 UI 状态
- [x] **代码质量工程化**: TypeScript 严格模式，ESLint + Prettier，所有质量门禁
- [x] **后端技术栈约束**: 使用 Spring Boot + Supabase，复用现有表结构

### 性能与标准检查：
- [x] **性能标准**: 页面切换<500ms，换算计算<100ms
- [x] **安全标准**: 使用 Zod 数据验证，Spring Boot 后端验证
- [x] **可访问性标准**: 遵循 WCAG 2.1 AA，支持键盘导航

## Project Structure

### Documentation (this feature)

```text
specs/P002-unit-conversion/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output (OpenAPI spec)
│   └── api.yaml
├── UIDEMO/              # UI reference designs
│   ├── ConversionManagement.tsx
│   ├── 换算管理.jpg
│   └── 换算管理-添加规则.jpg
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
frontend/src/
├── features/
│   └── unit-conversion/         # Feature module
│       ├── components/          # Feature-specific components
│       │   ├── ConversionList.tsx
│       │   ├── ConversionForm.tsx
│       │   ├── ConversionStats.tsx
│       │   └── ConversionChainGraph.tsx
│       ├── hooks/               # Custom hooks
│       │   ├── useConversions.ts
│       │   └── useConversionCalculation.ts
│       ├── services/            # API services
│       │   └── conversionService.ts
│       ├── types/               # TypeScript types
│       │   └── index.ts
│       └── utils/               # Utility functions
│           ├── cycleDetection.ts
│           └── pathFinding.ts
├── pages/
│   └── bom/
│       └── ConversionPage.tsx   # Route: /bom/conversion
└── mocks/
    └── handlers/
        └── conversion.ts        # MSW mock handlers

backend/src/main/java/com/cinema/
├── unitconversion/              # Feature package
│   ├── controller/
│   │   └── UnitConversionController.java
│   ├── service/
│   │   ├── UnitConversionService.java
│   │   └── ConversionPathService.java
│   ├── repository/
│   │   └── UnitConversionRepository.java
│   ├── domain/
│   │   └── UnitConversion.java
│   └── dto/
│       ├── UnitConversionDto.java
│       ├── CreateConversionRequest.java
│       └── ConversionPathResponse.java
```

**Structure Decision**: 前端采用 feature-based 模块化架构，后端新增 `unitconversion` 包遵循现有项目分层结构（controller/service/repository/domain/dto）。

## Complexity Tracking

> **No violations detected. All requirements align with constitution principles.**

| Aspect | Assessment |
|--------|------------|
| 数据库表 | 复用现有 `unit_conversions` 表，无需新建 |
| 技术栈 | 完全符合 B端 React + Ant Design + Spring Boot 要求 |
| 测试策略 | TDD 流程：先写测试，后写实现 |
