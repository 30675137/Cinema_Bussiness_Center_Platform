# Research: 前端路径结构优化

**Date**: 2025-01-27  
**Feature**: 006-frontend-structure-refactor

## 研究目标

本研究的目的是确定前端路径结构重构的最佳实践，包括文件合并策略、路径别名更新方法、依赖合并策略等关键技术决策。

## 技术调研

### 1. 文件合并策略

#### 问题
- 根目录 `src/` 和 `frontend/src/` 可能存在同名文件
- `frontend/Cinema_Operation_Admin/src/` 和 `frontend/src/` 可能存在同名文件
- 如何安全地合并这些文件而不丢失数据？

#### 决策
**采用分层合并策略**：
1. **优先级顺序**：
   - `frontend/src/` 中的文件优先级最高（保留现有功能）
   - `Cinema_Operation_Admin/src/` 中的文件作为参考
   - 根目录 `src/` 中的文件优先级最低

2. **冲突处理策略**：
   - 如果文件名相同但内容不同，需要进行手动审查
   - 优先保留 `frontend/src/` 中的版本
   - 如果 `Cinema_Operation_Admin/src/` 中的版本更新或更完整，需要手动合并
   - 创建冲突报告文件，记录所有需要手动处理的文件

3. **文件复制策略**：
   - 使用文件系统操作进行复制，而非移动
   - 保留源文件直到验证完成
   - 使用递归复制确保目录结构完整

#### 理由
- 保证现有功能的稳定性，避免引入破坏性变更
- 提供明确的冲突解决流程
- 可追溯性：保留源文件便于回滚

#### 替代方案考虑
- **方案A**: 完全覆盖（被拒绝）— 风险太高，可能丢失重要代码
- **方案B**: 使用 Git merge 工具（被拒绝）— 这些是不同的目录结构，不适合用 Git 合并
- **方案C**: 手动逐个审查（被拒绝）— 效率太低，文件数量太多

### 2. 路径别名更新策略

#### 问题
- `@admin/*` 别名当前指向 `Cinema_Operation_Admin/src/*`
- 合并后需要将所有 `@admin/*` 引用更新为 `@/*`
- 如何批量更新导入路径？

#### 决策
**采用分阶段更新策略**：

1. **查找所有引用**：
   - 使用正则表达式搜索：`@admin/` 或 `from ['"]@admin`
   - 记录所有使用 `@admin` 别名的文件位置

2. **更新导入语句**：
   - 将 `@admin/path/to/file` 替换为 `@/path/to/file`
   - 确保路径在合并后的目录结构中正确

3. **更新配置文件**：
   - `vite.config.ts`: 移除 `@admin` 别名配置
   - `tsconfig.app.json`: 移除 `@admin/*` 路径映射

4. **验证更新**：
   - 运行 TypeScript 类型检查确保路径解析正确
   - 运行 ESLint 检查导入错误

#### 理由
- 系统化方法确保不遗漏任何引用
- 分阶段进行便于验证和回滚
- 使用工具自动化减少人工错误

#### 替代方案考虑
- **方案A**: 手动查找替换（被拒绝）— 容易遗漏，效率低
- **方案B**: 使用 IDE 的全局替换（部分采用）— 需要配合代码审查

### 3. package.json 依赖合并策略

#### 问题
- `frontend/package.json` 和 `Cinema_Operation_Admin/package.json` 都需要依赖项
- 如何合并依赖而不冲突？

#### 决策
**采用依赖合并策略**：

1. **依赖项合并规则**：
   - 对于相同的包，保留版本号较高的版本
   - 对于不同的包，全部合并到 `frontend/package.json`
   - 对于冲突的版本，优先使用 `frontend/package.json` 中的版本

2. **scripts 合并**：
   - 合并所有脚本命令
   - 确保命令不冲突

3. **其他字段合并**：
   - 保留 `frontend/package.json` 中的主要配置（name, version 等）
   - 合并 devDependencies 和 dependencies

#### 理由
- 保证依赖的完整性，不丢失任何包
- 使用较新版本提高安全性
- 保持主项目配置的一致性

#### 替代方案考虑
- **方案A**: 完全使用 frontend/package.json（被拒绝）— 可能丢失 Cinema_Operation_Admin 特有的依赖
- **方案B**: 完全使用 Cinema_Operation_Admin/package.json（被拒绝）— 可能丢失 frontend 的依赖和配置

### 4. 测试配置文件合并

#### 问题
- 可能存在多个 `playwright.config.ts` 和 `vitest.config.ts`
- 如何统一测试配置？

#### 决策
**采用配置合并策略**：

1. **Playwright 配置**：
   - 保留 `frontend/playwright.config.ts` 作为主配置
   - 合并测试目录路径
   - 合并测试匹配模式

2. **Vitest 配置**：
   - 保留 `frontend/vitest.config.ts` 作为主配置
   - 合并测试目录路径和匹配模式
   - 合并覆盖率配置

3. **测试 setup 文件**：
   - 合并 `tests/setup.ts` 文件
   - 确保所有必要的测试工具都被引入

#### 理由
- 统一的测试配置便于维护
- 保持测试环境的一致性
- 确保所有测试都能正常运行

### 5. 构建和类型检查验证

#### 问题
- 如何确保重构后项目能够正常构建？
- 如何确保所有类型检查通过？

#### 决策
**采用分阶段验证策略**：

1. **阶段1 - 文件合并后**：
   - 运行 `npm run build` 验证构建
   - 运行 `tsc --noEmit` 验证类型
   - 检查是否有路径解析错误

2. **阶段2 - 路径更新后**：
   - 再次运行类型检查
   - 运行 ESLint 检查导入错误
   - 运行 `npm run dev` 验证开发服务器

3. **阶段3 - 删除目录前**：
   - 运行完整测试套件
   - 进行手动功能测试
   - 确认所有功能正常

#### 理由
- 及早发现问题，降低修复成本
- 分阶段验证确保每个步骤都正确
- 全面的测试保证功能完整性

## 关键技术决策总结

| 决策项 | 决策 | 理由 |
|--------|------|------|
| 文件合并优先级 | frontend/src/ > Cinema_Operation_Admin/src/ > 根目录 src/ | 保证现有功能稳定性 |
| 冲突处理 | 手动审查 + 冲突报告 | 确保不丢失重要代码 |
| 路径别名更新 | 批量替换 @admin 为 @/ | 系统化处理，不遗漏 |
| 依赖合并 | 保留高版本 + 合并所有包 | 保证依赖完整性 |
| 测试配置 | 合并配置 + 统一目录 | 保持测试一致性 |
| 验证策略 | 分阶段验证 | 及早发现问题 |

## 风险评估

### 高风险项
1. **文件冲突导致代码丢失**
   - 缓解措施：创建冲突报告，手动审查所有冲突
   - 缓解措施：保留源文件直到验证完成

2. **路径更新遗漏导致运行时错误**
   - 缓解措施：使用自动化工具批量替换
   - 缓解措施：运行完整的类型检查和构建验证

3. **依赖冲突导致构建失败**
   - 缓解措施：仔细合并依赖，优先使用高版本
   - 缓解措施：合并后立即运行 `npm install` 和构建验证

### 中风险项
1. **测试配置不正确导致测试失败**
   - 缓解措施：合并测试配置后立即运行测试套件

2. **TypeScript 路径映射配置错误**
   - 缓解措施：更新配置后立即运行类型检查

## 实施建议

1. **创建备份**：在开始重构前，创建 Git 分支或备份
2. **分步执行**：按照 User Stories 的顺序逐步执行
3. **频繁验证**：每个步骤完成后立即验证
4. **文档记录**：记录所有决策和遇到的问题
5. **团队沟通**：确保团队成员了解重构计划

## 参考资料

- [Vite 路径别名配置](https://vitejs.dev/config/shared-options.html#resolve-alias)
- [TypeScript 路径映射](https://www.typescriptlang.org/docs/handbook/module-resolution.html#path-mapping)
- [Node.js 文件系统操作最佳实践](https://nodejs.org/api/fs.html)
