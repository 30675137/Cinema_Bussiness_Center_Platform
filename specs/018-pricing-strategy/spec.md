# Feature Specification: 场景包定价策略设置 (Scenario Package Pricing Strategy)

**Feature Branch**: `018-pricing-strategy`
**Created**: 2025-12-20
**Status**: Draft
**Input**: User description: "根据 Phase 5 (US3 - 设置定价策略) 创建新的spec"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 设置场景包打包价格 (Priority: P1)

运营人员需要为已配置完内容的场景包设置打包一口价，该价格通常低于各项内容单独购买的总和，以体现打包优惠。系统需要显示参考总价（仅包含软权益和服务项目的价格总和），帮助运营人员制定合理的打包价格。

**Why this priority**: 这是定价策略的核心功能，运营人员必须能够设置打包价格才能让场景包具备商业价值。这是最小可用功能，可以验证基本的定价流程。

**Independent Test**: 用户可以独立完成"为已配置内容的场景包设置打包价格并保存"的完整流程，验证价格输入、参考总价显示和保存功能是否正常工作。

**Acceptance Scenarios**:

1. **Given** 场景包内容已配置完成（包含软权益和服务项目），**When** 运营人员进入定价设置页面，**Then** 系统显示所选软权益（单品）和服务项目的单独购买总价作为参考（硬权益不计入参考总价）
2. **Given** 定价设置页面已打开，**When** 运营人员输入打包价格（如¥1888），**Then** 系统接受输入并准备保存
3. **Given** 打包价格已输入，**When** 运营人员点击"保存"按钮，**Then** 系统验证价格为正数并保存定价配置
4. **Given** 打包价格设置为¥1888，**When** 运营人员返回场景包列表，**Then** 系统显示该场景包的打包价格

---

### User Story 2 - 查看优惠金额和优惠比例 (Priority: P2)

运营人员在设置打包价格时，需要实时看到优惠金额和优惠比例，以便评估打包优惠力度是否合理。系统应自动计算并显示这些指标。

**Why this priority**: 优惠金额和优惠比例是辅助决策的重要指标，但不是必须功能。运营人员可以手动计算，但系统自动计算能提升效率和准确性。

**Independent Test**: 用户可以独立完成"输入打包价格后查看系统自动计算的优惠金额和比例"的流程，验证计算逻辑的准确性。

**Acceptance Scenarios**:

1. **Given** 定价设置页面显示参考总价为¥2500（仅包含软权益和服务项目），**When** 运营人员输入打包价格为¥1888，**Then** 系统自动计算并显示优惠金额为¥612（¥2500 - ¥1888）
2. **Given** 优惠金额已计算，**When** 系统计算优惠比例，**Then** 显示优惠比例为约75%（¥1888 / ¥2500 × 100%）
3. **Given** 打包价格已输入，**When** 运营人员修改打包价格为¥2000，**Then** 系统重新计算并更新优惠金额（¥500）和优惠比例（80%）

---

### User Story 3 - 响应场景包内容变更 (Priority: P3)

当运营人员修改场景包内容（增加或减少软权益单品或服务项目）后，定价设置页面的参考总价应自动更新，并提示运营人员重新确认打包价格，确保定价与内容保持一致。

**Why this priority**: 这是数据一致性的保障功能，防止内容变更后价格失效。虽然重要，但可以在基础定价功能完成后再实现。

**Independent Test**: 用户可以独立完成"修改场景包内容后查看参考总价更新并重新确认打包价格"的流程，验证数据联动和提示功能是否正常工作。

**Acceptance Scenarios**:

1. **Given** 场景包已设置打包价格¥1888，参考总价为¥2500，**When** 运营人员在内容配置页面增加一个单品（价值¥300），**Then** 系统更新参考总价为¥2800
2. **Given** 参考总价已更新为¥2800，**When** 运营人员返回定价设置页面，**Then** 系统显示新的参考总价¥2800，并提示"场景包内容已变更，请重新确认打包价格"
3. **Given** 系统提示重新确认价格，**When** 运营人员确认保持原价格¥1888 或修改为新价格，**Then** 系统保存运营人员的决定并清除提示
4. **Given** 场景包内容减少（如删除一个服务项目），**When** 参考总价降低，**Then** 系统同样更新参考总价并提示重新确认打包价格

---

### User Story 4 - 验证定价规则 (Priority: P4)

系统需要对运营人员输入的打包价格进行验证，确保价格为正数，防止输入无效或错误的价格数据。

**Why this priority**: 数据验证是基础功能，但可以在核心定价功能完成后再完善。初期可以依赖前端验证。

**Independent Test**: 用户可以独立完成"尝试输入无效价格并接收错误提示"的流程，验证价格验证逻辑是否正常工作。

**Acceptance Scenarios**:

1. **Given** 定价设置页面已打开，**When** 运营人员输入打包价格为0，**Then** 系统显示错误提示"打包价格必须大于0"
2. **Given** 定价设置页面已打开，**When** 运营人员输入打包价格为负数（如-100），**Then** 系统显示错误提示"打包价格必须为正数"
3. **Given** 定价设置页面已打开，**When** 运营人员输入打包价格为非数字（如abc），**Then** 系统显示错误提示"请输入有效的价格数字"
4. **Given** 打包价格验证失败，**When** 运营人员点击"保存"按钮，**Then** 系统阻止保存并要求修正错误

---

### Edge Cases

- 当场景包仅包含硬权益（观影购票优惠权益）而无软权益和服务项目时，参考总价如何计算？系统应显示参考总价为¥0，并提示"当前场景包仅包含硬权益，无法计算参考总价，请手动设置打包价格"
- 当场景包内容为空（无任何权益或服务项目）时如何处理？系统应阻止进入定价设置页面，提示"请先配置场景包内容"
- 当运营人员设置的打包价格远高于参考总价（如参考总价¥2000，打包价格¥5000）时如何处理？系统应提示"打包价格高于参考总价，请确认是否正确"（警告但不阻止保存）
- 当场景包中的某个单品价格发生变化（如原价¥100改为¥120）时如何处理？系统应重新计算参考总价并提示运营人员
- 当多个运营人员同时编辑同一个场景包的定价时如何处理？系统应采用乐观锁机制，后保存者提示"定价已被他人修改，请刷新后重试"
- 当打包价格包含小数（如¥1888.88）时如何处理？系统应支持两位小数的价格输入
- 当参考总价为¥0时（场景包仅含硬权益），优惠比例如何计算？系统应显示"N/A"或"无法计算"，避免除以0的错误

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在定价设置页面显示场景包所选软权益（单品）和服务项目的单独购买参考总价
- **FR-002**: 系统必须排除硬权益（观影购票优惠权益）的价值，仅计算软权益和服务项目的价格总和作为参考总价
- **FR-003**: 系统必须允许运营人员输入打包一口价，支持整数和两位小数的价格格式
- **FR-004**: 系统必须验证打包价格为正数（大于0）
- **FR-005**: 系统必须在运营人员输入打包价格时，自动计算并显示优惠金额（参考总价 - 打包价格）
- **FR-006**: 系统必须在运营人员输入打包价格时，自动计算并显示优惠比例（打包价格 / 参考总价 × 100%）
- **FR-007**: 系统必须在场景包内容变更后更新参考总价，并在定价设置页面提示"场景包内容已变更，请重新确认打包价格"
- **FR-008**: 系统必须支持运营人员在内容变更后确认保持原价格或修改为新价格
- **FR-009**: 系统必须在场景包仅包含硬权益（无软权益和服务项目）时，显示参考总价为¥0，并提示手动设置打包价格
- **FR-010**: 系统必须在场景包内容为空时，阻止进入定价设置页面，提示"请先配置场景包内容"
- **FR-011**: 系统必须在打包价格高于参考总价时显示警告提示，但不阻止保存
- **FR-012**: 系统必须在参考总价为¥0时，将优惠比例显示为"N/A"或"无法计算"
- **FR-013**: 系统必须使用乐观锁机制防止并发编辑冲突，后保存者应收到"定价已被他人修改，请刷新后重试"的提示
- **FR-014**: 系统必须记录定价配置的修改时间和操作人
- **FR-015**: 系统必须在场景包列表页面显示场景包的打包价格

### Key Entities *(include if feature involves data)*

- **PackagePricing（场景包定价）**: 定义场景包的定价策略，包含以下属性：
  - 打包一口价（packagePrice）：运营人员设置的最终销售价格
  - 参考总价（referencePrice）：软权益和服务项目的单独购买价格总和
  - 优惠金额（discountAmount）：参考总价 - 打包一口价
  - 优惠比例（discountRate）：打包一口价 / 参考总价 × 100%
  - 修改时间（updatedAt）：最后修改时间
  - 操作人（updatedBy）：最后修改人
  - 版本号（version）：用于乐观锁控制

- **ScenarioPackage（场景包）**: 关联定价配置，一个场景包对应一个定价配置

- **PackageItem（场景包单品项）**: 软权益中的具体单品，用于计算参考总价

- **PackageService（场景包服务项）**: 服务项目，用于计算参考总价

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 运营人员可以在2分钟内完成场景包的定价设置并保存
- **SC-002**: 系统能够在500毫秒内计算并显示参考总价、优惠金额和优惠比例
- **SC-003**: 价格验证准确率达到100%，阻止所有无效价格（0、负数、非数字）的保存
- **SC-004**: 优惠金额和优惠比例的计算准确率达到100%，误差不超过0.01%
- **SC-005**: 场景包内容变更后，参考总价能够在1秒内自动更新
- **SC-006**: 并发编辑冲突检测准确率达到100%，避免定价数据覆盖问题
- **SC-007**: 90%以上的运营人员在首次使用时能够独立完成定价设置流程
- **SC-008**: 定价设置页面加载时间不超过1秒

## Assumptions *(optional)*

1. 软权益（单品）和服务项目的价格数据来源于已有的商品主数据和服务配置，价格为标准售价
2. 硬权益（观影购票优惠权益）因其优惠性质无法量化为固定金额，因此不计入参考总价
3. 参考总价的计算公式为：∑(单品价格 × 数量) + ∑(服务项目价格)
4. 优惠金额的计算公式为：参考总价 - 打包一口价
5. 优惠比例的计算公式为：(打包一口价 / 参考总价) × 100%，结果保留两位小数
6. 打包价格支持整数和两位小数（如¥1888 或 ¥1888.88）
7. 运营人员具有定价设置的完整权限，不涉及审批流程
8. 定价配置的版本号用于乐观锁控制，每次保存时版本号递增
9. 场景包内容变更后，运营人员必须手动确认价格（保持原价格或修改），系统不会自动调整打包价格
10. 当参考总价为¥0时（场景包仅含硬权益），优惠金额和优惠比例无法计算，显示为"N/A"
11. 打包价格高于参考总价的场景是允许的（如特殊服务费、附加价值等），但系统会给出警告提示
12. 定价配置与场景包实体是一对一关系，每个场景包只有一个当前有效的定价配置

## Out of Scope *(optional)*

1. 动态定价和促销规则（如节假日加价、会员折扣、早鸟优惠等）
2. 价格版本管理和历史记录查询（仅保留当前有效定价）
3. 批量定价操作（如批量调价、批量复制定价策略）
4. 定价审批流程（如财务审批、管理层审批）
5. 价格策略模板和预设方案（如固定折扣率模板、季节性定价模板）
6. 竞品价格比较和市场分析功能
7. 价格敏感度分析和定价建议算法
8. 不同渠道的差异化定价（如小程序、第三方平台）
9. 会员等级定价和动态折扣
10. 成本分析和利润率计算
