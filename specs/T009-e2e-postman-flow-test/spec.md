# Feature Specification: E2E Postman 业务流程测试

**Feature Branch**: `T009-e2e-postman-flow-test`  
**Created**: 2026-01-14  
**Status**: Draft  
**Input**: 通过 postman 进行一次全流程测试，从创建 SKU 到采购入库再到订单下单（考虑扣减与库存不足）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 完整业务流程端到端测试 (Priority: P1)

测试人员需要验证从商品主数据创建、采购入库到销售订单的完整业务流程，确保系统各模块协同工作正常，库存扣减逻辑正确，以及异常场景（如库存不足）能被正确处理。

**Why this priority**: 这是核心业务流程的完整验证，涵盖了 SKU 管理、BOM 配方、采购入库和销售订单等关键模块。确保端到端流程畅通是系统可用性的基础。

**Independent Test**: 可以通过 Postman Collection Runner 独立执行完整测试流程，验证创建的测试数据能够支撑从上游到下游的所有业务操作，并返回明确的成功/失败结果。

**Acceptance Scenarios**:

1. **Given** 系统为空白状态，**When** 依次创建 SPU、原料 SKU、成品 SKU、BOM 配方，**Then** 所有资源创建成功，返回唯一标识符
2. **Given** SKU 和 BOM 已创建，**When** 创建采购订单并确认入库，**Then** 门店库存数量正确增加
3. **Given** 门店库存充足，**When** 创建销售订单，**Then** 订单创建成功，库存预占成功，库存可用数量减少
4. **Given** 门店库存不足，**When** 尝试创建超出库存的销售订单，**Then** 订单创建失败，返回库存不足错误信息，包含缺货清单
5. **Given** 已有预占库存的订单，**When** 取消订单，**Then** 预占的库存被释放，可用数量恢复

---

### Edge Cases

- **边界条件测试**：
  - 当采购入库数量为 0 或负数时，系统应拒绝入库操作
  - 当订单数量刚好等于库存数量时，应成功创建订单并将可用库存降至 0
  - 当订单数量超出库存 1 单位时，应返回库存不足错误

- **异常场景测试**：
  - 创建 BOM 时，如果原料 SKU 不存在，应返回配置错误
  - 创建订单时，如果成品 SKU 没有配置 BOM，应返回配置错误
  - 创建订单时，如果成品 SKU 状态为停用，应返回不可售卖错误
  - 采购入库时，如果采购订单状态不正确（如已关闭），应拒绝入库

- **并发场景测试**：
  - 当多个订单同时请求相同商品时，系统应正确处理库存预占，避免超卖
  - 当采购入库和销售订单同时操作同一 SKU 时，库存数量应保持一致性

## Requirements *(mandatory)*

### Functional Requirements

#### 测试数据准备

- **FR-001**: 系统必须支持通过 API 创建测试 SPU（标准产品单元），包含名称、分类、描述等基本信息
- **FR-002**: 系统必须支持创建原料类型 SKU，指定标准成本和计量单位（如 ml、g）
- **FR-003**: 系统必须支持创建成品类型 SKU，并允许配置损耗率
- **FR-004**: 系统必须支持为成品 SKU 配置 BOM（Bill of Materials）配方，指定原料组件、用量和计量单位
- **FR-005**: BOM 配方必须支持 MATERIAL 类型组件，使用 materialId 引用原料 SKU

#### 采购入库流程

- **FR-006**: 系统必须支持创建采购订单（Purchase Order），指定供应商、SKU、数量和单价
- **FR-007**: 系统必须支持采购订单确认入库，将采购数量增加到门店库存的 on_hand_qty 和 available_qty
- **FR-008**: 采购入库成功后，系统必须记录库存流水（inventory_transaction），包含交易类型、数量、单价和来源单据
- **FR-009**: 采购入库必须验证采购订单状态，只有 APPROVED 或 CONFIRMED 状态的订单允许入库

#### 销售订单流程

- **FR-010**: 系统必须支持创建销售订单，指定门店、SKU、数量
- **FR-011**: 创建销售订单时，系统必须根据 BOM 配方展开成品 SKU，计算所需原料用量
- **FR-012**: BOM 展开必须支持递归展开（如果组件本身也是成品）和 MATERIAL 类型叶子节点
- **FR-013**: 创建订单时，系统必须验证 SKU 类型，只有成品（FINISHED_PRODUCT）和套餐（COMBO）类型可以下单
- **FR-014**: 创建订单时，系统必须检查所有原料的门店库存是否充足（available_qty >= 所需数量）
- **FR-015**: 库存充足时，系统必须创建库存预占记录（inventory_reservation），状态为 RESERVED，并减少 available_qty
- **FR-016**: 库存不足时，系统必须返回 409 错误，包含缺货清单（shortageItems），列出每个缺货原料的 SKU ID、名称、所需数量和可用数量

#### 订单取消流程

- **FR-017**: 系统必须支持取消销售订单，释放已预占的库存
- **FR-018**: 取消订单时，系统必须将预占记录状态更新为 CANCELLED，并将 available_qty 恢复

### Key Entities

- **SPU (Standard Product Unit)**: 标准产品单元，表示商品的抽象分类（如"鸡尾酒"），包含名称、分类 ID、描述、状态
- **SKU (Stock Keeping Unit)**: 库存量单位，表示可交易的具体商品规格，包含编码、名称、类型（原料/包材/成品/套餐）、主单位、标准成本、损耗率
- **BOM (Bill of Materials)**: 物料清单/配方，定义成品 SKU 由哪些原料组成，包含成品 ID、组件列表、损耗率
- **BOM Component**: BOM 组件，表示配方中的单个原料，包含组件类型（MATERIAL/SKU）、原料 ID 或组件 ID、用量、单位
- **Purchase Order**: 采购订单，记录从供应商采购的商品信息，包含供应商 ID、订单项（SKU、数量、单价）、订单状态
- **Store Inventory**: 门店库存，记录每个门店每个 SKU 的库存数量，包含门店 ID、SKU ID、现存数量、可用数量、预占数量、安全库存
- **Inventory Reservation**: 库存预占记录，记录销售订单对库存的锁定，包含订单 ID、SKU ID、门店 ID、预占数量、预占状态
- **Beverage Order**: 销售订单（饮品订单），记录客户购买的商品，包含门店 ID、订单项（SKU、数量）、订单状态、预占状态

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 测试人员可以在 5 分钟内完成从 SPU 创建到订单下单的完整流程测试
- **SC-002**: 所有测试场景（正常流程、库存不足、订单取消）的通过率达到 100%
- **SC-003**: 库存扣减逻辑正确性达到 100%，不出现超卖或库存不一致问题
- **SC-004**: 异常场景（如库存不足）能够返回清晰的错误信息，包含缺货清单，帮助测试人员快速定位问题
- **SC-005**: Postman Collection 可以被重复执行，支持数据清理和重新准备，确保测试的可重复性
- **SC-006**: 测试数据构造合理，符合真实业务场景（如莫吉托配方包含朗姆酒、薄荷叶、苏打水）

## Test Data Specification

### 测试数据规格

| 资源类型 | 名称 | 规格 | 数量/成本 |
|---------|------|------|----------|
| **SPU** | 测试饮品 SPU - Mojito | 鸡尾酒分类 | 1个 |
| **原料 SKU** | 朗姆酒 | raw_material, ml | 标准成本: 0.15元/ml |
| **原料 SKU** | 薄荷叶 | raw_material, g | 标准成本: 0.05元/g |
| **原料 SKU** | 苏打水 | raw_material, ml | 标准成本: 0.01元/ml |
| **成品 SKU** | 莫吉托 | finished_product, 杯 | 售价: 35元/杯 |
| **成品 SKU** | 草莓莫吉托 | finished_product, 杯 | 售价: 38元/杯 |
| **BOM 配方** | 莫吉托配方 | 45ml朗姆酒 + 5g薄荷叶 + 200ml苏打水 | 损耗率: 5% |
| **采购入库** | 朗姆酒 | 采购数量: 5000ml | 采购单价: 0.12元/ml |
| **采购入库** | 薄荷叶 | 采购数量: 500g | 采购单价: 0.04元/g |
| **采购入库** | 苏打水 | 采购数量: 20000ml | 采购单价: 0.008元/ml |
| **初始库存** | 朗姆酒 | 5000ml（约110杯） | 可用库存: 5000ml |
| **初始库存** | 薄荷叶 | 500g（约100杯） | 可用库存: 500g |
| **初始库存** | 苏打水 | 20000ml（约100杯） | 可用库存: 20000ml |

**理论最大制作量**: 100杯莫吉托（受薄荷叶库存限制）

## Test Scenarios

### 场景 1: 正常下单 - 单品订单

- **订单内容**: 2杯莫吉托
- **预期结果**: 订单创建成功，库存预占成功
- **验证点**:
  - 订单状态 = PENDING_PAYMENT
  - 预占状态 = RESERVED
  - 朗姆酒可用库存减少 90ml (45ml × 2)
  - 薄荷叶可用库存减少 10g (5g × 2)
  - 苏打水可用库存减少 400ml (200ml × 2)

### 场景 2: 正常下单 - 多品订单

- **订单内容**: 2杯莫吉托 + 1杯草莓莫吉托
- **预期结果**: 订单创建成功，库存预占成功
- **验证点**: 所有商品的库存正确扣减

### 场景 3: 库存不足 - 超大数量订单

- **订单内容**: 9999杯莫吉托
- **预期结果**: 订单创建失败，返回 409 错误
- **验证点**:
  - 错误码 = ORD_BIZ_002
  - 错误信息包含"库存不足"
  - 返回缺货清单（shortageItems），列出薄荷叶所需 49995g，可用 500g

### 场景 4: 订单取消 - 释放库存

- **前置条件**: 已创建 1 个莫吉托订单
- **操作**: 取消该订单
- **预期结果**: 库存预占被释放
- **验证点**:
  - 预占记录状态 = CANCELLED
  - 朗姆酒、薄荷叶、苏打水的可用库存恢复到扣减前的数量

### 场景 5: 边界值测试 - 刚好用完库存

- **前置条件**: 薄荷叶库存 500g
- **订单内容**: 100杯莫吉托（需要 500g 薄荷叶）
- **预期结果**: 订单创建成功
- **验证点**:
  - 薄荷叶可用库存 = 0g
  - 其他原料库存正确扣减

## Assumptions

1. 测试环境已部署后端服务（Spring Boot）和数据库（Supabase PostgreSQL）
2. 测试门店 ID 固定为 `00000000-0000-0000-0000-000000000099`
3. 测试 SPU 的分类 ID 固定为 `550e8400-e29b-41d4-a716-446655440003`（饮品分类）
4. 采购订单在入库前需要先创建并审批通过
5. 销售订单的客户 ID 可以为空（支持匿名下单）
6. BOM 配方中的损耗率计入成本计算，但不影响库存扣减逻辑
7. 库存单位必须与 SKU 的主单位一致（如朗姆酒的库存单位必须是 ml）
8. 测试执行过程中，系统不会有其他并发操作干扰测试数据

## Dependencies

- **O012-order-inventory-reservation**: 订单创建时库存预占功能已完成
- **P001-sku-master-data**: SKU 主数据管理功能已完成，支持 BOM 配置
- **P005-bom-inventory-deduction**: BOM 展开和库存扣减逻辑已实现
- **采购入库模块**: 采购订单和入库功能已实现（假设存在，如不存在需标记为前置开发任务）

## Out of Scope

- 不涉及前端 UI 测试，仅通过 Postman API 测试
- 不涉及支付流程测试
- 不涉及订单发货和配送流程
- 不涉及供应商管理功能测试
- 不涉及库存盘点和调拨功能测试
- 不测试系统性能和并发能力（仅功能验证）
- 不涉及多门店库存协调和调拨

## Notes

- 本规格专注于 E2E 测试的设计和数据准备，具体的 Postman Collection 实现将在 `/speckit.plan` 阶段完成
- 测试数据（如莫吉托配方）参考了 O012 模块的 Setup Collection 设计
- 如果采购入库模块尚未实现，可以先使用直接插入 `store_inventory` 表的方式初始化库存（通过 Supabase REST API）
