# Feature Specification: 场景包管理 (Scenario Package Management)

**Feature Branch**: `017-scenario-package`
**Created**: 2025-12-19
**Status**: Draft
**Input**: User description: "场景包管理 (Scenario Package Management) - 定义产品原型，包括新建场景包、关联影厅类型、定义规则、组合内容、定价策略和上架状态管理"

## Clarifications

### Session 2025-12-19

- Q: 用户提到"需要考虑背景图片的上传"，但当前规格说明中将图片/视频管理列为超出范围。图片上传功能的范围应该如何定义？ → A: 支持每个场景包上传单张背景图片
- Q: 背景图片的存储方式应该如何实现？ → A: 使用 Supabase Storage 存储图片
- Q: "硬权益（观影权益）"的具体含义是什么？ → A: 观影购票优惠权益
- Q: 场景包发布时，硬权益是否为必填项？ → A: 硬权益可选，场景包可仅包含软权益和服务项目
- Q: 定价设置中的"参考总价"是否应该包含硬权益的价值？ → A: 参考总价仅包含软权益和服务项目，硬权益不计入
- Q: UI 中硬权益应使用简单字符串数组还是结构化实体？ → A: 使用结构化 PackageBenefit 实体，包含类型和参数
- Q: UI 状态枚举应使用 ARCHIVED（已归档）还是 UNPUBLISHED（已下架）？ → A: 使用 UNPUBLISHED（已下架），支持重新上架
- Q: 服务项目的 UI 选择方式应该如何设计？ → A: 使用下拉菜单 + 列表管理，与软权益交互一致

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 创建基础场景包 (Priority: P1)

运营人员需要创建一个新的场景包作为产品原型，例如"VIP 生日派对专场"，设置基本信息包括名称、描述和适用影厅类型。这是最核心的功能，没有这个功能，后续的内容组合和定价都无法进行。

**Why this priority**: 这是整个场景包管理的基础功能，必须先能创建场景包实体，才能进行后续的内容配置和定价。这是最小可用功能，可以先验证场景包的基本数据结构。

**Independent Test**: 用户可以独立完成"创建一个新场景包并保存为草稿"的完整流程，验证场景包基本信息的创建、编辑和存储功能是否正常工作。

**Acceptance Scenarios**:

1. **Given** 运营人员登录系统并进入场景包管理页面，**When** 点击"新建场景包"按钮，**Then** 系统显示场景包创建表单
2. **Given** 场景包创建表单已打开，**When** 填写场景包名称"VIP 生日派对专场"、描述、上传背景图片和勾选适用影厅类型（1号厅 VIP、3号厅 Party），**Then** 系统保存场景包基本信息（包括背景图片URL）并显示成功提示
3. **Given** 已创建的场景包，**When** 运营人员修改场景包名称、背景图片或影厅类型，**Then** 系统更新场景包信息并保留修改历史
4. **Given** 场景包列表页面，**When** 运营人员查看已创建的场景包，**Then** 系统显示场景包名称、背景图片缩略图、适用影厅、状态（草稿/已发布）和创建时间

---

### User Story 2 - 配置场景包规则和内容组合 (Priority: P2)

运营人员需要为已创建的场景包配置使用规则（时长、适用人数）和内容组合，包括硬权益（观影购票优惠权益，如折扣票价、免费场次等）、软权益（单品组合）和服务项目（管家服务、布置服务）。这是场景包的核心价值体现。

**Why this priority**: 场景包的价值在于内容组合，这个功能让场景包从"空壳"变成"有内容的产品"。虽然重要，但必须在基础场景包创建之后才能进行。

**Independent Test**: 用户可以独立完成"为草稿状态的场景包配置完整的规则和内容"的流程，验证规则配置、权益选择和服务项目选择功能是否正常工作。

**Acceptance Scenarios**:

1. **Given** 草稿状态的场景包，**When** 运营人员设置时长为3小时、适用人数为10-20人，**Then** 系统保存规则配置并进行有效性校验（时长>0，人数范围合理）
2. **Given** 场景包规则已配置，**When** 运营人员在软权益区域勾选"20杯莫吉托"和"5份小食拼盘"，**Then** 系统记录选中的单品及数量
3. **Given** 场景包内容配置页面，**When** 运营人员勾选"管家服务"和"布置服务"，**Then** 系统记录选中的服务项目
4. **Given** 场景包配置完成，**When** 运营人员预览场景包内容，**Then** 系统显示完整的规则、权益和服务清单

---

### User Story 3 - 设置场景包定价策略 (Priority: P3)

运营人员需要为场景包设置打包一口价，该价格通常低于各项内容单独购买的总和，以体现打包优惠。系统需要提供单品总价参考，帮助运营人员制定合理的打包价格。

**Why this priority**: 定价是场景包商业化的关键，但可以在内容配置完成后再进行。这个功能依赖于前面的内容组合，因此优先级较低。

**Independent Test**: 用户可以独立完成"为已配置内容的场景包设置打包价格"的流程，验证定价设置、价格计算和优惠比例提示功能是否正常工作。

**Acceptance Scenarios**:

1. **Given** 场景包内容已配置完成，**When** 运营人员进入定价设置页面，**Then** 系统显示所选软权益（单品）和服务项目的单独购买总价作为参考（硬权益不计入参考总价）
2. **Given** 定价设置页面显示参考总价为¥2500（仅包含软权益和服务项目），**When** 运营人员设置打包价格为¥1888，**Then** 系统计算并显示优惠比例（约75%）和优惠金额（¥612）
3. **Given** 打包价格已设置，**When** 运营人员修改场景包内容（增加或减少单品或服务项目），**Then** 系统更新参考总价并提示重新确认打包价格
4. **Given** 打包价格设置为¥1888，**When** 运营人员保存定价策略，**Then** 系统验证价格为正数并保存

---

### User Story 4 - 发布和管理场景包状态 (Priority: P4)

运营人员需要将草稿状态的场景包发布上架，使其在小程序端对用户可见。同时需要支持已发布场景包的下架、重新上架和删除操作，以应对业务调整需求。

**Why this priority**: 发布功能是场景包最终投入使用的必要步骤，但在完成创建、配置和定价之后才有意义。这是业务流程的最后一环。

**Independent Test**: 用户可以独立完成"将草稿场景包发布上架"的流程，验证状态变更、权限控制和小程序端可见性联动功能是否正常工作。

**Acceptance Scenarios**:

1. **Given** 草稿状态且已配置完整（至少包含一项内容：硬权益、软权益或服务项目，且有定价）的场景包，**When** 运营人员点击"发布"按钮，**Then** 系统将状态改为"已发布"并在小程序端展示
2. **Given** 草稿状态但配置不完整的场景包（无任何内容或无定价），**When** 运营人员点击"发布"，**Then** 系统提示"请先完成内容配置和定价设置"并阻止发布
3. **Given** 已发布的场景包，**When** 运营人员点击"下架"按钮，**Then** 系统将状态改为"已下架"并在小程序端隐藏
4. **Given** 已下架的场景包，**When** 运营人员点击"重新上架"，**Then** 系统将状态改回"已发布"并在小程序端再次展示
5. **Given** 草稿或已下架的场景包，**When** 运营人员点击"删除"并确认，**Then** 系统标记为已删除（软删除）并从列表中移除

---

### Edge Cases

- 当运营人员选择的影厅类型被禁用或删除后，场景包如何处理？系统应提示"包含已失效影厅，请重新选择"
- 当场景包中选择的单品被下架或删除后，如何处理？系统应在编辑时提示"包含已失效商品"并要求重新配置
- 当多个运营人员同时编辑同一个场景包时如何处理？系统应采用乐观锁机制，后保存者提示"该场景包已被他人修改，请刷新后重试"
- 当打包价格设置为0或负数时如何处理？系统应验证价格必须为正数
- 当场景包的适用人数范围设置不合理（如最小值大于最大值）时如何处理？系统应验证最小值≤最大值
- 当已发布的场景包被修改后如何处理版本管理？系统应提示"修改已发布场景包将创建新版本，旧版本订单不受影响"
- 当删除场景包时已有用户预订该场景包怎么办？系统应检查是否有进行中的订单，如有则提示"该场景包有进行中的订单，无法删除"
- 当上传的背景图片文件过大或格式不支持时如何处理？系统应验证图片格式（仅支持JPG/PNG/WebP）和大小（不超过5MB），不符合要求时提示错误
- 当场景包未上传背景图片时如何处理？系统应允许不上传背景图片（可选字段），列表和详情页使用默认占位图展示

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须允许运营人员创建新的场景包，包括填写名称、描述、上传背景图片（可选）和选择适用的影厅类型
- **FR-001a**: 系统必须支持背景图片上传功能，每个场景包限一张背景图片，支持JPG/PNG/WebP格式，文件大小不超过5MB，图片存储在 Supabase Storage 中
- **FR-001b**: 系统必须在场景包列表和详情页显示背景图片，未上传时使用默认占位图
- **FR-002**: 系统必须支持运营人员为场景包设置使用规则，包括时长（单位：小时）和适用人数范围（最小人数-最大人数）
- **FR-003**: 系统必须提供硬权益（观影购票优惠权益，如折扣票价、免费场次）、软权益（单品组合）和服务项目（如管家服务、布置服务）的选择界面
- **FR-004**: 系统必须允许运营人员为软权益中的每个单品设置数量
- **FR-005**: 系统必须在定价设置页面显示所选软权益（单品）和服务项目的单独购买参考总价（硬权益不计入参考总价）
- **FR-006**: 系统必须允许运营人员设置打包一口价，并自动计算优惠比例和优惠金额（基于软权益和服务项目的参考总价）
- **FR-007**: 系统必须验证打包价格为正数
- **FR-008**: 系统必须验证使用规则的合理性（时长>0，最小人数≤最大人数）
- **FR-009**: 系统必须支持场景包状态管理，包括草稿、已发布、已下架三种状态
- **FR-010**: 系统必须在发布前验证场景包配置的完整性（必须包含至少一项内容：硬权益、软权益或服务项目，且必须设置定价）
- **FR-011**: 系统必须支持已下架场景包的重新上架操作
- **FR-012**: 系统必须支持场景包的软删除（标记删除而非物理删除），仅允许删除草稿或已下架状态的场景包
- **FR-013**: 系统必须在删除前检查场景包是否有进行中的订单，如有则阻止删除
- **FR-014**: 系统必须记录场景包的创建时间、修改时间和操作人
- **FR-015**: 系统必须在场景包列表页面提供筛选功能（按状态、影厅类型、创建时间筛选）
- **FR-016**: 系统必须在编辑场景包时检测所选影厅和单品的有效性，如发现已失效项则提示运营人员
- **FR-017**: 系统必须使用乐观锁机制防止并发编辑冲突
- **FR-018**: 系统必须在小程序端仅展示"已发布"状态的场景包
- **FR-019**: 系统必须支持场景包的预览功能，展示完整的规则、内容和定价信息
- **FR-020**: 系统必须保存场景包的草稿状态，允许运营人员分多次完成配置

### Key Entities *(include if feature involves data)*

- **ScenarioPackage（场景包）**: 代表一个产品原型，包含名称、描述、背景图片URL（可选）、状态（草稿/已发布/已下架/已删除）、创建时间、修改时间、操作人等基本属性。与影厅类型、使用规则、内容组合和定价策略关联。
- **PackageRule（场景包规则）**: 定义场景包的使用规则，包括时长（小时）、最小人数、最大人数。一个场景包对应一个规则配置。
- **PackageContent（场景包内容）**: 定义场景包包含的内容，包括硬权益（观影购票优惠权益）、软权益和服务项目。一个场景包可以包含多个内容项。
- **PackageBenefit（场景包硬权益）**: 观影购票优惠权益的具体配置，包括优惠类型（折扣票价/免费场次）、折扣率或免费场次数量等属性。
- **PackageItem（场景包单品项）**: 软权益中的具体单品，包括单品ID、单品名称、数量。与商品主数据（第一阶段创建的单品）关联。
- **PackageService（场景包服务项）**: 服务项目，如管家服务、布置服务。包括服务ID、服务名称。
- **PackagePricing（场景包定价）**: 定义场景包的定价策略，包括打包一口价、参考总价、优惠比例、优惠金额。一个场景包对应一个定价配置。
- **HallType（影厅类型）**: 影厅类型实体，场景包通过多对多关系关联适用的影厅类型。
- **PackageVersion（场景包版本）**: 记录场景包的版本历史，当已发布场景包被修改时创建新版本，确保已有订单不受影响。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 运营人员可以在5分钟内完成一个场景包的基础信息创建并保存为草稿
- **SC-002**: 运营人员可以在10分钟内完成场景包的内容配置（规则、权益、服务）和定价设置
- **SC-003**: 系统能够在1秒内计算并显示场景包的参考总价、优惠比例和优惠金额
- **SC-004**: 95%以上的场景包发布操作能够成功完成，无系统错误
- **SC-005**: 场景包列表加载时间不超过2秒（在1000个场景包的数据量下）
- **SC-006**: 场景包状态变更（发布/下架）能够在3秒内同步到小程序端
- **SC-007**: 并发编辑冲突检测准确率达到100%，避免数据覆盖问题
- **SC-008**: 运营人员能够通过筛选功能在2秒内找到目标场景包（在1000个场景包的数据量下）
- **SC-009**: 场景包配置完整性验证准确率达到100%，避免不完整的场景包被发布
- **SC-010**: 90%以上的运营人员在首次使用时能够独立完成场景包创建、配置和发布的完整流程

## Assumptions *(optional)*

1. 影厅类型数据来源于已有的影厅主数据，不需要在场景包管理中创建新的影厅类型
2. 软权益中的单品数据来源于第一阶段已创建的商品主数据（MDM/PIM）
3. 服务项目（如管家服务、布置服务）作为预定义的服务类型存储，不需要动态创建
4. 场景包的定价策略采用简单的一口价模式，不涉及动态定价、时段差价等复杂规则
5. 场景包版本管理采用简单的版本号递增策略，修改已发布场景包时自动创建新版本
6. 小程序端的场景包展示逻辑由前端实现，后端仅提供状态为"已发布"的场景包数据
7. 运营人员具有场景包管理的完整权限，不涉及细粒度的角色权限控制
8. 场景包的软删除策略保留已删除数据，便于审计和数据恢复，物理删除由数据归档策略处理
9. 打包价格的优惠比例计算公式为：优惠比例 = (打包价格 / 参考总价) × 100%，其中参考总价仅包含软权益和服务项目的价格总和，不包含硬权益
10. 场景包适用人数范围的设置不强制要求，如不设置则默认"不限人数"
11. 背景图片存储在 Supabase Storage 中，场景包实体仅存储图片的公开访问URL
12. 硬权益（观影购票优惠权益）为可选项，场景包可仅包含软权益和服务项目，但发布时必须至少包含一项内容（硬权益、软权益或服务项目之一）
13. 参考总价计算逻辑：仅累加软权益（单品）和服务项目的标准价格，硬权益因其优惠性质无法量化为固定金额，故不计入参考总价
14. UI 中硬权益使用结构化 PackageBenefit 实体（包含类型、折扣率、免费次数等字段），而非简单字符串数组，便于类型化管理和扩展
15. 场景包状态使用 DRAFT、PUBLISHED、UNPUBLISHED 三种状态，不使用 ARCHIVED。下架后的场景包可以重新发布
16. 服务项目的 UI 选择方式与软权益保持一致（下拉菜单 + 列表管理），每个服务仅需选择一次，无需设置数量

## Out of Scope *(optional)*

1. 场景包的实际预订和订单管理功能（属于预订系统的范畴）
2. 场景包的库存管理和可用性检查（属于库存管理系统的范畴）
3. 场景包的动态定价和促销规则（如节假日加价、会员折扣等）
4. 场景包的推荐算法和个性化展示（属于推荐系统的范畴）
5. 场景包的评价和反馈管理（属于评价系统的范畴）
6. 场景包的数据分析和报表（如销量统计、收益分析等，属于BI系统的范畴）
7. 场景包的多语言支持（当前仅支持中文）
8. 场景包的多图片上传和视频管理（当前仅支持单张背景图片）
9. 场景包的第三方平台同步（如美团、大众点评等）
10. 场景包的退款和取消规则配置（属于订单管理的范畴）
