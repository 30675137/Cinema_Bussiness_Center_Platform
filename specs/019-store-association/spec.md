# Feature Specification: 场景包场馆关联配置

**Feature Branch**: `019-store-association`
**Created**: 2025-12-21
**Status**: Draft
**Input**: User description: "B端需新增「场馆关联」配置界面，从 stores 表选择关联场馆"

## Clarifications

### Session 2025-12-21

- Q: 这个场馆关联配置应该集成到哪个现有功能的编辑页面中？ → A: 017-scenario-package（场景包管理）- 扩展现有的场景包编辑表单/页面
- Q: 这个新的"场馆关联"与现有的"影厅类型关联"（hallTypeIds）是什么关系？ → A: 两者独立共存 - 影厅类型定义适用的影厅规格，场馆关联定义可用的门店范围
- Q: 在本功能的语境中，"场馆"具体指的是什么？ → A: Store（门店）- 场景包关联到整个门店，该门店下符合类型的影厅均可使用
- Q: 这个新的场馆关联功能在数据模型层面应该如何实现？ → A: 新增独立的关联表（scenario_package_store_associations）- 标准多对多关系
- Q: 这个新的场馆关联配置功能在前端应该如何组织实现？ → A: 在现有的场景包编辑页面中新增"场馆关联"配置区域（扩展 scenario-packages/edit 组件）
- Q: Postman 测试脚本应覆盖哪些 API 端点？ → A: 覆盖所有 API 端点（CRUD + 门店列表查询）
- Q: Postman 测试脚本应包含哪些环境配置？ → A: 仅本地开发环境（localhost）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 为场景包配置关联场馆 (Priority: P1)

B端运营人员在创建或编辑场景包时，需要选择该场景包可在哪些影院场馆使用。系统展示场馆列表（从 stores 表读取），运营人员可通过多选或搜索功能选择一个或多个场馆，并保存场馆关联关系。

**Why this priority**: 这是场景包场馆关联的核心功能，没有此功能场景包无法与具体场馆绑定，影响C端用户预订时的场馆可用性判断。

**Independent Test**: 可通过访问场景包编辑页面，验证是否能成功展示场馆列表、选择场馆并保存关联关系。检查数据库中关联表是否正确记录。

**Acceptance Scenarios**:

1. **Given** 运营人员打开场景包编辑页面，**When** 点击"场馆关联"配置区域，**Then** 系统展示所有可用场馆列表（从 stores 表读取），包括场馆名称、地址等基本信息
2. **Given** 场馆列表已展示，**When** 运营人员选择多个场馆（通过复选框或多选下拉框），**Then** 系统记录选择状态并高亮显示已选场馆
3. **Given** 运营人员已选择场馆，**When** 点击"保存"按钮，**Then** 系统将场景包与选中场馆的关联关系持久化到数据库，并显示保存成功提示
4. **Given** 场景包已有关联场馆，**When** 运营人员重新打开编辑页面，**Then** 系统自动回显之前选择的场馆（复选框处于选中状态）

---

### User Story 2 - 搜索和筛选场馆 (Priority: P2)

当场馆数量较多时（超过10个），运营人员需要通过搜索功能快速定位目标场馆，避免在长列表中手动翻找。系统支持按场馆名称、地址关键词进行模糊搜索。

**Why this priority**: 提升运营效率，特别是当系统中场馆数量增长时，搜索功能能显著减少配置时间。属于用户体验优化，非核心阻塞功能。

**Independent Test**: 可通过在场馆列表的搜索框输入关键词，验证是否能正确过滤并仅展示匹配的场馆。

**Acceptance Scenarios**:

1. **Given** 场馆列表已展示，**When** 运营人员在搜索框输入场馆名称关键词（如"万达"），**Then** 系统实时过滤列表，仅展示名称包含该关键词的场馆
2. **Given** 搜索结果已展示，**When** 运营人员清空搜索框，**Then** 系统恢复展示完整场馆列表
3. **Given** 运营人员输入的关键词无匹配结果，**When** 搜索执行完成，**Then** 系统展示"未找到匹配场馆"提示

---

### User Story 3 - 批量管理场馆关联 (Priority: P3)

运营人员需要快速为多个场景包配置相同的场馆关联，或者批量移除某些场馆关联。系统提供批量操作功能，允许一次性为多个场景包关联相同的场馆列表。

**Why this priority**: 属于效率提升功能，适用于批量运营场景（如新增区域场馆时，需将所有通用场景包关联到新场馆）。非紧急需求，可后续迭代实现。

**Independent Test**: 可通过在场景包列表页面勾选多个场景包，验证是否能统一配置场馆关联并批量保存。

**Acceptance Scenarios**:

1. **Given** 运营人员在场景包列表页面，**When** 勾选多个场景包并点击"批量配置场馆"，**Then** 系统弹出场馆选择弹窗，选择的场馆将应用于所有选中的场景包
2. **Given** 批量场馆选择已完成，**When** 点击"应用到所有"按钮，**Then** 系统为所有选中场景包更新场馆关联关系，并显示操作成功提示

---

### Edge Cases

- **当场馆被删除或停用时**：如果场景包已关联某场馆，但该场馆在 stores 表中被标记为已删除或停用，系统应如何处理？建议在编辑页面显示"该场馆已停用"警告，但保留关联记录（软删除场景）。
- **当场景包未关联任何场馆时**：运营人员是否允许保存未关联场馆的场景包？建议强制要求至少关联一个场馆，否则提示"请至少选择一个场馆"并阻止保存。
- **并发编辑冲突**：如果两个运营人员同时编辑同一场景包的场馆关联，系统应如何处理？建议使用乐观锁（版本号）机制，后保存者提示"场馆关联已被其他用户修改，请刷新后重试"。
- **场馆列表为空**：如果 stores 表中无可用场馆（所有场馆均已删除或停用），系统应展示"暂无可用场馆，请先添加场馆"提示。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统 MUST 在场景包编辑页面提供场馆关联配置区域，展示所有有效场馆列表（从 stores 表读取，排除已删除记录）
- **FR-002**: 系统 MUST 支持多选功能，允许运营人员为单个场景包关联一个或多个场馆
- **FR-003**: 系统 MUST 在保存时验证至少选择一个场馆，否则阻止保存并提示错误信息
- **FR-004**: 系统 MUST 在重新打开编辑页面时，自动回显该场景包已关联的场馆（复选框处于选中状态）
- **FR-005**: 系统 MUST 将场景包与场馆的关联关系持久化到数据库关联表中（包含场景包ID、场馆ID、创建时间、修改时间等字段）
- **FR-006**: 系统 MUST 支持场馆搜索功能，允许按场馆名称或地址关键词进行模糊搜索
- **FR-007**: 系统 MUST 在场馆列表中展示场馆的基本信息，包括场馆名称、地址、状态（如营业中、已停用）
- **FR-008**: 系统 MUST 使用乐观锁机制防止并发编辑冲突，当检测到冲突时提示用户刷新页面
- **FR-009**: 系统 MUST 在关联的场馆被停用或删除时，在编辑页面显示警告标识，但保留关联记录（支持历史数据追溯）
- **FR-010**: 系统 SHOULD 支持批量配置场馆关联（非 MVP 必须功能，可后续迭代实现）
- **FR-011**: 系统 MUST 调用现有的门店查询 API（来自 014-hall-store-backend）获取门店列表数据，确保与门店管理功能的数据一致性

### API Testing Requirements

- **TR-001**: 项目 MUST 提供 Postman Collection 文件（`specs/019-store-association/postman/store-association.postman_collection.json`），覆盖所有 API 端点
- **TR-002**: Postman Collection MUST 包含以下 API 测试用例：
  - `GET /api/stores` - 获取门店列表
  - `GET /api/scenario-packages/{id}` - 获取场景包详情（含门店关联）
  - `POST /api/scenario-packages` - 创建场景包（含门店关联）
  - `PUT /api/scenario-packages/{id}` - 更新场景包（含门店关联）
  - `DELETE /api/scenario-packages/{id}` - 删除场景包
- **TR-003**: 每个 Postman 请求 MUST 包含：
  - 请求描述和预期行为说明
  - 环境变量引用（`{{baseUrl}}`、`{{packageId}}`）
  - Tests 脚本验证响应状态码和关键字段
- **TR-004**: Postman Collection SHOULD 包含 Pre-request Scripts 实现测试数据准备和清理
- **TR-005**: 项目 MUST 提供本地开发环境配置文件（`specs/019-store-association/postman/local.postman_environment.json`），包含 `baseUrl=http://localhost:8080` 等变量

### Feature Dependencies

本功能基于以下现有功能进行扩展：

1. **017-scenario-package（场景包管理）** - 主要依赖
   - **依赖内容**: 场景包编辑页面和表单结构
   - **扩展方式**: 在现有编辑页面（`frontend/src/pages/scenario-packages/edit`）中新增"门店关联"配置区域
   - **数据关系**: 通过新增的关联表 `scenario_package_store_associations` 与 `scenario_packages` 表建立多对多关系

2. **014-hall-store-backend（门店和影厅后端建模）** - 数据源依赖
   - **依赖内容**: `stores` 表及其数据模型、门店查询 API
   - **使用方式**: 调用门店列表 API 获取可选门店数据，展示门店名称、地址、状态等信息
   - **数据关系**: 通过关联表中的 `store_id` 外键引用 `stores.id`

3. **frontend/src/pages/stores/（门店管理页面）** - 可选参考
   - **依赖内容**: 门店数据的前端展示和管理
   - **使用方式**: 可复用门店列表的展示组件或 API 调用逻辑

### Key Entities

- **场景包场馆关联关系（ScenarioPackageStoreAssociation）**: 表示场景包与门店的多对多关联关系，通过独立的关联表 `scenario_package_store_associations` 实现，包含关联ID、场景包ID、门店ID、创建时间、修改时间、创建人、修改人等字段
- **门店（Store）**: 现有的门店实体（stores 表，来自 014-hall-store-backend），包含门店ID、门店名称、地址、状态（营业中/已停用）、创建时间等字段，作为关联选择的数据源。门店数据可通过前端门店管理页面（`frontend/src/pages/stores/`）维护
- **场景包（ScenarioPackage）**: 现有的场景包实体（来自 017-scenario-package），通过关联表与门店建立多对多关系。场景包已包含影厅类型关联（hallTypeIds），门店关联是独立的维度，两者配合使用：影厅类型定义适用的影厅规格，门店关联定义可用的地理范围

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 运营人员能在 3 步操作内完成场景包场馆关联配置（打开编辑页 → 选择场馆 → 保存），平均操作时间不超过 1 分钟
- **SC-002**: 当场馆数量超过 10 个时，运营人员使用搜索功能定位目标场馆的时间缩短至 10 秒以内（相比无搜索功能的手动翻找）
- **SC-003**: 场馆关联数据的正确性达到 100%（保存的关联关系与运营人员选择完全一致，无遗漏或错误关联）
- **SC-004**: 系统支持至少 100 个场馆的并发展示和选择操作，列表加载时间不超过 2 秒
- **SC-005**: 在并发编辑场景下，乐观锁机制能 100% 检测到冲突并阻止数据覆盖，避免数据丢失

## Assumptions

1. **stores 表已存在且包含有效数据**: 假设系统中已有门店管理功能（来自 014-hall-store-backend 和前端 `frontend/src/pages/stores/`），stores 表包含门店ID、名称、地址、状态等字段，且至少有 1 个有效门店记录
2. **场景包编辑页面已实现**: 假设场景包的创建/编辑功能已存在（来自 017-scenario-package），本功能在现有编辑页面中新增"门店关联"配置区域（扩展 `frontend/src/pages/scenario-packages/edit` 组件）
3. **采用多对多关联关系**: 假设一个场景包可关联多个门店，一个门店也可被多个场景包关联（通过独立的中间关联表 `scenario_package_store_associations` 实现）
4. **关联关系软删除**: 假设当门店被停用或删除时，关联关系不物理删除，而是保留历史记录（便于数据审计和恢复）
5. **默认排序规则**: 门店列表按创建时间倒序排列（最新添加的门店优先展示），可通过搜索功能覆盖排序
6. **权限控制**: 假设仅具有"场景包管理"权限的B端用户（如运营人员、管理员）可访问门店关联配置功能
7. **UI 组件**: 使用标准的多选复选框列表或多选下拉框（如 Ant Design 的 Select 组件配置 mode="multiple"）实现门店选择
8. **与影厅类型关联的关系**: 假设门店关联与现有的影厅类型关联（hallTypeIds）独立共存，两者配合使用：影厅类型定义场景包适用的影厅规格（如VIP厅、Party厅），门店关联定义场景包在哪些门店可用（地理范围限制）
