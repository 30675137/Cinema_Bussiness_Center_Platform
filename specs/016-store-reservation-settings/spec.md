# Feature Specification: 门店预约设置管理（已整合到门店管理）

**Feature Branch**: `016-store-reservation-settings`
**Created**: 2025-12-22
**Updated**: 2025-12-22
**Status**: Integrated
**Input**: User description: "基于\"014-hall-store-backend\"将门店预约设置功能放到到门店管理中"

> **整合说明**: 本功能已整合到「门店管理」页面，不再作为独立菜单项。用户在门店管理列表中点击「预约」按钮即可配置该门店的预约设置。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 配置门店预约时间段 (Priority: P1)

作为运营人员，我希望在门店管理页面中为每个门店配置可预约的时间段（如工作日 10:00-22:00，周末 9:00-23:00），这样影厅预约系统就可以根据门店的营业时间自动判断哪些时段可以接受预约，避免在非营业时间产生无效预订。

**Why this priority**: 门店预约时间段是预约系统的基础约束条件。没有这个配置，系统无法判断哪些时间段可以接受预约，会导致预约冲突和运营混乱。这是预约功能的核心前置条件。

**Independent Test**: 只实现本故事时，运营可以为指定门店设置营业时间段（如工作日 10:00-22:00，周末 9:00-23:00），保存后，前端影厅预约页面在选择时段时自动过滤掉非营业时间，只允许选择配置的可预约时间段。

**Acceptance Scenarios**:

1. **Given** 门店 A 已存在且当前无预约时间配置，**When** 运营在门店管理页面为门店 A 添加工作日预约时间段 10:00-22:00 并保存，**Then** 配置成功保存到数据库，前端影厅预约页面选择门店 A 时，工作日时段选择器只显示 10:00-22:00 范围内的时间点
2. **Given** 门店 A 已配置工作日 10:00-22:00 预约时段，**When** 运营在门店管理页面修改为 9:00-23:00 并保存，**Then** 新配置覆盖旧配置，前端影厅预约页面立即生效新的时间范围
3. **Given** 门店 A 已配置预约时段，**When** 运营在门店管理页面删除该配置，**Then** 该门店的预约时段恢复为空（或系统默认值），前端影厅预约页面对该门店显示"未配置预约时间"提示

---

### User Story 2 - 配置门店预约提前量 (Priority: P1)

作为运营人员，我希望为每个门店设置预约提前量（如至少提前 2 小时预约，最多提前 30 天预约），这样可以给门店留出准备时间，同时避免用户过早锁定资源导致资源浪费。

**Why this priority**: 预约提前量是预约系统的重要运营规则，直接影响用户预约体验和门店资源利用效率。没有这个配置，可能出现用户临时预约导致门店无法准备，或提前半年预约占用资源的问题。

**Independent Test**: 只实现本故事时，运营可以为指定门店设置最小提前时间（如 2 小时）和最大提前时间（如 30 天），保存后，前端影厅预约页面在选择日期时自动禁用不符合提前量规则的日期（如小于 2 小时或大于 30 天的日期不可选）。

**Acceptance Scenarios**:

1. **Given** 门店 A 已存在且当前无提前量配置，**When** 运营为门店 A 设置最小提前 2 小时、最大提前 30 天并保存，**Then** 配置成功保存，前端预约页面选择日期时，距离当前时间小于 2 小时的时段不可选，大于 30 天的日期也不可选
2. **Given** 当前时间是 12 月 22 日 14:00，门店 A 配置最小提前 2 小时，**When** 用户在前端预约页面选择 12 月 22 日 15:00 时段，**Then** 系统提示"不满足最小提前 2 小时要求"并阻止预约
3. **Given** 门店 A 配置最大提前 30 天，**When** 用户尝试预约 60 天后的时段，**Then** 系统提示"不满足最大提前 30 天要求"并阻止预约

---

### User Story 3 - 配置门店预约单位时长 (Priority: P2)

作为运营人员，我希望为每个门店设置预约的最小时间单位（如 1 小时、2 小时或 4 小时），这样可以标准化预约时段，避免出现零碎的 30 分钟或 15 分钟预约，方便资源排期和清场准备。

**Why this priority**: 预约单位时长影响资源排期的颗粒度和运营效率，但不是预约功能的强制前置条件。如果缺少此配置，系统可以默认使用 1 小时作为单位，不影响核心预约流程。

**Independent Test**: 只实现本故事时，运营可以为指定门店设置预约时间单位（如 2 小时），保存后，前端影厅预约页面在选择时长时只能选择 2 小时的倍数（如 2h、4h、6h），无法选择 1 小时或 3 小时。

**Acceptance Scenarios**:

1. **Given** 门店 A 已存在且当前无时长单位配置（默认 1 小时），**When** 运营为门店 A 设置预约时间单位为 2 小时并保存，**Then** 配置成功保存，前端预约页面的时长选择器只显示 2h、4h、6h 等选项
2. **Given** 门店 A 配置预约时间单位为 4 小时，**When** 用户在前端预约页面尝试选择 2 小时时长，**Then** 系统提示"该门店最小预约时长为 4 小时"并自动调整为 4 小时

---

### User Story 4 - 配置门店预约押金规则 (Priority: P3)

作为运营人员，我希望为每个门店设置预约押金规则（如是否需要押金、押金金额或押金比例），这样可以降低用户爽约风险，保障门店利益。

**Why this priority**: 押金规则是预约系统的增值功能，用于提升预约履约率和保护门店利益。但这不是预约功能的核心，缺少押金功能时用户仍可正常预约，只是门店需要承担更高的爽约风险。

**Independent Test**: 只实现本故事时，运营可以为指定门店设置押金规则（如需要押金，押金金额 200 元），保存后，前端预约页面在提交预约时显示押金信息并要求用户支付押金，否则无法完成预约。

**Acceptance Scenarios**:

1. **Given** 门店 A 已存在且当前无押金规则，**When** 运营为门店 A 设置押金规则（需要押金，押金 200 元）并保存，**Then** 配置成功保存，前端预约页面在选择门店 A 时显示"需支付押金 200 元"提示
2. **Given** 门店 A 配置押金 200 元，**When** 用户在前端完成预约信息填写并提交，**Then** 系统跳转到支付页面要求用户支付 200 元押金，支付成功后才创建预约记录

---

### Edge Cases

- 门店预约时间段存在交叉或重叠时如何处理？（如工作日 10:00-22:00 和周末 9:00-23:00 同时配置）
- 门店被停用后，已配置的预约设置是否保留？重新启用门店时是否自动恢复这些配置？
- 预约提前量配置修改后，已存在的未来预约是否受影响？（如原本提前 60 天预约成功，后续修改为最大提前 30 天）
- 门店预约时间段配置为空时，前端预约页面应该禁用该门店选项还是使用默认全天候时段？
- 预约单位时长修改后，正在进行中的预约（跨越修改时间点）是否需要调整？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须允许运营人员为每个门店配置可预约的时间段，支持按星期分别配置（如周一至周五 10:00-22:00，周六周日 9:00-23:00），每个时间段包含开始时间和结束时间
- **FR-002**: 系统必须允许运营人员为每个门店配置预约提前量规则，包括最小提前时间（如至少提前 2 小时）和最大提前时间（如最多提前 30 天），并在前端预约页面根据此规则限制可选日期和时段
- **FR-003**: 系统必须允许运营人员为每个门店配置预约单位时长（如 1 小时、2 小时、4 小时），前端预约页面的时长选择器必须基于此配置仅显示允许的时长选项
- **FR-004**: 系统必须允许运营人员为每个门店配置预约押金规则，包括是否需要押金、押金金额或押金比例（按预约总价的百分比），前端预约流程根据此规则决定是否要求用户支付押金
- **FR-005**: 系统必须提供查询指定门店预约设置的 API 接口，返回该门店的所有预约配置（时间段、提前量、时长单位、押金规则），供前端影厅预约页面使用
- **FR-006**: 系统必须在门店管理页面的操作列中集成「预约」按钮，运营人员点击后弹出预约设置 Modal，可查看和修改该门店的预约配置（已整合，不再独立页面）
- **FR-007**: 系统必须对预约设置的输入进行合法性校验，如开始时间必须早于结束时间、最小提前时间必须小于最大提前时间、押金金额必须为非负数等，校验失败时返回明确错误提示
- **FR-008**: 当门店预约设置被修改时，系统必须记录修改日志（包括修改人、修改时间、修改前后的值），便于审计和问题排查
- **FR-009**: 当门店被停用时，系统必须保留该门店的预约设置配置但标记为不可用，前端预约页面不再显示该门店，重新启用门店时预约设置自动恢复生效
- **FR-010**: 系统必须为新创建的门店提供默认的预约设置（如默认工作日 9:00-21:00，最小提前 1 小时，最大提前 30 天，时长单位 1 小时，无押金），运营可以基于默认值修改

### Key Entities *(include if feature involves data)*

- **Store（门店）**: 在 014-hall-store-backend 基础上扩展，增加与预约设置的关联关系
  - storeId（系统内部唯一标识）
  - name（门店名称）
  - region / city（所属区域/城市）
  - status（启用/停用等枚举）
  - reservationSettings（关联的预约设置实体）
  - createdAt, updatedAt（时间戳）

- **ReservationSettings（预约设置）**: 表示一个门店的预约配置规则
  - settingsId（设置唯一标识）
  - storeId（所属门店标识，外键关联 Store）
  - timeSlots（可预约时间段列表，按星期分组，每个时段包含 dayOfWeek、startTime、endTime）
  - minAdvanceHours（最小提前小时数，如 2 表示至少提前 2 小时）
  - maxAdvanceDays（最大提前天数，如 30 表示最多提前 30 天）
  - durationUnit（预约单位时长，单位：小时，如 1、2、4）
  - depositRequired（是否需要押金，布尔值）
  - depositAmount（押金金额，单位：元，当 depositRequired 为 true 时有效）
  - depositPercentage（押金比例，单位：百分比，当 depositRequired 为 true 且希望按比例收取时使用）
  - isActive（配置是否生效，布尔值，门店停用时设为 false）
  - createdBy, updatedBy（创建人和修改人）
  - createdAt, updatedAt（时间戳）

- **ReservationTimeSlot（预约时间段）**: 表示门店在某一天的可预约时间段
  - dayOfWeek（星期几，1-7 表示周一至周日）
  - startTime（开始时间，格式如 "10:00"）
  - endTime（结束时间，格式如 "22:00"）

- **Store-ReservationSettings Relationship（门店-预约设置关系）**: 一对一关系，一个门店有一个预约设置配置，通过 storeId 外键关联

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 运营人员可以在 3 分钟内为一个门店完成所有预约设置的配置（时间段、提前量、时长单位、押金规则），并在前端影厅预约页面验证配置生效
- **SC-002**: 前端影厅预约页面在用户选择门店后，根据该门店的预约设置自动过滤不可用时段的准确率达到 100%，不会出现选择了非营业时间或违反提前量规则的情况
- **SC-003**: 门店预约设置修改后，前端影厅预约页面在 5 秒内响应最新配置，用户刷新页面或重新选择门店后立即看到新规则
- **SC-004**: 对于预约设置的任何修改，系统记录完整的审计日志（修改人、修改时间、修改内容），审计日志覆盖率 100%
- **SC-005**: 门店管理页面集成预约设置入口后，用户可以在 2 秒内打开预约设置配置界面，查看和修改配置的操作流畅度用户满意度达 90% 以上

## Assumptions

- 预约时间段按星期配置，假设同一天只有一个时间段（如周一 10:00-22:00），不支持一天内多个不连续时段（如 10:00-12:00 和 14:00-22:00），如果未来需要支持，可扩展 timeSlots 字段为列表
- 预约提前量规则假设对所有影厅一视同仁，不区分不同类型影厅的提前量差异
- 押金规则假设同一门店的所有影厅使用相同的押金策略，不支持按影厅类型差异化配置押金
- 新创建的门店假设自动分配默认预约设置（工作日 9:00-21:00，最小提前 1 小时，最大提前 30 天，时长单位 1 小时，无押金），运营可后续修改
- 门店被停用时假设预约设置配置保留但标记为不可用（isActive = false），重新启用门店时自动恢复（isActive = true）
- 预约设置修改仅对新预约生效，不影响已创建的历史预约记录
