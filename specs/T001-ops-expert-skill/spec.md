# Feature Specification: 运营专家技能 (Ops Expert Skill)

**Feature Branch**: `T001-ops-expert-skill`
**Created**: 2025-12-25
**Status**: Draft
**Input**: User description: "创建一个熟悉这套系统的运营专家技能可以通过交流完成日常对系统的操作"

<!--
  规格编号格式说明 (Spec ID Format):
  T001 - 工具/基础设施模块的第一个功能
-->

## Clarifications

### Session 2025-12-25

- Q: 技能实现形式应采用哪种 Claude Code 组件？ → A: Agent + Skill 组合 - Agent (`agents/ops-expert.md`) 负责交互执行，Skill (`skills/ops-expert/SKILL.md`) 提供业务知识库作为参考
- Q: Skill 业务知识库应包含哪些业务领域的规则？ → A: 全部规划模块（包含品牌、分类、库存等），不仅限于已实现功能
- Q: Agent 执行操作时应使用什么工具来与系统交互？ → A: 查询走 Supabase MCP 直接读取数据库，写操作走后端 API（封装为 Python 脚本供 Agent 调用）
- Q: Skill 知识库的内容来源和更新机制是什么？ → A: 以 specs 目录规格文档为主自动/半自动生成，手动补充运营特有内容（如常见问题、操作技巧、业务场景示例）
- Q: Python 脚本的执行环境和依赖管理方式？ → A: 使用项目根目录虚拟环境 (venv/poetry)，与现有 Python 工具共享依赖管理
- Q: Agent 的触发方式和调用入口是什么？ → A: 通过 slash command 手动触发（如 `/ops`），用户明确调用运营专家

### Session 2025-12-26

- Q: SKU创建与BOM配置的操作流程应该是什么？ → A: 导入模式 - 支持通过Excel/CSV批量导入SKU和BOM配置
- Q: SKU和BOM的必填字段应包含哪些？ → A: 标准集 - SKU编码、名称、规格、分类、单位、成本价、售价；BOM包含子项SKU编码、数量、单位
- Q: Excel/CSV导入SKU/BOM时，数据验证失败如何处理？ → A: 导入时进行前置校验，显示错误清单，允许修正后重新导入
- Q: 组合商品（有BOM的SKU）的成本价和售价如何确定？ → A: 成本自动计算 - 系统自动计算组合商品成本价 = Σ(子项成本价 × 数量)，售价由运营人员手动设置
- Q: BOM嵌套深度和循环依赖应如何限制？ → A: 支持多层BOM（最多3层），循环依赖检测，显示警告但允许继续

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 通过对话查询系统数据 (Priority: P1)

运营人员希望通过自然语言对话的方式快速查询系统中的各类数据，例如"查看所有已发布的场景包"、"显示门店A的预约设置"、"统计本周的预约订单数量"，而无需手动在多个管理页面之间切换导航。

**Why this priority**: 查询是运营人员最高频的操作，通过对话查询可以显著提升工作效率。这是技能的核心价值，不依赖其他功能即可独立提供价值。

**Independent Test**: 运营人员可以输入自然语言查询指令，系统返回准确的数据结果，无需进入具体管理页面即可获取所需信息。

**Acceptance Scenarios**:

1. **Given** 运营人员打开运营专家对话界面，**When** 输入"查看所有已发布的场景包"，**Then** 系统返回所有状态为"已发布"的场景包列表，包含名称、价格、适用影厅等关键信息
2. **Given** 对话界面已打开，**When** 输入"门店A的预约时间段是什么"，**Then** 系统返回门店A的预约时间配置（如工作日10:00-22:00，周末9:00-23:00）
3. **Given** 对话界面已打开，**When** 输入"本周有多少个场景包预约订单"，**Then** 系统统计并返回本周的预约订单数量和基本摘要信息
4. **Given** 查询结果返回后，**When** 运营人员点击结果中的数据项，**Then** 系统跳转到对应的管理页面以便进行详细查看或编辑

---

### User Story 2 - 通过对话执行日常操作 (Priority: P2)

运营人员希望通过自然语言指令执行常见的日常操作，例如"将场景包X下架"、"为门店B添加工作日预约时段10:00-20:00"、"创建一个新的场景包草稿"，系统自动识别意图并执行操作，减少手动操作步骤。

**Why this priority**: 执行操作是运营工作的核心，但需要建立在查询能力之上（先查询确认目标对象，再执行操作）。通过对话执行可以简化多步骤操作流程。

**Independent Test**: 运营人员可以输入操作指令，系统解析意图后执行操作，并返回操作结果确认。

**Acceptance Scenarios**:

1. **Given** 对话界面已打开，**When** 输入"将场景包'VIP生日派对'下架"，**Then** 系统识别目标场景包，请求运营人员确认，确认后执行下架操作并返回"已成功下架"的确认消息
2. **Given** 对话界面已打开，**When** 输入"为门店'旗舰店'设置周末预约时段9:00-23:00"，**Then** 系统更新门店的预约时间配置并返回确认消息
3. **Given** 对话界面已打开，**When** 输入"创建一个名为'家庭观影日'的新场景包"，**Then** 系统创建场景包草稿并返回创建结果，提示运营人员后续需要配置内容和定价
4. **Given** 执行操作前，**When** 系统识别到操作具有破坏性（如删除、下架），**Then** 系统显示确认对话框，要求运营人员明确确认后才执行

---

### User Story 3 - 获取操作指导和系统帮助 (Priority: P3)

运营人员希望在遇到不确定的操作时，可以向系统询问操作指导，例如"如何发布一个场景包"、"场景包定价策略怎么设置"、"门店预约押金规则有哪些选项"，系统提供清晰的操作步骤说明和业务规则解释。

**Why this priority**: 操作指导帮助新运营人员快速上手，减少培训成本，但不是核心功能。对于熟练的运营人员，查询和操作功能更重要。

**Independent Test**: 运营人员可以输入帮助类问题，系统返回准确的操作指导和业务规则说明。

**Acceptance Scenarios**:

1. **Given** 对话界面已打开，**When** 输入"如何发布一个场景包"，**Then** 系统返回场景包发布的完整步骤说明（创建草稿→配置内容→设置定价→发布），并说明每个步骤的要求
2. **Given** 对话界面已打开，**When** 输入"场景包发布需要满足什么条件"，**Then** 系统返回发布前置条件（必须包含至少一项内容：硬权益、软权益或服务项目，且必须设置定价）
3. **Given** 对话界面已打开，**When** 输入"门店预约提前量是什么意思"，**Then** 系统解释预约提前量的业务含义（最小提前时间和最大提前时间的作用）并给出配置示例

---

### User Story 4 - 批量操作和数据导出 (Priority: P4)

运营人员希望通过对话发起批量操作或数据导出请求，例如"将所有门店的预约时长单位改为2小时"、"导出本月所有场景包的销售数据"、"批量下架所有过期的促销场景包"，系统确认操作范围后批量执行。

**Why this priority**: 批量操作是高级功能，使用频率较低但在特定场景下非常有价值（如批量配置新门店、季度数据统计）。需要谨慎处理以防止误操作。

**Independent Test**: 运营人员可以发起批量操作请求，系统显示受影响的数据范围，确认后批量执行并返回执行结果摘要。

**Acceptance Scenarios**:

1. **Given** 对话界面已打开，**When** 输入"将所有门店的预约时长单位改为2小时"，**Then** 系统列出受影响的门店数量和名称，请求确认，确认后批量更新并返回"已更新N家门店的预约时长单位"
2. **Given** 对话界面已打开，**When** 输入"导出所有已发布场景包的列表"，**Then** 系统生成导出文件并提供下载链接
3. **Given** 批量操作影响超过10条数据，**When** 系统识别到批量操作请求，**Then** 系统强制要求二次确认，显示"此操作将影响N条数据，请输入'确认执行'以继续"

---

### Edge Cases

- 当运营人员的指令含糊不清或存在多个匹配结果时如何处理？系统应请求澄清，如"找到多个名为'VIP'的场景包，请问您指的是哪一个？"
- 当指令中提及的数据不存在时如何处理？系统应提示"未找到名为'XXX'的场景包，请检查名称是否正确"
- 当运营人员尝试执行超出权限的操作时如何处理？系统应提示"您没有执行此操作的权限，请联系管理员"
- 当系统无法理解运营人员的指令时如何处理？系统应提示"抱歉，我没有理解您的意思，您可以尝试换一种方式描述，或输入'帮助'查看支持的操作"
- 当执行操作过程中发生系统错误时如何处理？系统应提示"操作执行失败：[错误原因]，请稍后重试或联系技术支持"
- 当运营人员在对话中切换上下文（如从查询门店切换到查询场景包）时如何处理？系统应正确识别新的上下文，不应混淆不同业务对象的查询和操作
- 当批量操作部分成功部分失败时如何处理？系统应返回详细的执行报告，列出成功和失败的条目及失败原因
- 当Excel/CSV导入SKU/BOM数据验证失败时如何处理？系统应进行前置校验，在导入前显示完整的错误清单（包含行号、字段名、错误原因），不执行任何数据写入，允许运营人员修正文件后重新导入
- 当BOM配置中引用的子项SKU编码不存在时如何处理？系统应在前置校验阶段标记为错误，提示"第X行：子项SKU编码'YYY'不存在，请先创建该SKU或检查编码是否正确"
- 当导入的SKU编码与现有数据重复时如何处理？系统应在前置校验阶段提示"第X行：SKU编码'ZZZ'已存在"，并允许运营人员选择：(1) 跳过该行 (2) 更新现有SKU (3) 修改文件后重新导入
- 当BOM嵌套深度超过3层时如何处理？系统应在前置校验阶段拒绝导入，提示"第X行：BOM嵌套深度超过最大限制（3层），请调整BOM结构后重新导入"
- 当BOM配置存在循环依赖时如何处理？系统应在前置校验阶段检测并显示警告"检测到循环依赖：SKU-A → SKU-B → SKU-A，这可能导致成本计算错误"，然后询问运营人员是否继续导入（允许继续但记录警告日志）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须提供一个 Claude Code Agent (`agents/ops-expert.md`) 作为运营专家代理，通过 slash command `/ops` 手动触发调用；同时提供 Skill 知识库 (`skills/ops-expert/SKILL.md`) 作为业务规则参考
- **FR-001a**: Agent 查询数据时通过 Supabase MCP 直接读取数据库，执行写操作时调用封装好的 Python 脚本（位于 `skills/ops-expert/scripts/`），脚本内部调用后端 REST API
- **FR-001b**: Skill 知识库内容以 specs 目录规格文档为主要来源（自动/半自动生成），同时包含手动维护的运营特有内容（`references/ops-guide.md`：常见问题、操作技巧、业务场景示例）
- **FR-002**: 系统必须能够解析运营人员的自然语言输入，识别查询意图、操作意图或帮助请求意图
- **FR-003**: 系统必须支持查询以下业务数据：场景包（列表、详情、统计）、门店（列表、详情、预约设置）、影厅（列表、详情）、预约订单（列表、统计）
- **FR-004**: 系统必须支持执行以下常见操作：场景包状态变更（发布/下架）、门店预约设置修改、场景包基本信息编辑、SKU批量创建（通过Excel/CSV导入）、BOM配置批量导入
- **FR-005**: 系统必须在执行破坏性操作（删除、下架、批量修改）前请求运营人员确认
- **FR-006**: 系统必须提供操作指导功能，能够回答关于系统功能、业务规则和操作流程的问题
- **FR-007**: 系统必须记录所有通过对话执行的操作日志，包括操作人、操作时间、操作内容和操作结果
- **FR-008**: 系统必须在查询结果中提供跳转到对应管理页面的链接，方便运营人员进行详细查看或编辑
- **FR-009**: 系统必须能够处理模糊查询，当存在多个匹配结果时引导运营人员进行选择
- **FR-010**: 系统必须支持对话上下文管理，能够基于上下文理解后续指令（如"查看详情"指上一次查询的结果）
- **FR-011**: 系统必须在无法理解指令时提供友好的错误提示和引导
- **FR-012**: 系统必须支持批量操作请求，在执行前显示受影响的数据范围
- **FR-013**: 系统必须验证运营人员的权限，禁止执行超出权限范围的操作
- **FR-014**: 系统必须提供常用指令示例和帮助文档，帮助运营人员了解支持的功能
- **FR-015**: 系统必须支持Excel/CSV格式的SKU批量导入，在导入前进行完整的数据验证，显示所有验证错误的详细清单（包含行号、字段名、错误原因），验证通过后才允许执行导入
- **FR-016**: 系统必须支持Excel/CSV格式的BOM配置批量导入，验证子项SKU编码的存在性，确保BOM数据的引用完整性
- **FR-017**: 系统必须在SKU/BOM导入时处理编码重复冲突，允许运营人员选择处理策略（跳过、更新、取消导入）
- **FR-018**: 系统必须在导入具有BOM的组合商品时，自动计算其成本价（成本价 = Σ(子项成本价 × 子项数量)），确保成本核算的准确性和一致性；售价由运营人员在导入文件中手动填写
- **FR-019**: 系统必须支持最多3层深度的BOM嵌套（例如：套餐 → 组合商品 → 基础商品），超过3层深度时在前置校验阶段拒绝导入
- **FR-020**: 系统必须在BOM导入时检测循环依赖（例如：SKU-A的BOM包含SKU-B，SKU-B的BOM又包含SKU-A），检测到循环依赖时显示警告信息但允许运营人员选择是否继续导入

### Key Entities *(include if feature involves data)*

- **OpsExpertSession（运营专家会话）**: 代表一次运营人员与系统的对话会话，包含会话ID、运营人员ID、开始时间、最后活动时间、会话状态（活跃/已结束）
- **ConversationMessage（对话消息）**: 代表会话中的一条消息，包含消息ID、会话ID、消息类型（用户输入/系统响应）、消息内容、时间戳
- **OperationLog（操作日志）**: 记录通过对话执行的操作，包含日志ID、会话ID、操作人ID、操作类型、操作目标、操作参数、操作结果、执行时间
- **IntentRecognition（意图识别结果）**: 解析用户输入后的结构化结果，包含意图类型（查询/操作/帮助）、业务领域（场景包/门店/影厅/订单）、操作动作、目标参数
- **SKU（库存单位）**: 代表可销售/库存管理的基本商品单位，包含SKU编码（唯一标识）、名称、规格描述、分类、计量单位、成本价、售价、创建时间、更新时间
- **BOM（物料清单）**: 定义组合商品的构成关系，包含父级SKU编码、子项SKU编码、子项数量、子项单位、BOM版本号、生效日期

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 运营人员可以在30秒内通过对话获取所需的数据查询结果，无需在多个页面间切换
- **SC-002**: 系统对常见运营指令的意图识别准确率达到90%以上
- **SC-003**: 通过对话执行的日常操作（如场景包上下架、门店预约设置修改）成功率达到95%以上
- **SC-004**: 80%的运营人员在首次使用后表示对话式操作比传统页面操作更高效
- **SC-005**: 系统对不理解的指令能够在2秒内提供友好的引导提示
- **SC-006**: 所有通过对话执行的操作都有完整的操作日志记录，审计覆盖率100%
- **SC-007**: 破坏性操作（删除、批量修改）的误操作率控制在1%以下（通过确认机制保障）
- **SC-008**: 运营人员平均每天使用对话技能的次数达到10次以上（表明技能被接受和常用）

## Assumptions

1. 运营人员具备基本的系统使用经验，了解场景包、门店、影厅等核心业务概念
2. 对话技能作为辅助工具，不替代传统的管理后台页面，两者并存
3. 意图识别基于预定义的指令模式和关键词，不依赖复杂的AI模型训练
4. 运营人员的权限由现有的角色权限系统管理，对话技能遵循相同的权限规则
5. 对话上下文仅在当前会话内有效，会话结束后上下文清空
6. 批量操作的数据量上限为100条，超过需要分批执行
7. 系统支持的业务领域包括：场景包管理、门店管理、影厅管理、预约订单管理、品牌管理、分类管理、库存管理等全部规划模块（知识库覆盖全部规划功能，实际操作能力随模块实现逐步扩展）
8. 对话界面采用侧边栏或弹窗形式，不独占屏幕，方便运营人员同时查看其他页面
9. Python 脚本使用项目根目录虚拟环境 (venv/poetry)，依赖包括 requests、supabase-py 等，与现有 `.specify/scripts/` 工具共享依赖管理
10. 组合商品（配置了BOM的SKU）的成本价由系统根据BOM自动计算（成本价 = Σ(子项成本价 × 子项数量)），售价由运营人员根据定价策略手动设置，允许售价高于或低于成本（系统不强制利润率限制）
11. SKU/BOM批量导入仅支持新增和更新操作，不支持批量删除（删除操作需通过对话单独确认，防止误操作）
12. BOM支持最多3层嵌套深度（例如：套餐 → 组合商品 → 基础商品），这个深度能够满足大多数实际业务场景，同时避免过度复杂导致的性能和维护问题
13. BOM循环依赖检测会在前置校验阶段执行，检测到循环依赖时系统显示警告但允许运营人员选择继续导入（用于处理特殊场景或测试数据），所有循环依赖的导入操作都会记录在操作日志中便于审计

## Out of Scope

1. 基于机器学习的智能意图理解（当前使用规则匹配和关键词识别）
2. 多轮复杂对话和任务规划（如"帮我创建一个完整的场景包并发布"的多步骤自动执行）
3. 语音输入和语音交互功能
4. 移动端App的对话技能适配（当前仅支持B端管理后台）
5. 与第三方系统的数据集成（如从美团同步订单数据）
6. 预测性建议和智能推荐（如"您可能想要查看..."）
7. 对话记录的永久存储和历史对话检索（当前仅保留活跃会话）
8. 自然语言生成的报表和数据分析（仅支持预定义格式的数据查询）
