# Feature Specification: Material Management Filter & Actions

**Feature Branch**: `M002-material-filter`  
**Created**: 2026-01-14  
**Status**: Draft  
**Input**: User description: "增加物料主数据管理的筛选器区域（分类筛选、状态筛选、成本范围、关键词搜索）和操作按钮组（新建物料、批量导入、批量导出、批量操作）"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 快速筛选物料 (Priority: P1)

作为物料管理员，我需要能够快速筛选和搜索物料，以便在大量物料数据中找到目标物料进行后续操作（编辑、查看、删除等）。

**Why this priority**: 这是最基础的查询功能，是所有物料管理操作的前提。没有有效的筛选功能，用户无法在大量数据中快速定位目标物料，严重影响工作效率。

**Independent Test**: 可以通过在物料列表页面输入不同的筛选条件（分类、状态、成本范围、关键词），验证筛选结果是否正确，无需依赖其他功能即可独立测试。

**Acceptance Scenarios**:

1. **Given** 物料列表页面已加载，**When** 用户在分类筛选器中选择"原料"，**Then** 列表仅显示分类为"原料"的物料
2. **Given** 物料列表页面已加载，**When** 用户在状态筛选器中选择"在用"，**Then** 列表仅显示状态为"在用"的物料
3. **Given** 物料列表页面已加载，**When** 用户在成本范围输入框中输入最小成本 10 和最大成本 100，**Then** 列表仅显示标准成本在 10-100 元之间的物料
4. **Given** 物料列表页面已加载，**When** 用户在关键词搜索框中输入"糖浆"，**Then** 列表显示物料编码或物料名称中包含"糖浆"的所有物料
5. **Given** 用户已设置多个筛选条件（如分类="原料"、状态="在用"、关键词="糖"），**When** 用户点击"重置"按钮，**Then** 所有筛选条件清空，列表显示全部物料
6. **Given** 用户已设置多个筛选条件，**When** 用户点击"查询"按钮，**Then** 列表根据所有筛选条件的交集进行过滤显示

---

### User Story 2 - 批量导出物料数据 (Priority: P2)

作为物料管理员，我需要能够将筛选后的物料数据导出为 Excel 文件，以便进行线下分析、存档或与其他部门共享数据。

**Why this priority**: 导出功能是数据管理系统的标准功能，允许用户在系统外进行数据分析和共享。虽然不影响核心增删改查功能，但对于数据分析和报表需求很重要。

**Independent Test**: 可以独立测试：点击"批量导出"按钮后是否生成正确的 Excel 文件，文件中是否包含当前筛选条件下的所有物料数据及正确的列。

**Acceptance Scenarios**:

1. **Given** 物料列表页面已加载且未设置任何筛选条件，**When** 用户点击"批量导出"按钮，**Then** 系统生成包含所有物料数据的 Excel 文件并自动下载
2. **Given** 用户已设置筛选条件（如分类="包材"），**When** 用户点击"批量导出"按钮，**Then** 系统生成仅包含符合筛选条件的物料数据的 Excel 文件
3. **Given** 物料列表为空（无物料或筛选结果为空），**When** 用户点击"批量导出"按钮，**Then** 系统提示"暂无数据可导出"
4. **Given** 用户点击"批量导出"按钮，**When** 导出文件生成成功，**Then** Excel 文件包含以下列：物料编码、物料名称、分类、状态、库存单位、采购单位、换算率、标准成本、规格、描述、创建时间

---

### User Story 3 - 批量导入物料数据 (Priority: P3)

作为物料管理员，我需要能够通过上传 Excel 文件批量导入物料数据，以便快速初始化系统数据或批量添加新物料。

**Why this priority**: 批量导入功能在系统初始化阶段或需要大量新增物料时非常有用，但在日常使用中频率较低。相比核心筛选和导出功能，优先级较低。

**Independent Test**: 可以独立测试：准备符合模板格式的 Excel 文件，上传后验证物料是否正确创建，错误处理是否符合预期。

**Acceptance Scenarios**:

1. **Given** 物料列表页面已加载，**When** 用户点击"批量导入"按钮，**Then** 系统打开文件上传对话框
2. **Given** 文件上传对话框已打开，**When** 用户点击"下载模板"链接，**Then** 系统下载标准格式的 Excel 模板文件
3. **Given** 用户选择了符合模板格式的 Excel 文件，**When** 用户点击"上传"按钮，**Then** 系统解析文件并显示预览结果（包含成功和失败的行数统计）
4. **Given** 预览结果显示有部分数据校验失败，**When** 用户查看失败详情，**Then** 系统显示每一行的具体错误信息（如"第3行：物料名称不能为空"）
5. **Given** 预览结果全部校验成功，**When** 用户点击"确认导入"按钮，**Then** 系统批量创建物料并显示导入成功的数量
6. **Given** 导入文件中包含重复的物料编码，**When** 系统处理该行数据，**Then** 系统标记该行为失败并提示"物料编码已存在"

---

### User Story 4 - 批量操作物料 (Priority: P3)

作为物料管理员，我需要能够批量选择多个物料并执行批量操作（如批量删除、批量修改状态），以便提高批量管理效率。

**Why this priority**: 批量操作功能提升管理效率，但相比基础筛选和单条操作，使用频率较低，优先级较低。

**Independent Test**: 可以独立测试：在列表中勾选多个物料，点击批量操作按钮，验证操作是否正确应用到所有选中的物料。

**Acceptance Scenarios**:

1. **Given** 物料列表页面已加载，**When** 用户勾选多个物料（如3个），**Then** 页面顶部显示"已选择 3 项"提示和批量操作按钮
2. **Given** 用户已勾选多个物料，**When** 用户点击"批量删除"按钮，**Then** 系统弹出确认对话框显示"确定要删除选中的 N 个物料吗？"
3. **Given** 确认对话框已打开，**When** 用户点击"确定"按钮，**Then** 系统删除所有选中的物料并显示删除结果（成功X个，失败Y个）
4. **Given** 用户已勾选多个物料，**When** 用户点击"批量修改状态"按钮并选择"停用"，**Then** 系统批量更新所有选中物料的状态为"停用"
5. **Given** 批量操作中部分物料因被 BOM 引用而无法删除，**When** 批量删除完成，**Then** 系统显示详细结果："成功删除 2 个，失败 1 个（物料编码 M001 已被 BOM 引用）"

---

### Edge Cases

- **筛选条件组合为空**: 当用户设置的筛选条件组合导致没有符合条件的物料时，列表显示"暂无数据"提示，而不是空白页面
- **成本范围输入无效**: 当用户输入的最小成本大于最大成本时，系统提示"最小成本不能大于最大成本"
- **关键词搜索特殊字符**: 当用户在关键词搜索框中输入特殊字符（如 `%`, `_`, `\`）时，系统正确转义并进行精确匹配
- **导出大数据量**: 当导出的物料数量超过 10000 条时，系统提示"数据量过大，建议使用筛选条件缩小范围"并限制单次导出最多 10000 条
- **导入文件格式错误**: 当上传的文件不是 Excel 格式或文件损坏时，系统提示"文件格式错误或文件损坏，请重新上传"
- **导入文件列缺失**: 当上传的 Excel 文件缺少必填列（如物料名称、分类）时，系统提示"文件缺少必填列：物料名称、分类"
- **批量操作权限**: 当用户没有批量删除权限时，批量删除按钮显示为禁用状态并提示"您没有权限执行此操作"
- **批量操作部分失败**: 批量操作中部分成功部分失败时，系统显示详细的成功和失败列表，允许用户查看具体哪些物料操作失败及原因

## Requirements *(mandatory)*

### Functional Requirements

#### 筛选功能

- **FR-001**: 系统必须提供分类筛选下拉框，允许用户选择"原料"或"包材"，选择后列表仅显示该分类的物料
- **FR-002**: 系统必须提供状态筛选下拉框，允许用户选择"在用"、"停用"或"淘汰"，选择后列表仅显示该状态的物料
- **FR-003**: 系统必须提供成本范围输入框（最小成本、最大成本），允许用户输入数字，输入后列表仅显示标准成本在该范围内的物料
- **FR-004**: 系统必须提供关键词搜索框，允许用户输入关键词，搜索物料编码或物料名称中包含该关键词的物料（不区分大小写）
- **FR-005**: 系统必须提供"查询"按钮，点击后根据所有已设置的筛选条件进行过滤
- **FR-006**: 系统必须提供"重置"按钮，点击后清空所有筛选条件并重新加载全部物料
- **FR-007**: 所有筛选器必须支持"清空"操作（下拉框显示×图标），点击后清空该筛选条件
- **FR-008**: 当多个筛选条件同时设置时，系统必须按照条件的交集进行过滤（AND 逻辑）

#### 操作按钮组

- **FR-009**: 系统必须在页面右上方提供"新建物料"按钮，点击后打开物料创建表单
- **FR-010**: 系统必须提供"批量导入"按钮，点击后打开文件上传对话框
- **FR-011**: 系统必须提供"批量导出"按钮，点击后根据当前筛选条件导出物料数据为 Excel 文件
- **FR-012**: 系统必须提供"批量操作"下拉菜单，包含"批量删除"和"批量修改状态"选项

#### 批量导出

- **FR-013**: 导出的 Excel 文件必须包含以下列：物料编码、物料名称、分类、状态、库存单位、采购单位、换算率、标准成本、规格、描述、创建时间
- **FR-014**: 导出文件名必须包含时间戳，格式为：`物料数据_YYYYMMDD_HHmmss.xlsx`
- **FR-015**: 当导出数据量超过 10000 条时，系统必须提示用户并限制单次导出最多 10000 条
- **FR-016**: 当列表为空或筛选结果为空时，系统必须提示"暂无数据可导出"

#### 批量导入

- **FR-017**: 系统必须提供标准 Excel 模板文件供用户下载，模板必须包含必填列和选填列的说明
- **FR-018**: 系统必须校验上传文件的格式（仅支持 .xlsx 和 .xls 格式）
- **FR-019**: 系统必须校验上传文件的列结构，必填列包括：物料名称、分类、库存单位ID、采购单位ID
- **FR-020**: 系统必须对每一行数据进行校验，校验规则包括：
  - 物料名称不能为空且长度不超过 100 字符
  - 分类必须为"RAW_MATERIAL"或"PACKAGING"
  - 库存单位ID和采购单位ID必须存在于系统中
  - 物料编码如果填写必须唯一（不与已有物料重复）
  - 标准成本必须为非负数
  - 换算率必须为正数
- **FR-021**: 系统必须在导入前显示预览结果，包括成功行数、失败行数、失败详情（行号+错误信息）
- **FR-022**: 系统必须仅导入校验成功的数据，校验失败的行不导入
- **FR-023**: 系统必须在导入完成后显示导入结果统计：成功导入 X 条，失败 Y 条

#### 批量操作

- **FR-024**: 系统必须提供多选框（Checkbox）允许用户勾选物料
- **FR-025**: 当用户勾选至少一个物料时，系统必须在页面顶部显示"已选择 N 项"提示和批量操作按钮
- **FR-026**: 批量删除功能必须弹出确认对话框显示"确定要删除选中的 N 个物料吗？"
- **FR-027**: 批量删除必须检测物料是否被 BOM 引用，被引用的物料不能删除并记录失败原因
- **FR-028**: 批量修改状态功能必须提供状态选择器（在用、停用、淘汰）
- **FR-029**: 批量操作完成后必须显示详细结果：成功 X 个，失败 Y 个，以及失败物料的编码和原因

### Key Entities

- **MaterialFilter**: 物料筛选条件对象，包含分类、状态、成本范围（最小、最大）、关键词等属性
- **MaterialExportData**: 物料导出数据对象，包含物料的所有展示字段（编码、名称、分类、状态、单位、成本、规格等）
- **MaterialImportRecord**: 物料导入记录对象，包含行号、物料数据、校验状态（成功/失败）、错误信息等属性
- **MaterialBatchOperation**: 批量操作对象，包含操作类型（删除、修改状态）、选中的物料ID列表、操作结果（成功列表、失败列表及原因）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能在 5 秒内通过筛选条件（分类+关键词）从 1000+ 条物料数据中定位到目标物料
- **SC-002**: 用户能在 10 秒内完成物料数据导出操作（包含 1000 条以内的数据）
- **SC-003**: 用户能在 30 秒内完成批量导入 100 条物料数据（包括模板下载、填写、上传、预览、确认）
- **SC-004**: 批量操作功能能在 5 秒内完成对 50 个物料的状态修改
- **SC-005**: 筛选条件重置后，列表在 2 秒内恢复显示全部物料数据
- **SC-006**: 导出的 Excel 文件格式正确，能被 Excel、WPS 等常见软件正常打开且数据完整
- **SC-007**: 导入功能的数据校验准确率达到 100%（所有不符合规则的数据都能被检测出来）
- **SC-008**: 批量操作的错误提示准确率达到 100%（每个失败的物料都能显示具体的失败原因）
- **SC-009**: 用户对筛选功能的满意度达到 90% 以上（通过用户反馈或问卷调查）
- **SC-010**: 批量导入功能减少手动逐条录入物料的时间成本 80% 以上
